<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="https://learn.microsoft.com/en-us/dotnet/api/system.runtime.serialization.iserializable"><code>ISerializable</code></a> interface is the mechanism to control the type serialization process. If not implemented correctly this could result in an invalid serialization and hard-to-detect bugs.</p>
</div>
<div class="paragraph">
<p>This rule raises an issue on types that implement <code>ISerializable</code> without following the <a href="https://learn.microsoft.com/en-us/dotnet/standard/design-guidelines/serialization">serialization pattern recommended by Microsoft</a>.</p>
</div>
<div class="paragraph">
<p>Specifically, this rule checks for these problems:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <a href="https://learn.microsoft.com/en-us/dotnet/api/system.serializableattribute"><code>SerializableAttribute</code></a> attribute is missing.</p>
</li>
<li>
<p>Non-serializable fields are not marked with the <a href="https://learn.microsoft.com/en-us/dotnet/api/system.nonserializedattribute"><code>NonSerializedAttribute</code></a> attribute.</p>
</li>
<li>
<p>There is no serialization constructor.</p>
</li>
<li>
<p>An unsealed type has a serialization constructor that is not <code>protected</code>.</p>
</li>
<li>
<p>A sealed type has a serialization constructor that is not <code>private</code>.</p>
</li>
<li>
<p>An unsealed type has an <a href="https://learn.microsoft.com/en-us/dotnet/api/system.runtime.serialization.iserializable.getobjectdata"><code>ISerializable.GetObjectData</code></a> that is not both <code>public</code> and <code>virtual</code>.</p>
</li>
<li>
<p>A derived type has a serialization constructor that does not call the <code>base</code> constructor.</p>
</li>
<li>
<p>A derived type has an <code>ISerializable.GetObjectData</code> method that does not call the <code>base</code> method.</p>
</li>
<li>
<p>A derived type has serializable fields but the <code>ISerializable.GetObjectData</code> method is not overridden.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Classes that inherit from <a href="https://learn.microsoft.com/en-us/dotnet/api/system.exception"><code>Exception</code></a> are implementing <code>ISerializable</code>. Make sure the <code>[Serializable]</code> attribute is used and that <code>ISerializable</code> is correctly implemented. Even if you don&#8217;t plan to explicitly serialize the object yourself, it might still require serialization, for instance when crossing the boundary of an <a href="https://learn.microsoft.com/en-us/dotnet/api/system.appdomain"><code>AppDomain</code></a>.</p>
</div>
<div class="paragraph">
<p>This rule only raises an issue on classes that indicate that they are interested in serialization (see the <em>Exceptions</em> section). That is to reduce noise because a lot of classes in the base class library are implementing <code>ISerializable</code>, including the following classes: <a href="https://learn.microsoft.com/en-us/dotnet/api/system.exception"><code>Exception</code></a>, <a href="https://learn.microsoft.com/en-us/dotnet/api/system.uri"><code>Uri</code></a>, <a href="https://learn.microsoft.com/en-us/dotnet/api/system.collections.hashtable"><code>Hashtable</code></a>, <a href="https://learn.microsoft.com/en-us/dotnet/api/system.collections.generic.dictionary-2"><code>Dictionary&lt;TKey,TValue&gt;</code></a>, <a href="https://learn.microsoft.com/en-us/dotnet/api/system.data.dataset"><code>DataSet</code></a>, <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.httpwebrequest"><code>HttpWebRequest</code></a>, <a href="https://learn.microsoft.com/en-us/dotnet/api/system.text.regularexpressions.regex"><code>Regex</code></a> <a href="https://learn.microsoft.com/en-us/dotnet/api/system.windows.forms.treenode"><code>TreeNode</code></a>, and others. There is often no need to add serialization support in classes derived from these types.</p>
</div>
<div class="sect2">
<h3 id="_exceptions">Exceptions</h3>
<div class="ulist">
<ul>
<li>
<p>Classes in test projects are not checked.</p>
</li>
<li>
<p>Classes need to indicate that they are interested in serialization support by either</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Applying the <code>[Serializable]</code> attribute</p>
</li>
<li>
<p>Having <code>ISerializable</code> in their base type list</p>
</li>
<li>
<p>Declaring a <a href="https://learn.microsoft.com/en-us/dotnet/standard/design-guidelines/serialization#supporting-runtime-serialization">serialization constructor</a></p>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-csharp" data-lang="csharp">[Serializable]                                                                                 // 1.
public class SerializationOptIn_Attribute
{
}

public class SerializationOptIn_Interface : ISerializable                                      // 2.
{
}

public class SerializationOptIn_Constructor
{
    protected SerializationOptIn_Constructor(SerializationInfo info, StreamingContext context) // 3.
    {
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Make sure to follow the <a href="https://learn.microsoft.com/en-us/dotnet/standard/design-guidelines/serialization">recommended guidelines</a> when implementing <code>ISerializable</code>.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-csharp" data-lang="csharp">public class Bar
{
}

public class Foo : ISerializable // Noncompliant: serialization constructor is missing
                                 // Noncompliant: the [Serializable] attribute is missing
{
    private readonly Bar bar; // Noncompliant: the field is not marked with [NonSerialized]
}

public sealed class SealedFoo : Foo
{
    private int val; // Noncompliant: 'val' is serializable and GetObjectData is not overridden

    public SealedFoo()
    {
        // ...
    }

    public SealedFoo(SerializationInfo info, StreamingContext context) // Noncompliant: serialization constructor is not `private`
                                                                       // Noncompliant: serialization constructor does not call base constructor
    {
        // ...
    }
}

public class UnsealedFoo : Foo
{
    public UnsealedFoo()
    {
        // ...
    }

    public UnsealedFoo(SerializationInfo info, StreamingContext context) // Noncompliant: serialization constructor is not `protected`
        : base(info, context)
    {
        // ...
    }

    protected void GetObjectData(SerializationInfo info, StreamingContext context) // Noncompliant: GetObjectData is not public virtual
    {
        // Noncompliant: does not call base.GetObjectData(info, context)
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-csharp" data-lang="csharp">public class Bar
{
}

[Serializable]
public class Foo : ISerializable // Compliant: the class is marked with [Serializable]
{
    [NonSerialized]
    private readonly Bar bar; // Compliant: the field is marked with [NonSerialized]

    public Foo()
    {
        // ...
    }

    protected Foo(SerializationInfo info, StreamingContext context) // Compliant: serialization constructor is present
    {
        // ...
    }

    public virtual void GetObjectData(SerializationInfo info, StreamingContext context)
    {
        // ...
    }
}

[Serializable]
public sealed class SealedFoo : Foo
{
    private int val; // Compliant: 'val' is serializable and GetObjectData is overridden

    public SealedFoo()
    {
        // ...
    }

    private SealedFoo(SerializationInfo info, StreamingContext context) // Compliant: serialization constructor is `private`
        : base(info, context) // Compliant: serialization constructor calls base constructor
    {
        // ...
    }

    public override void GetObjectData(SerializationInfo info, StreamingContext context)
    {
        base.GetObjectData(info, context);
        // ...
    }
}

[Serializable]
public class UnsealedFoo : Foo
{
    public UnsealedFoo()
    {
        // ...
    }

    protected UnsealedFoo(SerializationInfo info, StreamingContext context) // Compliant: serialization constructor is `protected`
        : base(info, context)
    {
        // ...
    }

    public virtual void GetObjectData(SerializationInfo info, StreamingContext context) // Compliant: GetObjectData is public virtual
    {
        base.GetObjectData(info, context); // Compliant: calls base.GetObjectData(info, context)
        // ...

    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>Microsoft Learn - <a href="https://learn.microsoft.com/en-us/dotnet/standard/design-guidelines/serialization">Serialization</a></p>
</li>
<li>
<p>Microsoft Learn - <a href="https://learn.microsoft.com/en-us/dotnet/api/system.runtime.serialization.iserializable"><code>ISerializable</code> Interface</a></p>
</li>
<li>
<p>Microsoft Learn - <a href="https://learn.microsoft.com/en-us/dotnet/api/system.serializableattribute"><code>SerializableAttribute</code> Class</a></p>
</li>
<li>
<p>Microsoft Learn - <a href="https://learn.microsoft.com/en-us/dotnet/api/system.nonserializedattribute"><code>NonSerializedAttribute</code> Class</a></p>
</li>
<li>
<p>Microsoft Learn - <a href="https://learn.microsoft.com/en-us/dotnet/api/system.runtime.serialization.iserializable.getobjectdata"><code>ISerializable.GetObjectData</code> Method</a></p>
</li>
<li>
<p>Microsoft Learn - <a href="https://learn.microsoft.com/en-us/dotnet/api/system.exception"><code>Exception</code> Class</a></p>
</li>
</ul>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Update this implementation of <code>ISerializable</code> to conform to the recommended serialization pattern.
Override 'GetObjectData(SerializationInfo, StreamingContext)' and serialize 'X'.
Invoke 'base.GetObjectData(SerializationInfo, StreamingContext)' in this method.
Make 'GetObjectData' 'public' and 'virtual', or seal 'X'.
Make this constructor 'X'.
Call constructor 'base(SerializationInfo, StreamingContext)'.
Add a 'X' constructor '{typeSymbol.Name}(SerializationInfo, StreamingContext)'.</p>
</div>
</div>
<div class="sect2">
<h3 id="_highlighting">Highlighting</h3>
<div class="paragraph">
<p>The type identifier.</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_on_16_mar_2017_121137_ann_campbell_wrote">on 16 Mar 2017, 12:11:37 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~amaury.leve] I&#8217;ve edited. Please double-check me.</p>
</div>
<div class="paragraph">
<p>Also, examples for each noncompliant case aren&#8217;t necessary IMO. I&#8217;d show only one or two particularly damaging or particularly subtle examples.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_24_mar_2017_160550_valeri_hristov_wrote">on 24 Mar 2017, 16:05:50 Valeri Hristov wrote:</h3>
<div class="paragraph">
<p>The following check is not implemented because it is difficult to know exactly which fields should be marked with <code>NonSerialized</code> and I am afraid it will generate too many FPs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Non-serializable fields are not marked with the <code>System.NonSerializedAttribute</code> attribute.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We find mostly classes that derive from Exception in the projects we test and that&#8217;s why they might not be a good source for checking issues and false positives (statistically).</p>
</div>
</div>
</div>
</div>