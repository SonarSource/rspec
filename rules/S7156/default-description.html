<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This rule raises an issue when <code>copy.replace</code> is used on an incorrect type.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Python 3.13 introduced the function <code>copy.replace(obj, /, **changes)</code> which creates a new duplicate of the same type as <code>obj</code> then updating the values of the fields provided in <code>changes</code>.
However, calling <code>copy.replace(...)</code> with an argument of an unsupported type will raise an <code>TypeError</code>.
In order for a type to be supported by <code>copy.replace(...)</code>, the <a href="https://docs.python.org/3/library/copy.html#object.__replace__">replace protocol</a> must be implemented.</p>
</div>
<div class="paragraph">
<p>The following built-in types implement the <a href="https://docs.python.org/3/library/copy.html#object.__replace__">replace protocol</a> and are thus supported by <code>copy.replace(...)</code></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>datetime.datetime</code>, <code>datetime.date</code>, <code>datetime.time</code></p>
</li>
<li>
<p><code>inspect.Signature</code>, <code>inspect.Parameter</code></p>
</li>
<li>
<p><code>types.SimpleNamespace</code></p>
</li>
<li>
<p><a href="https://docs.python.org/3/library/typing.html#typing.NamedTuple">typed named tuples</a>, <code>collections.namedtuple()</code></p>
</li>
<li>
<p><a href="https://docs.python.org/3/library/dataclasses.html">data classes</a></p>
</li>
<li>
<p><a href="https://docs.python.org/3/reference/datamodel.html#code-objects">code objects</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_exceptions">Exceptions</h3>
<div class="paragraph">
<p>This issue is only raised for Python 3.13 and above, since the respective method isn&#8217;t available in previous versions of Python.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If the argument passed to <code>copy.replace(...)</code> is a class defined in this project then, to fix the issue, implement the <a href="https://docs.python.org/3/library/copy.html#object.__replace__">replace protocol</a> by defining the <code>__replace__</code> method in the class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class SomeClass:
    def __init__(self, name):
        self.name = name

    def __replace__(self, /, **changes):
        return SomeClass(changes.get("name", self.name))</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">import copy

class AClass:
    ...

a = AClass()
b = copy.replace(a) # Noncompliant: AClass does not implement __replace__(...)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">import copy

class AClass:
    ...
    def __replace__(self, /, **changes):
        ...

a = AClass()
b = copy.replace(a) # Compliant


@dataclass
class ADataClass:
    ...

c = ADataClass()
d = copy.replace(c) # Compliant</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_pitfalls">Pitfalls</h3>
<div class="paragraph">
<p>Ensure that if the <code>__replace__</code> is implemented that the implementation creates a new object instead of updating the old one.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>Python Documentation - <a href="https://docs.python.org/3/library/copy.html#copy.replace">copy — Shallow and deep copy operations — copy.replace</a></p>
</li>
<li>
<p>Python Documentation - <a href="https://docs.python.org/3/library/copy.html#object.__replace__">copy — Shallow and deep copy operations — object.__replace__</a></p>
</li>
<li>
<p>Python Documentation - <a href="https://docs.python.org/3/whatsnew/3.13.html#copy">What&#8217;s New in Python 3.13</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>