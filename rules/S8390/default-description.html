<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is an issue when a path operation function accepts a JSON request body (using Pydantic models or <code>Body()</code> parameters) without explicitly validating that the <code>Content-Type</code> header is set to <code>application/json</code> or a compatible JSON media type.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When a FastAPI path operation accepts JSON request bodies without validating the <code>Content-Type</code> header, it becomes vulnerable to Cross-Site Request Forgery (CSRF) attacks.</p>
</div>
<div class="paragraph">
<p>Browsers implement CORS (Cross-Origin Resource Sharing) protections that require a preflight OPTIONS request for certain types of cross-origin requests. However, requests with certain "simple" content types like <code>text/plain</code> are exempt from this preflight check.</p>
</div>
<div class="paragraph">
<p>An attacker can exploit this by:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Creating a malicious web page that sends a POST request with <code>Content-Type: text/plain</code></p>
</li>
<li>
<p>Including valid JSON data in the request body</p>
</li>
<li>
<p>The browser sends this request without a CORS preflight check</p>
</li>
<li>
<p>If the FastAPI application doesn&#8217;t validate the Content-Type header, it will process the JSON data</p>
</li>
<li>
<p>This bypasses CORS protections and allows the attacker to perform actions on behalf of an authenticated user</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This vulnerability is particularly dangerous because:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It can be exploited from any website the victim visits</p>
</li>
<li>
<p>It works even if the application has CORS configured correctly</p>
</li>
<li>
<p>It can lead to unauthorized state-changing operations</p>
</li>
<li>
<p>The victim&#8217;s authentication credentials (cookies, etc.) are automatically included by the browser</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>Without proper Content-Type validation, attackers can:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Perform unauthorized actions on behalf of authenticated users</p>
</li>
<li>
<p>Modify or delete user data</p>
</li>
<li>
<p>Execute privileged operations if the victim has elevated permissions</p>
</li>
<li>
<p>Bypass CORS security controls</p>
</li>
<li>
<p>Compromise the integrity and confidentiality of the application</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The severity is particularly high for endpoints that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Perform state-changing operations (create, update, delete)</p>
</li>
<li>
<p>Handle sensitive data</p>
</li>
<li>
<p>Require authentication</p>
</li>
<li>
<p>Have elevated privileges</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it_in_fastapi">How to fix it in FastAPI</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Add explicit Content-Type header validation to ensure only requests with <code>application/json</code> (or compatible JSON media types) are processed. Use the <code>Header()</code> parameter to extract the Content-Type header and validate it before processing the request body.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">@app.post("/items/")
async def create_item(item: Item):
    # No Content-Type validation - vulnerable to CSRF
    return item</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">from fastapi import Header, HTTPException

@app.post("/items/")
async def create_item(
    item: Item,
    content_type: str = Header(...)
):
    if not content_type.startswith('application/json'):
        raise HTTPException(
            status_code=415,
            detail="Content-Type must be application/json"
        )
    return item</code></pre>
</div>
</div>
<div class="paragraph">
<p>For applications with multiple JSON endpoints, create a reusable dependency that validates the Content-Type header. This reduces code duplication and ensures consistent validation across all endpoints.</p>
</div>
</div>
<div class="sect3">
<h4 id="_noncompliant_code_example_2">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">@app.post("/users/")
async def create_user(user: User):
    return user

@app.post("/products/")
async def create_product(product: Product):
    return product</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution_2">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">from fastapi import Depends, Header, HTTPException
from typing import Annotated

def validate_json_content_type(content_type: str = Header(...)):
    if not content_type.startswith('application/json'):
        raise HTTPException(
            status_code=415,
            detail="Content-Type must be application/json"
        )

JsonContentType = Annotated[None, Depends(validate_json_content_type)]

@app.post("/users/")
async def create_user(user: User, _: JsonContentType):
    return user

@app.post("/products/")
async def create_product(product: Product, _: JsonContentType):
    return product</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>FastAPI Security Documentation - <a href="https://fastapi.tiangolo.com/tutorial/security/">Official FastAPI documentation on security best practices</a></p>
</li>
<li>
<p>FastAPI Header Parameters - <a href="https://fastapi.tiangolo.com/tutorial/header-params/">Documentation on how to use Header parameters in FastAPI</a></p>
</li>
<li>
<p>OWASP CSRF Prevention Cheat Sheet - <a href="https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html">Comprehensive guide on preventing CSRF attacks</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_standards">Standards</h3>
<div class="ulist">
<ul>
<li>
<p>CWE 352 - <a href="https://cwe.mitre.org/data/definitions/352.html">CWE-352: Cross-Site Request Forgery (CSRF)</a></p>
</li>
<li>
<p>OWASP Top 10 2021 A01 - <a href="https://owasp.org/Top10/A01_2021-Broken_Access_Control/">Broken Access Control</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_related_rules">Related rules</h3>
<div class="ulist">
<ul>
<li>
<p><a data-rspec-id="S5122" class="rspec-auto-link">S5122</a> - CORS policy should be restrictive</p>
</li>
</ul>
</div>
</div>
</div>
</div>