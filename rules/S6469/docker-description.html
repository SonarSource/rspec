<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For mounts types <code>secret</code> and <code>ssh</code>, Dockerfile&#8217;s <code>RUN</code> instruction supports a
<code>mode</code> option for setting permissions. If you set this mode so that any user of
the operating system can access the mount, it is vulnerable to leaks.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Docker offers a feature to mount files and directories for specific <code>RUN</code>
instructions when building Docker images. This feature can be used to provide
secrets to commands that are executed during the build without baking them
into the image. Additionally, it can be used to access SSH agents during the
build.</p>
</div>
<div class="paragraph">
<p>The <code>mode</code> option is an octal value that allows you to specify the permissions
for a particular file or directory. By default, on Docker, when mounting a
<code>secret</code>, it is set to <code>0400</code>.</p>
</div>
<div class="paragraph">
<p>For <code>ssh</code>, it is set by default to <code>0600</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The first digit <code>0</code> stands for special permissions (like setuid, setgid and
sticky bit) and in this case means that no special permissions are set.</p>
</li>
<li>
<p>The following <code>6</code> (4+2 in octal format) means that the <code>owner</code> has read (4)
and write (2) permissions</p>
</li>
<li>
<p><code>00</code> means that the <code>group</code> and <code>others</code> have no permissions.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the <code>others</code> bit is set to a value other than 0 at build-time, any other
process can access it when the <code>RUN</code> command is executed: the secrets are
vulnerable to supply chain attacks that aim to siphon secrets from containers.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="sect3">
<h4 id="_unauthorized_access">Unauthorized access</h4>
<div class="paragraph">
<p>The unintended audience can exploit the leaked private key or equivalent to
authenticate themselves as the legitimate owner, gaining unauthorized entry to
systems, servers, or accounts that accept the key for authentication.</p>
</div>
<div class="paragraph">
<p>This unauthorized access opens the door for various malicious activities,
including data breaches, unauthorized modifications, and misuse of sensitive
information.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-docker" data-lang="docker"># Noncompliant
RUN --mount=type=secret,id=build_secret,mode=0777 ./installer.sh</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-docker" data-lang="docker">RUN --mount=type=secret,id=build_secret,mode=0700 ./installer.sh</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_how_does_this_work">How does this work?</h3>
<div class="paragraph">
<p>In general, always follow the least privilege principle, and set the <code>others</code>
bit to <code>0</code>. By default, if <code>mode</code> is not set, permissions are safe.</p>
</div>
<div class="paragraph">
<p>In case you made this change because you need to access secrets or agents as a
low-privileged user, you can use the options <code>uid</code> and <code>gid</code> to provide access
without having to resort to world-readable or writable permissions that might
expose them to unintended parties.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>Dockerfile Reference - <a href="https://docs.docker.com/engine/reference/builder/#run---mounttypesecret">RUN --mount=type=secret</a></p>
</li>
<li>
<p>Red Hat - <a href="https://www.redhat.com/sysadmin/linux-file-permissions-explained">Linux file permissions explained</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_standards">Standards</h3>
<div class="ulist">
<ul>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/732">CWE-732 - Incorrect Permission Assignment for Critical Resource</a></p>
</li>
<li>
<p>STIG Viewer - <a href="https://stigviewer.com/stigs/application_security_and_development/2024-12-06/finding/V-222430">Application Security and Development: V-222430</a> - The application must execute without excessive account permissions.</p>
</li>
</ul>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>For secret:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Remove world permissions for this sensitive file.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For ssh:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Remove world permissions for this sensitive agent.</p>
</li>
</ul>
</div>
<hr>
</div>
</div>
</div>