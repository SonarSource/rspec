== Why is this an issue?

Docker offers a feature to mount files and directories for specific `RUN`
instructions when building Docker images. This feature can be used to provide
secrets to commands that are executed during the build without baking them
into the image. Additionally, it can be used to access SSH agents during the
build.

The `mode` option allows you to change the permissions of the secrets or
agents. By default, it is set to `0400` for `secret` and `0600` for `ssh`.

The mode option is an octal value that specifies the permissions for a
particular file or directory. +
The first digit 0 stands for special permissions (like setuid, setgid and
sticky bit) and in this case means that no special permissions are set. +
The following three digits 600 indicate the permissions for the `owner`, `group`
and `others` respectively. In this case 6 (4+2 in binary format) means that the
`owner` has read (4) and write (2) permissions, and 00 means that the `group` and
`others` have no permissions.

If the `others` bit is set to a value other than 0 during creation, these
secrets are vulnerable to supply chain attacks that aim to siphon secrets from
containers.

When the `RUN` command is executed, the secret is exposed.

=== What is the potential impact?

==== Unauthorized access

The unintended audience can exploit the leaked private key or equivalent to
authenticate themselves as the legitimate owner, gaining unauthorized entry to
systems, servers, or accounts that accept the key for authentication.

This unauthorized access opens the door for various malicious activities,
including data breaches, unauthorized modifications, and misuse of sensitive
information.

== How to fix it

=== Code examples

==== Noncompliant code example

[source,docker,diff-id=1,diff-type=noncompliant]
----
RUN --mount=type=secret,id=build_secret,mode=0777 ./installer.sh # Noncompliant
----

==== Compliant solution

[source,docker,diff-id=1,diff-type=compliant]
----
RUN --mount=type=secret,id=build_secret,uid=1000 ./installer.sh
----

=== How does this work?

Always set the `others` bit to `0`.

In case you made this change because you need to access secrets or agents as a
low-privileged user, you can use the options `uid` and `gid` to provide access
without having to resort to world-readable or writable permissions that might
expose them to unintended parties.

== Resources

=== Documentation

* https://docs.docker.com/engine/reference/builder/#run---mounttypesecret[Dockerfile reference] - RUN --mount

=== Standards

* https://cwe.mitre.org/data/definitions/732[MITRE, CWE-732] - Incorrect Permission Assignment for Critical Resource


ifdef::env-github,rspecator-view[]

'''
== Implementation Specification
(visible only on this page)

=== Message

For secret:

 * Remove world permissions for this sensitive file.

For ssh:

 * Remove world permissions for this sensitive agent.



'''
endif::env-github,rspecator-view[]
