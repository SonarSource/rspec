<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Array covariance is the principle that if an implicit or explicit reference conversion exits from type <code>A</code> to <code>B</code>, then the same conversion exists from the array type <code>A[]</code> to <code>B[]</code>.</p>
</div>
<div class="paragraph">
<p>While this array conversion can be useful in readonly situations to pass instances of <code>A[]</code> where <code>B[]</code> is expected, it must be used with care, since assigning an instance of <code>B</code> into an array of <code>A</code> will cause an <code>ArrayTypeMismatchException</code> to be thrown at runtime.</p>
</div>
<div class="sect2">
<h3 id="_noncompliant_code_example">Noncompliant code example</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-csharp" data-lang="csharp">abstract class Fruit { }
class Apple : Fruit { }
class Orange : Fruit { }

class Program
{
  static void Main(string[] args)
  {
    Fruit[] fruits = new Apple[1]; // Noncompliant - array covariance is used
    FillWithOranges(fruits);
  }

  // Just looking at the code doesn't reveal anything suspicious
  static void FillWithOranges(Fruit[] fruits)
  {
    for (int i = 0; i &lt; fruits.Length; i++)
    {
      fruits[i] = new Orange(); // Will throw an ArrayTypeMismatchException
    }
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_compliant_solution">Compliant solution</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-csharp" data-lang="csharp">abstract class Fruit { }
class Apple : Fruit { }
class Orange : Fruit { }

class Program
{
  static void Main(string[] args)
  {
    Orange[] fruits = new Orange[1]; // Compliant
    FillWithOranges(fruits);
  }

  static void FillWithOranges(Orange[] fruits)
  {
    for (int i = 0; i &lt; fruits.Length; i++)
    {
      fruits[i] = new Orange();
    }
  }
}</code></pre>
</div>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Refactor the code to not rely on potentially unsafe array conversions.</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_relates_to_s3062">relates to: <a data-rspec-id="S3062" class="rspec-auto-link">S3062</a></h3>

</div>
<div class="sect2">
<h3 id="_on_11_may_2015_143324_dinesh_bolkensteyn_wrote">on 11 May 2015, 14:33:24 Dinesh Bolkensteyn wrote:</h3>
<div class="paragraph">
<p>I don&#8217;t get this explanation - I think we need a real example where something fails</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_12_may_2015_130933_ann_campbell_wrote">on 12 May 2015, 13:09:33 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>how 'bout now [~dinesh.bolkensteyn]?</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_12_may_2015_162025_dinesh_bolkensteyn_wrote">on 12 May 2015, 16:20:25 Dinesh Bolkensteyn wrote:</h3>
<div class="paragraph">
<p>Note that we probably also want an issue here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>FillWithOranges(new Apple[1]); // Noncompliant
void FillWithOranges(Fruit[] fruits) { fruits[0] = new Orange(); }</pre>
</div>
</div>
<div class="paragraph">
<p>and that, in an ideal world, we would actually be able to flag the <code>FillWithOranges</code> method which should be refactored to take <code>Orange[]</code> as argument</p>
</div>
<div class="paragraph">
<p>I&#8217;m thinking that we can change this rule to something like: Don&#8217;t assign into arrays of A when there exists subtypes of A.</p>
</div>
<div class="paragraph">
<p>So, on the trivial example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>object[] a = new string[42]; // This is actually OK - as long as we only plan to read from "a" then nothing bad will happen
a[0] = 42; // Noncompliant - here the rule determines that "a" is an array of "object", for which it is able to find many derived types ({{string}}, {{Int32}}, etc.)</pre>
</div>
</div>
<div class="paragraph">
<p>WDYT [~ann.campbell.2]?</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_14_may_2015_125142_ann_campbell_wrote">on 14 May 2015, 12:51:42 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>thanks [~dinesh.bolkensteyn]</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_15_jun_2015_124851_tamas_vajk_wrote">on 15 Jun 2015, 12:48:51 Tamas Vajk wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2] this rule is missing the severity and scale mappings</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_15_jun_2015_131321_tamas_vajk_wrote">on 15 Jun 2015, 13:13:21 Tamas Vajk wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2] can you create a separate rule, which is an actual bug detection rule based on this one?</p>
</div>
<div class="paragraph">
<p>This rule says that we should report on <code>Fruit[] fruits = new Apple[1];</code>, however, that&#8217;s perfectly fine, that line won&#8217;t throw an exception. The problem comes when we try to put a non-<code>Apple</code> derived fruit in the array. So we should mark this line: <code>fruits[i] = new Orange();</code> that there is a potential bug here.</p>
</div>
<div class="paragraph">
<p>However, currently we have no way of finding these real bugs. So that&#8217;s why I would create a separate rule.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_15_jun_2015_142422_ann_campbell_wrote">on 15 Jun 2015, 14:24:22 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~tamas.vajk] SQALE was already there. I&#8217;ve added severity</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_15_jun_2015_144757_tamas_vajk_wrote">on 15 Jun 2015, 14:47:57 Tamas Vajk wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2] True, and it should be disabled by default, if I&#8217;m right?</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_16_jun_2015_113144_ann_campbell_wrote">on 16 Jun 2015, 11:31:44 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>Correct [~tamas.vajk]</p>
</div>
</div>
</div>
</div>