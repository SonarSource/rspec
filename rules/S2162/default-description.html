<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A key facet of the <code>equals</code> contract is that if <code>a.equals(b)</code> then <code>b.equals(a)</code>, i.e. that the relationship is symmetric.</p>
</div>
<div class="paragraph">
<p>Using <code>instanceof</code> breaks the contract when there are subclasses, because while the child is an <code>instanceof</code> the parent, the parent is not an <code>instanceof</code> the child. For instance, assume that <code>Raspberry extends Fruit</code> and adds some fields (requiring a new implementation of <code>equals</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Fruit fruit = new Fruit();
Raspberry raspberry = new Raspberry();

if (raspberry instanceof Fruit) { ... } // true
if (fruit instanceof Raspberry) { ... } // false</pre>
</div>
</div>
<div class="paragraph">
<p>If similar <code>instanceof</code> checks were used in the classes' <code>equals</code> methods, the symmetry principle would be broken:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>raspberry.equals(fruit); // false
fruit.equals(raspberry); //true</pre>
</div>
</div>
<div class="paragraph">
<p>Additionally, non <code>final</code> classes shouldn&#8217;t use a hardcoded class name in the <code>equals</code> method because doing so breaks the method for subclasses. Instead, make the comparison dynamic.</p>
</div>
<div class="paragraph">
<p>Further, comparing to an unrelated class type breaks the contract for that unrelated type, because while <code>thisClass.equals(unrelatedClass)</code> can return true, <code>unrelatedClass.equals(thisClass)</code> will not.</p>
</div>
<div class="sect2">
<h3 id="_noncompliant_code_example">Noncompliant code example</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class Fruit extends Food {
  private Season ripe;

  public boolean equals(Object obj) {
    if (obj == this) {
      return true;
    }
    if (obj == null) {
      return false;
    }
    if (Fruit.class == obj.getClass()) { // Noncompliant; broken for child classes
      return ripe.equals(((Fruit)obj).getRipe());
    }
    if (obj instanceof Fruit ) {  // Noncompliant; broken for child classes
      return ripe.equals(((Fruit)obj).getRipe());
    }
    else if (obj instanceof Season) { // Noncompliant; symmetry broken for Season class
      // ...
    }
    //...</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_compliant_solution">Compliant solution</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class Fruit extends Food {
  private Season ripe;

  public boolean equals(Object obj) {
    if (obj == this) {
      return true;
    }
    if (obj == null) {
      return false;
    }
    if (this.getClass() == obj.getClass()) {
      return ripe.equals(((Fruit)obj).getRipe());
    }
    return false;
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://wiki.sei.cmu.edu/confluence/x/AzZGBQ">CERT, MET08-J.</a> - Preserve the equality contract when overriding the equals() method</p>
</li>
</ul>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="ulist">
<ul>
<li>
<p>Compare to "this.getClass()" instead.</p>
</li>
<li>
<p>Remove this comparison to an unrelated class.</p>
</li>
</ul>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_replaces_s2161">replaces: <a data-rspec-id="S2161" class="rspec-auto-link">S2161</a></h3>

</div>
<div class="sect2">
<h3 id="_on_15_oct_2014_215059_freddy_mallet_wrote">on 15 Oct 2014, 21:50:59 Freddy Mallet wrote:</h3>
<div class="paragraph">
<p>We&#8217;re advising the opposite in the compliant solution of rule <a data-rspec-id="S2097" class="rspec-auto-link">RSPEC-2097</a> @Ann. And we&#8217;re doing that because 95% of the time, developers are using <code>instanceof</code> operator which is more readable than checking the equality of classes.</p>
</div>
<div class="paragraph">
<p>I guess this rule might remain valuable in some specific contexts but I would not activate it by default.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_16_oct_2014_154456_ann_campbell_wrote">on 16 Oct 2014, 15:44:56 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~freddy.mallet] I&#8217;ve updated <a data-rspec-id="S2097" class="rspec-auto-link">RSPEC-2097</a> because the old example was broken for child classes since the advice is to use the parent class' <code>equals</code> method for parent class fields and check child class fields in the child&#8217;s <code>equals</code> method.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_16_oct_2014_163620_ann_campbell_wrote">on 16 Oct 2014, 16:36:20 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>FYI [~freddy.mallet], I followed, then reversed your advice and combined this with EQ_CHECK_FOR_OPERAND_NOT_COMPATIBLE_WITH_THIS instead since both rules look at symmetry.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_17_oct_2014_100704_freddy_mallet_wrote">on 17 Oct 2014, 10:07:04 Freddy Mallet wrote:</h3>
<div class="paragraph">
<p>Ok @Ann and I would merge this rule with <a data-rspec-id="S2161" class="rspec-auto-link">RSPEC-2161</a></p>
</div>
</div>
</div>
</div>