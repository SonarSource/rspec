<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is an issue when background threads, tasks, or any initialization code is placed after a call to <code>uvicorn.run()</code> in a FastAPI application.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In FastAPI applications, <code>uvicorn.run()</code> is a blocking call that starts the web server and runs indefinitely until the server is shut down. This means that any code placed after <code>uvicorn.run()</code> will not execute until the server stops.</p>
</div>
<div class="paragraph">
<p>When developers place background thread initialization, task scheduling, or other setup code after <code>uvicorn.run()</code>, they expect these tasks to run alongside the web server. However, because <code>uvicorn.run()</code> blocks the execution flow, the code after it never gets a chance to run.</p>
</div>
<div class="paragraph">
<p>This creates a silent failure scenario where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The application appears to start successfully</p>
</li>
<li>
<p>The web server runs normally</p>
</li>
<li>
<p>Background tasks never start</p>
</li>
<li>
<p>No error messages are displayed</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This behavior is particularly problematic because the application may seem to work correctly during initial testing, but critical background functionality (like periodic data synchronization, cleanup tasks, or monitoring) will be completely absent.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>Background tasks that never start can lead to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Data synchronization failures</p>
</li>
<li>
<p>Missed scheduled operations</p>
</li>
<li>
<p>Resource cleanup not occurring</p>
</li>
<li>
<p>Monitoring or health checks not running</p>
</li>
<li>
<p>Silent degradation of application functionality</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Move all background task initialization and startup code before the <code>uvicorn.run()</code> call. This ensures that threads and tasks are started before the blocking server call.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">if __name__ == '__main__':
    uvicorn.run(app, host="0.0.0.0", port=8000)
    # This thread will never start because uvicorn.run() blocks
    _worker_thread = Thread(target=start_worker, daemon=False)  # Noncompliant
    _worker_thread.start()</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">if __name__ == '__main__':
    # Start the background thread before uvicorn.run()
    _worker_thread = Thread(target=start_worker, daemon=False)
    _worker_thread.start()
    uvicorn.run(app, host="0.0.0.0", port=8000)</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>Uvicorn Documentation - Running Programmatically - <a href="https://www.uvicorn.org/#running-programmatically">Official documentation on how uvicorn.run() works</a></p>
</li>
<li>
<p>FastAPI Documentation - Background Tasks - <a href="https://fastapi.tiangolo.com/tutorial/background-tasks/">Guide on implementing background tasks in FastAPI</a></p>
</li>
<li>
<p>Python Threading Documentation - <a href="https://docs.python.org/3/library/threading.html">Official Python documentation on threading</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>