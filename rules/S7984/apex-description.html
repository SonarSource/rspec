<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is an issue when Apex code in Transaction Security Policy classes contains operations that could throw exceptions without proper error handling.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Transaction Security Policies are critical components of Salesforce security monitoring. They evaluate events in real-time to detect suspicious activities and enforce security rules.</p>
</div>
<div class="paragraph">
<p>When exceptions occur in these policies, the entire policy evaluation can fail. This creates several serious problems:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Silent failures</strong>: The policy may fail without clear error messages, making it difficult to detect and diagnose issues.</p>
</li>
<li>
<p><strong>Security gaps</strong>: Failed policies cannot monitor or block suspicious activities, potentially allowing unauthorized access to go undetected.</p>
</li>
<li>
<p><strong>Unreliable monitoring</strong>: Intermittent exceptions can cause inconsistent policy enforcement, reducing the effectiveness of security controls.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Common causes of exceptions in Transaction Security Policies include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Null pointer exceptions when accessing event data</p>
</li>
<li>
<p>Type casting errors when processing event attributes</p>
</li>
<li>
<p>String operations on null or unexpected values</p>
</li>
<li>
<p>External service calls that may timeout or fail</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These failures are particularly dangerous because they can occur during active security incidents, precisely when reliable policy enforcement is most critical.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>Unhandled exceptions in Transaction Security Policies can compromise the security monitoring of your Salesforce org. Failed policies may allow unauthorized activities to proceed undetected, potentially leading to data breaches, unauthorized access, or compliance violations. The silent nature of these failures makes them especially dangerous, as security teams may not realize their monitoring is compromised.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Wrap potentially risky operations in try-catch blocks. Always check for null values before using them, and provide appropriate logging for debugging. Return a safe default value (typically false) when exceptions occur.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-apex" data-lang="apex">public class MyTransactionSecurityPolicy implements TxnSecurity.PolicyCondition {
    public boolean evaluate(TxnSecurity.Event e) {
        String userLocation = e.getData().get('SourceIp');
        return userLocation.contains('suspicious'); // Noncompliant
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-apex" data-lang="apex">public class MyTransactionSecurityPolicy implements TxnSecurity.PolicyCondition {
    public boolean evaluate(TxnSecurity.Event e) {
        try {
            String userLocation = e.getData().get('SourceIp');
            return userLocation != null &amp;&amp; userLocation.contains('suspicious');
        } catch (Exception ex) {
            System.debug('Transaction security policy error: ' + ex.getMessage());
            return false; // Safe default
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>Transaction Security Policies - <a href="https://help.salesforce.com/s/articleView?id=sf.enhanced_transaction_security_overview.htm">Official Salesforce documentation on Transaction Security Policies</a></p>
</li>
<li>
<p>TxnSecurity.PolicyCondition Interface - <a href="https://developer.salesforce.com/docs/atlas.en-us.apexref.meta/apexref/apex_interface_TxnSecurity_PolicyCondition.htm">Apex reference for the PolicyCondition interface</a></p>
</li>
<li>
<p>Salesforce Shield Trail - <a href="https://trailhead.salesforce.com/en/content/learn/trails/shield">Comprehensive learning path for Salesforce Shield security features</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_standards">Standards</h3>
<div class="ulist">
<ul>
<li>
<p>CWE-248: Uncaught Exception - <a href="https://cwe.mitre.org/data/definitions/248.html">Weakness related to uncaught exceptions that can lead to system instability</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>