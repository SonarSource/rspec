<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to protect shared resources, Salesforce enforces a maximum number of DML statements which can be executed inside a single <a href="https://developer.salesforce.com/docs/atlas.en-us.apexcode.meta/apexcode/apex_transaction.htm">transaction</a>. This is part of <a href="https://developer.salesforce.com/docs/atlas.en-us.apexcode.meta/apexcode/apex_gov_limits.htm">Governor limits</a>. If a DML statement is nested inside a loop&#8217;s body (For/While/Do-While) it might be executed more times than the Governor limit allows, making the code fail.</p>
</div>
<div class="paragraph">
<p>Thus it is a best practice to not have DML statements nested in the body of loops and instead perform the DML operation on a list of sObjects.</p>
</div>
<div class="paragraph">
<p>This rule raises an issue when it detects DML statements inside a loop.</p>
</div>
<div class="sect2">
<h3 id="_noncompliant_code_example">Noncompliant code example</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-apex" data-lang="apex">public class myDMLLoop {
    public static void myFunction() {
        for (Task task: [Select Id, subject from Task]) {
            if (task.subject == 'foo') {
                task.subject = 'bar';
                update task; // Noncompliant
            }
        }
    }
}
// Query in a while loop
public class myDMLLoop {
    public static void myFunction(Task[] tasks) {
        Integer i = 0;
        while ( i &lt; 1000) {
            Task task = tasks[i];
            if (task.subject == 'foo') {
                task.subject = 'bar';
                update task; // Noncompliant
            }
        }
    }
}

// Query in a do-while loop
public class myDMLLoop {
    public static void myFunction(Task[] tasks) {
        Integer i = 0;
        do {
            Task task = tasks[i];
            if (task.subject == 'foo') {
                task.subject = 'bar';
                update task; // Noncompliant
            }
            i++;
        } while (i &lt; 1000);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_compliant_solution">Compliant solution</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-apex" data-lang="apex">public class myDMLLoop {
  	public static void myFunction() {
		List&lt;Task&gt; updatedTasks = new List&lt;Task&gt;();
        for (Task task: [Select Id, subject from Task]) {
            if (task.subject == 'foo') {
                task.subject = 'bar';
                updatedTasks.add(task);
            }
        }
        update updatedTasks;
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://developer.salesforce.com/index.php?title=Apex_Code_Best_Practices&amp;oldid=26951">Apex Code Best Practices</a></p>
</li>
<li>
<p><a href="https://developer.salesforce.com/docs/atlas.en-us.apexcode.meta/apexcode/langCon_apex_loops_for_SOQL.htm">SOQL For Loops</a></p>
</li>
</ul>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Move this DML statement out of the loop or process sObjects by batch.</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_on_5_jul_2019_173538_nicolas_harraudeau_wrote">on 5 Jul 2019, 17:35:38 Nicolas Harraudeau wrote:</h3>
<div class="paragraph">
<p>If the rule raise false positives one possible exception is:</p>
</div>
</div>
<div class="sect2">
<h3 id="_exceptions">Exceptions</h3>
<div class="paragraph">
<p>No issue will be raised when the DML statement is executed on a collection returned by a for loop. In this case the for loop already executed the DML statement in bulk.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>public class myDMLLoop {
    public static void myFunction() {
        for (Task[] task: [Select Id, subject from Task]) { // Ok. The SOQL query is processing a batch of Tasks instead of a single one
        	task.subject = task.subject + ' processed';
        	update task; // This update a batch of Tasks
        }
        for (List&lt;Task&gt; tasks: [Select Id, subject from Task]) { // Same here
            for (Task task: tasks) {
        		task.subject = task.subject + ' processed';
            }
            update tasks;
         }
    }
}</pre>
</div>
</div>
</div>
</div>
</div>