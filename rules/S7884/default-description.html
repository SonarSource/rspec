<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This rule raises an issue when code manually implements find-or-create patterns using conditional statements with methods like <code>exists?</code>, <code>find_by</code>, <code>where().first</code>, or find-destroy-create sequences instead of using Rails' built-in ActiveRecord methods.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Manual implementation of find-or-create logic is a common anti-pattern in Rails applications that leads to several problems.</p>
</div>
<div class="paragraph">
<p>Rails provides dedicated ActiveRecord methods like <code>find_or_create_by</code>, <code>find_or_initialize_by</code>, and <code>first_or_create</code> specifically designed to handle these scenarios. These methods are not just convenience features - they offer important advantages over manual implementations.</p>
</div>
<div class="paragraph">
<p><strong>Verbosity and readability issues</strong>: Manual patterns require multiple lines of conditional logic to accomplish what built-in methods can do in a single, expressive statement. This makes the code harder to read and understand, especially for developers familiar with Rails conventions.</p>
</div>
<div class="paragraph">
<p><strong>Race condition vulnerabilities</strong>: In concurrent environments, manual existence checks followed by creation can lead to race conditions. Between the time you check if a record exists and when you create it, another process might create the same record, potentially causing duplicate key errors or unexpected behavior.</p>
</div>
<div class="paragraph">
<p><strong>Error-prone implementation</strong>: Manual patterns are more susceptible to bugs. Developers might forget to handle edge cases, use inconsistent query conditions between the check and creation, or make mistakes in the conditional logic.</p>
</div>
<div class="paragraph">
<p><strong>Maintenance overhead</strong>: Manual implementations require more code to maintain and test. Changes to the logic need to be applied in multiple places, increasing the chance of introducing inconsistencies.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>Using manual find-or-create patterns instead of Rails' built-in methods can lead to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Race conditions</strong> in concurrent environments that may cause duplicate records or application errors</p>
</li>
<li>
<p><strong>Reduced code maintainability</strong> due to verbose, repetitive conditional logic</p>
</li>
<li>
<p><strong>Increased bug risk</strong> from manual implementation of complex database interaction patterns</p>
</li>
<li>
<p><strong>Poor code readability</strong> that makes it harder for team members to understand and modify the code</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it_in_rails">How to fix it in Rails</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Replace manual existence checks with <code>find_or_create_by</code> for simple find-or-create scenarios. This method atomically finds an existing record or creates a new one if none exists.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby"># Manual existence check with conditional creation
def get_or_create_tag
  tag = Tag.where(name: tag_name, user_id: user.id).first # Noncompliant
  if tag.nil?
    tag = Tag.create(name: tag_name, user_id: user.id)
  end
  tag
end</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby"># Use Rails' built-in find_or_create_by method
def get_or_create_tag
  Tag.find_or_create_by(name: tag_name, user_id: user.id)
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use <code>find_or_create_by</code> with a block when you need to set additional attributes only for new records. The block is executed only when creating a new record.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_code_examples_2">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example_2">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby"># Manual find-or-create with additional attributes
user = User.find_by(email: email) # Noncompliant
if user.nil?
  user = User.create(email: email, name: name, role: 'member')
end
user</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution_2">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby"># Use find_or_create_by with block for additional attributes
User.find_or_create_by(email: email) do |user|
  user.name = name
  user.role = 'member'
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace find-destroy-create patterns with <code>find_or_initialize_by</code> when you need to update existing records. This method finds an existing record or initializes a new one without saving it immediately.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_code_examples_3">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example_3">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby"># Manual find-destroy-create pattern
@student = Student.where(user_id: current_user.id).first # Noncompliant
if @student
  Student.destroy_all(user_id: current_user.id)
end
@student = Student.new(user_id: current_user.id, department: 1)
@student.save!</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution_3">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby"># Use find_or_initialize_by for update scenarios
@student = Student.find_or_initialize_by(user_id: current_user.id)
@student.department = 1
@student.save!</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>Rails Active Record Query Interface Guide - <a href="https://guides.rubyonrails.org/active_record_querying.html#find-or-build-a-new-object">Official Rails documentation covering find_or_create_by and related methods</a></p>
</li>
<li>
<p>Rails API Documentation - find_or_create_by - <a href="https://api.rubyonrails.org/classes/ActiveRecord/Relation.html#method-i-find_or_create_by">Detailed API documentation for the find_or_create_by method</a></p>
</li>
<li>
<p>Rails API Documentation - find_or_initialize_by - <a href="https://api.rubyonrails.org/classes/ActiveRecord/Relation.html#method-i-find_or_initialize_by">API documentation for find_or_initialize_by method</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>