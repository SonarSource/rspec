<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Kotlin coroutines follow the principle of structured concurrency. This helps in preventing resource leaks and ensures that scopes are only exited once all child coroutines have exited. Hence, structured concurrency enables developers to build concurrent applications while having to worry less about cleaning up concurrent tasks manually.</p>
</div>
<div class="paragraph">
<p>It is possible to break this concept of structured concurrency in various ways. Generally, this is not advised, as it can open the door to coroutines being leaked or lost. Ask yourself if breaking structured concurrency here is really necessary for the application&#8217;s business logic, or if it could be avoided by refactoring parts of the code.</p>
</div>
<div class="paragraph">
<p>This rule raises an issue when it detects that the structured concurrency principles are violated. It avoids reporting on valid use cases and in situations where developers have consciously opted into using delicate APIs (e.g. by using the <code>@OptIn</code> annotation) and hence should be aware of the possible pitfalls.</p>
</div>
<div class="sect2">
<h3 id="_noncompliant_code_example">Noncompliant code example</h3>
<div class="paragraph">
<p><a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-global-scope/index.html">GlobalScope</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin">fun main() {
  GlobalScope.launch { // Noncompliant: no explicit opt-in to DelicateCoroutinesApi
    // Do some work
  }.join()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Manual job instantiation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin">fun startLongRunningBackgroundJob(job: Job) {
    val coroutineScope = CoroutineScope(job)
    coroutineScope.launch(Job()) { // Noncompliant: new job instance passed to launch()
        // Do some work
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Manual supervisor instantiation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin">    coroutineScope {
        launch(SupervisorJob()) { // Noncompliant: new supervisor instance passed to launch()
            // Do some work
        }
    }</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_compliant_solution">Compliant solution</h3>
<div class="paragraph">
<p>In many situations, a good pattern is to use <code>coroutineScope</code> as provided in suspending functions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin">suspend fun main() {
    worker()
}

suspend fun worker() {
    coroutineScope {
        launch { // Compliant: no manually created job/supervisor instance passed to launch()
            // Do some work
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-global-scope/index.html">GlobalScope</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin">@OptIn(DelicateCoroutinesApi::class)
fun main() {
    GlobalScope.launch { // Compliant: explicit opt-in to DelicateCoroutinesApi via method annotation
        // Do some work
    }.join()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>No manual job instantiation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin">fun startLongRunningBackgroundJob(job: Job) {
    val coroutineScope = CoroutineScope(job)
    coroutineScope.launch { // Compliant: no manually created job/supervisor instance passed to launch()
        // Do some work
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using a supervisor scope instead of manually instantiating a supervisor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin">  supervisorScope {
    launch {
      // Do some work
    }
  }</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://kotlinlang.org/docs/coroutines-basics.html#structured-concurrency">Structured concurrency</a> in the Kotlin docs</p>
</li>
<li>
<p><a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-global-scope/index.html">GlobalScope documentation</a></p>
</li>
<li>
<p><a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-coroutine-scope/index.html">coroutineScope documentation</a></p>
</li>
<li>
<p><a href="https://developer.android.com/kotlin/coroutines/coroutines-best-practices">Android coroutines best practices</a></p>
</li>
</ul>
</div>
</div>
</div>