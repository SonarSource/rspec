== Why is this an issue?

A cast is an https://learn.microsoft.com/en-us/dotnet/visual-basic/programming-guide/language-features/data-types/implicit-and-explicit-conversions[explicit conversion], in other words, this is a way to tell the compiler the intent to convert from a type to another.

In Visual Basic, there is two explicit conversion operator: 

[source,vbnet]
----
Dim x As Single = 0.5F
Dim i As Integer = CInt(x)              // Casting (explicit conversion) from float to int
Dim y As Integer = DirectCast(x)        // Casting using DirectCast operator from float to int
----

In most cases, the compiler will be able to catch inappropriate casts between incompatible value types or reference types.

However, the compiler will not be able to detect inappropriate casts to interfaces.

This rule applies also to the https://learn.microsoft.com/en-us/dotnet/visual-basic/language-reference/operators/is-operator[`Is` operator] when used for type-testing.

[source,vbnet]
----
Dim b As Object = New Base()
Console.WriteLine(TypeOf b Is Base)     // Type-testing using the is operator
----

=== What is the potential impact?

Inappropriate casts will lead to unexpected behaviors or runtime errors such as https://learn.microsoft.com/en-us/dotnet/api/system.invalidcastexception[`InvalidCastException`].

=== Exceptions

No issue is reported if the interface has no implementing class in the assembly.

== How to fix it

To prevent an https://learn.microsoft.com/en-us/dotnet/api/system.invalidcastexception[`InvalidCastException`] from raising during an explicit conversion, it is recommended to use the https://learn.microsoft.com/en-us/dotnet/visual-basic/language-reference/operators/trycast-operator[`TryCast` operator].
When the conversion is not possible, the `TryCast` operator returns `Nothing` and will never raise an exception.

=== Code examples

==== Noncompliant code example

[source,vbnet,diff-id=1,diff-type=noncompliant]
----
Interface IMyInterface
End Interface

Public Class Implementer
    Implements IMyInterface
End Class

Public Class OrphanClass
End Class

Module Program
    Sub Main()
        Dim orphan = New OrphanClass()
        Dim x = CType(orphan, IMyInterface)    ' Noncompliant: InvalidCastException is being thrown
        Dim b = TypeOf orphan Is IMyInterface  ' Noncompliant: always false
    End Sub
End Module
----

==== Compliant solution

[source,vbnet,diff-id=1,diff-type=compliant]
----
Interface IMyInterface
End Interface

Public Class Implementer
    Implements IMyInterface
End Class

Public Class OrphanClass
End Class

Module Program
    Sub Main()
        Dim orphan = New OrphanClass()
        Dim x = TryCast(orphan, IMyInterface)  ' Compliant: but will always be null
        Dim b = False
    End Sub
End Module
----

== Resources

=== Documentation
* https://learn.microsoft.com/en-us/dotnet/visual-basic/programming-guide/language-features/data-types/type-conversions[Type Conversions in Visual Basic]
** https://learn.microsoft.com/en-us/dotnet/visual-basic/programming-guide/language-features/data-types/implicit-and-explicit-conversions[Implicit and Explicit Conversions in Visual Basic]
** https://learn.microsoft.com/en-us/dotnet/visual-basic/programming-guide/language-features/data-types/how-to-convert-an-object-to-another-type[How to: Convert an Object to Another Type in Visual Basic]
* https://learn.microsoft.com/en-us/dotnet/visual-basic/language-reference/operators/directcast-operator[`DirectCast` operator]
* https://learn.microsoft.com/en-us/dotnet/visual-basic/language-reference/functions/ctype-function[`CType` function]
* https://learn.microsoft.com/en-us/dotnet/visual-basic/language-reference/operators/trycast-operator[`TryCast` operator]
* https://cwe.mitre.org/data/definitions/588[MITRE, CWE-588 - Attempt to Access Child of a Non-structure Pointer]
* https://cwe.mitre.org/data/definitions/704[MITRE, CWE-704 - Incorrect Type Conversion or Cast]

include::../rspecator-dotnet.adoc[]
