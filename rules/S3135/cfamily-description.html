<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>sizeof</code> returns the size in bytes of a type. One common usage pattern, especially in C, is to use <code>sizeof</code> to determine the size of an array. However, arrays decay to pointers when passed as arguments to a function, and if <code>sizeof</code> is applied to such an argument, it will return the size of the pointer, not of the array. A similar issue happens when the array is used in an arithmetic operation.</p>
</div>
<div class="paragraph">
<p>This rule raises issues when:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>sizeof</code> is used to compute the array size of a pointer passed as a function argument.</p>
</li>
<li>
<p><code>sizeof</code> is called on the result of an arithmetic operation involving an array.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note: C&#43;&#43;17 provides a <code>std::size</code> function that will correctly compute the number of elements of an array and fail to compile if provided with a pointer. It is simpler and safer to use this variant when available. C&#43;&#43;20 also provides the functions <code>std::ssize</code>, <code>std::ranges::size</code>, and <code>std::ranges::ssize</code> with similar effects.</p>
</div>
<div class="sect2">
<h3 id="_noncompliant_code_example">Noncompliant code example</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">void fun(int *data, int array[10]) {
  size_t const dataSize = sizeof data / sizeof(int); // Noncompliant, type of data is int *
  size_t const arraySize = sizeof array / sizeof(int); // Noncompliant, type of array is int * too
  int primes[] = { 1, 2, 3, 5, 7, 13, 17, 19};
  size_t const primesSize2 = sizeof(primes + 1) / sizeof(int); // Noncompliant, type of primes + 1 is int *
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_compliant_solution">Compliant solution</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">// Computing dataSize is now the responsibility of the caller
void fun(int *data, int dataSize, int (&amp;array)[10]) {
  size_t const arraySize = sizeof array / sizeof(int); // Compliant, no decay
  int primes[] = { 1, 2, 3, 5, 7, 13, 17, 19};
  size_t const primesSize = std::size(primes); // Better variant in C++17
  size_t const primesSize2 = sizeof primes / sizeof(int) + 1; // Compliant, type of primes is int[8]
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://wiki.sei.cmu.edu/confluence/x/CdYxBQ">CERT, ARR01-C.</a> - Do not apply the <code>sizeof</code> operator to a pointer when taking the size of an array</p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/467">CWE-467 - Use of sizeof() on a Pointer Type</a></p>
</li>
</ul>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="ulist">
<ul>
<li>
<p>Remove this calculation inside the "sizeof".</p>
</li>
<li>
<p>Remove this use of "sizeof" with a numeric constant.</p>
</li>
<li>
<p>Remove the inner "sizeof".</p>
</li>
<li>
<p>Refactor this use of "sizeof" on expression of a pointer type.</p>
</li>
<li>
<p>Remove any possible side effects from this "sizeof".</p>
</li>
<li>
<p>Don&#8217;t use "sizeof" with an operand of a "void" type.</p>
</li>
</ul>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_deprecates_s2215">deprecates: <a data-rspec-id="S2215" class="rspec-auto-link">S2215</a></h3>

</div>
<div class="sect2">
<h3 id="_deprecates_s1913">deprecates: <a data-rspec-id="S1913" class="rspec-auto-link">S1913</a></h3>

</div>
<div class="sect2">
<h3 id="_is_related_to_s922">is related to: <a data-rspec-id="S922" class="rspec-auto-link">S922</a></h3>

</div>
<div class="sect2">
<h3 id="_on_29_jun_2015_102519_massimo_paladin_wrote">on 29 Jun 2015, 10:25:19 Massimo PALADIN wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2] could you please verify this spec?</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_29_jun_2015_115101_ann_campbell_wrote">on 29 Jun 2015, 11:51:01 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~massimo.paladin], I&#8217;ve made a few edits which you&#8217;ll want to double-check, but I don&#8217;t like the code example. I would have expected to see a <code>malloc</code> rather than an array declaration. Something like the following which is (when correctly written) a common idiom:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>int size = 42;
char *cp = malloc(sizeof(char * size));  // Noncompliant</pre>
</div>
</div>
<div class="paragraph">
<p>and</p>
</div>
<div class="listingblock">
<div class="content">
<pre>int size = 42;
char *cp = malloc(size * sizeof(char));</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_on_29_jun_2015_132224_ann_campbell_wrote">on 29 Jun 2015, 13:22:24 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>check it over, please [~massimo.paladin]</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_30_jun_2015_151224_ann_campbell_wrote">on 30 Jun 2015, 15:12:24 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~massimo.paladin] I&#8217;ve edited the description some. Please double-check me.</p>
</div>
<div class="paragraph">
<p>Also I favor moving <code>sizeof</code> out of <a data-rspec-id="S2665" class="rspec-auto-link">RSPEC-2665</a> and consolidating all the bad arguments to <code>sizeof</code> here. That would leave <a data-rspec-id="S2665" class="rspec-auto-link">RSPEC-2665</a> as: "alignof" should not be used with operands of a "void" type</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_2_jul_2015_202602_ann_campbell_wrote">on 2 Jul 2015, 20:26:02 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>FYI [~massimo.paladin] I suggest a title of: Valid arguments should be passed to "sizeof"</p>
</div>
<div class="paragraph">
<p>It&#8217;s slightly more specific</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_3_jul_2015_065154_massimo_paladin_wrote">on 3 Jul 2015, 06:51:54 Massimo PALADIN wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2] title updated.</p>
</div>
</div>
</div>
</div>