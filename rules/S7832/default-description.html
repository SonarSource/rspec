<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This rule raises an issue when database write operations (create, update, delete, save) are performed within validation callbacks (<code>before_validation</code> or <code>after_validation</code>).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Validation callbacks run during the validation phase of the ActiveRecord lifecycle, before the record is actually persisted to the database. Performing database write operations at this stage can cause several problems:</p>
</div>
<div class="paragraph">
<p><strong>Database Locking Issues</strong>: Validation callbacks can be called multiple times during a single save operation. If these callbacks perform database writes, they can create locks that conflict with the main save operation, leading to database deadlocks or "database is locked" errors.</p>
</div>
<div class="paragraph">
<p><strong>Transaction Conflicts</strong>: The validation phase occurs within the same database transaction as the main save operation. Additional database writes during validation can interfere with this transaction, potentially causing rollbacks or inconsistent data states.</p>
</div>
<div class="paragraph">
<p><strong>Unexpected Behavior</strong>: Validation callbacks are meant to validate data, not modify the database. Mixing validation logic with data persistence breaks the separation of concerns and makes the code harder to understand and maintain.</p>
</div>
<div class="paragraph">
<p><strong>Performance Impact</strong>: Database operations in validation callbacks can significantly slow down the validation process, especially if the callbacks are triggered multiple times or involve complex queries.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>Database write operations in validation callbacks can lead to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Database deadlocks and locking errors that prevent records from being saved</p>
</li>
<li>
<p>Data inconsistency due to transaction conflicts</p>
</li>
<li>
<p>Poor application performance due to unnecessary database operations during validation</p>
</li>
<li>
<p>Difficult-to-debug issues where validation appears to succeed but data is not properly persisted</p>
</li>
<li>
<p>Maintenance challenges due to unclear separation between validation and persistence logic</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it_in_ruby_on_rails">How to fix it in Ruby on Rails</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Move database write operations from validation callbacks to persistence callbacks like <code>after_create</code>, <code>after_save</code>, or <code>after_commit</code>. These callbacks run after the record has been successfully persisted, making database operations safe.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">class Podcast &lt; ActiveRecord::Base
  has_many :tracks

  before_validation :create_tracks # Noncompliant

  def create_tracks
    json = fetch_podcast_data
    json.sections.each do |section|
      if section.section_type == "track"
        Track.create(name: section.track.name, podcast_id: self.id) # Noncompliant
      end
    end
  end
end</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">class Podcast &lt; ActiveRecord::Base
  has_many :tracks

  after_create :create_tracks

  private

  def create_tracks
    json = fetch_podcast_data
    json.sections.each do |section|
      if section.section_type == "track"
        Track.create(name: section.track.name, podcast_id: self.id)
      end
    end
  end
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>For operations that should only happen after the transaction is committed, use <code>after_commit</code> callbacks to ensure data consistency.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_code_examples_2">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example_2">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">class User &lt; ActiveRecord::Base
  before_validation :update_profile_cache # Noncompliant

  def update_profile_cache
    ProfileCache.find_by(user_id: id)&amp;.update(data: profile_data) # Noncompliant
  end
end</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution_2">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">class User &lt; ActiveRecord::Base
  after_commit :update_profile_cache, on: [:create, :update]

  private

  def update_profile_cache
    ProfileCache.find_by(user_id: id)&amp;.update(data: profile_data)
  end
end</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>ActiveRecord Callbacks Guide - <a href="https://guides.rubyonrails.org/active_record_callbacks.html">Official Rails guide explaining the different types of callbacks and their proper usage</a></p>
</li>
<li>
<p>ActiveRecord Transactions - <a href="https://api.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html">Documentation on ActiveRecord transactions and how callbacks interact with them</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_standards">Standards</h3>
<div class="ulist">
<ul>
<li>
<p>CWE-362: Concurrent Execution using Shared Resource with Improper Synchronization - <a href="https://cwe.mitre.org/data/definitions/362.html">Database operations in validation callbacks can lead to race conditions and synchronization issues</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>