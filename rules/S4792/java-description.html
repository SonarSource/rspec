<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Configuring loggers is security-sensitive. It has led in the past to the following vulnerabilities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.cve.org/CVERecord?id=CVE-2018-0285">CVE-2018-0285</a></p>
</li>
<li>
<p><a href="https://www.cve.org/CVERecord?id=CVE-2000-1127">CVE-2000-1127</a></p>
</li>
<li>
<p><a href="https://www.cve.org/CVERecord?id=CVE-2017-15113">CVE-2017-15113</a></p>
</li>
<li>
<p><a href="https://www.cve.org/CVERecord?id=CVE-2015-5742">CVE-2015-5742</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Logs are useful before, during and after a security incident.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Attackers will most of the time start their nefarious work by probing the system for vulnerabilities. Monitoring this activity and stopping it is the first step to prevent an attack from ever happening.</p>
</li>
<li>
<p>In case of a successful attack, logs should contain enough information to understand what damage an attacker may have inflicted.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Logs are also a target for attackers because they might contain sensitive information. Configuring loggers has an impact on the type of information logged and how they are logged.</p>
</div>
<div class="paragraph">
<p>This rule flags for review code that initiates loggers configuration. The goal is to guide security code reviews.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ask_yourself_whether">Ask Yourself Whether</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>unauthorized users might have access to the logs, either because they are stored in an insecure location or because the application gives access to them.</p>
</li>
<li>
<p>the logs contain sensitive information on a production server. This can happen when the logger is in debug mode.</p>
</li>
<li>
<p>the log can grow without limit. This can happen when additional information is written into logs every time a user performs an action and the user can perform the action as many times as he/she wants.</p>
</li>
<li>
<p>the logs do not contain enough information to understand the damage an attacker might have inflicted. The loggers mode (info, warn, error) might filter out important information. They might not print contextual information like the precise time of events or the server hostname.</p>
</li>
<li>
<p>the logs are only stored locally instead of being backuped or replicated.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is a risk if you answered yes to any of those questions.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_recommended_secure_coding_practices">Recommended Secure Coding Practices</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Check that your production deployment doesn&#8217;t have its loggers in "debug" mode as it might write sensitive information in logs.</p>
</li>
<li>
<p>Production logs should be stored in a secure location which is only accessible to system administrators.</p>
</li>
<li>
<p>Configure the loggers to display all warnings, info and error messages. Write relevant information such as the precise time of events and the hostname.</p>
</li>
<li>
<p>Choose log format which is easy to parse and process automatically. It is important to process logs rapidly in case of an attack so that the impact is known and limited.</p>
</li>
<li>
<p>Check that the permissions of the log files are correct. If you index the logs in some other service, make sure that the transfer and the service are secure too.</p>
</li>
<li>
<p>Add limits to the size of the logs and make sure that no user can fill the disk with logs. This can happen even when the user does not control the logged information. An attacker could just repeat a logged action many times.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Remember that configuring loggers properly doesn&#8217;t make them bullet-proof. Here is a list of recommendations explaining on how to use your logs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Don&#8217;t log any sensitive information. This obviously includes passwords and credit card numbers but also any personal information such as user names, locations, etc&#8230;&#8203; Usually any information which is protected by law is good candidate for removal.</p>
</li>
<li>
<p>Sanitize all user inputs before writing them in the logs. This includes checking its size, content, encoding, syntax, etc&#8230;&#8203; As for any user input, validate using whitelists whenever possible. Enabling users to write what they want in your logs can have many impacts. It could for example use all your storage space or compromise your log indexing service.</p>
</li>
<li>
<p>Log enough information to monitor suspicious activities and evaluate the impact an attacker might have on your systems. Register events such as failed logins, successful logins, server side input validation failures, access denials and any important transaction.</p>
</li>
<li>
<p>Monitor the logs for any suspicious activity.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sensitive_code_example">Sensitive Code Example</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This rule supports the following libraries: Log4J, <code>java.util.logging</code> and Logback</p>
</div>
<div class="listingblock">
<div class="content">
<pre>// === Log4J 2 ===
import org.apache.logging.log4j.core.config.builder.api.ConfigurationBuilderFactory;
import org.apache.logging.log4j.Level;
import org.apache.logging.log4j.core.*;
import org.apache.logging.log4j.core.config.*;

// Sensitive: creating a new custom configuration
abstract class CustomConfigFactory extends ConfigurationFactory {
    // ...
}

class A {
    void foo(Configuration config, LoggerContext context, java.util.Map&lt;String, Level&gt; levelMap,
            Appender appender, java.io.InputStream stream, java.net.URI uri,
            java.io.File file, java.net.URL url, String source, ClassLoader loader, Level level, Filter filter)
            throws java.io.IOException {
        // Creating a new custom configuration
        ConfigurationBuilderFactory.newConfigurationBuilder();  // Sensitive

        // Setting loggers level can result in writing sensitive information in production
        Configurator.setAllLevels("com.example", Level.DEBUG);  // Sensitive
        Configurator.setLevel("com.example", Level.DEBUG);  // Sensitive
        Configurator.setLevel(levelMap);  // Sensitive
        Configurator.setRootLevel(Level.DEBUG);  // Sensitive

        config.addAppender(appender); // Sensitive: this modifies the configuration

        LoggerConfig loggerConfig = config.getRootLogger();
        loggerConfig.addAppender(appender, level, filter); // Sensitive
        loggerConfig.setLevel(level); // Sensitive

        context.setConfigLocation(uri); // Sensitive

        // Load the configuration from a stream or file
        new ConfigurationSource(stream);  // Sensitive
        new ConfigurationSource(stream, file);  // Sensitive
        new ConfigurationSource(stream, url);  // Sensitive
        ConfigurationSource.fromResource(source, loader);  // Sensitive
        ConfigurationSource.fromUri(uri);  // Sensitive
    }
}</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>// === java.util.logging ===
import java.util.logging.*;

class M {
    void foo(LogManager logManager, Logger logger, java.io.InputStream is, Handler handler)
            throws SecurityException, java.io.IOException {
        logManager.readConfiguration(is); // Sensitive

        logger.setLevel(Level.FINEST); // Sensitive
        logger.addHandler(handler); // Sensitive
    }
}</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>// === Logback ===
import ch.qos.logback.classic.util.ContextInitializer;
import ch.qos.logback.core.Appender;
import ch.qos.logback.classic.joran.JoranConfigurator;
import ch.qos.logback.classic.spi.ILoggingEvent;
import ch.qos.logback.classic.*;

class M {
    void foo(Logger logger, Appender&lt;ILoggingEvent&gt; fileAppender) {
        System.setProperty(ContextInitializer.CONFIG_FILE_PROPERTY, "config.xml"); // Sensitive
        JoranConfigurator configurator = new JoranConfigurator(); // Sensitive

        logger.addAppender(fileAppender); // Sensitive
        logger.setLevel(Level.DEBUG); // Sensitive
    }
}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_exceptions">Exceptions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Log4J 1.x is not covered as it has reached <a href="https://blogs.apache.org/foundation/entry/apache_logging_services_project_announces">end of life</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>OWASP - <a href="https://owasp.org/Top10/A09_2021-Security_Logging_and_Monitoring_Failures/">Top 10 2021 Category A9 - Security Logging and Monitoring Failures</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-top-ten/2017/A3_2017-Sensitive_Data_Exposure">Top 10 2017 Category A3 - Sensitive Data Exposure</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-top-ten/2017/A10_2017-Insufficient_Logging%2526Monitoring">Top 10 2017 Category A10 - Insufficient Logging &amp; Monitoring</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/117">CWE-117 - Improper Output Neutralization for Logs</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/532">CWE-532 - Information Exposure Through Log Files</a></p>
</li>
</ul>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Make sure that this logger&#8217;s configuration is safe.</p>
</div>
</div>
<div class="sect2">
<h3 id="_highlighting">Highlighting</h3>
<div class="paragraph">
<p>Call to logger configuration function.</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_on_12_sep_2018_181549_nicolas_harraudeau_wrote">on 12 Sep 2018, 18:15:49 Nicolas Harraudeau wrote:</h3>
<div class="paragraph">
<p>Note: For now we will not add support for configuration files.</p>
</div>
<div class="paragraph">
<p>However for the future this rule or another should also raise an issue on the first line of any file named <code>log4j2.xml</code>, <code>log4j2-test.xml</code>, <code>logback.xml</code>, <code>logback-test.xml</code>.</p>
</div>
<div class="paragraph">
<p><strong>Later</strong> it would be great if it also raised an issue on the first line of files named</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>log4j2.json</code>, <code>log4j2.jsn</code>, <code>log4j2.yaml</code>, <code>log4j2.yml</code>, <code>log4j2.properties</code>, <code>log4j2-test.json</code>, <code>log4j2-test.jsn</code>, <code>log4j2-test.yaml</code>, <code>log4j2-test.yml</code>, <code>log4j2-test.properties</code>. See <a href="https://logging.apache.org/log4j/2.x/manual/configuration.html">Log4J 2 documentation </a>.</p>
</li>
<li>
<p><code>logback.groovy</code> See <a href="https://logback.qos.ch/manual/configuration.html">Logback documentation</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_on_24_oct_2018_114129_nicolas_harraudeau_wrote">on 24 Oct 2018, 11:41:29 Nicolas Harraudeau wrote:</h3>
<div class="paragraph">
<p>To investigate:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.util.logging.LoggingMXBean#setLoggerLevel(String loggerName, String levelName)</code> could also be considered to raise an issue</p>
</li>
<li>
<p>We could also raise issues for the logback library on classes extending <code>ch.qos.logback.classic.spi.Configurator</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_is_related_to_s2773">is related to: <a data-rspec-id="S2773" class="rspec-auto-link">S2773</a></h3>

</div>
</div>
</div>