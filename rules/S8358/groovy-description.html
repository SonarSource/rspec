<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This rule raises an issue when a method annotated with <code>@NonCPS</code> contains calls to Pipeline steps such as <code>node</code>, <code>sh</code>, <code>echo</code>, <code>readFile</code>, <code>httpRequest</code>, or other CPS-transformed code.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Jenkins Pipeline uses a Continuation-Passing Style (CPS) transformation system to enable state persistence and restart capabilities. This system transforms most Pipeline code to handle interruptions and resumptions gracefully.</p>
</div>
<div class="paragraph">
<p>Methods annotated with <code>@NonCPS</code> are compiled normally without CPS transformation, behaving like binary methods from the Java Platform or Jenkins core. This provides performance benefits and allows the use of more Groovy language features.</p>
</div>
<div class="paragraph">
<p>However, when <code>@NonCPS</code> methods call Pipeline steps (which are CPS-transformed), the CPS interpreter cannot operate correctly. This creates a fundamental incompatibility between non-CPS-transformed code calling CPS-transformed code.</p>
</div>
<div class="paragraph">
<p>The result is anomalous behavior where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The Pipeline step&#8217;s return value becomes the method&#8217;s return value</p>
</li>
<li>
<p>Normal execution flow is interrupted</p>
</li>
<li>
<p>The rest of the method code after the Pipeline step call is not executed</p>
</li>
<li>
<p>Confusing error messages may appear in logs</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This behavior occurs because <code>CpsCallableInvocation</code> exceptions are thrown from Pipeline steps and interrupt the method&#8217;s execution, leading to incorrect and often confusing results.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>This anti-pattern can cause several serious issues:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Unexpected execution flow</strong>: Methods may return prematurely with unexpected values, causing logic errors in the Pipeline</p>
</li>
<li>
<p><strong>Silent failures</strong>: Code after Pipeline step calls in <code>@NonCPS</code> methods will not execute, potentially skipping critical operations</p>
</li>
<li>
<p><strong>Difficult debugging</strong>: The anomalous behavior can be confusing to diagnose, leading to wasted development time</p>
</li>
<li>
<p><strong>Pipeline instability</strong>: The CPS interpreter&#8217;s inability to handle these calls correctly can lead to unpredictable Pipeline behavior</p>
</li>
<li>
<p><strong>Maintenance problems</strong>: Future modifications to the code may not work as expected due to the underlying execution flow issues</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Remove the @NonCPS annotation to allow the method to be CPS-transformed and safely call Pipeline steps.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@NonCPS
def compileOnPlatforms() {
  ['linux', 'windows'].each { arch -&gt;
    node(arch) { // Noncompliant
      sh 'make'
    }
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def compileOnPlatforms() {
  ['linux', 'windows'].each { arch -&gt;
    node(arch) {
      sh 'make'
    }
  }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>Jenkins Pipeline CPS Method Mismatches - <a href="https://www.jenkins.io/doc/book/pipeline/cps-method-mismatches/">Official Jenkins documentation explaining CPS method mismatches and their solutions</a></p>
</li>
<li>
<p>Pipeline: Groovy Plugin Documentation - <a href="https://plugins.jenkins.io/workflow-cps/">Technical documentation for the Pipeline Groovy plugin explaining CPS transformation</a></p>
</li>
<li>
<p>Scaling Pipelines - @NonCPS Best Practices - <a href="https://www.jenkins.io/doc/book/pipeline/scaling-pipeline/">Jenkins documentation on scaling pipelines with proper @NonCPS usage</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>