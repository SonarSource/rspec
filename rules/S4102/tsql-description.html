<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When you add a new constraint to a table, (<code>ALTER TABLE ... ADD CONSTRAINT ...</code>), <code>WITH CHECK</code> is assumed by default, and existing data are automatically validated.</p>
</div>
<div class="paragraph">
<p>But when you disable/enable an existing constraint, <code>WITH NOCHECK</code> is assumed by default, and existing data are no longer trusted. In this case you will face an integrity issue that prevents some rows from being updated, and a performance issue because the query optimizer cannot trust this constraint anymore.</p>
</div>
<div class="paragraph">
<p>Of course, <code>WITH CHECK</code> is obviously preferred, but if <code>NOCHECK</code> behavior is desired, it should not be selected by omission, but specified explicitly because <code>WITH NOCHECK</code> has such a significant impact. By making <code>NOCHECK</code> explicit, the developer documents that this behavior has been selected on purpose.</p>
</div>
<div class="paragraph">
<p>Note: You can list the existing constraints that are in an untrusted state using:</p>
</div>
<div class="paragraph">
<p><code>SELECT * FROM sys.foreign_keys WHERE is_not_trusted = 1;</code></p>
</div>
<div class="paragraph">
<p><code>SELECT * FROM sys.check_constraints WHERE is_not_trusted = 1;</code></p>
</div>
<div class="sect2">
<h3 id="_noncompliant_code_example">Noncompliant code example</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">-- Create a trusted constraint
ALTER TABLE users ADD CONSTRAINT max_age CHECK (age &lt; 200) ;

-- Disable the constraint
ALTER TABLE users NOCHECK CONSTRAINT max_age;

-- Enable the constraint
ALTER TABLE users CHECK CONSTRAINT max_age; -- Noncompliant, 'WITH NOCHECK' is the default mode, but is it really intentional?</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_compliant_solution">Compliant solution</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">-- Create a trusted constraint
ALTER TABLE users ADD CONSTRAINT max_age CHECK (age &lt; 200) ;

-- Disable the constraint
ALTER TABLE users NOCHECK CONSTRAINT max_age;

-- Enable the constraint
ALTER TABLE users WITH CHECK CHECK CONSTRAINT max_age;
-- OR
ALTER TABLE users WITH NOCHECK CHECK CONSTRAINT max_age;</code></pre>
</div>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Specify explicitly "WITH CHECK" or "WITH NOCHECK".</p>
</div>
</div>
<div class="sect2">
<h3 id="_highlighting">Highlighting</h3>
<div class="paragraph">
<p>CHECK CONSTRAINT keyword of the ALTER TABLE &#8230;&#8203; CHECK CONSTRAINT &#8230;&#8203;</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_on_21_jul_2017_071742_alban_auzeill_wrote">on 21 Jul 2017, 07:17:42 Alban Auzeill wrote:</h3>
<div class="paragraph">
<p>Note, in existing code we mainly found issues on the following (redundant) pattern generated by SQL Management Studio:</p>
</div>
<div class="paragraph">
<p>ALTER TABLE &#8230;&#8203; ADD  CONSTRAINT &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>ALTER TABLE &#8230;&#8203; CHECK CONSTRAINT &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>I found a discussion related to it here:</p>
</div>
<div class="paragraph">
<p><a href="https://stackoverflow.com/questions/529941/with-check-add-constraint-followed-by-check-constraint-vs-add-constraint" class="bare">https://stackoverflow.com/questions/529941/with-check-add-constraint-followed-by-check-constraint-vs-add-constraint</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_on_21_jul_2017_140417_ann_campbell_wrote">on 21 Jul 2017, 14:04:17 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>So perhaps this should be removed from the default profile [~alban.auzeill]?</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_24_jul_2017_165119_ann_campbell_wrote">on 24 Jul 2017, 16:51:19 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>I&#8217;ve made a couple edits [~alban.auzeill]. Double-check me, please.</p>
</div>
</div>
</div>
</div>