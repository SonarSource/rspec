Creating a Variable Length Array (VLA) with a size that is not greater than zero leads to undefined behavior.

== Why is this an issue?

Variable length arrays are used to allocate a stack size for the number of elements that are known at the runtime,
for example: 

[source,c]
----
void merge(int* tab, int size, int first) {
  int res[size]; // allocate buffer for merging on stack
  // merge the ranges [tab, tab + first) and [tab + first, tab + last) into res
  memcpy(tab, res, size * sizeof(int));
}
----

The syntax follows the one used by an array with static size (where size is constant),
and the value placed in the square brackets (`[size]` in the above example) determines the size of the array.
For both static and runtime-sized arrays, the size is required to be greater than zero,
however, in the case of VLAs, this cannot be verified at compile-time, 
and any program that creates such an array with a size that has a value of zero or is negative, 
has undefined behavior.

[source,c]
----
void example() {
  int s = -1;
  int vla[s]; // program compiles, and have undefined behavior
  int arr[-1]; // program is ill-formed
}
----

This defect may also manifest when a variable used as size is not initialized and its value is not deterministic.
This may result in a negative or zero value being read from it in case of some program runs.
 
[source,c]
----
void uninitialized() {
  int s;      // uninitialized, the value is not determined
  int vla[s]; // program compiles, have undefined behavior if the value read from s is negative or zero
}
----


A non-positive size of the VLAs may also result from using a value loaded by the program from a file or other external resources used as size without previous validation.
Such values as usually referred to as being _tainted_.

[source,c]
----
void loadFromInput() {
  int size;
  scanf("%d", &size); // loads size from input
  char bytes[size]; // size may be negative
  /* ... */  
}
----

The above code will lead to undefined behavior when the value of the `size` load from the input is not greater than zero.
This may happen due to source data corruption, accidental user mistake, or malicious action. 

=== What is the potential impact?

Creating a variable length array with a size smaller or equal to zero causes undefined behavior.
This means the compiler is not bound by the language standard anymore, and your program has no meaning assigned to it.

Practically this can lead to a wide range of effects and may lead to the following:

* crashes, in particular segmentation faults, when the program access memory that it is not allowed to,
* memory corruption and data losses, when the program overwrites bytes responsible for storing data or executable code,
* stack overflow, when negative size is interpreted as a large positive number.

Furthermore, in a situation when VLA size is dependent on the user input, it can lead to vulnerabilities in the program. 

== How to fix it

Ensure that the size of the variable length array is always greater than zero.
In case of value that depends on user input (is _tainted_), include appropriate checks to ensure that value is positive
before using it as size for VLA.

=== Code examples

==== Noncompliant code example

[source,cpp]
----
void directly() {
}

void f1() {
  int n;
  int a[n]; // Noncompliant; n is undefined
}

----

=== Pitfalls

// Review question: mentions that large VLA may lead to stack overflow, and there is no way for a program to reject
// allocation. In this case, using a heap may be better. However, this is not related to a problem in the rule.
// and does not avoid it.

== Resources

=== Documentation

* C++ reference - https://en.cppreference.com/w/c/language/array#Variable-length_arrays[Variable length arrays]

=== Standards

* CERT - https://wiki.sei.cmu.edu/confluence/display/c/ARR32-C.+Ensure+size+arguments+for+variable+length+arrays+are+in+a+valid+range[ARR32-C. Ensure size arguments for variable length arrays are in a valid range]

ifdef::env-github,rspecator-view[]

'''
== Implementation Specification
(visible only on this page)

=== Message

zero size

negative size

garbage as size


'''
== Comments And Links
(visible only on this page)

=== on 11 Mar 2019, 18:37:42 Ann Campbell wrote:
Is "strictly positive" a https://www.merriam-webster.com/dictionary/term%20of%20art[term of art]? If not, I suggest a re-word

endif::env-github,rspecator-view[]
