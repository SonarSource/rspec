:rule_platform: Flutter
include::../summary.adoc[]

include::../ask-yourself.adoc[]

:platform-explanation: For `webview_flutter`, this is done by providing a `NavigationDelegate` to the `WebViewController`. The `onNavigationRequest` callback in this delegate is called for every navigation attempt (e.g., when a user clicks a link or JavaScript tries to change the location). This callback allows the application to inspect the target URL and decide whether to allow the navigation by returning `NavigationDecision.navigate` or block it by returning `NavigationDecision.prevent`. + \
 + \
For `flutter_inappwebview`, the `shouldOverrideUrlLoading` callback on the `InAppWebView` widget serves a similar purpose. For this callback to be invoked, the `useShouldOverrideUrlLoading` option in `InAppWebViewSettings` must be set to `true`. When a navigation is attempted, this callback receives details about the navigation action. The application can then return `NavigationActionPolicy.ALLOW` to permit the navigation or `NavigationActionPolicy.CANCEL` to block it.
include::../recommended-practices.adoc[]

== Sensitive Code Example

The default configurations for both `webview_flutter` and `flutter_inappwebview` allow arbitrary navigation.

In `webview_flutter`, setting no `NavigationDelegate` or using the default one will allow the user to navigate to any URL.

[source,dart,diff-id=1,diff-type=noncompliant]
----
import 'package:webview_flutter/webview_flutter.dart';

final WebViewController controller = WebViewController()  // Sensitive - all navigation is permitted by default
  ..setJavaScriptMode(JavaScriptMode.unrestricted)
  ..loadRequest(Uri.parse('https://example.com/'));
----

In `flutter_inappwebview`, all navigation is permitted when `useShouldOverrideUrlLoading` is set to `false` or when no `shouldOverrideUrlLoading` callback is provided:

[source,dart,diff-id=2,diff-type=noncompliant]
----
import 'package:flutter_inappwebview/flutter_inappwebview.dart';

InAppWebView(
  initialUrlRequest: URLRequest(url: WebUri('https://example.com/')),
  initialSettings: InAppWebViewSettings(  // Sensitive - all navigation is permitted by default
    javaScriptEnabled: true,
  ),
);
----

== Compliant Solution

In `webview_flutter`:

[source,dart,diff-id=1,diff-type=compliant]
----
import 'package:webview_flutter/webview_flutter.dart';

final WebViewController controller = WebViewController()
  ..setJavaScriptMode(JavaScriptMode.unrestricted)
  ..setNavigationDelegate(
    NavigationDelegate(
      onNavigationRequest: (NavigationRequest request) {
        final Uri uri = Uri.parse(request.url);
        if (uri.host == 'example.com') {
          return NavigationDecision.navigate;
        }

        return NavigationDecision.prevent;
      },
    ),
  )
  ..loadRequest(Uri.parse('https://example.com/'));
----

In `flutter_inappwebview`:

[source,dart,diff-id=2,diff-type=compliant]
----
import 'package:flutter_inappwebview/flutter_inappwebview.dart';

InAppWebView(
  initialUrlRequest: URLRequest(url: WebUri('https://example.com/')),
  initialSettings: InAppWebViewSettings(
    javaScriptEnabled: true,
    useShouldOverrideUrlLoading: true,
  ),
  shouldOverrideUrlLoading: (controller, navigationAction) async {
    final uri = navigationAction.request.url;
    if (uri != null && uri.host == 'example.com') {
      return NavigationActionPolicy.ALLOW;
    }

    return NavigationActionPolicy.CANCEL;
  },
);
----

include::../see.adoc[]

* `pub.dev` - https://pub.dev/documentation/webview_flutter_android/latest/webview_flutter_android/NavigationDelegate-class.html[`NavigationDelegate` API documentation]
* `inappwebview.dev` - https://inappwebview.dev/docs/main/webview/settings/[`InAppWebViewSettings` API documentation]

== Related rules

* S6362 - Enabling JavaScript support for WebViews is security-sensitive