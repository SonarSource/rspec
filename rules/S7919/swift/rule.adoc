== Description

A web server uses a protocol like Transport Layer Security (TLS) to create a secure, encrypted connection with a user's browser. This process relies on a long-term secret key, stored on the server, to help establish a secure session for communication.

An issue can arise if an attacker records the encrypted traffic between a user and the server, and later steals the server's long-term key. With that key, the attacker could decrypt all the previously recorded conversations.

A feature called forward secrecy (or perfect forward secrecy) prevents this situation. It ensures that a new, temporary key is created for every user session. Because these session keys are temporary and not linked to the server's long-term key, stealing the long-term key does not help an attacker decrypt past sessions.

== Why is this an issue?

When forward secrecy is not in place, encrypted data from past sessions is at risk. If an attacker obtains the server's long-term private key, they can decrypt all previously recorded traffic that was encrypted with that key. This can lead to the exposure of sensitive information.

=== Exposure of Sensitive Information

An attacker could gain access to sensitive information exchanged in past sessions. This might include usernames, passwords, credit card numbers, or private messages. Once decrypted, this information could be used for identity theft, financial fraud, or other malicious activities.

=== Retroactive Data Breaches

The risk is not limited to future communications. An attacker can store large amounts of encrypted data and wait for an opportunity to obtain the server's key. Once the key is compromised, all past communications that were recorded can be decrypted. This means a security breach today could reveal data from months or even years ago.

== How to fix it in Security Framework

To ensure forward secrecy, you should correctly configure your app's App Transport Security (ATS) settings. ATS is a feature that improves user security and privacy by requiring iOS and macOS to use secure network connections over HTTPS. Forward secrecy is a default requirement of ATS.

The issue arises when an exception is created for a specific domain that weakens this protection. You can resolve this by removing the insecure exception from the `Info.plist` file.

=== Noncompliant code example

The following entry in the `Info.plist` file creates an exception for `example.com` and disables the forward secrecy requirement. This allows the app to communicate with the server using cipher suites that do not support forward secrecy.

[source,xml,diff-id=1,diff-type=noncompliant]
----
<key>NSAppTransportSecurity</key>
<dict>
    <key>NSExceptionDomains</key>
    <dict>
        <key>example.com</key>
        <dict>
            <key>NSIncludesSubdomains</key>
            <true/>
            <key>NSExceptionRequiresForwardSecrecy</key>
            <false/><!-- Noncompliant -->
        </dict>
    </dict>
</dict>
----

=== Compliant solution

To fix this, set the`NSExceptionRequiresForwardSecrecy` key to `true` or remove it from the domain's exception dictionary in your `Info.plist` file. Doing either will restore the default setting, which requires forward secrecy for that domain's connections.

[source,xml,diff-id=1,diff-type=compliant]
----
<key>NSAppTransportSecurity</key>
<dict>
    <key>NSExceptionDomains</key>
    <dict>
        <key>example.com</key>
        <dict>
            <key>NSIncludesSubdomains</key>
            <true/>
            <key>NSExceptionRequiresForwardSecrecy</key>
            <true/>
        </dict>
    </dict>
</dict>
----

== Resources
=== Documentation

* Apple Developer Documentation - https://developer.apple.com/documentation/security/preventing-insecure-network-connections#Ensure-the-Network-Server-Meets-Minimum-Requirements[Preventing Insecure Network Connections]

=== Standards

* CWE - https://cwe.mitre.org/data/definitions/327.html[CWE-327: Use of a Broken or Risky Cryptographic Algorithm]
* OWASP - https://owasp.org/Top10/A02_2021-Cryptographic_Failures/[Top 10 2021 Category A2 - Cryptographic Failures]
* OWASP - https://owasp.org/www-project-top-ten/2017/A3_2017-Sensitive_Data_Exposure[Top 10 2017 Category A3 - Sensitive Data Exposure]
* OWASP - https://owasp.org/www-project-top-ten/2017/A6_2017-Security_Misconfiguration[Top 10 2017 Category A6 - Security Misconfiguration]
* OWASP - https://owasp.org/www-project-mobile-top-10/2016-risks/m3-insecure-communication[Mobile Top 10 2016 Category M3 - Insecure Communication]
* OWASP - https://owasp.org/www-project-mobile-top-10/2023-risks/m5-insecure-communication[Mobile Top 10 2024 Category M5 - Insecure Communication]

