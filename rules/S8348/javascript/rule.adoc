Injections into Cross-Origin Resource Sharing (CORS) policies occur when the
application retrieves data like parameters or headers from an incoming HTTP
request and inserts it into its HTTP response without first sanitizing it.

== Why is this an issue?

Thanks to the Same-origin policy (SOP), browsers inherently trusts and performs
requests from an origin to itself. An origin is a service coming from a tuple
(domain, scheme, port).

Cross-Origin Resource Sharing (CORS) is a mechanism that allows a server to
establish trust to third-party "origins" (any tuple value difference), via the
`Access-Control-Allow-Origin` header. This trust can be tweaked with various
additional headers, such as the following:

* Access-Control-Allow-Methods
* Access-Control-Allow-Headers
* Access-Control-Allow-Credentials
* Access-Control-Max-Age

Enabling the possibility of injecting any value into the `Allow-Origin` or
`Allow-Credentials` headers is a breach of trust of your application, and
exposes it to a variety of different attacks, such as XSS or TLS hijacking.

== How to fix it

Generally, refrain from using any third-party data to set CORS trust boundary:

=== Code examples

==== Noncompliant code example

[source,javascript,diff-id=1,diff-type=noncompliant]
----
const express = require('express');
const app = express();

app.use((req, res, next) => {
  const origin = req.headers.origin;
  
  if (origin) {
    res.setHeader('Access-Control-Allow-Origin', origin); // Noncompliant
  }
  
  next();
});
----

==== Compliant solution

[source,javascript,diff-id=1,diff-type=compliant]
----
const express = require('express');
const app = express();

const ACAO = "https://example.com https://another.example.com";

app.use((req, res, next) => {
  res.setHeader('Access-Control-Allow-Origin', ACAO);
  
  next();
});
----

== Resources

=== Standards

* OWASP - https://owasp.org/Top10/A05_2021-Security_Misconfiguration/[Top 10 2021 Category A5 - Security Misconfiguration]
* OWASP - https://owasp.org/Top10/A07_2021-Identification_and_Authentication_Failures/[Top 10 2021 Category A7 - Identification and Authentication Failures]
* OWASP - https://owasp.org/www-project-top-ten/2017/A6_2017-Security_Misconfiguration[Top 10 2017 Category A6 - Security Misconfiguration]
* Mozilla - https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS[Cross-Origin Resource Sharing]
* Mozilla - https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy[Same-Origin Policy]
* CWE - https://cwe.mitre.org/data/definitions/346[CWE-346 - Origin Validation Error]
* CWE - https://cwe.mitre.org/data/definitions/942[CWE-942 - Overly Permissive Cross-domain Whitelist]

