CORS injection occurs when an application unsafely retrieves data—such as HTTP
headers or parameters—from an incoming request and reflects it into the
Cross-Origin Resource Sharing (CORS) headers of the response without
sanitization.

== Why is this an issue?

Browsers enforce the Same-Origin Policy (SOP), which restricts how a document or
script loaded from one origin can interact with resources from another. An
"origin" is defined by a specific tuple: (scheme, domain, port).

Cross-Origin Resource Sharing (CORS) is a mechanism that relaxes the SOP. It
allows a server to explicitly establish trust with third-party origins via the
Access-Control-Allow-Origin header. This trust is often configured alongside
other headers, such as:

* Access-Control-Allow-Methods
* Access-Control-Allow-Headers
* Access-Control-Allow-Credentials
* Access-Control-Max-Age


Enabling the possibility of injecting any value into the `Allow-Origin` is
a breach of trust of your application, and exposes it to a variety of different
attacks, such as XSS or TLS hijacking. +
The situation is worsened if the `Allow-Credentials` is set to `true` or
injectable.

If an attacker can inject arbitrary values into the Access-Control-Allow-Origin
header—particularly when paired with Access-Control-Allow-Credentials: true—they
can bypass the application's trust model.

== How to fix it

Generally, never use third party data to set up CORS boundaries. Instead, create
a strict allow-list of origins.

=== Code examples

==== Noncompliant code example

[source,javascript,diff-id=1,diff-type=noncompliant]
----
const express = require('express');
const app = express();

app.use((req, res, next) => {
  const origin = req.headers.origin;
  
  if (origin) {
    res.setHeader('Access-Control-Allow-Origin', origin); // Noncompliant
  }
  
  next();
});
----

==== Compliant solution

[source,javascript,diff-id=1,diff-type=compliant]
----
const express = require('express');
const app = express();

const ACAO = "https://example.com https://another.example.com";

app.use((req, res, next) => {
  res.setHeader('Access-Control-Allow-Origin', ACAO);
  
  next();
});
----

== Resources

=== Standards

* OWASP - https://owasp.org/Top10/A05_2021-Security_Misconfiguration/[Top 10 2021 Category A5 - Security Misconfiguration]
* OWASP - https://owasp.org/Top10/A07_2021-Identification_and_Authentication_Failures/[Top 10 2021 Category A7 - Identification and Authentication Failures]
* OWASP - https://owasp.org/www-project-top-ten/2017/A6_2017-Security_Misconfiguration[Top 10 2017 Category A6 - Security Misconfiguration]
* Mozilla - https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS[Cross-Origin Resource Sharing]
* Mozilla - https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy[Same-Origin Policy]
* CWE - https://cwe.mitre.org/data/definitions/346[CWE-346 - Origin Validation Error]
* CWE - https://cwe.mitre.org/data/definitions/942[CWE-942 - Overly Permissive Cross-domain Whitelist]

