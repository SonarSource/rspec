<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This rule raises an issue when an iteration with a condition is used instead of <code>np.where</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Computation over NumPy arrays can be executed more efficiently than computation over Pythonâ€™s built-in sequences.
This is due to the nature of the NumPy arrays (fixed size and homogeneous) as well as operations on these arrays which can be done with compiled code.</p>
</div>
<div class="paragraph">
<p>When executing an operation on each element of an array depending on a condition,
it is preferable to use the NumPy <code>np.where</code> function instead.
<code>np.where</code> provides better performance by benefiting from NumPy broadcasting operations.</p>
</div>
<div class="paragraph">
<p>Broadcasting is the term used to describe how NumPy treats arrays of different shape during arithmetic operations.
When applying an operation on two arrays of the same shape NumPy will work on each element of the arrays one by one.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">import numpy as np
a = np.array([1, 2, 3])

b = np.array([2, 3, 4])
a + b # result: [3, 5, 7]</code></pre>
</div>
</div>
<div class="paragraph">
<p>A good way to think of what happens in the example above is that, first, a list of tuples is created for each pair of elements from each array,
i.e. <code>[(1,2),(2,3),(3,4)]</code> then for each of these pair the <code>+</code> operation is applied.</p>
</div>
<div class="paragraph">
<p>Here is a similar example, except the operation is performed on arrays of different shapes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">import numpy as np

a = np.array([1, 2, 3])
b = np.array(5)
a + b # result: [6, 7, 8]</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a concrete example of broadcasting where the variable <code>b</code> is broadcasted to the size of the array <code>a</code>.
If we use the same intermediate representation as before it would look like this: <code>[(1,5),(2,5),(3,5)]</code>.
NumPy "stretched" the variable <code>b</code> from a single value <code>5</code> to an array of 3 elements, resulting in the following array <code>[5, 5, 5]</code>.
The arithmetic operation can then be applied on two arrays of the same size.
When a value is broadcasted, it allows NumPy to run array operations in C instead of Python,
thus allowing for better performance.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To fix this issue replace the iteration and condition with the <code>np.where</code> function.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">import numpy as np

def divide_by_two(arr: np.ndarray):
  for i in range(len(arr)):
    if (arr[i] % 2) == 0:
        arr[i] = arr[i] / 2 # Noncompliant: this computation can be done more efficiently with the np.where function
    else:
        arr[i] = 0

  return arr</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">import numpy as np

def divide_by_two(arr: np.ndarray):
   return (np.where((arr % 2 == 0), arr / 2, 0)) # Compliant</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>NumPy Documentation - <a href="https://numpy.org/doc/stable/reference/generated/numpy.where.html#numpy-where">numpy.where</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_articles_blog_posts">Articles &amp; blog posts</h3>
<div class="ulist">
<ul>
<li>
<p>POP Article - <a href="https://co-design.pop-coe.eu/best-practices/numba-numpy-python-serial-efficiency.html">numba-numpy-python-serial-efficiency</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>