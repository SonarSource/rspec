## Detection Logic
ec2 is used for aws_cdk.aws_ec2

### For level 2 construct

*Notes*

The `Connections` type is the one on which the checks are relevant.

A lot of Construct types have a `connections` attribute of type `Connections`. We
want to detect things there too.

#### Definitions

```
AdmPortNo: 22 OR 3389
BadProto: ec2.Protocol.ALL OR ec2.Protocol.TCP
Bad Port:
    ec2.Port.all_tcp()
    ec2.Port.all_traffic()
    ec2.Port.tcp($AdmPortNo)
    ec2.Port.tcp_range(start_port=X, end_port=Y)
        AND $X <= $AdmPortNo <= $Y
    ec2.Port(protocol=$BadProto, from_port=X, to_port=Y)
        AND $X <= $AdmPortNo <= $Y
```

```
BadPeer:
    ec2.Peer.any_ipv4()
    ec2.Peer.any_ipv6()
    ec2.Peer.ipv4("0.0.0.0/0")
    ec2.Peer.ipv6("::/0")
```

```
ConstructWithCo:
aws_cdk.aws_docdb.DatabaseCluster
aws_cdk.aws_lambda_python_alpha.PythonFunction
aws_cdk.aws_batch_alpha.ComputeEnvironment
aws_cdk.aws_efs.FileSystem
aws_cdk.aws_lambda_go_alpha.GoFunction
aws_cdk.aws_ecs.ExternalService
aws_cdk.aws_ecs.FargateService
aws_cdk.aws_ecs.Cluster
aws_cdk.aws_ecs.Ec2Service
aws_cdk.aws_elasticsearch.Domain
aws_cdk.aws_neptune_alpha.DatabaseCluster
aws_cdk.aws_eks.FargateCluster
aws_cdk.aws_eks.Cluster
aws_cdk.aws_codebuild.PipelineProject
aws_cdk.aws_codebuild.Project
aws_cdk.aws_rds.DatabaseInstance
aws_cdk.aws_rds.DatabaseInstanceReadReplica
aws_cdk.aws_rds.DatabaseCluster
aws_cdk.aws_rds.ServerlessClusterFromSnapshot
aws_cdk.aws_rds.DatabaseProxy
aws_cdk.aws_rds.DatabaseInstanceFromSnapshot
aws_cdk.aws_rds.ServerlessCluster
aws_cdk.aws_rds.DatabaseClusterFromSnapshot
aws_cdk.aws_lambda_nodejs.NodejsFunction
aws_cdk.aws_fsx.LustreFileSystem
aws_cdk.aws_ec2.BastionHostLinux
aws_cdk.aws_ec2.ClientVpnEndpoint
aws_cdk.aws_ec2.Instance
aws_cdk.aws_ec2.LaunchTemplate
aws_cdk.aws_ec2.SecurityGroup
aws_cdk.aws_kinesisfirehose_alpha.DeliveryStream
aws_cdk.aws_stepfunctions_tasks.SageMakerCreateTrainingJob
aws_cdk.aws_stepfunctions_tasks.SageMakerCreateModel
aws_cdk.aws_stepfunctions_tasks.EcsRunTask
aws_cdk.aws_redshift_alpha.Cluster
aws_cdk.aws_opensearchservice.Domain
aws_cdk.aws_secretsmanager.HostedRotation
aws_cdk.aws_msk_alpha.Cluster
aws_cdk.triggers.TriggerFunction
aws_cdk.aws_autoscaling.AutoScalingGroup
aws_cdk.aws_synthetics_alpha.Canary
aws_cdk.aws_cloudfront.experimental.EdgeFunction
aws_cdk.aws_lambda.Function
aws_cdk.aws_lambda.DockerImageFunction
aws_cdk.aws_lambda.SingletonFunction
aws_cdk.aws_lambda.Alias
aws_cdk.aws_lambda.Version
```

#### Detection

For $ConstructWithCo types:

* `allow_from` method is called on the `connections` property of a
    $ConstructWithCo instance with `other` parameter set to
    $BadPeer and `port` parameter set to $BadPort
* `allow_from_any_ipv4` method is called on the `connections` 
    property of a $ConstructWithCo instance with `port` parameter set to $BadPort

For `ec2.Connections` type:

* `allow_from` method is called on a `Connections` instance with
    `other` parameter set to $BadPeer and `port` parameter set to
    $BadPort
* `allow_from_any_ipv4` method is called on a `Connections`
    instance with `port` parameter set to $BadPort
* `allow_default_port_from` method is called on a `Connections`
    instance with `other` parameter set to $BadPeer and the
    `default_port` property of the `Connections` instance is
    known to be $BadPort
* `allow_default_port_from_any_ipv4` method is called on a
    `Connections` instance and the
    `default_port` property of the `Connections` instance is
    known to be $BadPort


For `ec2.SecurityGroup`:

* `add_ingress_rule` method is called on a `SecurityGroup`
    instance with `peer` set to $BadPeer and `connection`
    argument set to $BadPort

## For level 1 construct

*Notes*
ec2.CfnSecurityGroup.security_group_ingress is a Sequence representing the ingress
rules to apply to this security group. It accepts IngressProperty instance and
dict as entries. The dicts and IngressProperty instances have the same properties,
modulo the writing style (camel vs snake) we try to match both.

The protocol used as parameter of the filtering rules can be written as text or with
its protocol number. It is always a string anyway.

There are two ways to add rules to a Security Group, either provide them when
constructing the CfnSecurityGroup object or creating a CfnSecurityGroupIngress that
references an existing CfnSecurityGroup.

In this specification, only the relevant parameters are listed. Additional parameters
in the analyzed code should be considered irrelevant.


### Definitions

```
BadProto: "tcp", "6"
AdmPortNo: 22 OR 3389
```

```
UnsafeConnection:
ec2.CfnSecurityGroup.IngressProperty(ip_protocol="-1", cidr_ip="0.0.0.0/0")
ec2.CfnSecurityGroup.IngressProperty(ip_protocol="-1", cidr_ipv6="::/0")
ec2.CfnSecurityGroup.IngressProperty(ip_protocol=$BadProto, cidr_ip="0.0.0.0/0", from_port=X, to_port=Y)
    AND X <= $AdmPortNo <= Y
ec2.CfnSecurityGroup.IngressProperty(ip_protocol=$BadProto, cidr_ipv6="::/0", from_port=X, to_port=Y)
    AND X <= $AdmPortNo <= Y
{"ipProtocol":"-1", "cidrIp":"0.0.0.0/0"}
{"ipProtocol":"-1", "cidrIpv6":"::/0"}
{"ipProtocol":$BadProto, "cidrIp":"0.0.0.0/0", "fromPort":X, "toPort":Y}
    AND X <= $AdmPortNo <= Y
{"ipProtocol":$BadProto, "cidrIpv6":"::/0", "fromPort":X, "toPort":Y}
    AND X <= $AdmPortNo <= Y
```
### Detection

For ec2.CfnSecurityGroup:

* `ec2.CfnSecurityGroup` constructor is called with the
    `vpc_id` attribute set and not `None`, and the
    `security_group_ingress` attritutes is a `Sequence` that
    contains a $UnsafeConnection

For ec2.CfnSecurityGroupIngress:

* `ec2.CfnSecurityGroup` constructor is called with `ip_protocol` attribute set to $BadProto, `cidr_ip`
    set to "0.0.0.0/0", `from_port` set to X and `to_port` set to Y with X <= $AdmPortNo <= Y
* `ec2.CfnSecurityGroup` constructor is called with `ip_protocol` attribute set to $BadProto, `cidr_ipv6`
    set to "::/0", `from_port` set to X and `to_port` set to Y with X <= $AdmPortNo <= Y
* `ec2.CfnSecurityGroup` constructor is called with `ip_protocol` attribute set to "-1" and `cidr_ip`
    set to "0.0.0.0/0"
* `ec2.CfnSecurityGroup` constructor is called with `ip_protocol` attribute set to "-1" and `cidr_ipv6`
    set to "::/0"