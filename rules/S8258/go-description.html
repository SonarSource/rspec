<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is an issue when code checks a condition before calling <code>sync.Once.Do()</code> to avoid the overhead of synchronization.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Double-checked locking attempts to optimize performance by checking a condition before acquiring synchronization. However, this pattern creates data races in Go.</p>
</div>
<div class="paragraph">
<p>The problem occurs because the preliminary check is not synchronized. Even if one goroutine observes that a flag is set (like <code>done = true</code>), there&#8217;s no guarantee it will observe other memory writes that happened before that flag was set. This violates Go&#8217;s memory model.</p>
</div>
<div class="paragraph">
<p>In the context of <code>sync.Once</code>, this pattern is particularly problematic because:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The preliminary check can observe stale values</p>
</li>
<li>
<p>There&#8217;s no happens-before relationship between the flag check and other memory operations</p>
</li>
<li>
<p>The code may read uninitialized or partially initialized data</p>
</li>
<li>
<p><code>sync.Once</code> already provides the optimization internally with proper synchronization</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Go&#8217;s memory model requires explicit synchronization to establish happens-before relationships between memory operations in different goroutines.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>This can lead to data races where goroutines read uninitialized or inconsistent data. In the worst case, this can cause:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Reading of zero values or garbage data</p>
</li>
<li>
<p>Inconsistent program state</p>
</li>
<li>
<p>Unpredictable behavior that&#8217;s difficult to debug</p>
</li>
<li>
<p>Potential crashes when accessing uninitialized pointers or data structures</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Remove the preliminary check and call <code>sync.Once.Do()</code> directly. The <code>sync.Once</code> type already provides the necessary optimization with proper synchronization.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-go" data-lang="go">var a string
var done bool
var once sync.Once

func setup() {
	a = "hello, world"
	done = true
}

func doprint() {
	if !done { // Noncompliant
		once.Do(setup)
	}
	print(a)
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-go" data-lang="go">var a string
var once sync.Once

func setup() {
	a = "hello, world"
}

func doprint() {
	once.Do(setup)
	print(a)
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>Go Memory Model - <a href="https://go.dev/ref/mem">Official Go memory model documentation explaining synchronization and data races</a></p>
</li>
<li>
<p>sync.Once documentation - <a href="https://pkg.go.dev/sync#Once">Official documentation for the sync.Once type</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_standards">Standards</h3>
<div class="ulist">
<ul>
<li>
<p>CWE-362: Concurrent Execution using Shared Resource with Improper Synchronization - <a href="https://cwe.mitre.org/data/definitions/362.html">Race conditions and improper synchronization in concurrent programs</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_related_rules">Related rules</h3>
<div class="ulist">
<ul>
<li>
<p><a data-rspec-id="S2168" class="rspec-auto-link">RSPEC-2168</a> - <a href="https://rules.sonarsource.com/java/RSPEC-2168/">Double-checked locking should not be used (Java)</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>