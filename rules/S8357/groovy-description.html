<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Methods in Jenkins Pipeline scripts should be annotated with @NonCPS when they are called from constructors, override external class methods, or perform operations incompatible with CPS transformation.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Jenkins Pipeline uses Continuation Passing Style (CPS) transformation to save and restore the execution state of pipeline scripts. This allows pipelines to survive Jenkins restarts and resume where they left off.</p>
</div>
<div class="paragraph">
<p>However, CPS transformation has limitations and can cause runtime failures in specific scenarios:</p>
</div>
<div class="paragraph">
<p><strong>Constructor calls</strong>: Object construction via the <code>new</code> operator cannot be CPS-transformed. When a constructor calls a CPS-transformed method, it throws a <code>CpsCallableInvocation</code> exception that cannot be caught, causing the build to fail.</p>
</div>
<div class="paragraph">
<p><strong>Override methods</strong>: When you override methods from external classes (Java/Groovy standard libraries, binary classes), the overridden methods become CPS-transformed by default. If these methods are called from non-CPS contexts (like standard library code), it creates a mismatch that can lead to serialization problems and unexpected behavior.</p>
</div>
<div class="paragraph">
<p><strong>Performance impact</strong>: CPS transformation adds significant overhead. Methods that don&#8217;t need pipeline state management (like simple calculations or data transformations) perform better without CPS transformation.</p>
</div>
<div class="paragraph">
<p>The <code>@NonCPS</code> annotation tells Jenkins to skip CPS transformation for specific methods, allowing them to execute using normal Groovy semantics while avoiding the compatibility issues described above.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>Without proper use of <code>@NonCPS</code> annotation, you may experience:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Build failures</strong>: Constructor calls to CPS-transformed methods cause uncatchable exceptions that abort the build</p>
</li>
<li>
<p><strong>Runtime errors</strong>: Method mismatches between CPS and non-CPS contexts can cause unexpected behavior or failures</p>
</li>
<li>
<p><strong>Performance degradation</strong>: Unnecessary CPS transformation adds overhead to methods that don&#8217;t require it</p>
</li>
<li>
<p><strong>Serialization issues</strong>: Override methods may fail when called from external library code that expects normal method behavior</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Add @NonCPS annotation to methods called from constructors. This prevents CPS transformation issues when object construction calls these methods.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">class Test {
  def x
  public Test() {
    setX()  // Noncompliant: CPS-transformed method called from constructor
  }
  private void setX() {
    this.x = 1
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">class Test {
  def x
  public Test() {
    setXNonCPS()
  }
  @NonCPS
  private void setXNonCPS() {
    this.x = 1
  }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>Jenkins Pipeline CPS Method Mismatches - <a href="https://www.jenkins.io/doc/book/pipeline/cps-method-mismatches/">Official Jenkins documentation explaining CPS transformation issues and solutions</a></p>
</li>
<li>
<p>Pipeline: Groovy Plugin Documentation - <a href="https://plugins.jenkins.io/workflow-cps/">Technical documentation for the Pipeline Groovy plugin including @NonCPS usage</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>