<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>Mutexes</em> are synchronization primitives that allow managing concurrency using a mechanism of <code>lock</code>/<code>unlock</code>.</p>
</div>
<div class="paragraph">
<p>While explicitly locking or unlocking a <em>mutex</em> is possible, it is error-prone. This is particularly true in complex code paths (or with exceptions) where it is easy to have a mismatch between <code>lock</code>s and <code>unlock</code>s.</p>
</div>
<div class="paragraph">
<p>As a result, <em>mutexes</em> should not be locked or unlocked manually.</p>
</div>
<div class="paragraph">
<p>Adopting the C&#43;&#43; RAII (<em>Resource Acquisition Is Initialization</em>) idiom solves this problem by creating an object that will lock the <em>mutex</em> on creation and unlock it on destruction. Furthermore, using this idiom can also greatly improve the readability of the code.</p>
</div>
<div class="paragraph">
<p>Several classes are available as RAII wrappers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>std::scoped_lock</code> is the default, most efficient wrapper for simple cases (only available since C&#43;&#43;17)</p>
</li>
<li>
<p><code>std::lock_guard</code> is similar to <code>std::scoped_lock</code>, but with fewer features. It should only be used if you don&#8217;t have access to <code>std::scoped_lock</code>.</p>
</li>
<li>
<p><code>std::unique_lock</code> allows more manual unlocking/locking again and should only be used when these features are needed, for instance, with condition variables.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_noncompliant_code_example">Noncompliant code example</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">#include &lt;mutex&gt;

class DataItem;

class DataStore {
public:
  bool store(const DataItem &amp;dataItem);
  bool has(const DataItem &amp;dataItem);
};

DataStore sharedDataStore;
std::mutex sharedDataStoreMutex;

bool storeIfRelevantInSharedContext(const DataItem &amp;dataItem) {
  sharedDataStoreMutex.lock(); // Noncompliant
  if (sharedDataStore.has(dataItem)) {
    sharedDataStoreMutex.unlock(); // Noncompliant
    return false;
  }
  bool result = sharedDataStore.store(dataItem);
  sharedDataStoreMutex.unlock(); // Noncompliant
  return result;
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_compliant_solution">Compliant solution</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">#include &lt;mutex&gt;

class DataItem;

class DataStore {
public:
  bool store(const DataItem &amp;dataItem);
  bool has(const DataItem &amp;dataItem);
};

DataStore sharedDataStore;
std::mutex sharedDataStoreMutex;

bool storeIfRelevantInSharedContext(const DataItem &amp;dataItem) {
  std::scoped_lock&lt;std::mutex&gt; lock(sharedDataStoreMutex);
  if (sharedDataStore.has(dataItem)) {
    return false;
  }
  return sharedDataStore.store(dataItem);
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>C&#43;&#43; reference - <a href="https://en.cppreference.com/w/cpp/language/raii">RAII</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_external_coding_guidelines">External coding guidelines</h3>
<div class="ulist">
<ul>
<li>
<p>C&#43;&#43; Core Guidelines - <a href="https://github.com/isocpp/CppCoreGuidelines/blob/e49158a/CppCoreGuidelines.md#cp20-use-raii-never-plain-lockunlock">CP.20: Use RAII, never plain <code>lock()</code>/<code>unlock()</code></a></p>
</li>
</ul>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Use the RAII idiom instead of calling try_lock()/lock()/unlock() explicitly.</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_relates_to_s5184">relates to: <a data-rspec-id="S5184" class="rspec-auto-link">S5184</a></h3>

</div>
<div class="sect2">
<h3 id="_is_related_to_s5524">is related to: <a data-rspec-id="S5524" class="rspec-auto-link">S5524</a></h3>

</div>
<div class="sect2">
<h3 id="_on_5_nov_2019_200842_loïc_joly_wrote">on 5 Nov 2019, 20:08:42 Loïc Joly wrote:</h3>
<div class="paragraph">
<p>\[~geoffray.adde] Can you review my changes?</p>
</div>
<div class="paragraph">
<p>In particular, I removed one of your examples because I did not see the value it really brought&#8230;&#8203; Do you agree?</p>
</div>
</div>
</div>
</div>