<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>GraphQL servers are vulnerable to Denial of Service attacks when they fail to
limit the depth of queries. In such a case, an attacker is able to craft complex,
deeply nested queries to make the application unwillingly consume an important
amount of resources.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When a server receives a deeply nested query, it attempts to resolve all the
requested data. This process can consume a substantial amount of computational
resources, leading to a slowdown in server response times.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>A server that faces a resource exhaustion situation can become unstable.
The exact impact will depend on how the affected application is deployed and
how well the hosting server configuration is hardened.</p>
</div>
<div class="paragraph">
<p>In the worst case, when the application is deployed in an uncontained
environment, directly on its host system, the memory exhaustion will affect
the whole hosting server. The serverâ€™s operating system might start killing
arbitrary memory-intensive processes, including the main application or other
sensitive ones. This will result in a general operating failure, also known
as a Denial of Service (DoS).</p>
</div>
<div class="paragraph">
<p>In cases where the application is deployed in a virtualized or otherwise
contained environment, or where resource usage limits are in place, the
consequences are limited to the vulnerable application only. In that case,
other processes and applications hosted on the same server may keep on
running without perturbation. The vulnerable application will still
stop working properly.</p>
</div>
<div class="paragraph">
<p>In general, that kind of DoS attack can have severe financial consequences.
They are particularly important when the affected systems are business-critical.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">from graphql_server.flask import GraphQLView

app.add_url_rule("/api",
    view_func=GraphQLView.as_view(  # Noncompliant
        name="api",
        schema=schema,
    )
)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">from graphql_server.flask import GraphQLView
from graphene.validation import depth_limit_validator

app.add_url_rule("/api",
    view_func=GraphQLView.as_view(
        name="api",
        schema=schema,
        validation_rules=[
           depth_limit_validator(10) # Choose a value that fits your application's requirements
        ]
    )
)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_how_does_this_work">How does this work?</h3>
<div class="sect3">
<h4 id="_avoid_circular_references">Avoid circular references</h4>
<div class="paragraph">
<p>A prerequisite for deeply nested query to be executed is the presence of
circular references in the database schema. Avoid or minimize
circular references when designing the application&#8217;s database schema.</p>
</div>
</div>
<div class="sect3">
<h4 id="_set_limits">Set limits</h4>
<div class="paragraph">
<p>Limit the depth of the queries your server will accept. By setting a maximum
depth, you can ensure that excessively nested queries are rejected. Remember,
the values for maximum depth and complexity should be set according to your
application&#8217;s specific needs. Setting these limits too low could restrict
legitimate queries, while setting them too high could leave your server
vulnerable to attacks.</p>
</div>
<div class="paragraph">
<p>The easiest way to set such a limit is to use the query validation API available from Graphene 3. Applications running Graphene 2 should consider upgrading to Graphene 3 to benefit from this API.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_standards">Standards</h3>
<div class="ulist">
<ul>
<li>
<p>OWASP - <a href="https://owasp.org/Top10/A04_2021-Insecure_Design/">Top 10 2021 Category A4 - Insecure Design</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/Top10/A05_2021-Security_Misconfiguration/">Top 10 2021 Category A5 - Security Misconfiguration</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-top-ten/2017/A6_2017-Security_Misconfiguration">Top 10 2017 Category A6 - Security Misconfiguration</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/770">CWE-707 - Allocation of Resources Without Limits or Throttling</a></p>
</li>
<li>
<p>STIG Viewer - <a href="https://stigviewer.com/stigs/application_security_and_development/2024-12-06/finding/V-222667">Application Security and Development: V-222667</a> - Protections against DoS attacks must be implemented.</p>
</li>
</ul>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="ulist">
<ul>
<li>
<p>Change this code to limit the depth of GraphQL queries</p>
</li>
<li>
<p>This relationship creates circular references</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_highlighting">Highlighting</h3>
<div class="ulist">
<ul>
<li>
<p>Highlight the call to <code>GraphQLView.as_view</code> (primary location)</p>
</li>
<li>
<p>Highlight all calls to <code>sqlalchemy.orm.relationship</code> that create circular references (secondary location)</p>
</li>
</ul>
</div>
<hr>
</div>
</div>
</div>