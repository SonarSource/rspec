== How to fix it in OpenSSL

=== Code examples

include::../../common/fix/code-rationale.adoc[]

==== Noncompliant code example

[source,cpp,diff-id=1,diff-type=noncompliant]
----
#include <openssl/ssl.h>

const SSL_METHOD *method = TLS_method();
SSL_CTX *ctx = SSL_CTX_new(method);
SSL_CTX_set_verify(ctx, SSL_VERIFY_NONE, NULL); // Noncompliant; SSL_VERIFY_NONE means no automatic certificate verification
SSL *ssl = SSL_new(ctx);
SSL_connect(ssl);
----

[source,cpp,diff-id=2,diff-type=noncompliant]
----
#include <openssl/ssl.h>

static int verify_callback(int preverify_ok, X509_STORE_CTX *ctx) { return 1; } // This callback always validate the certificate
const SSL_METHOD *method = TLS_method();
SSL_CTX *ctx = SSL_CTX_new(method);
SSL_CTX_set_verify(ctx, CURLOPT_SSL_VERIFYPEER, verify_callback); // Noncompliant; the verify callback result overrides OpenSSL built-in verification enabled by CURLOPT_SSL_VERIFYPEER option.
SSL *ssl = SSL_new(ctx);
SSL_connect(ssl);
----

==== Compliant solution

[source,cpp,diff-id=1,diff-type=compliant]
----
#include <openssl/ssl.h>

const SSL_METHOD *method = TLS_method();
SSL_CTX *ctx = SSL_CTX_new(method);
SSL_CTX_set_verify(ctx, SSL_VERIFY_PEER, NULL); // Compliant; CURLOPT_SSL_VERIFYPEER enable OpenSSL's built-in verification of the peer certificate.
SSL *ssl = SSL_new(ctx);
SSL_connect(ssl);
----

=== How does this work?

include::../../common/fix/default-implementation.adoc[]
