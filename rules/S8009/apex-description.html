<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This rule raises an issue when the <code>instanceof</code> operator is used on a field that could be null without a prior null check.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In Apex, polymorphic fields like <code>WhoId</code> and <code>WhatId</code> can reference different object types or be null. When you use the <code>instanceof</code> operator on a null reference, it throws a <code>NullPointerException</code> at runtime.</p>
</div>
<div class="paragraph">
<p>Polymorphic fields are commonly used in Salesforce objects like Task and Event, where a single field can point to different types of records. For example, the <code>Who</code> field on a Task can reference either a Contact or a Lead record.</p>
</div>
<div class="paragraph">
<p>Developers often use <code>instanceof</code> to determine the actual type of the polymorphic field before casting it to the specific type. However, if the field is null (which can happen when the related record is deleted or the field was never populated), the <code>instanceof</code> check will fail with a runtime exception.</p>
</div>
<div class="paragraph">
<p>This issue is particularly problematic because:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It causes unexpected runtime failures that can break user workflows</p>
</li>
<li>
<p>The error might not be caught during testing if test data always has populated polymorphic fields</p>
</li>
<li>
<p>It can lead to poor user experience when operations fail unexpectedly</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>When this issue occurs, it results in a <code>NullPointerException</code> at runtime, which can:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Cause transaction failures and rollbacks</p>
</li>
<li>
<p>Break user workflows and business processes</p>
</li>
<li>
<p>Lead to poor user experience with unexpected error messages</p>
</li>
<li>
<p>Make the application appear unreliable to end users</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Add a null check before using the <code>instanceof</code> operator. Use the logical AND operator (<code>&amp;&amp;</code>) to ensure both conditions are met: the field is not null AND it is an instance of the expected type.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-apex" data-lang="apex">if(task.Who instanceof Contact) { // Noncompliant
    Contact con = (Contact) task.Who;
    System.debug('Contact: ' + con.Name);
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-apex" data-lang="apex">if(task.Who != null &amp;&amp; task.Who instanceof Contact) {
    Contact con = (Contact) task.Who;
    System.debug('Contact: ' + con.Name);
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>Polymorphic Relationships in SOQL Queries - <a href="https://www.apexhours.com/working-with-polymorphic-relationships-in-soql-queries">Guide on working with polymorphic fields in Salesforce and using instanceof safely</a></p>
</li>
<li>
<p>Apex Developer Guide - instanceof Operator - <a href="https://developer.salesforce.com/docs/atlas.en-us.apexcode.meta/apexcode/langCon_apex_expressions_operators_instanceof.htm">Official Salesforce documentation on the instanceof operator in Apex</a></p>
</li>
<li>
<p>Null Pointer Exceptions in Apex - <a href="https://developer.salesforce.com/docs/atlas.en-us.apexcode.meta/apexcode/apex_classes_exception_methods.htm">Salesforce documentation on handling exceptions including NullPointerException</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_standards">Standards</h3>
<div class="ulist">
<ul>
<li>
<p>CWE-476: NULL Pointer Dereference - <a href="https://cwe.mitre.org/data/definitions/476.html">Common weakness related to dereferencing null pointers</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_related_rules">Related rules</h3>
<div class="ulist">
<ul>
<li>
<p><a data-rspec-id="S4201" class="rspec-auto-link">RSPEC-4201</a> - <a href="https://rules.sonarsource.com/java/RSPEC-4201/">Java rule for null checks before instanceof operations</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>