<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Formatted SQL queries can be difficult to maintain, debug and can increase the risk of SQL injection when concatenating untrusted values into the query. However, this rule doesn&#8217;t detect SQL injections (unlike rule <a data-rspec-id="S3649" class="rspec-auto-link">S3649</a>), the goal is only to highlight complex/formatted queries.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ask_yourself_whether">Ask Yourself Whether</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Some parts of the query come from untrusted values (like user inputs).</p>
</li>
<li>
<p>The query is repeated/duplicated in other parts of the code.</p>
</li>
<li>
<p>The application must support different types of relational databases.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is a risk if you answered yes to any of those questions.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_recommended_secure_coding_practices">Recommended Secure Coding Practices</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Use <a href="https://cheatsheetseries.owasp.org/cheatsheets/Query_Parameterization_Cheat_Sheet.html">parameterized queries, prepared statements, or stored procedures</a> and bind variables to SQL query parameters.</p>
</li>
<li>
<p>Consider using ORM frameworks if there is a need to have an abstract layer to access data.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sensitive_code_example">Sensitive Code Example</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>public void Foo(DbContext context, string query, string param)
{
    string sensitiveQuery = string.Concat(query, param);
    context.Database.ExecuteSqlCommand(sensitiveQuery); // Sensitive
    context.Query&lt;User&gt;().FromSql(sensitiveQuery); // Sensitive

    context.Database.ExecuteSqlCommand($"SELECT * FROM mytable WHERE mycol={value}", param); // Sensitive, the FormattableString is evaluated and converted to RawSqlString
    string query = $"SELECT * FROM mytable WHERE mycol={param}";
    context.Database.ExecuteSqlCommand(query); // Sensitive, the FormattableString has already been evaluated, it won't be converted to a parametrized query.
}

public void Bar(SqlConnection connection, string param)
{
    SqlCommand command;
    string sensitiveQuery = string.Format("INSERT INTO Users (name) VALUES (\"{0}\")", param);
    command = new SqlCommand(sensitiveQuery); // Sensitive

    command.CommandText = sensitiveQuery; // Sensitive

    SqlDataAdapter adapter;
    adapter = new SqlDataAdapter(sensitiveQuery, connection); // Sensitive
}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compliant_solution">Compliant Solution</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-csharp" data-lang="csharp">public void Foo(DbContext context, string query, string param)
{
    context.Database.ExecuteSqlCommand("SELECT * FROM mytable WHERE mycol=@p0", param); // Compliant, it's a parametrized safe query
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>OWASP - <a href="https://owasp.org/Top10/A03_2021-Injection/">Top 10 2021 Category A3 - Injection</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-top-ten/2017/A1_2017-Injection">Top 10 2017 Category A1 - Injection</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/20">CWE-20 - Improper Input Validation</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/89">CWE-89 - Improper Neutralization of Special Elements used in an SQL Command</a></p>
</li>
<li>
<p>Derived from FindSecBugs rules <a href="https://h3xstream.github.io/find-sec-bugs/bugs.htm#SQL_INJECTION_JPA">Potential SQL/JPQL Injection (JPA)</a>, <a href="https://h3xstream.github.io/find-sec-bugs/bugs.htm#SQL_INJECTION_JDO">Potential SQL/JDOQL Injection (JDO)</a>, <a href="https://h3xstream.github.io/find-sec-bugs/bugs.htm#SQL_INJECTION_HIBERNATE">Potential SQL/HQL Injection (Hibernate)</a></p>
</li>
</ul>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Make sure using a dynamically formatted SQL query is safe here.</p>
</div>
</div>
<div class="sect2">
<h3 id="_highlighting">Highlighting</h3>
<div class="ulist">
<ul>
<li>
<p>Primary: on the sql query call</p>
</li>
<li>
<p>Secondary: on each assignment / format of the query</p>
<div class="ulist">
<ul>
<li>
<p>message when formatting: "SQL Query is dynamically formatted and assigned to {variable_name}"</p>
</li>
<li>
<p>message for an assignment: "SQL query is assigned to {variable_name}"</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_on_16_oct_2018_173858_nicolas_harraudeau_wrote">on 16 Oct 2018, 17:38:58 Nicolas Harraudeau wrote:</h3>
<div class="paragraph">
<p><strong>Implementation details</strong>:</p>
</div>
<div class="paragraph">
<p>Note that the first parameter of many function has a <code>string</code> as first parameter. The reason is that we do not want to highlight the instantiation of empty objects such as <code>new OdbcCommand()</code> which have their command set later via their property <code>CommandText</code>. The goal is to highlight the exact moment where the SQL string query is provided to the command. That way we highlight the place where the injection can take place.</p>
</div>
<div class="paragraph">
<p>Note also that no issue should be created if the SQL command has no risk of injection. Thus if the SQL command is a hard-coded string or the concatenation of hard-coded strings, it should not create an issue.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_8_oct_2019_111214_andrei_epure_wrote">on 8 Oct 2019, 11:12:14 Andrei Epure wrote:</h3>
<div class="paragraph">
<p>\[~nicolas.harraudeau] [~pierre-loup.tristant] - should this rule be harmonized with the libraries we support for <a data-rspec-id="S3649" class="rspec-auto-link">RSPEC-3649</a> (e.g. Dapper, Petapoco, NHibernate)?</p>
</div>
<div class="literalblock">
<div class="content">
<pre>_see all the references in https://github.com/SonarSource/sonar-security/blob/8.0.0-M1.5391/its/projects/internal/InternalBasic.CSharp/InternalBasic.CSharp.NetCore/InternalBasic.CSharp.NetCore.csproj[InternalBasic.CSharp.NetCore.csproj] and https://github.com/SonarSource/sonar-security/blob/8.0.0-M1.5391/its/projects/internal/InternalBasic.CSharp/InternalBasic.CSharp.NetFramework/InternalBasic.CSharp.NetFramework.csproj[InternalBasic.CSharp.NetFramework.csproj]_</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_is_duplicated_by_s3371">is duplicated by: <a data-rspec-id="S3371" class="rspec-auto-link">S3371</a></h3>

</div>
<div class="sect2">
<h3 id="_relates_to_s3649">relates to: <a data-rspec-id="S3649" class="rspec-auto-link">S3649</a></h3>

</div>
<div class="sect2">
<h3 id="_replaces_s1877">replaces: <a data-rspec-id="S1877" class="rspec-auto-link">S1877</a></h3>

</div>
<div class="sect2">
<h3 id="_on_12_oct_2014_164756_freddy_mallet_wrote">on 12 Oct 2014, 16:47:56 Freddy Mallet wrote:</h3>
<div class="paragraph">
<p>@Ann, I would associate this rule to Findbugs rules : SQL_NONCONSTANT_STRING_PASSED_TO_EXECUTE,SQL_PREPARED_STATEMENT_GENERATED_FROM_NONCONSTANT_STRING</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_12_nov_2014_154127_sébastien_gioria_wrote">on 12 Nov 2014, 15:41:27 Sébastien Gioria wrote:</h3>
<div class="paragraph">
<p>May I suggest to setup default severity as "Blocker" ? We should not find anymore Dynamic query in the source code without sanitizing.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_21_nov_2014_152202_freddy_mallet_wrote">on 21 Nov 2014, 15:22:02 Freddy Mallet wrote:</h3>
<div class="paragraph">
<p>Fine for me [~ann.campbell.2] and [~sebastien.gioria] to increase the severity to "Blocker"</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_21_nov_2014_173303_ann_campbell_wrote">on 21 Nov 2014, 17:33:03 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~freddy.mallet] I considered this, but our guidelines specifically say SQL Injection rules should be Critical. Guess I should have annotated the ticket accordingly. :-/</p>
</div>
<div class="paragraph">
<p>cc [~sebastien.gioria]</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_24_may_2016_131314_ann_campbell_wrote">on 24 May 2016, 13:13:14 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>ABAP reference: https://www.kiuwan.com/blog/security-business-oriented-languages-abap/</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_26_may_2016_114421_nicolas_bontoux_wrote">on 26 May 2016, 11:44:21 Nicolas Bontoux wrote:</h3>
<div class="paragraph">
<p>PL/SQL reference <a href="https://oracle-base.com/articles/misc/literals-substitution-variables-and-bind-variables">here</a> . Note that for PL/SQL this best practice is not just about security, there&#8217;s also a performance impact (soft/hard parsing logic).</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_16_jun_2016_155430_freddy_mallet_wrote">on 16 Jun 2016, 15:54:30 Freddy Mallet wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2] there is a huge difference between the two rules :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In PL/SQL, when using Literals or Substitution Variables there is absolutely no risk to change the structure of the SQL request to do something which is not expected &#8594; so we absolutely don&#8217;t care about the content of literal or substitution variables and a so about the fact that those values should be sanitized. The only overlap between the two rules is the remediation action but the purpose is absolutely not the same</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_on_17_jun_2016_134852_ann_campbell_wrote">on 17 Jun 2016, 13:48:52 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>To close the thread, we&#8217;ll leave PL/SQL here</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_19_sep_2018_151219_nicolas_harraudeau_wrote">on 19 Sep 2018, 15:12:19 Nicolas Harraudeau wrote:</h3>
<div class="paragraph">
<p>This rule becomes a Hotspot. The corresponding vulnerability is  <a data-rspec-id="S3649" class="rspec-auto-link">RSPEC-3649</a>.</p>
</div>
</div>
</div>
</div>