<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Formatted SQL queries can be difficult to maintain, debug and can increase the risk of SQL injection when concatenating untrusted values into the query. However, this rule doesn&#8217;t detect SQL injections (unlike rule <a data-rspec-id="S3649" class="rspec-auto-link">S3649</a>), the goal is only to highlight complex/formatted queries.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ask_yourself_whether">Ask Yourself Whether</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Some parts of the query come from untrusted values (like user inputs).</p>
</li>
<li>
<p>The query is repeated/duplicated in other parts of the code.</p>
</li>
<li>
<p>The application must support different types of relational databases.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is a risk if you answered yes to any of those questions.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_recommended_secure_coding_practices">Recommended Secure Coding Practices</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Use <a href="https://cheatsheetseries.owasp.org/cheatsheets/Query_Parameterization_Cheat_Sheet.html">parameterized queries, prepared statements, or stored procedures</a> and bind variables to SQL query parameters.</p>
</li>
<li>
<p>Consider using ORM frameworks if there is a need to have an abstract layer to access data.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sensitive_code_example">Sensitive Code Example</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-go" data-lang="go">func getName(db *sql.DB, id string) (string, error) {
    var name string
    row := db.QueryRow("SELECT name FROM users WHERE id = " + id) // Sensitive

    if err := row.Scan(&amp;name); err != nil {
        if err == sql.ErrNoRows {
            return name, fmt.Errorf("No name found for id %s", id)
        }
    }

    return name, nil
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compliant_solution">Compliant Solution</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-go" data-lang="go">func getName(db *sql.DB, id string) (string, error) {
    var name string
    row := db.QueryRow("SELECT name FROM users WHERE id = ?", id)

    if err := row.Scan(&amp;name); err != nil {
        if err == sql.ErrNoRows {
            return name, fmt.Errorf("No name found for id %s", id)
        }
    }

    return name, nil
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>OWASP - <a href="https://owasp.org/Top10/A03_2021-Injection/">Top 10 2021 Category A3 - Injection</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-top-ten/2017/A1_2017-Injection">Top 10 2017 Category A1 - Injection</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/20">CWE-20 - Improper Input Validation</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/89">CWE-89 - Improper Neutralization of Special Elements used in an SQL Command</a></p>
</li>
<li>
<p>Derived from FindSecBugs rules <a href="https://h3xstream.github.io/find-sec-bugs/bugs.htm#SQL_INJECTION_JPA">Potential SQL/JPQL Injection (JPA)</a>, <a href="https://h3xstream.github.io/find-sec-bugs/bugs.htm#SQL_INJECTION_JDO">Potential SQL/JDOQL Injection (JDO)</a>, <a href="https://h3xstream.github.io/find-sec-bugs/bugs.htm#SQL_INJECTION_HIBERNATE">Potential SQL/HQL Injection (Hibernate)</a></p>
</li>
</ul>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Make sure using a dynamically formatted SQL query is safe here.</p>
</div>
</div>
<div class="sect2">
<h3 id="_highlighting">Highlighting</h3>
<div class="ulist">
<ul>
<li>
<p>Primary: on the sql query call</p>
</li>
<li>
<p>Secondary: on each assignment / format of the query</p>
<div class="ulist">
<ul>
<li>
<p>message when formatting: "SQL Query is dynamically formatted and assigned to {variable_name}"</p>
</li>
<li>
<p>message for an assignment: "SQL query is assigned to {variable_name}"</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>