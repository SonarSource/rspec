<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Formatted SQL queries can be difficult to maintain, debug and can increase the risk of SQL injection when concatenating untrusted values into the query. However, this rule doesn&#8217;t detect SQL injections (unlike rule <a data-rspec-id="S3649" class="rspec-auto-link">S3649</a>), the goal is only to highlight complex/formatted queries.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ask_yourself_whether">Ask Yourself Whether</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Some parts of the query come from untrusted values (like user inputs).</p>
</li>
<li>
<p>The query is repeated/duplicated in other parts of the code.</p>
</li>
<li>
<p>The application must support different types of relational databases.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is a risk if you answered yes to any of those questions.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_recommended_secure_coding_practices">Recommended Secure Coding Practices</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Use <a href="https://cheatsheetseries.owasp.org/cheatsheets/Query_Parameterization_Cheat_Sheet.html">parameterized queries, prepared statements, or stored procedures</a> and bind variables to SQL query parameters.</p>
</li>
<li>
<p>Consider using ORM frameworks if there is a need to have an abstract layer to access data.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sensitive_code_example">Sensitive Code Example</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">// === MySQL ===
const mysql = require('mysql');
const mycon = mysql.createConnection({ host: host, user: user, password: pass, database: db });
mycon.connect(function(err) {
  mycon.query('SELECT * FROM users WHERE id = ' + userinput, (err, res) =&gt; {}); // Sensitive
});

// === PostgreSQL ===
const pg = require('pg');
const pgcon = new pg.Client({ host: host, user: user, password: pass, database: db });
pgcon.connect();
pgcon.query('SELECT * FROM users WHERE id = ' + userinput, (err, res) =&gt; {}); // Sensitive</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compliant_solution">Compliant Solution</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">// === MySQL ===
const mysql = require('mysql');
const mycon = mysql.createConnection({ host: host, user: user, password: pass, database: db });
mycon.connect(function(err) {
  mycon.query('SELECT name FROM users WHERE id = ?', [userinput], (err, res) =&gt; {});
});

// === PostgreSQL ===
const pg = require('pg');
const pgcon = new pg.Client({ host: host, user: user, password: pass, database: db });
pgcon.connect();
pgcon.query('SELECT name FROM users WHERE id = $1', [userinput], (err, res) =&gt; {});</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_exceptions">Exceptions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This rule&#8217;s current implementation does not follow variables. It will only detect SQL queries which are formatted directly in the function call.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const sql = 'SELECT * FROM users WHERE id = ' + userinput;
mycon.query(sql, (err, res) =&gt; {}); // Sensitive but no issue is raised.</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>OWASP - <a href="https://owasp.org/Top10/A03_2021-Injection/">Top 10 2021 Category A3 - Injection</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-top-ten/2017/A1_2017-Injection">Top 10 2017 Category A1 - Injection</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/20">CWE-20 - Improper Input Validation</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/89">CWE-89 - Improper Neutralization of Special Elements used in an SQL Command</a></p>
</li>
<li>
<p>Derived from FindSecBugs rules <a href="https://h3xstream.github.io/find-sec-bugs/bugs.htm#SQL_INJECTION_JPA">Potential SQL/JPQL Injection (JPA)</a>, <a href="https://h3xstream.github.io/find-sec-bugs/bugs.htm#SQL_INJECTION_JDO">Potential SQL/JDOQL Injection (JDO)</a>, <a href="https://h3xstream.github.io/find-sec-bugs/bugs.htm#SQL_INJECTION_HIBERNATE">Potential SQL/HQL Injection (Hibernate)</a></p>
</li>
</ul>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Make sure using a dynamically formatted SQL query is safe here.</p>
</div>
</div>
<div class="sect2">
<h3 id="_highlighting">Highlighting</h3>
<div class="ulist">
<ul>
<li>
<p>Primary: on the sql query call</p>
</li>
<li>
<p>Secondary: on each assignment / format of the query</p>
<div class="ulist">
<ul>
<li>
<p>message when formatting: "SQL Query is dynamically formatted and assigned to {variable_name}"</p>
</li>
<li>
<p>message for an assignment: "SQL query is assigned to {variable_name}"</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_on_8_dec_2018_151348_lars_svensson_wrote">on 8 Dec 2018, 15:13:48 Lars Svensson wrote:</h3>
<div class="paragraph">
<p><a href="https://www.npmjs.com/package/mysql" class="bare">https://www.npmjs.com/package/mysql</a></p>
</div>
<div class="paragraph">
<p><a href="https://www.npmjs.com/package/mysql2" class="bare">https://www.npmjs.com/package/mysql2</a></p>
</div>
<div class="paragraph">
<p><a href="https://www.npmjs.com/package/pg" class="bare">https://www.npmjs.com/package/pg</a> - docs: https://node-postgres.com/features/queries</p>
</div>
<div class="paragraph">
<p><a href="https://www.npmjs.com/package/sequelize" class="bare">https://www.npmjs.com/package/sequelize</a> - docs: http://docs.sequelizejs.com/</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_8_dec_2018_191956_lars_svensson_wrote">on 8 Dec 2018, 19:19:56 Lars Svensson wrote:</h3>
<div class="paragraph">
<p>Sequelize is currently the most popular NodeJS ORM with the module having ~285k downloads/week.</p>
</div>
<div class="paragraph">
<p>This OWASP project has a good example of an SQLi related with the sequelize module:</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/appsecco/dvna" class="bare">https://github.com/appsecco/dvna</a></p>
</div>
<div class="paragraph">
<p>sequelize.query() is used with user input concatenated to an SQL command</p>
</div>
</div>
<div class="sect2">
<h3 id="_is_duplicated_by_s3371">is duplicated by: <a data-rspec-id="S3371" class="rspec-auto-link">S3371</a></h3>

</div>
<div class="sect2">
<h3 id="_relates_to_s3649">relates to: <a data-rspec-id="S3649" class="rspec-auto-link">S3649</a></h3>

</div>
<div class="sect2">
<h3 id="_replaces_s1877">replaces: <a data-rspec-id="S1877" class="rspec-auto-link">S1877</a></h3>

</div>
<div class="sect2">
<h3 id="_on_12_oct_2014_164756_freddy_mallet_wrote">on 12 Oct 2014, 16:47:56 Freddy Mallet wrote:</h3>
<div class="paragraph">
<p>@Ann, I would associate this rule to Findbugs rules : SQL_NONCONSTANT_STRING_PASSED_TO_EXECUTE,SQL_PREPARED_STATEMENT_GENERATED_FROM_NONCONSTANT_STRING</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_12_nov_2014_154127_sébastien_gioria_wrote">on 12 Nov 2014, 15:41:27 Sébastien Gioria wrote:</h3>
<div class="paragraph">
<p>May I suggest to setup default severity as "Blocker" ? We should not find anymore Dynamic query in the source code without sanitizing.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_21_nov_2014_152202_freddy_mallet_wrote">on 21 Nov 2014, 15:22:02 Freddy Mallet wrote:</h3>
<div class="paragraph">
<p>Fine for me [~ann.campbell.2] and [~sebastien.gioria] to increase the severity to "Blocker"</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_21_nov_2014_173303_ann_campbell_wrote">on 21 Nov 2014, 17:33:03 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~freddy.mallet] I considered this, but our guidelines specifically say SQL Injection rules should be Critical. Guess I should have annotated the ticket accordingly. :-/</p>
</div>
<div class="paragraph">
<p>cc [~sebastien.gioria]</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_24_may_2016_131314_ann_campbell_wrote">on 24 May 2016, 13:13:14 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>ABAP reference: https://www.kiuwan.com/blog/security-business-oriented-languages-abap/</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_26_may_2016_114421_nicolas_bontoux_wrote">on 26 May 2016, 11:44:21 Nicolas Bontoux wrote:</h3>
<div class="paragraph">
<p>PL/SQL reference <a href="https://oracle-base.com/articles/misc/literals-substitution-variables-and-bind-variables">here</a> . Note that for PL/SQL this best practice is not just about security, there&#8217;s also a performance impact (soft/hard parsing logic).</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_16_jun_2016_155430_freddy_mallet_wrote">on 16 Jun 2016, 15:54:30 Freddy Mallet wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2] there is a huge difference between the two rules :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In PL/SQL, when using Literals or Substitution Variables there is absolutely no risk to change the structure of the SQL request to do something which is not expected &#8594; so we absolutely don&#8217;t care about the content of literal or substitution variables and a so about the fact that those values should be sanitized. The only overlap between the two rules is the remediation action but the purpose is absolutely not the same</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_on_17_jun_2016_134852_ann_campbell_wrote">on 17 Jun 2016, 13:48:52 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>To close the thread, we&#8217;ll leave PL/SQL here</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_19_sep_2018_151219_nicolas_harraudeau_wrote">on 19 Sep 2018, 15:12:19 Nicolas Harraudeau wrote:</h3>
<div class="paragraph">
<p>This rule becomes a Hotspot. The corresponding vulnerability is  <a data-rspec-id="S3649" class="rspec-auto-link">RSPEC-3649</a>.</p>
</div>
</div>
</div>
</div>