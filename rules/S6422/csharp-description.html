<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Making <a href="https://en.wikipedia.org/wiki/Blocking_(computing)">blocking calls</a> to <code>async</code> methods transforms the code into a synchronous operation. Doing so inside an Azure Function can lead to thread pool exhaustion.</p>
</div>
<div class="paragraph">
<p>Thread pool exhaustion refers to a situation where all available threads in a thread pool are occupied, and new tasks or work items cannot be scheduled for execution due to the lack of available threads. This can lead to delayed execution and degraded performance.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-csharp" data-lang="csharp">class RequestParser
{
	[FunctionName(nameof(ParseRequest))]
	public static async Task&lt;IActionResult&gt; ParseRequest([HttpTrigger(AuthorizationLevel.Function, "get", "post", Route = null)] HttpRequest req)
	{
		// This can lead to thread exhaustion
		string requestBody = new StreamReader(req.Body).ReadToEndAsync().Result;
		// do stuff...
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead, <a href="https://learn.microsoft.com/en-us/dotnet/csharp/asynchronous-programming/">asynchronous</a> mechanisms should be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-csharp" data-lang="csharp">class RequestParser
{
	[FunctionName(nameof(ParseRequest))]
	public static async Task&lt;IActionResult&gt; ParseRequest([HttpTrigger(AuthorizationLevel.Function, "get", "post", Route = null)] HttpRequest req)
	{
		// Non-blocking, asynchronous operation
		string requestBody = await new StreamReader(req.Body).ReadToEndAsync();
		// do stuff...
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This applies to multiple methods that are available when working with tasks:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">Goal</th>
<th class="tableblock halign-center valign-top">Blocking</th>
<th class="tableblock halign-center valign-top">Asynchronous</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Wait for the result of a task</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>Task.Wait</code>, <code>Task.Result</code> or <code>Task.GetAwaiter.GetResult</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>await</code></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Wait for any of many task to complete</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>Task.WaitAny</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>await Task.WhenAny</code></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Wait for all of many tasks to complete</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>Task.WaitAll</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>await Task.WhenAll</code></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Wait a period of time</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>Thread.Sleep</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>await Task.Delay</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>Microsoft Learn - <a href="https://learn.microsoft.com/en-us/archive/msdn-magazine/2013/march/async-await-best-practices-in-asynchronous-programming">Async/Await - Best Practices in Asynchronous Programming</a></p>
</li>
<li>
<p>Microsoft Learn - <a href="https://learn.microsoft.com/en-us/azure/azure-functions/performance-reliability#use-async-code-but-avoid-blocking-calls">Improve the performance and reliability of Azure Functions - Scalability best practices</a></p>
</li>
<li>
<p>Github - <a href="https://github.com/davidfowl/AspNetCoreDiagnosticScenarios/blob/master/AsyncGuidance.md">Async Guidance by David Fowler</a></p>
</li>
<li>
<p><a data-rspec-id="S4462" class="rspec-auto-link">S4462</a> - Calls to "async" methods should not be blocking (a more general version of this rule)</p>
</li>
</ul>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="paragraph">
<p>The implementation should be common with <a data-rspec-id="S4462" class="rspec-auto-link">S4462</a>. When implementing, should make sure <a data-rspec-id="S4462" class="rspec-auto-link">S4462</a> will ignore Azure Functions.</p>
</div>
</div>
</div>