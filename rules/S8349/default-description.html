<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A Content-Security Policy (CSP) is an allow-list mechanism that a web
application can provide to browsers to restrict requests originating from one of
its own web pages.</p>
</div>
<div class="paragraph">
<p>This is a semicolon-delimited string whose each entry is a <code>policy</code> of the form
<code>&lt;directive&gt; &lt;value&gt;</code>. <code>value</code> can be <code>'none'</code>, <code>'self'</code>, or other hardcoded
locations. For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>script-src <a href="https://example.com/" class="bare">https://example.com/</a></code> blocks loading and execution of any <code>&lt;script src=&#8230;&#8203;&gt;&lt;/script&gt;</code> whose src is not exactly the specified value.</p>
</li>
<li>
<p><code>media-src <a href="https://example.com/" class="bare">https://example.com/</a></code> blocks loading and execution of <code>&lt;audio&gt;</code> and <code>&lt;video&gt;</code> tags whose src is not exactly the specified value.</p>
</li>
<li>
<p>And so on. The full list of directives can be found in <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/Content-Security-Policy#directives">Content-Security-Policy (CSP) header | MDN</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Additionally, the directive <code>frame-ancestors</code> can be used to restrict which
pages can embed a given page, in order to prevent
<a href="https://portswigger.net/web-security/cross-site-scripting/content-security-policy#protecting-against-clickjacking-using-csp">clickjacking</a>.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>CSP injection occurs when an application unsafely retrieves data from an
incoming request and reflects it into the Content-Security Policy (CSP) headers
of the response without sanitization.</p>
</div>
<div class="paragraph">
<p>This means that an a third-party can add new directives or change existing
directives and enable uncontrolled execution of scripts or other dangerous
elements within a webpage.</p>
</div>
<div class="paragraph">
<p>Once unsafe policies are created, they pave the way to attacks on
vulnerabilities which could have been deemed harmless otherwise, such as XSS or
clickjacking.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Generally, never use third-party data to set up CSP boundaries. Instead, create
a strict allow-list of policies.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="paragraph">
<p>In the following example, not only setting a user-controlled nonce defeats the
purpose of the nonce, but the userId can be exploited to add more values to the
<code>script-src</code> directive.</p>
</div>
<div class="paragraph">
<p>The safest way to set a CSP is to maintain a hardcoded list of intentionnally
trusted values.</p>
</div>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const express = require('express');
const app = express();

app.use((req, res, next) =&gt; {
    const { domainName } = req.query;
    const csp = [
        "default-src 'none'",
        `img-src 'self' ${domainName}`, // Noncompliant
        "style-src 'self'"
    ].join('; ');

    res.setHeader("Content-Security-Policy", csp);
    next();
});</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const express = require('express');
const app = express();

app.use((req, res, next) =&gt; {
    const csp = [
        "default-src 'none'",
        "img-src 'self' https://images.example.com",
        "style-src 'self'"
    ].join('; ');

    res.setHeader("Content-Security-Policy", csp);
    next();
});</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_standards">Standards</h3>
<div class="ulist">
<ul>
<li>
<p>OWASP - <a href="https://owasp.org/Top10/A05_2021-Security_Misconfiguration/">Top 10 2021 Category A5 - Security Misconfiguration</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-top-ten/2017/A6_2017-Security_Misconfiguration">Top 10 2017 Category A6 - Security Misconfiguration</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/693">CWE-693 - Protection Mechanism Failure</a></p>
</li>
<li>
<p>STIG Viewer - <a href="https://stigviewer.com/stigs/application_security_and_development/2024-12-06/finding/V-222602">Application Security and Development: V-222602</a> - The application must protect from Cross-Site Scripting (XSS) vulnerabilities.</p>
</li>
</ul>
</div>
</div>
</div>
</div>