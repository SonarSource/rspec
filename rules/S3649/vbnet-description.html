<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Database injections (such as SQL injections) occur in an application when the
application retrieves data from a user or a third-party service and inserts it
into a database query without sanitizing it first.</p>
</div>
<div class="paragraph">
<p>If an application contains a database query that is vulnerable to injections,
it is exposed to attacks that target any database where that query is used.</p>
</div>
<div class="paragraph">
<p>A user with malicious intent is able to modify the existing query to change
its logic to a malicious one.</p>
</div>
<div class="paragraph">
<p>After creating the malicious request, the attacker can attack the databases
affected by this vulnerability without relying on any pre-requisites.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>In the context of a web application that is vulnerable to SQL injection:<br>
After discovering the injection, attackers inject data into the vulnerable
field to execute malicious commands in the affected databases.</p>
</div>
<div class="paragraph">
<p>Below are some real-world scenarios that illustrate some impacts of an attacker
exploiting the vulnerability.</p>
</div>
<div class="sect3">
<h4 id="_identity_spoofing_and_data_manipulation">Identity spoofing and data manipulation</h4>
<div class="paragraph">
<p>A malicious database query enables privilege escalation or direct data leakage
from one or more databases. This threat is the most widespread impact.</p>
</div>
</div>
<div class="sect3">
<h4 id="_data_deletion_and_denial_of_service">Data deletion and denial of service</h4>
<div class="paragraph">
<p>The malicious query makes it possible for the attacker to delete data in the
affected databases.<br>
This threat is particularly insidious if the attacked organization does not
maintain a disaster recovery plan (DRP).</p>
</div>
</div>
<div class="sect3">
<h4 id="_chaining_db_injections_with_other_vulnerabilities">Chaining DB injections with other vulnerabilities</h4>
<div class="paragraph">
<p>Attackers who exploit SQL injections rely on other vulnerabilities to maximize
their profits.<br>
Most of the time, organizations overlook some defense in depth measures because
they assume attackers cannot reach certain points in the infrastructure. This
misbehavior can lead to multiple attacks with great impact:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When secrets are stored unencrypted in databases: Secrets can be exfiltrated and lead to compromise of other components.</p>
</li>
<li>
<p>If server-side OS and/or database permissions are misconfigured, injection can lead to remote code execution (RCE).</p>
<div class="ulist">
<ul>
<li>
<p>See <a href="https://blog.sonarsource.com/exploiting-hibernate-injections/">our article on this topic</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it_in_entity_framework_core">How to fix it in Entity Framework Core</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="paragraph">
<p>The following code is an example of an overly simple data retrieval function.
It is vulnerable to SQL injection because user-controlled data is inserted
directly into a query string: The application assumes that incoming data
always has a specific range of characters and ignores that some characters may
change the query logic to a malicious one.</p>
</div>
<div class="paragraph">
<p>In this particular case, the query can be exploited with the following string:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>' OR '1'='1</pre>
</div>
</div>
<div class="paragraph">
<p>Using the UNION clause, an attacker would also be able to perform queries against
other tables and combine the returned data within the same query result.</p>
</div>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-vbnet" data-lang="vbnet">Public Class ExampleController
    Inherits Controller

    Public Function Authenticate(User As String, Pass As String) As IActionResult
        Dim Query As String = "SELECT * FROM users WHERE user = '" &amp; User &amp; "' AND pass = '" &amp; Pass &amp; "'"

        Dim DbSet As DbSet(Of UserAccount) = New UserAccountContext().Set(Of UserAccount)()
        Dim QueryResults = DbSet.FromSqlRaw(Query)

        If Not QueryResults.Any() Then
            Return Unauthorized()
        End If

        Return Ok()
    End Function
End Class</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-vbnet" data-lang="vbnet">Public Class ExampleController
    Inherits Controller

    Public Function Authenticate(User As String, Pass As String) As IActionResult
        Dim Query As String = "SELECT * FROM users WHERE user = {0} AND pass = {1}"

        Dim DbSet As DbSet(Of UserAccount) = New UserAccountContext().Set(Of UserAccount)()
        Dim QueryResults = DbSet.FromSqlRaw(Query, User, Pass)

        If Not QueryResults.Any() Then
            Return Unauthorized()
        End If

        Return Ok()
    End Function
End Class</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_how_does_this_work">How does this work?</h3>
<div class="sect3">
<h4 id="_use_prepared_statements">Use prepared statements</h4>
<div class="paragraph">
<p>As a rule of thumb, the best approach to protect against injections is to
systematically ensure that untrusted data cannot break out of an interpreted
context.</p>
</div>
<div class="paragraph">
<p>For database queries, prepared statements are a natural mechanism to achieve
this due to their internal workings.<br>
Here is an example with the following query string (Java SE syntax):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT * FROM users WHERE user = ? AND pass = ?</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Note: Placeholders may take different forms, depending on the library used. For the above example, the question mark symbol '?' was used as a placeholder.</strong></p>
</div>
<div class="paragraph">
<p>When a prepared statement is used by an application, the database server
compiles the query logic even before the application passes the literals
corresponding to the placeholders to the database.<br>
Some libraries expose a <code>prepareStatement</code> function that explicitly does so,
and some do not - because they do it transparently.</p>
</div>
<div class="paragraph">
<p>The compiled code that contains the query logic also includes the placeholders:
they serve as parameters.</p>
</div>
<div class="paragraph">
<p>After compilation, the query logic is frozen and cannot be changed.<br>
So when the application passes the literals that replace the placeholders, they
are not considered application logic by the database.</p>
</div>
<div class="paragraph">
<p>Consequently, the database server prevents the dynamic literals of a prepared
statement from affecting the underlying query, and thus sanitizes them.</p>
</div>
<div class="paragraph">
<p>On the other hand, the application does not automatically sanitize third-party
data (for example, user-controlled data) inserted directly into a query. An
attacker who controls this third-party data can cause the database to execute
malicious code.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it_in_dapper">How to fix it in Dapper</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_code_examples_2">Code examples</h3>
<div class="paragraph">
<p>The following code is an example of an overly simple data retrieval function.
It is vulnerable to SQL injection because user-controlled data is inserted
directly into a query string: The application assumes that incoming data
always has a specific range of characters and ignores that some characters may
change the query logic to a malicious one.</p>
</div>
<div class="paragraph">
<p>In this particular case, the query can be exploited with the following string:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>' OR '1'='1</pre>
</div>
</div>
<div class="paragraph">
<p>Using the UNION clause, an attacker would also be able to perform queries against
other tables and combine the returned data within the same query result.</p>
</div>
<div class="sect3">
<h4 id="_noncompliant_code_example_2">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-vbnet" data-lang="vbnet">Public Class ExampleController
    Inherits Controller

    Private ReadOnly ConnectionString As String

    Public Function Authenticate(User As String, Pass As String) As IActionResult
        Using Connection As New SqlConnection(ConnectionString)
            Dim Query As String = "SELECT * FROM users WHERE user = '" &amp; User &amp; "' AND pass = '" &amp; Pass &amp; "'"

            Dim Result = Connection.QueryFirst(Of UserEntity)(Query)
            If Result Is Nothing Then
                Unauthorized()
            End If
        End Using
        Return Ok()
    End Function
End Class</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution_2">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-vbnet" data-lang="vbnet">Public Class ExampleController
    Inherits Controller

    Private ReadOnly ConnectionString As String

    Public Function Authenticate(User As String, Pass As String) As IActionResult
        Using Connection As New SqlConnection(ConnectionString)
            Dim Query As String = "SELECT * FROM users WHERE user = @UserName AND password = @Password"
            Dim Parameters = New With {.UserName = User, .Password = Pass}

            Dim Result = Connection.QueryFirst(Of UserEntity)(Query, Parameters)
            If Result Is Nothing Then
                Unauthorized()
            End If
        End Using
        Return Ok()
    End Function
End Class</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_how_does_this_work_2">How does this work?</h3>
<div class="sect3">
<h4 id="_use_prepared_statements_2">Use prepared statements</h4>
<div class="paragraph">
<p>As a rule of thumb, the best approach to protect against injections is to
systematically ensure that untrusted data cannot break out of an interpreted
context.</p>
</div>
<div class="paragraph">
<p>For database queries, prepared statements are a natural mechanism to achieve
this due to their internal workings.<br>
Here is an example with the following query string (Java SE syntax):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT * FROM users WHERE user = ? AND pass = ?</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Note: Placeholders may take different forms, depending on the library used. For the above example, the question mark symbol '?' was used as a placeholder.</strong></p>
</div>
<div class="paragraph">
<p>When a prepared statement is used by an application, the database server
compiles the query logic even before the application passes the literals
corresponding to the placeholders to the database.<br>
Some libraries expose a <code>prepareStatement</code> function that explicitly does so,
and some do not - because they do it transparently.</p>
</div>
<div class="paragraph">
<p>The compiled code that contains the query logic also includes the placeholders:
they serve as parameters.</p>
</div>
<div class="paragraph">
<p>After compilation, the query logic is frozen and cannot be changed.<br>
So when the application passes the literals that replace the placeholders, they
are not considered application logic by the database.</p>
</div>
<div class="paragraph">
<p>Consequently, the database server prevents the dynamic literals of a prepared
statement from affecting the underlying query, and thus sanitizes them.</p>
</div>
<div class="paragraph">
<p>On the other hand, the application does not automatically sanitize third-party
data (for example, user-controlled data) inserted directly into a query. An
attacker who controls this third-party data can cause the database to execute
malicious code.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_articles_blog_posts">Articles &amp; blog posts</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://blog.sonarsource.com/exploiting-hibernate-injections/">SonarSource, Exploiting Hibernate Injections</a></p>
</li>
<li>
<p><a href="https://cheatsheetseries.owasp.org/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.html">OWASP, SQL Injection Prevention Cheat Sheet</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_standards">Standards</h3>
<div class="ulist">
<ul>
<li>
<p>OWASP - <a href="https://owasp.org/Top10/A03_2021-Injection/">Top 10 2021 Category A3 - Injection</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-top-ten/2017/A1_2017-Injection">Top 10 2017 Category A1 - Injection</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/20">CWE-20 - Improper Input Validation</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/89">CWE-89 - Improper Neutralization of Special Elements used in an SQL Command</a></p>
</li>
<li>
<p><a href="https://wiki.sei.cmu.edu/confluence/x/ITdGBQ">CERT, IDS00-J.</a> - Prevent SQL injection</p>
</li>
<li>
<p>STIG Viewer - <a href="https://stigviewer.com/stigs/application_security_and_development/2024-12-06/finding/V-222607">Application Security and Development: V-222607</a> - The application must not be vulnerable to SQL Injection.</p>
</li>
<li>
<p>STIG Viewer - <a href="https://stigviewer.com/stigs/application_security_and_development/2024-12-06/finding/V-222609">Application Security and Development: V-222609</a> - The application must not be subject to input handling vulnerabilities.</p>
</li>
</ul>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Change this code to not construct database queries directly from user-controlled data.</p>
</div>
</div>
<div class="sect2">
<h3 id="_highlighting">Highlighting</h3>
<div class="paragraph">
<p>"[varname]" is tainted (assignments and parameters)</p>
</div>
<div class="paragraph">
<p>this argument is tainted (method invocations)</p>
</div>
<div class="paragraph">
<p>the returned value is tainted (returns &amp; method invocations results)</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_is_related_to_s2077">is related to: <a data-rspec-id="S2077" class="rspec-auto-link">S2077</a></h3>

</div>
<div class="sect2">
<h3 id="_on_30_jun_2017_145158_amaury_levé_wrote">on 30 Jun 2017, 14:51:58 Amaury Levé wrote:</h3>
<div class="paragraph">
<p>Could you create the sub-task with all the cases described in the fxcop page?</p>
</div>
<div class="paragraph">
<p><a href="https://msdn.microsoft.com/en-us/library/ms182310.aspx" class="bare">https://msdn.microsoft.com/en-us/library/ms182310.aspx</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_on_30_jun_2017_151029_jean_christophe_collet_wrote">on 30 Jun 2017, 15:10:29 Jean-Christophe Collet wrote:</h3>
<div class="paragraph">
<p>Done</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_5_apr_2018_193103_ann_campbell_wrote">on 5 Apr 2018, 19:31:03 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~dinesh.bolkensteyn] all commentary should be concentrated in the description, not distributed throughout the code samples as well. I suggest something like</p>
</div>
<div class="paragraph">
<p><em><em>_Tainted data should be sanitized before use by for instance using prepared statements instead of concatenation.</em>_</em></p>
</div>
</div>
<div class="sect2">
<h3 id="_on_5_apr_2018_195820_dinesh_bolkensteyn_wrote">on 5 Apr 2018, 19:58:20 Dinesh Bolkensteyn wrote:</h3>
<div class="paragraph">
<p>Thanks [~ann.campbell.2] Could you please check again &amp; directly update this RSPEC if there are further things to improve?</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_5_apr_2018_202712_ann_campbell_wrote">on 5 Apr 2018, 20:27:12 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>Looks good [~dinesh.bolkensteyn]</p>
</div>
</div>
</div>
</div>