<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Memory allocation injections occur when an application computes the size of a piece of memory to be allocated from an
untrusted source. In such a case, an attacker could be able to make the application unwillingly consume an important
amount of memory by enforcing a large allocation size.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By repeatedly requesting a feature that consumes a lot of memory, attackers can constantly occupy
an important part of an application&#8217;s hosting server memory. Depending on the application&#8217;s deployment architecture, hosting server
resources and attackers' capabilities, this can lead to an exhaustion of the available server&#8217;s memory.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>A server that faces a memory exhaustion situation can become unstable. The exact impact will depend on how the
affected application is deployed and how well the hosting server configuration is hardened.</p>
</div>
<div class="paragraph">
<p>In the worst case, when the application is deployed in an uncontained environment, directly on its host system, the
memory exhaustion will affect the whole hosting server. The server&#8217;s operating system might start killing arbitrary
memory-intensive processes, including the main application or other sensitive ones. This will result in a general
operating failure, also known as a Denial of Service (DoS).</p>
</div>
<div class="paragraph">
<p>In cases where the application is deployed in a virtualized or otherwise contained environment, or where memory usage
limits are in place, the consequences are limited to the vulnerable application only. In that case, other processes and
applications hosted on the same server may keep on running without perturbation. The mainly affected application will
still stop working properly.</p>
</div>
<div class="paragraph">
<p>In general, that kind of DoS attack can have severe financial consequences. They are particularly important when the
affected systems are business-critical.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it_in_net">How to fix it in .NET</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="paragraph">
<p>The following code is vulnerable to a memory allocation injection because
the size of a memory allocation is determined using a user-controlled source.
It then performs the actual allocation without any verification or other
sanitization over the provided size.</p>
</div>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-csharp" data-lang="csharp">[Route("NonCompliantArrayList")]
public string NonCompliantArrayList()
{
    int size;
    try
    {
        size = int.Parse(Request.Query["size"]);
    }
    catch (FormatException)
    {
        return "Number format exception while reading size";
    }
    ArrayList arrayList = new ArrayList(size); // Noncompliant
    return size + " bytes were allocated.";
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-csharp" data-lang="csharp">public const int MAX_ALLOC_SIZE = 1024;

[Route("CompliantArrayList")]
public string CompliantArrayList()
{
    int size;
    try
    {
        size = int.Parse(Request.Query["size"]);
    }
    catch (FormatException)
    {
        return "Number format exception while reading size";
    }
    size = Math.Min(size, MAX_ALLOC_SIZE);
    ArrayList arrayList = new ArrayList(size);
    return size + " bytes were allocated.";
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_how_does_this_work">How does this work?</h3>
<div class="sect3">
<h4 id="_enforce_an_upper_limit">Enforce an upper limit</h4>
<div class="paragraph">
<p>When performing a memory allocation whose size depends on a user-controlled
parameter, it is of prime importance to enforce an upper limit to the size
being allocated. This will prevent any overly big memory slot from being
consumed by a single allocation.</p>
</div>
<div class="paragraph">
<p>Note that forcing an upper limit will not prevent Denial of Service attacks.
When an allocation size is restricted to a reasonable amount, attackers can
still request the allocating feature multiple times until the combined allocation
size becomes big enough to cause exhaustion. However, the smaller the allowed
allocation size, the higher the number of necessary requests and, thus, the
higher the required resources on the attacker side. As for most of the DoS
attack vectors, a trade-off must be found to prevent most attackers from causing
exhaustion while keeping a good level of performance and usability.</p>
</div>
<div class="paragraph">
<p>Here, the example compliant code uses the <code>Math.Min</code> function to enforce a
reasonable upper bound to the allocation size. In that case, no more than 1024
bytes can be allocated at a time.</p>
</div>
</div>
<div class="sect3">
<h4 id="_harden_the_execution_environment_configuration">Harden the execution environment configuration</h4>
<div class="paragraph">
<p>As a defense in depth measure, it is advised to harden the execution environment
configuration regarding memory usage. This can effectively reduce the scope of a
successful Denial of Service attack and prevent a complete outage, potentially
ranging over multiple applications.</p>
</div>
<div class="paragraph">
<p>When running the application in a contained environment, like a Docker
container, it is usually possible to limit the amount of memory provided to the
contained environment. In that case, memory exhaustion will only impact the
application hosting container and not the host system.</p>
</div>
<div class="paragraph">
<p>When running the application directly on a physical or heavy virtualized server,
memory limits can sometimes be set on the application&#8217;s associated service
account. For example, the <code>ulimit</code> mechanism of Unix based operating systems can
be used for that purpose. With such a limit set up, memory exhaustion only
impacts the applications and processes owned by the related service
account.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://owasp.org/www-community/attacks/Denial_of_Service">OWASP</a> - Denial of Service</p>
</li>
<li>
<p><a href="https://man.archlinux.org/man/core/pam/pam_limits.8.en">archlinux.org</a> - pam_limits - PAM module to limit resources</p>
</li>
<li>
<p><a href="https://access.redhat.com/solutions/1257953">RedHat</a> - How to set limits for services in RHEL and systemd</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_standards">Standards</h3>
<div class="ulist">
<ul>
<li>
<p>OWASP - <a href="https://owasp.org/Top10/A03_2021-Injection/">Top 10 2021 Category A3 - Injection</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-top-ten/2017/A1_2017-Injection">Top 10 2017 Category A1 - Injection</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/789">CWE-789 - Memory Allocation with Excessive Size Value</a></p>
</li>
<li>
<p>STIG Viewer - <a href="https://stigviewer.com/stigs/application_security_and_development/2024-12-06/finding/V-222594">Application Security and Development: V-222594</a> - The application must restrict the ability to launch Denial of Service (DoS) attacks against itself or other information systems.</p>
</li>
<li>
<p>STIG Viewer - <a href="https://stigviewer.com/stigs/application_security_and_development/2024-12-06/finding/V-222667">Application Security and Development: V-222667</a> - Protections against DoS attacks must be implemented.</p>
</li>
<li>
<p>STIG Viewer - <a href="https://stigviewer.com/stigs/application_security_and_development/2024-12-06/finding/V-222609">Application Security and Development: V-222609</a> - The application must not be subject to input handling vulnerabilities.</p>
</li>
</ul>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Change this code to not allocate memory based on user-controlled size.</p>
</div>
<hr>
</div>
</div>
</div>