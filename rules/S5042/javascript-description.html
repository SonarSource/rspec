<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Successful Zip Bomb attacks occur when an application expands untrusted archive files without controlling the size of the expanded data, which can lead to denial of service. A Zip bomb is usually a malicious archive file of a few kilobytes of compressed data but turned into gigabytes of uncompressed data. To achieve this extreme <a href="https://en.wikipedia.org/wiki/Data_compression_ratio">compression ratio</a>, attackers will compress irrelevant data (eg: a long string of repeated bytes).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ask_yourself_whether">Ask Yourself Whether</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Archives to expand are untrusted and:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>There is no validation of the number of entries in the archive.</p>
</li>
<li>
<p>There is no validation of the total size of the uncompressed data.</p>
</li>
<li>
<p>There is no validation of the ratio between the compressed and uncompressed archive entry.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is a risk if you answered yes to any of those questions.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_recommended_secure_coding_practices">Recommended Secure Coding Practices</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Define and control the ratio between compressed and uncompressed data, in general the data compression ratio for most of the legit archives is 1 to 3.</p>
</li>
<li>
<p>Define and control the threshold for maximum total size of the uncompressed data.</p>
</li>
<li>
<p>Count the number of file entries extracted from the archive and abort the extraction if their number is greater than a predefined threshold, in particular it&#8217;s not recommended to recursively expand archives (an entry of an archive could be also an archive).</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sensitive_code_example">Sensitive Code Example</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For <a href="https://github.com/npm/node-tar">tar</a> module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>const tar = require('tar');

tar.x({ // Sensitive
  file: 'foo.tar.gz'
});</pre>
</div>
</div>
<div class="paragraph">
<p>For <a href="https://github.com/cthackers/adm-zip">adm-zip</a> module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>const AdmZip = require('adm-zip');

let zip = new AdmZip("./foo.zip");
zip.extractAllTo("."); // Sensitive</pre>
</div>
</div>
<div class="paragraph">
<p>For <a href="https://stuk.github.io/jszip/">jszip</a> module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>const fs = require("fs");
const JSZip = require("jszip");

fs.readFile("foo.zip", function(err, data) {
  if (err) throw err;
  JSZip.loadAsync(data).then(function (zip) { // Sensitive
    zip.forEach(function (relativePath, zipEntry) {
      if (!zip.file(zipEntry.name)) {
        fs.mkdirSync(zipEntry.name);
      } else {
        zip.file(zipEntry.name).async('nodebuffer').then(function (content) {
          fs.writeFileSync(zipEntry.name, content);
        });
      }
    });
  });
});</pre>
</div>
</div>
<div class="paragraph">
<p>For <a href="https://github.com/thejoshwolfe/yauzl">yauzl</a> module</p>
</div>
<div class="listingblock">
<div class="content">
<pre>const yauzl = require('yauzl');

yauzl.open('foo.zip', function (err, zipfile) {
  if (err) throw err;

  zipfile.on("entry", function(entry) {
    zipfile.openReadStream(entry, function(err, readStream) {
      if (err) throw err;
      // TODO: extract
    });
  });
});</pre>
</div>
</div>
<div class="paragraph">
<p>For <a href="https://github.com/maxogden/extract-zip">extract-zip</a> module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>const extract = require('extract-zip')

async function main() {
  let target = __dirname + '/test';
  await extract('test.zip', { dir: target }); // Sensitive
}
main();</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compliant_solution">Compliant Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For <a href="https://github.com/npm/node-tar">tar</a> module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const tar = require('tar');
const MAX_FILES = 10000;
const MAX_SIZE = 1000000000; // 1 GB

let fileCount = 0;
let totalSize = 0;

tar.x({
  file: 'foo.tar.gz',
  filter: (path, entry) =&gt; {
    fileCount++;
    if (fileCount &gt; MAX_FILES) {
      throw 'Reached max. number of files';
    }

    totalSize += entry.size;
    if (totalSize &gt; MAX_SIZE) {
      throw 'Reached max. size';
    }

    return true;
  }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>For <a href="https://github.com/cthackers/adm-zip">adm-zip</a> module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const AdmZip = require('adm-zip');
const MAX_FILES = 10000;
const MAX_SIZE = 1000000000; // 1 GB
const THRESHOLD_RATIO = 10;

let fileCount = 0;
let totalSize = 0;
let zip = new AdmZip("./foo.zip");
let zipEntries = zip.getEntries();
zipEntries.forEach(function(zipEntry) {
    fileCount++;
    if (fileCount &gt; MAX_FILES) {
        throw 'Reached max. number of files';
    }

    let entrySize = zipEntry.getData().length;
    totalSize += entrySize;
    if (totalSize &gt; MAX_SIZE) {
        throw 'Reached max. size';
    }

    let compressionRatio = entrySize / zipEntry.header.compressedSize;
    if (compressionRatio &gt; THRESHOLD_RATIO) {
        throw 'Reached max. compression ratio';
    }

    if (!zipEntry.isDirectory) {
        zip.extractEntryTo(zipEntry.entryName, ".");
    }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>For <a href="https://stuk.github.io/jszip/">jszip</a> module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const fs = require("fs");
const pathmodule = require("path");
const JSZip = require("jszip");

const MAX_FILES = 10000;
const MAX_SIZE = 1000000000; // 1 GB

let fileCount = 0;
let totalSize = 0;
let targetDirectory = __dirname + '/archive_tmp';

fs.readFile("foo.zip", function(err, data) {
  if (err) throw err;
  JSZip.loadAsync(data).then(function (zip) {
    zip.forEach(function (relativePath, zipEntry) {
      fileCount++;
      if (fileCount &gt; MAX_FILES) {
        throw 'Reached max. number of files';
      }

      // Prevent ZipSlip path traversal (S6096)
      const resolvedPath = pathmodule.join(targetDirectory, zipEntry.name);
      if (!resolvedPath.startsWith(targetDirectory)) {
        throw 'Path traversal detected';
      }

      if (!zip.file(zipEntry.name)) {
        fs.mkdirSync(resolvedPath);
      } else {
        zip.file(zipEntry.name).async('nodebuffer').then(function (content) {
          totalSize += content.length;
          if (totalSize &gt; MAX_SIZE) {
            throw 'Reached max. size';
          }

          fs.writeFileSync(resolvedPath, content);
        });
      }
    });
  });
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Be aware that due to the similar structure of sensitive and compliant code the issue will be raised in both cases. It is up to the developer to decide if the implementation is secure.</p>
</div>
<div class="paragraph">
<p>For <a href="https://github.com/thejoshwolfe/yauzl">yauzl</a> module</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const yauzl = require('yauzl');

const MAX_FILES = 10000;
const MAX_SIZE = 1000000000; // 1 GB
const THRESHOLD_RATIO = 10;

yauzl.open('foo.zip', function (err, zipfile) {
  if (err) throw err;

  let fileCount = 0;
  let totalSize = 0;

  zipfile.on("entry", function(entry) {
    fileCount++;
    if (fileCount &gt; MAX_FILES) {
      throw 'Reached max. number of files';
    }

    // The uncompressedSize comes from the zip headers, so it might not be trustworthy.
    // Alternatively, calculate the size from the readStream.
    let entrySize = entry.uncompressedSize;
    totalSize += entrySize;
    if (totalSize &gt; MAX_SIZE) {
      throw 'Reached max. size';
    }

    if (entry.compressedSize &gt; 0) {
      let compressionRatio = entrySize / entry.compressedSize;
      if (compressionRatio &gt; THRESHOLD_RATIO) {
        throw 'Reached max. compression ratio';
      }
    }

    zipfile.openReadStream(entry, function(err, readStream) {
      if (err) throw err;
      // TODO: extract
    });
  });
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Be aware that due to the similar structure of sensitive and compliant code the issue will be raised in both cases. It is up to the developer to decide if the implementation is secure.</p>
</div>
<div class="paragraph">
<p>For <a href="https://github.com/maxogden/extract-zip">extract-zip</a> module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const extract = require('extract-zip')

const MAX_FILES = 10000;
const MAX_SIZE = 1000000000; // 1 GB
const THRESHOLD_RATIO = 10;

async function main() {
  let fileCount = 0;
  let totalSize = 0;

  let target = __dirname + '/foo';
  await extract('foo.zip', {
    dir: target,
    onEntry: function(entry, zipfile) {
      fileCount++;
      if (fileCount &gt; MAX_FILES) {
        throw 'Reached max. number of files';
      }

      // The uncompressedSize comes from the zip headers, so it might not be trustworthy.
      // Alternatively, calculate the size from the readStream.
      let entrySize = entry.uncompressedSize;
      totalSize += entrySize;
      if (totalSize &gt; MAX_SIZE) {
        throw 'Reached max. size';
      }

      if (entry.compressedSize &gt; 0) {
        let compressionRatio = entrySize / entry.compressedSize;
        if (compressionRatio &gt; THRESHOLD_RATIO) {
          throw 'Reached max. compression ratio';
        }
      }
    }
  });
}
main();</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>OWASP - <a href="https://owasp.org/Top10/A01_2021-Broken_Access_Control/">Top 10 2021 Category A1 - Broken Access Control</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/Top10/A05_2021-Security_Misconfiguration/">Top 10 2021 Category A5 - Security Misconfiguration</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-top-ten/2017/A5_2017-Broken_Access_Control">Top 10 2017 Category A5 - Broken Access Control</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-top-ten/2017/A6_2017-Security_Misconfiguration">Top 10 2017 Category A6 - Security Misconfiguration</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/409">CWE-409 - Improper Handling of Highly Compressed Data (Data Amplification)</a></p>
</li>
<li>
<p><a href="https://www.bamsoftware.com/hacks/zipbomb/">bamsoftware.com</a> - A better Zip Bomb</p>
</li>
</ul>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Make sure that expanding this archive file is safe here.</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_on_16_nov_2018_154842_alexandre_gigleux_wrote">on 16 Nov 2018, 15:48:42 Alexandre Gigleux wrote:</h3>
<div class="paragraph">
<p>TODO: update CERT WIKI once implemented</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_16_nov_2018_155932_ann_campbell_wrote">on 16 Nov 2018, 15:59:32 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~alexandre.gigleux] can "Expanding" be used here instead of "Uncompressing"? It sounds more natural to me.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_17_nov_2018_150121_alexandre_gigleux_wrote">on 17 Nov 2018, 15:01:21 Alexandre Gigleux wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2] What about "Unpacking"?</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_19_nov_2018_130935_ann_campbell_wrote">on 19 Nov 2018, 13:09:35 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>It&#8217;s not common usage [~alexandre.gigleux]</p>
</div>
</div>
</div>
</div>