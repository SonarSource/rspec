<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Creating custom roles that allow privilege escalation can allow attackers to
maliciously exploit an organization&#8217;s cloud resources.</p>
</div>
<div class="paragraph">
<p>Certain GCP permissions allow impersonation of one or more privileged principals
within a GCP infrastructure.<br>
To prevent privilege escalation after an account has been compromised,
proactively follow GCP Security Insights and ensure that custom roles contain
as few privileges as possible that allow direct or indirect impersonation.</p>
</div>
<div class="paragraph">
<p>For example, privileges like <code>deploymentmanager.deployments.create</code> allow
impersonation of service accounts, even if the name does not sound like it.<br>
Other privileges like <code>setIamPolicy</code>, which are more explicit, directly allow
their holder to extend their privileges.</p>
</div>
<div class="paragraph">
<p>After gaining a foothold in the target infrastructure, sophisticated attackers
typically map their newfound roles to understand what is exploitable.</p>
</div>
<div class="paragraph">
<p>The riskiest privileges are either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>At the infrastructure level: privileges to perform project, folder, or
organization-wide administrative tasks.</p>
</li>
<li>
<p>At the resource level: privileges to perform resource-wide administrative tasks.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In either case, the following privileges should be avoided or granted only with
caution:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code><strong>.</strong>.setIamPolicy</code></p>
</li>
<li>
<p><code>cloudbuilds.builds.create</code></p>
</li>
<li>
<p><code>cloudfunctions.functions.create</code></p>
</li>
<li>
<p><code>cloudfunctions.functions.update</code></p>
</li>
<li>
<p><code>cloudscheduler.jobs.create</code></p>
</li>
<li>
<p><code>composer.environments.create</code></p>
</li>
<li>
<p><code>compute.instances.create</code></p>
</li>
<li>
<p><code>dataflow.jobs.create</code></p>
</li>
<li>
<p><code>dataproc.clusters.create</code></p>
</li>
<li>
<p><code>deploymentmanager.deployments.create</code></p>
</li>
<li>
<p><code>iam.roles.update</code></p>
</li>
<li>
<p><code>iam.serviceAccountKeys.create</code></p>
</li>
<li>
<p><code>iam.serviceAccounts.actAs</code></p>
</li>
<li>
<p><code>iam.serviceAccounts.getAccessToken</code></p>
</li>
<li>
<p><code>iam.serviceAccounts.getOpenIdToken</code></p>
</li>
<li>
<p><code>iam.serviceAccounts.implicitDelegation</code></p>
</li>
<li>
<p><code>iam.serviceAccounts.signBlob</code></p>
</li>
<li>
<p><code>iam.serviceAccounts.signJwt</code></p>
</li>
<li>
<p><code>orgpolicy.policy.set</code></p>
</li>
<li>
<p><code>run.services.create</code></p>
</li>
<li>
<p><code>serviceusage.apiKeys.create</code></p>
</li>
<li>
<p><code>serviceusage.apiKeys.list</code></p>
</li>
<li>
<p><code>storage.hmacKeys.create</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ask_yourself_whether">Ask Yourself Whether</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>This role requires impersonation to perform specific tasks with different
privileges.</p>
</li>
<li>
<p>This custom role is intended for a small group of administrators.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is a risk if you answered no to these questions.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_recommended_secure_coding_practices">Recommended Secure Coding Practices</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use a permission that does not allow privilege escalation.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sensitive_code_example">Sensitive Code Example</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Lightweight custom role intended for a developer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-terraform" data-lang="terraform">resource "google_organization_iam_custom_role" "example" {
  permissions = [
    "iam.serviceAccounts.getAccessToken",     # Sensitive
    "iam.serviceAccounts.getOpenIdToken",     # Sensitive
    "iam.serviceAccounts.actAs",              # Sensitive
    "iam.serviceAccounts.implicitDelegation", # Sensitive
    "resourcemanager.projects.get",
    "resourcemanager.projects.list",
    "run.services.create",
    "run.services.delete",
    "run.services.get",
    "run.services.getIamPolicy",
    "run.services.list",
    "run.services.update",
  ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Lightweight custom role intended for a read-only user:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-terraform" data-lang="terraform">resource "google_project_iam_custom_role" "example" {
  permissions = [
    "iam.serviceAccountKeys.create",        # Sensitive
    "iam.serviceAccountKeys.get",           # Sensitive
    "deploymentmanager.deployments.create", # Sensitive
    "cloudbuild.builds.create",             # Sensitive
    "resourcemanager.projects.get",
    "resourcemanager.projects.list",
    "run.services.get",
    "run.services.getIamPolicy",
    "run.services.list",
  ]
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compliant_solution">Compliant Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Lightweight custom role intended for a developer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-terraform" data-lang="terraform">resource "google_project_iam_custom_role" "example" {
  permissions = [
    "resourcemanager.projects.get",
    "resourcemanager.projects.list",
    "run.services.create",
    "run.services.delete",
    "run.services.get",
    "run.services.getIamPolicy",
    "run.services.list",
    "run.services.update",
  ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Lightweight custom role intended for a read-only user:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-terraform" data-lang="terraform">resource "google_project_iam_custom_role" "example" {
  permissions = [
    "resourcemanager.projects.get",
    "resourcemanager.projects.list",
    "run.services.get",
    "run.services.getIamPolicy",
    "run.services.list",
  ]
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://cloud.google.com/iam/docs/custom-roles-permissions-support">GCP IAM Docs</a> - Support levels for permissions in custom roles</p>
</li>
<li>
<p><a href="https://cloud.google.com/iam/docs/understanding-custom-roles">GCP IAM Docs</a> - Understanding IAM custom roles</p>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=Z-JFVJZ-HDA">DEFONConference Youtube Video</a> - DEF CON Safe Mode - Dylan Ayrey and Allison Donovan - Lateral Movement &amp; Privilege Escalation in GCP</p>
</li>
<li>
<p><a href="https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/">Rhino Security Labs</a> - Privilege Escalation in Google Cloud Platform - Part 1 (IAM)</p>
</li>
<li>
<p><a href="https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/">Rhino Security Labs</a> - Privilege Escalation in Google Cloud Platform - Part 2 (Non-IAM)</p>
</li>
<li>
<p><a href="https://www.praetorian.com/blog/google-cloud-platform-gcp-service-account-based-privilege-escalation-paths/">Praetorian</a> - Google Cloud Platform (GCP) Service Account-based Privilege Escalation paths</p>
</li>
<li>
<p><a href="https://cloud.google.com/iam/docs/manage-policy-insights">GCP Docs</a> - Security Insights</p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/668">CWE-668 - Exposure of Resource to Wrong Sphere</a></p>
</li>
</ul>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Make sure that using a permission that allows privilege escalation is safe here.</p>
</div>
</div>
<div class="sect2">
<h3 id="_highlighting">Highlighting</h3>
<div class="paragraph">
<p>Highlight the sensitive list item.</p>
</div>
</div>
</div>
</div>