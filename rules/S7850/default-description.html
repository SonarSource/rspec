<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This rule raises an issue when code downloads remote files to the server only to immediately serve them to users.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Downloading remote files to your server before serving them to users creates unnecessary overhead and performance problems.</p>
</div>
<div class="paragraph">
<p>When you use methods like <code>open()</code> or <code>Net::HTTP.get()</code> to fetch a remote file and then immediately serve it with <code>send_data</code>, your server becomes a middleman in the file transfer. This approach has several drawbacks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Resource consumption</strong>: Your server uses memory and CPU to download and temporarily store files that could be served directly</p>
</li>
<li>
<p><strong>Increased latency</strong>: Users wait for two network transfers instead of one - first from remote storage to your server, then from your server to the user</p>
</li>
<li>
<p><strong>Process blocking</strong>: Your application processes are tied up handling file transfers instead of serving other requests</p>
</li>
<li>
<p><strong>Bandwidth costs</strong>: You pay for both inbound and outbound data transfer</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This pattern is particularly problematic with large files or high traffic, as it can quickly exhaust server resources and degrade application performance.</p>
</div>
<div class="paragraph">
<p>Cloud storage services like AWS S3, Google Cloud Storage, and Azure Blob Storage provide signed URLs specifically to avoid this problem. These URLs allow users to download files directly from the storage service while maintaining access control.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>This inefficient pattern can lead to server resource exhaustion, increased response times, and higher infrastructure costs. In high-traffic scenarios, it may cause application timeouts or crashes due to memory or process limits being exceeded.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When using Net::HTTP or similar libraries, avoid downloading remote files just to serve them. Use streaming or redirect approaches instead.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">def serve_remote_file
  uri = URI(params[:file_url])
  response = Net::HTTP.get_response(uri) # Noncompliant
  send_data response.body, type: response.content_type
end</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">def serve_remote_file
  # Generate a signed URL or use a streaming proxy
  signed_url = generate_signed_url(params[:file_id])
  redirect_to signed_url
end</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it_in_rails">How to fix it in Rails</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use redirect to signed URLs instead of downloading and serving files. Most cloud storage services provide methods to generate time-limited signed URLs that allow direct access while maintaining security.</p>
</div>
<div class="sect2">
<h3 id="_code_examples_2">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example_2">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">def download
  @attachment = Attachment.find(params[:id])
  data = open(@attachment.file.url) # Noncompliant
  send_data data.read, filename: "file.pdf", type: "application/pdf"
end</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution_2">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">def download
  @attachment = Attachment.find(params[:id])
  redirect_to @attachment.file.expiring_url(10.minutes)
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>Avoid using send_file with remote URLs as it will fail. Instead, generate signed URLs and redirect users directly to the storage service.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_code_examples_3">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example_3">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">def show
  @attachment = Attachment.find(params[:id])
  send_file(@attachment.file.url, disposition: 'attachment') # Noncompliant
end</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution_3">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">def show
  @attachment = Attachment.find(params[:id])
  @download_url = @attachment.file.expiring_url(10.minutes)
  # Use @download_url in your view template
end</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>AWS S3 Presigned URLs - <a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/presigned-urls.html">Official AWS documentation on generating presigned URLs for direct file access</a></p>
</li>
<li>
<p>Rails send_file Documentation - <a href="https://api.rubyonrails.org/classes/ActionController/DataStreaming.html#method-i-send_file">Rails documentation explaining send_file limitations with remote URLs</a></p>
</li>
<li>
<p>Carrierwave Direct Upload - <a href="https://github.com/carrierwaveuploader/carrierwave#direct-upload">Guide on implementing direct uploads to avoid server-side file handling</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_standards">Standards</h3>
<div class="ulist">
<ul>
<li>
<p>CWE-400: Uncontrolled Resource Consumption - <a href="https://cwe.mitre.org/data/definitions/400.html">Relates to inefficient resource usage that can lead to denial of service</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>