<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Using <code>ENV</code> and <code>ARG</code> to handle secrets can lead to sensitive information being
disclosed
to an inappropriate sphere.</p>
</div>
<div class="paragraph">
<p>The <code>ARG</code> and <code>ENV</code> instructions in a Dockerfile are used to configure the image
build and the container environment respectively. Both can be used at image
build time,
during the execution of commands in the container, and <code>ENV</code> can also be used
at runtime.</p>
</div>
<div class="paragraph">
<p>In most cases, build-time and environment variables are used to propagate
configuration items
from the host to the image or container. A typical example for an environmental
variable is the <code>PATH</code> variable, used
to configure where system executables are searched for.</p>
</div>
<div class="paragraph">
<p>Using <code>ARG</code> and <code>ENV</code> to propagate configuration entries that contain secrets
causes a
security risk. Indeed, in most cases, artifacts of those values are kept in the
final image. The secret information
leak can happen either in the container environment itself, the image
metadata or the build environment logs.</p>
</div>
<div class="paragraph">
<p>The concrete impact of such an issue highly depends on the secret&#8217;s purpose and
the exposure sphere:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Financial impact if a paid service API key is disclosed and used.</p>
</li>
<li>
<p>Application compromise if an application&#8217;s secret, like a session signing
key, is disclosed.</p>
</li>
<li>
<p>Infrastructure component takeover, if a system secret, like a remote access
key, is leaked.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ask_yourself_whether">Ask Yourself Whether</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>The variable contains a value that should be kept confidential.</p>
</li>
<li>
<p>The container image or Dockerfile will be distributed to users who do not need to know the secret value.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is a risk if you answered yes to any of those questions.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_recommended_secure_coding_practices">Recommended Secure Coding Practices</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Use Buildkit&#8217;s secret mount options when secrets have to be used at build
time.</p>
</li>
<li>
<p>For run time secret variables, best practices would recommend only setting
them at runtime, for example with the <code>--env</code> option of the <code>docker run</code> command.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that, in both cases, the files exposing the secrets should be securely
stored and not exposed to a large sphere. In most cases, using a secret vault or
another similar component should be preferred. For example, <strong>Docker Swarm</strong>
provides a <strong>secrets</strong> service that can be used to handle most confidential data.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sensitive_code_example">Sensitive Code Example</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-docker" data-lang="docker">FROM example
# Sensitive
ARG ACCESS_TOKEN
# Sensitive
ENV ACCESS_TOKEN=${ACCESS_TOKEN}
CMD /run.sh</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compliant_solution">Compliant Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For build time secrets, use <a href="https://docs.docker.com/engine/reference/builder/#run---mounttypesecret">Buildkit&#8217;s secret mount type</a> instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-docker" data-lang="docker">FROM example
RUN --mount=type=secret,id=build_secret ./installer.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>For runtime secrets, leave the environment variables empty until runtime:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-docker" data-lang="docker">FROM example
ENV ACCESS_TOKEN=""
CMD /run.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>Store the runtime secrets in an <a href="https://docs.docker.com/compose/env-file/">environment file</a> (such as <code>.env</code>) and then start the container with the <a href="https://docs.docker.com/engine/reference/commandline/run/#env"><code>--env-file</code></a> argument:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-docker" data-lang="docker">docker run --env-file .env myImage</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.docker.com/engine/reference/builder/#env">Dockerfile reference</a>  - ENV command</p>
</li>
<li>
<p><a href="https://docs.docker.com/engine/reference/builder/#arg">Dockerfile reference</a>  - ARG command</p>
</li>
<li>
<p><a href="https://docs.docker.com/engine/reference/builder/#run---mounttypesecret">Dockerfile reference</a> - RUN command secrets mount points</p>
</li>
<li>
<p><a href="https://docs.docker.com/engine/swarm/secrets/">Docker documentation</a> - Manage sensitive data with Docker secrets</p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/522">CWE-522 - Insufficiently Protected Credentials</a></p>
</li>
</ul>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_message">Message</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When a dangerous environment variable is found:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Make sure that using ENV to handle a secret is safe here.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When a dangerous argument variable is found:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Make sure that using ARG to handle a secret is safe here.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_highlighting">Highlighting</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The environment or argument variable name.</p>
</div>
<hr>
</div>
</div>