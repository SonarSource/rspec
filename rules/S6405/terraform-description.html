<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>SSH keys stored and managed in a project&#8217;s metadata can be used to access GCP VM instances. By default, GCP automatically deploys project-level SSH keys to VM instances.</p>
</div>
<div class="paragraph">
<p>Project-level SSH keys can lead to unauthorized access because:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Their use prevents fine-grained VM-level access control and makes it difficult to follow <a href="https://en.wikipedia.org/wiki/Principle_of_least_privilege">the principle of least privilege</a>.</p>
</li>
<li>
<p>Unlike managed access control with <a href="https://cloud.google.com/compute/docs/instances/managing-instance-access">OS Login</a>, manual cryptographic key management is error-prone and requires careful attention. For example, if a user leaves a project, their SSH keys should be removed from the metadata to prevent unwanted access.</p>
</li>
<li>
<p>If a project-level SSH key is compromised, all VM instances may be compromised.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ask_yourself_whether">Ask Yourself Whether</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>VM instances in a project have different security requirements.</p>
</li>
<li>
<p>Many users with different profiles need access to the VM instances in that project.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is a risk if you answered yes to any of those questions.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_recommended_secure_coding_practices">Recommended Secure Coding Practices</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Block project-level SSH keys by setting the <code>metadata.block-project-ssh-keys</code> argument to <code>true</code></p>
</li>
<li>
<p>Use <a href="https://cloud.google.com/compute/docs/instances/access-overview?_ga=2.125788746.-190863609.1642494607#oslogin">OSLogin</a> to benefit from managed access control.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sensitive_code_example">Sensitive Code Example</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-terraform" data-lang="terraform">resource "google_compute_instance" "example" { # Sensitive, because metadata.block-project-ssh-keys is not set to true
  name         = "example"
  machine_type = "e2-micro"
  zone         = "us-central1-a"

  network_interface {
    network = "default"

    access_config {
    }
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compliant_solution">Compliant Solution</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-terraform" data-lang="terraform">resource "google_compute_instance" "example" {
  name         = "example"
  machine_type = "e2-micro"
  zone         = "us-central1-a"

  metadata = {
    block-project-ssh-keys = true
  }

  network_interface {
    network = "default"

    access_config {
    }
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/266">CWE-266 - Incorrect Privilege Assignment</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/269">CWE-269 - Improper Privilege Management</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/272">CWE-272 - Least Privilege Violation</a></p>
</li>
<li>
<p><a href="https://cloud.google.com/compute/docs/connect/restrict-ssh-keys#remove-metadata-key">GCP Documentation</a> - Restrict SSH keys from VMs</p>
</li>
<li>
<p><a href="https://cloud.google.com/compute/docs/instances/access-overview#risks">GCP Documentation</a> - Risks of manual key management</p>
</li>
</ul>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Make sure that enabling project-wide SSH keys is safe here.</p>
</div>
</div>
</div>
</div>