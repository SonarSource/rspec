<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Floating point math is imprecise because of the challenges of storing such values in a binary representation. Even worse, floating point math is not associative; push a <code>float</code> or a <code>double</code> through a series of simple mathematical operations and the answer will be different based on the order of those operation because of the rounding that takes place at each step.</p>
</div>
<div class="paragraph">
<p>Even simple floating point assignments are not simple:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>float f = 0.1; // 0.100000001490116119384765625
double d = 0.1; // 0.1000000000000000055511151231257827021181583404541015625</pre>
</div>
</div>
<div class="paragraph">
<p>(Results will vary based on compiler and compiler settings);</p>
</div>
<div class="paragraph">
<p>Therefore, the use of the equality (<code>==</code>) and inequality (<code>!=</code>) operators on <code>float</code> or <code>double</code> values is almost always an error. Instead the best course is to avoid floating point comparisons altogether. When that is not possible, you should consider using one of Java&#8217;s float-handling <code>Numbers</code> such as <code>BigDecimal</code> which can properly handle floating point comparisons. A third option is to look not for equality but for whether the value is close enough. I.e. compare the absolute value of the difference between the stored value and the expected value against a margin of acceptable error. Note that this does not cover all cases (<code>NaN</code> and <code>Infinity</code> for instance).</p>
</div>
<div class="paragraph">
<p>This rule checks for the use of direct and indirect equality/inequailty tests on floats and doubles.</p>
</div>
<div class="sect2">
<h3 id="_noncompliant_code_example">Noncompliant code example</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">float myNumber = 3.146;
if ( myNumber == 3.146f ) { //Noncompliant. Because of floating point imprecision, this will be false
  // ...
}
if ( myNumber != 3.146f ) { //Noncompliant. Because of floating point imprecision, this will be true
  // ...
}

if (myNumber &lt; 4 || myNumber &gt; 4) { // Noncompliant; indirect inequality test
  // ...
}

float zeroFloat = 0.0f;
if (zeroFloat == 0) {  // Noncompliant. Computations may end up with a value close but not equal to zero.
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_exceptions">Exceptions</h3>
<div class="paragraph">
<p>Since <code>NaN</code> is not equal to itself, the specific case of testing a floating point value against itself is a valid test for <code>NaN</code> and is therefore ignored. Though using <code>Double.isNaN</code> method should be preferred instead, as intent is more explicit.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">float f;
double d;
if(f != f) { // Compliant; test for NaN value
  System.out.println("f is NaN");
} else if (f != d) { // Noncompliant
  // ...
}</code></pre>
</div>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Equality tests should not be made with floating point values.</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_on_2_oct_2014_090120_nicolas_peru_wrote">on 2 Oct 2014, 09:01:20 Nicolas Peru wrote:</h3>
<div class="paragraph">
<p>Updated message and description based on : http://www.ibm.com/developerworks/library/j-jtp0114/#N101EA</p>
</div>
<div class="paragraph">
<p>Please review.</p>
</div>
<div class="paragraph">
<p>The trick here is to report a correct error message.</p>
</div>
<div class="paragraph">
<p>I am not sure we should detect indirect equality detection as stated in main description (see previous link).</p>
</div>
<div class="paragraph">
<p>I am also wondering about a recommandation to use BigDecimal.compareTo instead of a float equality.</p>
</div>
<div class="paragraph">
<p>I think we should definitely detect those float (in)equality but I am really wondering about what we should recommend as a fix for this issue.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_3_oct_2014_185133_ann_campbell_wrote">on 3 Oct 2014, 18:51:33 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~nicolas.peru] for buggy code code don&#8217;t always have to suggest a fix since there can be many ways to handle it.</p>
</div>
<div class="paragraph">
<p>Having finally read some of the reference you provided, I&#8217;ve updated the description to offer 3 courses of action</p>
</div>
<div class="ulist">
<ul>
<li>
<p>just don&#8217;t do it</p>
</li>
<li>
<p>just a Number such as BigDecimal</p>
</li>
<li>
<p>compare vs margin of error</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Also, I had inadvertently deleted the wrong code sample. Noncompliant code restored to last state (still missing indirect equality tests) and Compliant solution removed.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_9_oct_2014_085951_nicolas_peru_wrote">on 9 Oct 2014, 08:59:51 Nicolas Peru wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2] After mail discussion I updated description, feel free to correct it.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_9_oct_2014_114916_ann_campbell_wrote">on 9 Oct 2014, 11:49:16 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~nicolas.peru] I&#8217;ve updated the inline comments (and code formatting)</p>
</div>
</div>
<div class="sect2">
<h3 id="_is_duplicated_by_s884">is duplicated by: <a data-rspec-id="S884" class="rspec-auto-link">S884</a></h3>

</div>
<div class="sect2">
<h3 id="_on_22_apr_2014_213712_evgeny_mandrikov_wrote">on 22 Apr 2014, 21:37:12 Evgeny Mandrikov wrote:</h3>
<div class="paragraph">
<p>\[~freddy.mallet] [~ann.campbell.2] duplicates <a data-rspec-id="S884" class="rspec-auto-link">RSPEC-884</a> ?</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_23_apr_2014_153008_ann_campbell_wrote">on 23 Apr 2014, 15:30:08 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>Closed the other since this is more fully specified</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_23_apr_2014_155451_evgeny_mandrikov_wrote">on 23 Apr 2014, 15:54:51 Evgeny Mandrikov wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2] For rules coming from MISRA I prefer titles from MISRA instead of hand-crafted ones ;) Same probably for description - I expect it to be good in MISRA.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_17_sep_2014_100101_freddy_mallet_wrote">on 17 Sep 2014, 10:01:01 Freddy Mallet wrote:</h3>
<div class="paragraph">
<p>@Ann, for me the compliant solution is incorrect because if the developer really wants to check for equality, using the "&gt;=" operator is obviously not an option.</p>
</div>
<div class="paragraph">
<p>See MISRA description:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The recommended method for achieving deterministic floating-point comparisons is to write a library</p>
</div>
<div class="paragraph">
<p>that implements the comparison operations. The library should take into account the floating-point</p>
</div>
<div class="paragraph">
<p>granularity (FLT_EPSILON) and the magnitude of the numbers being compared. See also Rule 13.4 and</p>
</div>
<div class="paragraph">
<p>Rule 20.3.</p>
</div>
</blockquote>
</div>
</div>
<div class="sect2">
<h3 id="_on_30_sep_2014_085000_evgeny_mandrikov_wrote">on 30 Sep 2014, 08:50:00 Evgeny Mandrikov wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2] I can&#8217;t finish implementation of this rule with unfinished description - see comment from [~freddy.mallet]</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_30_sep_2014_120034_ann_campbell_wrote">on 30 Sep 2014, 12:00:34 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~evgeny.mandrikov] see the C-Family sub-task</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_30_sep_2014_121412_evgeny_mandrikov_wrote">on 30 Sep 2014, 12:14:12 Evgeny Mandrikov wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2] ok, thx</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_3_oct_2014_081625_nicolas_peru_wrote">on 3 Oct 2014, 08:16:25 Nicolas Peru wrote:</h3>
<div class="paragraph">
<p>I disagree with cases like :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>if(myNumber &lt;= 3.146 &amp;&amp; myNumber &gt;= 3.146)
if (myNumber &lt; 4 || myNumber &gt; 4)</pre>
</div>
</div>
<div class="paragraph">
<p>For me this is crappy code no matter if you are using floating point or not. I truly believe this case should not pollute this rule and be a rule on its own (applied to every numeric type) with the suggestion to refactor it using <code>=</code> or <code>!=</code></p>
</div>
</div>
<div class="sect2">
<h3 id="_on_3_oct_2014_140201_ann_campbell_wrote">on 3 Oct 2014, 14:02:01 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~nicolas.peru] what if the user activates this rule but not the other one?</p>
</div>
<div class="paragraph">
<p>Also, the "crappy" example is drawn almost exactly from MISRA. We can debate whether or not it belongs in the Java implementation (although it is an equality test), but it needs to remain in the main rule.</p>
</div>
</div>
</div>
</div>