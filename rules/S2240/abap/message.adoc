Refactor this piece of code to not stop the execution of the nesting "SELECT" loop before having read all the elements