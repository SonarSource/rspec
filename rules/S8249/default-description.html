<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is an issue when resources that implement a <code>Close()</code> method are created but not closed with a <code>defer</code> statement placed immediately after successful acquisition.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In Go, resources like files, network connections, database connections, and API clients typically implement a <code>Close()</code> method to release system resources. When these resources are not properly closed, they can cause resource leaks that may lead to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Memory leaks</strong>: Unclosed resources consume memory that cannot be reclaimed by the garbage collector</p>
</li>
<li>
<p><strong>File descriptor exhaustion</strong>: Operating systems limit the number of open file descriptors per process</p>
</li>
<li>
<p><strong>Connection pool exhaustion</strong>: Database and network connection pools have limited capacity</p>
</li>
<li>
<p><strong>Performance degradation</strong>: Accumulated leaked resources slow down the application over time</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>defer</code> statement in Go ensures that cleanup code runs when the surrounding function returns, regardless of how it returns (normal return, early return due to error, or panic). This makes <code>defer</code> the idiomatic way to guarantee resource cleanup.</p>
</div>
<div class="paragraph">
<p>Placing the <code>defer</code> statement immediately after successful resource acquisition is crucial. If placed later in the function, early returns due to errors or other conditions may bypass the <code>defer</code> statement, causing the same resource leak the <code>defer</code> was meant to prevent.</p>
</div>
<div class="paragraph">
<p>Go&#8217;s <code>defer</code> mechanism executes deferred functions in Last-In-First-Out (LIFO) order, making it safe to defer multiple resource cleanups in sequence.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>Resource leaks can cause applications to consume increasing amounts of system resources over time, eventually leading to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Application crashes due to resource exhaustion</p>
</li>
<li>
<p>System-wide performance issues affecting other processes</p>
</li>
<li>
<p>Increased infrastructure costs due to higher resource usage</p>
</li>
<li>
<p>Potential security vulnerabilities if resource limits are exploited</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Add a <code>defer</code> statement to close the resource immediately after successful creation and error checking. This ensures the resource is always cleaned up when the function exits.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-go" data-lang="go">client, err := genai.NewClient(ctx, config)
if err != nil {
    return fmt.Errorf("failed to create client: %w", err)
}
// client is never closed - resource leak</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-go" data-lang="go">client, err := genai.NewClient(ctx, config)
if err != nil {
    return fmt.Errorf("failed to create client: %w", err)
}
defer client.Close()</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>Go Tour - Defer - <a href="https://go.dev/tour/flowcontrol/12">Official Go tutorial explaining defer statements and their execution behavior</a></p>
</li>
<li>
<p>Go Blog - Defer, Panic, and Recover - <a href="https://go.dev/blog/defer-panic-and-recover">Comprehensive guide to defer statements with practical examples of resource management</a></p>
</li>
<li>
<p>Effective Go - Defer - <a href="https://go.dev/doc/effective_go#defer">Best practices for using defer statements in Go programs</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_standards">Standards</h3>
<div class="ulist">
<ul>
<li>
<p>CWE-404: Improper Resource Shutdown or Release - <a href="https://cwe.mitre.org/data/definitions/404.html">Weakness related to improper release of system resources</a></p>
</li>
<li>
<p>CWE-772: Missing Release of Resource after Effective Lifetime - <a href="https://cwe.mitre.org/data/definitions/772.html">Weakness where resources are not properly released after use</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>