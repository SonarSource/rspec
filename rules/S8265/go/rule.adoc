This rule raises an issue when code checks if a file exists using `os.Stat()` and then creates the file in a separate operation using `os.Create()` or similar functions.

== Why is this an issue?

Checking file existence and then creating a file in separate operations creates a Time-of-Check-Time-of-Use (TOCTOU) race condition vulnerability.

Between the existence check and the file creation, another process or thread might:

* Create the file, causing your creation to fail unexpectedly
* Delete an existing file, causing your check to be outdated
* Replace the file with a symbolic link pointing to a sensitive location

This race condition window can lead to:

* **Security vulnerabilities**: An attacker could exploit the timing gap to manipulate file operations
* **Unpredictable behavior**: Your application might fail in production under concurrent access
* **Data corruption**: Multiple processes trying to create the same file simultaneously

The fundamental issue is that file system operations are not atomic by default. The state of the file system can change between your check and your action, making your initial check meaningless.

=== What is the potential impact?

Race conditions can lead to security vulnerabilities where attackers exploit the timing gap to manipulate file operations. This can result in unauthorized file access, data corruption, or application crashes in concurrent environments.

== How to fix it

Use `os.OpenFile()` with the `O_CREATE|O_EXCL` flags to atomically create a file only if it doesn't exist. This eliminates the race condition by combining the existence check and creation into a single atomic operation.

=== Code examples

==== Noncompliant code example

[source,go,diff-id=1,diff-type=noncompliant]
----
if _, err := os.Stat(filename); os.IsNotExist(err) {
    file, err := os.Create(filename) // Noncompliant
    if err != nil {
        return err
    }
    defer file.Close()
    // write to file
}
----

==== Compliant solution

[source,go,diff-id=1,diff-type=compliant]
----
file, err := os.OpenFile(filename, os.O_CREATE|os.O_EXCL|os.O_WRONLY, 0644)
if err != nil {
    if os.IsExist(err) {
        // file already exists, handle accordingly
        return fmt.Errorf("file already exists: %s", filename)
    }
    return err
}
defer file.Close()
// write to file
----

== Resources

=== Documentation

 * Go os package documentation - https://pkg.go.dev/os#OpenFile[Official documentation for os.OpenFile and file creation flags]

 * Go file handling best practices - https://go.dev/doc/effective_go#files[Effective Go guidelines for file operations]

=== Standards

 * CWE 367 - https://cwe.mitre.org/data/definitions/367.html[Time-of-check Time-of-use (TOCTOU) Race Condition]

=== Related rules

 * S8261 - File existence should not be tested before attempting to open the file
