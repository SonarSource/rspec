This is an issue when code checks if a file exists and then creates it in separate operations, creating a Time-of-Check-Time-of-Use (TOCTOU) race condition.

== Why is this an issue?

When you check if a file exists and then create it in separate operations, you create a Time-of-Check-Time-of-Use (TOCTOU) race condition vulnerability.

Between the time you check if the file exists and the time you create it, another process or thread might:

* Create the file, causing your creation to fail unexpectedly
* Delete an existing file, causing your check to be outdated
* Replace the file with a symbolic link pointing to a sensitive location

This race condition window can lead to:

* Application crashes or unexpected behavior
* Security vulnerabilities where attackers manipulate file operations
* Data corruption or loss
* Privilege escalation attacks in some scenarios

The fundamental problem is that file system operations are not atomic by default. The state of the file system can change between your check and your action, making your initial check meaningless.

=== What is the potential impact?

Attackers can exploit this race condition to:

* Cause application failures by manipulating file creation timing
* Redirect file operations to unintended locations using symbolic links
* Potentially escalate privileges if the application runs with elevated permissions
* Corrupt data by interfering with file operations at critical moments

== How to fix it

Use atomic file operations instead of separate check and create operations. The `os.OpenFile()` function with `O_CREATE|O_EXCL` flags atomically creates a file only if it doesn't exist, eliminating the race condition.

=== Code examples

==== Noncompliant code example

[source,go,diff-id=1,diff-type=noncompliant]
----
if _, err := os.Stat(filename); os.IsNotExist(err) {
    file, err := os.Create(filename) // Noncompliant
    if err != nil {
        return err
    }
    defer file.Close()
    // handle file creation
}
----

==== Compliant solution

[source,go,diff-id=1,diff-type=compliant]
----
file, err := os.OpenFile(filename, os.O_CREATE|os.O_EXCL|os.O_WRONLY, 0644)
if err != nil {
    if os.IsExist(err) {
        // file already exists
        return fmt.Errorf("file already exists: %s", filename)
    }
    return err
}
defer file.Close()
// handle file creation
----

== Resources

=== Documentation

 * Go os package documentation - https://pkg.go.dev/os#OpenFile[Official documentation for os.OpenFile and file operation flags]

 * OWASP Race Conditions - https://owasp.org/www-community/vulnerabilities/Race_Conditions[OWASP guide on race condition vulnerabilities]

=== Standards

 * CWE 367 - https://cwe.mitre.org/data/definitions/367.html[Time-of-check Time-of-use (TOCTOU) Race Condition]

=== Related rules

 * S5847 - File existence should not be tested before attempting to open the file (C/C++)
