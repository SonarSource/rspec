Disabling Azure-managed RBAC on Kubernetes clusters can reduce an organization's ability to protect itself against access control compromise.

Using Role-Based Access Control is better for [REASONS]

In case of security incident, Role-Based Access control will allow operations team to mitigate account theft and malicious accesses.

== Ask Yourself Whether

* This Azure resource is essential for the information system infrastructure.
* This Azure resource is essential for mission-critical functions.
* Compliance policies require access to this resource to specifically be authenticated with Role-Based Access Control.

There is a risk if you answered yes to any of those questions.

== Recommended Secure Coding Practices

Enable Role-Based Access Control. And if link it to Azure Active Directory.

== Sensitive Code Example

For https://azure.microsoft.com/fr-fr/services/kubernetes-service/[Azure Kubernetes Services]:

----
resource "azurerm_kubernetes_cluster" "example" {
  name                = "${var.prefix}-k8s"
  location            = azurerm_resource_group.example.location
  resource_group_name = azurerm_resource_group.example.name

  role_based_access_control {
    enabled = true

    azure_active_directory {
      managed = true
      azure_rbac_enabled = false # Sensitive
    }
  }
}
----

For https://azure.microsoft.com/fr-fr/services/key-vault/[Key Vaults]:

----
resource "azurerm_key_vault" "production" {
  name                        = "${var.prefix}keyvault"
  enable_rbac_authorization   = false # Sensitive

  access_policy {
    key_permissions = [
      "Get",
    ]

    secret_permissions = [
      "Get",
    ]

    storage_permissions = [
      "Get",
    ]
  }
}
----

== Compliant Solution

For https://azure.microsoft.com/fr-fr/services/kubernetes-service/[Azure Kubernetes Services]:

----
resource "azurerm_kubernetes_cluster" "example" {
  name                = "${var.prefix}-k8s"
  location            = azurerm_resource_group.example.location
  resource_group_name = azurerm_resource_group.example.name

  role_based_access_control {
    enabled = true

    azure_active_directory {
      managed = true
      azure_rbac_enabled = true
    }
  }
}
----

For https://azure.microsoft.com/fr-fr/services/key-vault/[Key Vaults]:

----
resource "azurerm_key_vault" "production" {
  name                        = "${var.prefix}keyvault"
  enable_rbac_authorization   = true

  access_policy {
    key_permissions = [
      "Get",
    ]

    secret_permissions = [
      "Get",
    ]

    storage_permissions = [
      "Get",
    ]
  }
}
----

== See

* https://owasp.org/Top10/A01_2021-Broken_Access_Control/[OWASP Top 10 2021 Category A1] - Boken Access Control
* https://owasp.org/www-project-top-ten/2017/A5_2017-Broken_Access_Control[OWASP Top 10 2017 Category A5] - Boken Access Control
* https://cwe.mitre.org/data/definitions/668.html[MITRE, CWE-668] - Exposure of Resource to Wrong Sphere

ifdef::env-github,rspecator-view[]

'''
== Implementation Specification
(visible only on this page)

=== Message

[IDEAS]

* For `key_vault`:
  # Disabling RBAC authorization weakens the Key Vault access control. Make sure it is safe here.
  # OR
  # Disabling RBAC forces to maintain the security of this resource access control. Make sure it is safe here.
resource "azurerm_key_vault" "production2" { # Sensitive
  # enable_rbac_authorization is missing
  # Omitting `enable_rbac_authorization` weakens the Key Vault access control. Make sure it is safe here.
  # OR
  # Omitting `enable_rbac_authorization` forces to maintain the security of this resource access control. Make sure it is safe here.

* For `kubernetes_cluster`:
# These resource examples have been reduced for clarity purposes
      azure_rbac_enabled = false # Sensitive
      # Make sure disabling Azure RBAC is safe here.
      # Disabling Azure RBAC forces you to maintain the security of this resource access control. Make sure it is safe here.
    azure_active_directory { # Sensitive
      # azure_rbac_enabled is missing
      # Omitting azure_rbac_enabled may affect the Kubernetes cluster security. Make sure it is safe here.
      # OR
      # Omitting azure_rbac_enabled weakens the security controls that Azure would have set up. Make sure it is safe here.
      # OR
      # Omitting azure_rbac_enabled will make you use your own security controls, instead of Azure's. Make sure it is safe here.
      # OR
      # Omitting azure_rbac_enabled forces you to maintain the security of this resource access control. Make sure it is safe here.
      managed = false # Sensitive
      # Managing the cluster by yourself doesn't garantee the security controls that Azure would have done. Make sure it is safe here.
      # OR
      # setting `managed`to false forces you to maintain the security of this resource access control. Make sure it is safe here.
      # Note: If managed is set to false, azure_rbac_enabled cannot be specified
    azure_active_directory { # Sensitive
      # managed is missing
      # Managing the cluster by yourself doesn't garantee the security controls that Azure would have done. Make sure it is safe here.
      # OR
      # setting `managed`to false forces you to maintain the security of this resource access control. Make sure it is safe here.
      # Note: If managed is set to false, azure_rbac_enabled cannot be specified
  role_based_access_control { # Sensitive
    # The azure_active_directory block is missing
    # Omitting `azure_active_directory` forces you to maintain the security of this resource access control. Make sure it is safe here.
    enabled = false # Sensitive
    # disabling RBAC forces you to maintain the security of this resource access control. Make sure it is safe here.
    # enabled is required, won't be missing
    # it doesn't matter if azure_active_directory is set if enabled = false
resource "azurerm_kubernetes_cluster" "production7" { # Sensitive
  # role_based_access_control is missing
  # omitting `role_based_access_control` forces you to maintain the security of this resource access control. Make sure it is safe here.

=== Highlighting

* If role_based_acccess_control is missing, highlight the resource
* If an assignment is non-compliant, highlight the entire assignment
* If an assignment is missing, highlight block where it should be.

[TALK ABOUT PRIORITIES]


endif::env-github,rspecator-view[]

