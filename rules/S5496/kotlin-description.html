<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Server-side template injections occur when an application
retrieves data from a user or a third-party service and inserts it into a
template, without sanitizing it first.</p>
</div>
<div class="paragraph">
<p>If an application contains a template that is vulnerable to injections,
it is exposed to attacks that target the underlying rendering server.</p>
</div>
<div class="paragraph">
<p>A user with malicious intent can create requests that will cause
the template to change its logic into unwanted behavior.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>An attacker exploiting a server-side template injection vulnerability will be
able to execute arbitrary commands on the underlying operating system.</p>
</div>
<div class="paragraph">
<p>The impact depends on the access control measures taken on the target system
OS. In the worst-case scenario, the process runs with root privileges, and
therefore any OS commands or programs may be affected.</p>
</div>
<div class="paragraph">
<p>Below are some real-world scenarios that illustrate some impacts of an attacker
exploiting the vulnerability.</p>
</div>
<div class="sect3">
<h4 id="_denial_of_service_and_data_leaks">Denial of service and data leaks</h4>
<div class="paragraph">
<p>In this scenario, the attack aims to disrupt the organization&#8217;s activities and
profit from data leaks.</p>
</div>
<div class="paragraph">
<p>An attacker could, for example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>download the internal server&#8217;s data, most likely to sell it</p>
</li>
<li>
<p>modify data, send malware</p>
</li>
<li>
<p>stop services or exhaust resources (with fork bombs for example)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This threat is particularly insidious if the attacked organization does not
maintain a disaster recovery plan (DRP).</p>
</div>
</div>
<div class="sect3">
<h4 id="_root_privilege_escalation_and_pivot">Root privilege escalation and pivot</h4>
<div class="paragraph">
<p>In this scenario, the attacker can do everything described in the previous
section. The difference is that the attacker also manages to elevate their
privileges to an administrative level and attacks other servers.</p>
</div>
<div class="paragraph">
<p>Here, the impact depends on how much the target company focuses on its Defense
In Depth. For example, the entire infrastructure can be compromised by a
combination of OS injections and <strong>misconfiguration</strong> of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Docker or Kubernetes clusters</p>
</li>
<li>
<p>cloud services</p>
</li>
<li>
<p>network firewalls and routing</p>
</li>
<li>
<p>OS access control</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it_in_groovy">How to fix it in Groovy</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="paragraph">
<p>The following code example is vulnerable to a Server-Side Template Injection
attack because it builds a template string from a user input without control or
sanitation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin">import groovy.text.markup.MarkupTemplateEngine
import groovy.text.markup.TemplateConfiguration

@Controller
class ExampleController {
    @GetMapping("/example")
    fun example(@RequestParam("title") title: String): String {
        val templateString = "h1('$title')"
        val config = TemplateConfiguration()
        val engine = MarkupTemplateEngine(config)
        val template = engine.createTemplate(templateString) // Noncompliant
        val out = template.make()
        return out.toString()
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin">import groovy.text.markup.MarkupTemplateEngine
import groovy.text.markup.TemplateConfiguration

@Controller
class ExampleController {
    @GetMapping("/example")
    fun example(@RequestParam("title") title: String): String {
        val templateString = "h1(title)"

        val ctx = mutableMapOf&lt;String, Any&gt;()
        ctx["title"] = title

        val config = TemplateConfiguration()
        val engine = MarkupTemplateEngine(config)
        val template = engine.createTemplate(templateString)
        val out: Writable = template.make(ctx)
        return out.toString()
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_how_does_this_work">How does this work?</h3>
<div class="paragraph">
<p>The compliant code example uses a template binding to pass user information to
the template. The rendering engine then ensures that this tainted data is
processed in a way that will not change the template semantics.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_articles_blog_posts">Articles &amp; blog posts</h3>
<div class="ulist">
<ul>
<li>
<p>Acunetix Web Security Blog - <a href="https://www.acunetix.com/blog/web-security-zone/exploiting-ssti-in-thymeleaf/">Exploiting SSTI in Thymeleaf</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_standards">Standards</h3>
<div class="ulist">
<ul>
<li>
<p>OWASP - <a href="https://owasp.org/Top10/A03_2021-Injection/">Top 10 2021 Category A3 - Injection</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-top-ten/2017/A1_2017-Injection">Top 10 2017 Category A1 - Injection</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/94">CWE-94 - Improper Control of Generation of Code</a></p>
</li>
<li>
<p>STIG Viewer - <a href="https://stigviewer.com/stigs/application_security_and_development/2024-12-06/finding/V-222609">Application Security and Development: V-222609</a> - The application must not be subject to input handling vulnerabilities.</p>
</li>
</ul>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Change this code to not construct template content directly from user-controlled data.</p>
</div>
<hr>
</div>
</div>
</div>