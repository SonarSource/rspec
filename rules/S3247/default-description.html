<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In C#, the <a href="https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/operators/type-testing-and-cast#is-operator"><code>is</code> type testing operator</a> can be used to check if the run-time type of an object is compatible with a given type. If the object is not null, then the <code>is</code> operator performs a cast, and so performing another cast following the check result is redundant.</p>
</div>
<div class="paragraph">
<p>This can impact:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Performance: Performing the type check and cast separately can lead to minor performance issues. While this might not be noticeable in small applications, it can add up in larger, more complex systems.</p>
</li>
<li>
<p>Readability: The code is less readable and less clean because it requires two lines (and two operations) to achieve something that could be done in one.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use <a href="https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/functional/pattern-matching">pattern macthing</a> to perform the check and retrieve the cast result.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-csharp" data-lang="csharp">if (x is Fruit)  // Noncompliant
{
  var f = (Fruit)x; // or x as Fruit
  // ...
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-csharp" data-lang="csharp">if (x is Fruit fruit)
{
  // ...
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>Microsoft Learn - <a href="https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/operators/type-testing-and-cast">Type-testing operators and cast expressions - <code>is</code>, <code>as</code>, <code>typeof</code> and casts</a></p>
</li>
<li>
<p>Microsoft Learn - <a href="https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/operators/is">is operator (C# reference)</a></p>
</li>
<li>
<p>Microsoft Learn - <a href="https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/functional/pattern-matching">Pattern matching overview</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_benchmarks">Benchmarks</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Method</th>
<th class="tableblock halign-left valign-top">Runtime</th>
<th class="tableblock halign-left valign-top">Mean</th>
<th class="tableblock halign-left valign-top">Standard Deviation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IsPattern_Class</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">.NET 9.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">176.48 ns</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.765 ns</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IsWithCast_Class</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">.NET 9.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">246.12 ns</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">22.391 ns</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IsPattern_Class</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">.NET Framework 4.8.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">325.11 ns</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">14.435 ns</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IsWithCast_Class</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">.NET Framework 4.8.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">311.22 ns</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">11.145 ns</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IsPattern_Interface</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">.NET 9.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">26.77 ns</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.123 ns</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IsWithCast_Interface</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">.NET 9.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">26.45 ns</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.115 ns</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IsPattern_Interface</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">.NET Framework 4.8.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">119.80 ns</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5.411 ns</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IsWithCast_Interface</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">.NET Framework 4.8.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">119.33 ns</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4.380 ns</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IsPattern_ValueType</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">.NET 9.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">22.58 ns</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.161 ns</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IsWithCast_ValueType</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">.NET 9.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">19.41 ns</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.675 ns</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IsPattern_ValueType</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">.NET Framework 4.8.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">39.66 ns</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.645 ns</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IsWithCast_ValueType</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">.NET Framework 4.8.1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">41.34 ns</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.462 ns</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="_glossary">Glossary</h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://en.wikipedia.org/wiki/Arithmetic_mean">Mean</a></p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/Standard_deviation">Standard Deviation</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The results were generated by running the following snippet with <a href="https://github.com/dotnet/BenchmarkDotNet">BenchmarkDotNet</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-csharp" data-lang="csharp">private Random random = new Random(1);

private object ReturnSometimes&lt;T&gt;() where T : new() =&gt;
    random.Next(2) switch
    {
        0 =&gt; new T(),
        1 =&gt; new object(),
    };

[BenchmarkCategory("ValueType"), Benchmark(Baseline = true)]
public int IsPattern_ValueType()
{
    var i = ReturnSometimes&lt;int&gt;();
    return i is int d
        ? d
        : default;
}

[BenchmarkCategory("ValueType"), Benchmark]
public int IsWithCast_ValueType()
{
    var i = ReturnSometimes&lt;int&gt;();
    return i is int
        ? (int)i
        : default;
}

[BenchmarkCategory("Class"), Benchmark(Baseline = true)]
public DuplicateCasts IsPattern_Class()
{
    var i = ReturnSometimes&lt;DuplicateCasts&gt;();
    return i is DuplicateCasts d
        ? d
        : default;
}

[BenchmarkCategory("Class"), Benchmark]
public DuplicateCasts IsWithCast_Class()
{
    var i = ReturnSometimes&lt;DuplicateCasts&gt;();
    return i is DuplicateCasts
        ? (DuplicateCasts)i
        : default;
}

[BenchmarkCategory("Interface"), Benchmark(Baseline = true)]
public IReadOnlyList&lt;int&gt; IsPattern_Interface()
{
    var i = ReturnSometimes&lt;List&lt;int&gt;&gt;();
    return i is IReadOnlyList&lt;int&gt; d
        ? d
        : default;
}

[BenchmarkCategory("Interface"), Benchmark]
public IReadOnlyList&lt;int&gt; IsWithCast_Interface()
{
    var i = ReturnSometimes&lt;List&lt;int&gt;&gt;();
    return i is IReadOnlyList&lt;int&gt;
        ? (IReadOnlyList&lt;int&gt;)i
        : default;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Hardware configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>BenchmarkDotNet v0.14.0, Windows 10 (10.0.19045.5247/22H2/2022Update)
Intel Core Ultra 7 165H, 1 CPU, 22 logical and 16 physical cores
  [Host]               : .NET Framework 4.8.1 (4.8.9282.0), X64 RyuJIT VectorSize=256
  .NET 9.0             : .NET 9.0.0 (9.0.24.52809), X64 RyuJIT AVX2
  .NET Framework 4.8.1 : .NET Framework 4.8.1 (4.8.9282.0), X64 RyuJIT VectorSize=256</code></pre>
</div>
</div>
<hr>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Primary: "Replace this type-check-and-cast sequence to use pattern matching."</p>
</div>
<div class="paragraph">
<p>Secondary: Replace this cast</p>
</div>
</div>
<div class="sect2">
<h3 id="_highlighting">Highlighting</h3>
<div class="ulist">
<ul>
<li>
<p>Primary: on the "is" check</p>
</li>
<li>
<p>Secondary: on the following casts</p>
</li>
</ul>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_is_related_to_s1905">is related to: <a data-rspec-id="S1905" class="rspec-auto-link">S1905</a></h3>

</div>
<div class="sect2">
<h3 id="_on_8_jul_2015_152840_ann_campbell_wrote">on 8 Jul 2015, 15:28:40 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~tamas.vajk] note that I&#8217;m a little concerned the title might be too broad. What do you think?</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_9_jul_2015_121838_tamas_vajk_wrote">on 9 Jul 2015, 12:18:38 Tamas Vajk wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2] I think the title is okay. Maybe we could add "useless duplicate casts&#8230;&#8203;"</p>
</div>
<div class="paragraph">
<p>I found this: https://msdn.microsoft.com/en-us/library/ms182271.aspx, which also uses the phrase "duplicate casts", so there is no need to modify it.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_9_jul_2015_123534_ann_campbell_wrote">on 9 Jul 2015, 12:35:34 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~tamas.vajk] I vote against adding "useless" to the title since that, in itself, would be redundant. :-)</p>
</div>
</div>
</div>
</div>