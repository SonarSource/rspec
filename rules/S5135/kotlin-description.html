<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Deserialization injections occur when applications deserialize wholly or
partially untrusted data without verification.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>In the context of a web application performing unsafe deserialization:<br>
After detecting the injection vector, attackers inject a carefully-crafted
payload into the application.</p>
</div>
<div class="paragraph">
<p>Below are some real-world scenarios that illustrate some impacts of an attacker
exploiting the vulnerability.</p>
</div>
<div class="sect3">
<h4 id="_application_specific_attacks">Application-specific attacks</h4>
<div class="paragraph">
<p>In this scenario, the attackers succeed in injecting an object of the expected
class, but with malicious properties that affect the object&#8217;s behavior.</p>
</div>
<div class="paragraph">
<p>If the application relies on the properties of the deserialized object,
attackers can modify the data structure or content to escalate privileges or
perform unwanted actions.<br>
In the context of an e-commerce application, this could be changing the number
of products or prices.</p>
</div>
</div>
<div class="sect3">
<h4 id="_full_application_compromise">Full application compromise</h4>
<div class="paragraph">
<p>In the worst-case scenario, the attackers succeed in injecting an object of a
completely different class than expected, triggering code execution.</p>
</div>
<div class="paragraph">
<p>Depending on the attacker, code execution can be used with different
intentions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Download the internal server&#8217;s data, most likely to sell it.</p>
</li>
<li>
<p>Modify data, install malware, for instance, malware that mines cryptocurrencies.</p>
</li>
<li>
<p>Stop services or exhaust resources, for instance, with fork bombs.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This threat is particularly insidious if the attacked organization does not
maintain a Disaster Recovery Plan (DRP).</p>
</div>
</div>
<div class="sect3">
<h4 id="_root_privilege_escalation_and_pivot">Root privilege escalation and pivot</h4>
<div class="paragraph">
<p>In this scenario, the attacker can do everything described in the previous
section. The difference is that the attacker additionally manages to elevate
his privileges as an administrator and attack other servers.</p>
</div>
<div class="paragraph">
<p>Here, the impact depends on how much the target company focuses on its Defense
In Depth. For example, the entire infrastructure can be compromised through a
combination of unsafe deserialization and misconfiguration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Docker or Kubernetes clusters</p>
</li>
<li>
<p>cloud services</p>
</li>
<li>
<p>network firewalls and routing</p>
</li>
<li>
<p>OS access control</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it_in_java_io_api">How to fix it in Java I/O API</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="paragraph">
<p>The following code is vulnerable to deserialization attacks because it
deserializes HTTP data without validating it first.</p>
</div>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin">class RequestProcessor {
    fun doGet(request: HttpServletRequest, response: HttpServletResponse) {
        val servletIS = request.inputStream
        val objectIS = ObjectInputStream(servletIS)
        val input = objectIS.readObject()
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin">class SecureObjectInputStream(input: InputStream) : ObjectInputStream(input) {
    companion object {
        val APPROVED_CLASSES = arrayOf(AllowedClass1::class.simpleName, AllowedClass2::class.simpleName)
    }
    override fun resolveClass(osc: ObjectStreamClass): Class&lt;*&gt; {
        if (osc.name !in APPROVED_CLASSES) {
            throw InvalidClassException("Unauthorized deserialization", osc.name)
        }
        return super.resolveClass(osc)
    }
}

class RequestProcessor {
    fun doGet(request: HttpServletRequest, response: HttpServletResponse) {
        val servletIS = request.inputStream
        val objectIS: ObjectInputStream = SecureObjectInputStream(servletIS)
        val input = objectIS.readObject()
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_how_does_this_work">How does this work?</h3>
<div class="paragraph">
<p>Allowing users to provide data for deserialization generally creates more
problems than it solves.</p>
</div>
<div class="paragraph">
<p>Anything that can be done through deserialization can generally be done with more
secure data structures.<br>
Therefore, our first suggestion is to avoid deserialization in the first
place.</p>
</div>
<div class="paragraph">
<p>However, if deserialization mechanisms are valid in your context, here are some
security suggestions.</p>
</div>
<div class="sect3">
<h4 id="_more_secure_serialization_methods">More secure serialization methods</h4>
<div class="paragraph">
<p>Some more secure serialization methods reduce the risk of security breaches,
although not definitively.</p>
</div>
<div class="paragraph">
<p>A complete object serializer is probably unnecessary if you only need to
receive primitive data (for example integers, strings, bools, etc.).<br>
In this case, formats such as JSON and XML protect the application from
deserialization attacks by default.</p>
</div>
<div class="paragraph">
<p>For more complex objects, the next step is to control which class fields are
exposed by creating class-specific serialization methods.<br>
The most common method is to use Data Transfer Objects (DTO) patterns or Google
Protocol Buffers (protobufs). After creating the Protobuf data structure, the
Protobuf compiler creates class files that handle operations such as
serializing and deserializing data.</p>
</div>
</div>
<div class="sect3">
<h4 id="_integrity_check">Integrity check</h4>
<div class="paragraph">
<p>Message authentication codes (MAC) can be used to prevent tampering with
serialized data that is meant to be stored outside the application server:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>On the server-side, when serializing an object, compute a MAC of the
result and append it to the serialized object string.</p>
</li>
<li>
<p>When the serialized value is submitted back, verify the serialization string
MAC on the server side before deserialization.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Depending on the situation, two MAC computation modes can be used.</p>
</div>
<div class="paragraph">
<p>If the same application will be responsible for the MAC computing and
validation, a symmetric signature algorithm can be used. In that case, HMAC
should be preferred, with a strong underlying hash algorithm such as SHA-256.</p>
</div>
<div class="paragraph">
<p>If multiple parties have to validate the serialized data, an asymetric
signature algorithm should be used. This will reduce the chances for a signing
secret to be leaked. In that case, the <code>RSASSA-PSS</code> algorithm can be used.</p>
</div>
<div class="paragraph">
<p><strong>Note</strong>: Be sure to store the signing secret securely.</p>
</div>
</div>
<div class="sect3">
<h4 id="_pre_approved_classes">Pre-Approved classes</h4>
<div class="paragraph">
<p>As a last resort, create a list of approved and safe classes that the
application should be able to deserialize.<br>
If the untrusted class does not match an entry in this list, it should be
rejected because it is considered unsafe.</p>
</div>
<div class="paragraph">
<p><strong>Note</strong>: Untrusted classes should be filtered out <strong>during</strong> deserialization,
not after.<br>
Depending on the language or framework, this should be possible by overriding
the serialization process or using native capabilities to restrict type
deserialization.</p>
</div>
<div class="paragraph">
<p>In the previous example, the pre-approved list uses class names to validate the
deserialized class.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_standards">Standards</h3>
<div class="ulist">
<ul>
<li>
<p>OWASP - <a href="https://owasp.org/Top10/A08_2021-Software_and_Data_Integrity_Failures/">Top 10 2021 Category A8 - Software and Data Integrity Failures</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-top-ten/2017/A8_2017-Insecure_Deserialization">Top 10 2017 Category A8 - Insecure Deserialization</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/20">CWE-20 - Improper Input Validation</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/502">CWE-502 - Deserialization of Untrusted Data</a></p>
</li>
<li>
<p>STIG Viewer - <a href="https://stigviewer.com/stigs/application_security_and_development/2024-12-06/finding/V-222609">Application Security and Development: V-222609</a> - The application must not be subject to input handling vulnerabilities.</p>
</li>
</ul>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Change this code to not deserialize user-controlled data.</p>
</div>
</div>
<div class="sect2">
<h3 id="_highlighting">Highlighting</h3>
<div class="paragraph">
<p>"[varname]" is tainted (assignments and parameters)</p>
</div>
<div class="paragraph">
<p>this argument is tainted (method invocations)</p>
</div>
<div class="paragraph">
<p>the returned value is tainted (returns &amp; method invocations results)</p>
</div>
<hr>
</div>
</div>
</div>