<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Encrypting data is security-sensitive. It has led in the past to the following vulnerabilities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.cve.org/CVERecord?id=CVE-2017-7902">CVE-2017-7902</a></p>
</li>
<li>
<p><a href="https://www.cve.org/CVERecord?id=CVE-2006-1378">CVE-2006-1378</a></p>
</li>
<li>
<p><a href="https://www.cve.org/CVERecord?id=CVE-2003-1376">CVE-2003-1376</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Proper encryption requires both the encryption algorithm and the key to be strong. Obviously the private key needs to remain secret and be renewed regularly. However these are not the only means to defeat or weaken an encryption.</p>
</div>
<div class="paragraph">
<p>This rule flags function calls that initiate encryption/decryption.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ask_yourself_whether">Ask Yourself Whether</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>the private key might not be random, strong enough or the same key is reused for a long long time.</p>
</li>
<li>
<p>the private key might be compromised. It can happen when it is stored in an unsafe place or when it was transferred in an unsafe manner.</p>
</li>
<li>
<p>the key exchange is made without properly authenticating the receiver.</p>
</li>
<li>
<p>the encryption algorithm is not strong enough for the level of protection required. Note that encryption algorithms strength decreases as time passes.</p>
</li>
<li>
<p>the chosen encryption library is deemed unsafe.</p>
</li>
<li>
<p>a nonce is used, and the same value is reused multiple times, or the nonce is not random.</p>
</li>
<li>
<p>the RSA algorithm is used, and it does not incorporate an Optimal Asymmetric Encryption Padding (OAEP), which might weaken the encryption.</p>
</li>
<li>
<p>the CBC (Cypher Block Chaining) algorithm is used for encryption, and it&#8217;s IV (Initialization Vector) is not generated using a secure random algorithm, or it is reused.</p>
</li>
<li>
<p>the Advanced Encryption Standard (AES) encryption algorithm is used with an unsecure mode. See the recommended practices for more information.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You are at risk if you answered yes to any of those questions.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_recommended_secure_coding_practices">Recommended Secure Coding Practices</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Generate encryption keys using secure random algorithms.</p>
</li>
<li>
<p>When generating cryptographic keys (or key pairs), it is important to use a key length that provides enough entropy against brute-force attacks. For the Blowfish algorithm the key should be at least 128 bits long, while for the RSA algorithm it should be at least 2048 bits long.</p>
</li>
<li>
<p>Regenerate the keys regularly.</p>
</li>
<li>
<p>Always store the keys in a safe location and transfer them only over safe channels.</p>
</li>
<li>
<p>If there is an exchange of cryptographic keys, check first the identity of the receiver.</p>
</li>
<li>
<p>Only use strong encryption algorithms. Check regularly that the algorithm is still deemed secure. It is also imperative that they are implemented correctly. Use only encryption libraries which are deemed secure. Do not define your own encryption algorithms as they will most probably have flaws.</p>
</li>
<li>
<p>When a nonce is used, generate it randomly every time.</p>
</li>
<li>
<p>When using the RSA algorithm, incorporate an Optimal Asymmetric Encryption Padding (OAEP).</p>
</li>
<li>
<p>When CBC is used for encryption, the IV must be random and unpredictable. Otherwise it exposes the encrypted value to crypto-analysis attacks like "Chosen-Plaintext Attacks". Thus a secure random algorithm should be used. An IV value should be associated to one and only one encryption cycle, because the IV&#8217;s purpose is to ensure that the same plaintext encrypted twice will yield two different ciphertexts.</p>
</li>
<li>
<p>The Advanced Encryption Standard (AES) encryption algorithm can be used with various modes. Galois/Counter Mode (GCM) with no padding should be preferred to the following combinations which are not secured:</p>
<div class="ulist">
<ul>
<li>
<p>Electronic Codebook (ECB) mode: Under a given key, any given plaintext block always gets encrypted to the same ciphertext block. Thus, it does not hide data patterns well. In some senses, it doesn&#8217;t provide serious message confidentiality, and it is not recommended for use in cryptographic protocols at all.</p>
</li>
<li>
<p>Cipher Block Chaining (CBC) with PKCS#5 padding (or PKCS#7) is susceptible to padding oracle attacks.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sensitive_code_example">Sensitive Code Example</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Builtin functions</p>
</div>
<div class="listingblock">
<div class="content">
<pre>function myEncrypt($cipher, $key, $data, $mode, $iv, $options, $padding, $infile, $outfile, $recipcerts, $headers, $nonce, $ad, $pub_key_ids, $env_keys)
{
    mcrypt_ecb ($cipher, $key, $data, $mode); // Sensitive
    mcrypt_cfb($cipher, $key, $data, $mode, $iv); // Sensitive
    mcrypt_cbc($cipher, $key, $data, $mode, $iv); // Sensitive
    mcrypt_encrypt($cipher, $key, $data, $mode); // Sensitive

    openssl_encrypt($data, $cipher, $key, $options, $iv); // Sensitive
    openssl_public_encrypt($data, $crypted, $key, $padding); // Sensitive
    openssl_pkcs7_encrypt($infile, $outfile, $recipcerts, $headers); // Sensitive
    openssl_seal($data, $sealed_data, $env_keys, $pub_key_ids); // Sensitive

    sodium_crypto_aead_aes256gcm_encrypt ($data, $ad, $nonce, $key); // Sensitive
    sodium_crypto_aead_chacha20poly1305_encrypt ($data, $ad, $nonce, $key); // Sensitive
    sodium_crypto_aead_chacha20poly1305_ietf_encrypt ($data, $ad, $nonce, $key); // Sensitive
    sodium_crypto_aead_xchacha20poly1305_ietf_encrypt ($data, $ad, $nonce, $key); // Sensitive
    sodium_crypto_box_seal ($data, $key); // Sensitive
    sodium_crypto_box ($data, $nonce, $key); // Sensitive
    sodium_crypto_secretbox ($data, $nonce, $key); // Sensitive
    sodium_crypto_stream_xor ($data, $nonce, $key); // Sensitive
}</pre>
</div>
</div>
<div class="paragraph">
<p>CakePHP</p>
</div>
<div class="listingblock">
<div class="content">
<pre>use Cake\Utility\Security;

function myCakeEncrypt($key, $data, $engine)
{
    Security::encrypt($data, $key); // Sensitive

    // Do not use custom made engines and remember that Mcrypt is deprecated.
    Security::engine($engine); // Sensitive. Setting the encryption engine.
}</pre>
</div>
</div>
<div class="paragraph">
<p>CodeIgniter</p>
</div>
<div class="listingblock">
<div class="content">
<pre>class EncryptionController extends CI_Controller
{
    public function __construct()
    {
        parent::__construct();
        $this-&gt;load-&gt;library('encryption');
    }

    public function index()
    {
        $this-&gt;encryption-&gt;create_key(16); // Sensitive. Review the key length.
        $this-&gt;encryption-&gt;initialize( // Sensitive.
            array(
                'cipher' =&gt; 'aes-256',
                'mode' =&gt; 'ctr',
                'key' =&gt; 'the key',
            )
        );
        $this-&gt;encryption-&gt;encrypt("mysecretdata"); // Sensitive.
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p>CraftCMS version 3</p>
</div>
<div class="listingblock">
<div class="content">
<pre>use Craft;

// This is similar to Yii as it used by CraftCMS
function craftEncrypt($data, $key, $password) {
    Craft::$app-&gt;security-&gt;encryptByKey($data, $key); // Sensitive
    Craft::$app-&gt;getSecurity()-&gt;encryptByKey($data, $key); // Sensitive
    Craft::$app-&gt;security-&gt;encryptByPassword($data, $password); // Sensitive
    Craft::$app-&gt;getSecurity()-&gt;encryptByPassword($data, $password); // Sensitive
}</pre>
</div>
</div>
<div class="paragraph">
<p>Drupal 7 - Encrypt module</p>
</div>
<div class="listingblock">
<div class="content">
<pre>function drupalEncrypt() {
    $encrypted_text = encrypt('some string to encrypt'); // Sensitive
}</pre>
</div>
</div>
<div class="paragraph">
<p>Joomla</p>
</div>
<div class="listingblock">
<div class="content">
<pre>use Joomla\Crypt\CipherInterface;

abstract class MyCipher implements CipherInterface // Sensitive. Implementing custom cipher class
{}

function joomlaEncrypt() {
    new Joomla\Crypt\Cipher_Sodium(); // Sensitive
    new Joomla\Crypt\Cipher_Simple(); // Sensitive
    new Joomla\Crypt\Cipher_Rijndael256(); // Sensitive
    new Joomla\Crypt\Cipher_Crypto(); // Sensitive
    new Joomla\Crypt\Cipher_Blowfish(); // Sensitive
    new Joomla\Crypt\Cipher_3DES(); // Sensitive
}
}</pre>
</div>
</div>
<div class="paragraph">
<p>Laravel</p>
</div>
<div class="listingblock">
<div class="content">
<pre>use Illuminate\Support\Facades\Crypt;

function myLaravelEncrypt($data)
{
    Crypt::encryptString($data); // Sensitive
    Crypt::encrypt($data); // Sensitive
    // encrypt using the Laravel "encrypt" helper
    encrypt($data); // Sensitive
}</pre>
</div>
</div>
<div class="paragraph">
<p>PHP-Encryption library</p>
</div>
<div class="listingblock">
<div class="content">
<pre>use Defuse\Crypto\Crypto;
use Defuse\Crypto\File;

function mypPhpEncryption($data, $key, $password, $inputFilename, $outputFilename, $inputHandle, $outputHandle) {
    Crypto::encrypt($data, $key); // Sensitive
    Crypto::encryptWithPassword($data, $password); // Sensitive
    File::encryptFile($inputFilename, $outputFilename, $key); // Sensitive
    File::encryptFileWithPassword($inputFilename, $outputFilename, $password); // Sensitive
    File::encryptResource($inputHandle, $outputHandle, $key); // Sensitive
    File::encryptResourceWithPassword($inputHandle, $outputHandle, $password); // Sensitive
}</pre>
</div>
</div>
<div class="paragraph">
<p>PhpSecLib</p>
</div>
<div class="listingblock">
<div class="content">
<pre>function myphpseclib($mode) {
    new phpseclib\Crypt\RSA(); // Sensitive. Note: RSA can also be used for signing data.
    new phpseclib\Crypt\AES(); // Sensitive
    new phpseclib\Crypt\Rijndael(); // Sensitive
    new phpseclib\Crypt\Twofish(); // Sensitive
    new phpseclib\Crypt\Blowfish(); // Sensitive
    new phpseclib\Crypt\RC4(); // Sensitive
    new phpseclib\Crypt\RC2(); // Sensitive
    new phpseclib\Crypt\TripleDES(); // Sensitive
    new phpseclib\Crypt\DES(); // Sensitive

    new phpseclib\Crypt\AES($mode); // Sensitive
    new phpseclib\Crypt\Rijndael($mode); // Sensitive
    new phpseclib\Crypt\TripleDES($mode); // Sensitive
    new phpseclib\Crypt\DES($mode); // Sensitive
}</pre>
</div>
</div>
<div class="paragraph">
<p>Sodium Compat library</p>
</div>
<div class="listingblock">
<div class="content">
<pre>function mySodiumCompatEncrypt($data, $ad, $nonce, $key) {
    ParagonIE_Sodium_Compat::crypto_aead_chacha20poly1305_ietf_encrypt($data, $ad, $nonce, $key); // Sensitive
    ParagonIE_Sodium_Compat::crypto_aead_xchacha20poly1305_ietf_encrypt($data, $ad, $nonce, $key); // Sensitive
    ParagonIE_Sodium_Compat::crypto_aead_chacha20poly1305_encrypt($data, $ad, $nonce, $key); // Sensitive

    ParagonIE_Sodium_Compat::crypto_aead_aes256gcm_encrypt($data, $ad, $nonce, $key); // Sensitive

    ParagonIE_Sodium_Compat::crypto_box($data, $nonce, $key); // Sensitive
    ParagonIE_Sodium_Compat::crypto_secretbox($data, $nonce, $key); // Sensitive
    ParagonIE_Sodium_Compat::crypto_box_seal($data, $key); // Sensitive
    ParagonIE_Sodium_Compat::crypto_secretbox_xchacha20poly1305($data, $nonce, $key); // Sensitive
}</pre>
</div>
</div>
<div class="paragraph">
<p>Yii version 2</p>
</div>
<div class="listingblock">
<div class="content">
<pre>use Yii;

// Similar to CraftCMS as it uses Yii
function YiiEncrypt($data, $key, $password) {
    Yii::$app-&gt;security-&gt;encryptByKey($data, $key); // Sensitive
    Yii::$app-&gt;getSecurity()-&gt;encryptByKey($data, $key); // Sensitive
    Yii::$app-&gt;security-&gt;encryptByPassword($data, $password); // Sensitive
    Yii::$app-&gt;getSecurity()-&gt;encryptByPassword($data, $password); // Sensitive
}</pre>
</div>
</div>
<div class="paragraph">
<p>Zend</p>
</div>
<div class="listingblock">
<div class="content">
<pre>use Zend\Crypt\FileCipher;
use Zend\Crypt\PublicKey\DiffieHellman;
use Zend\Crypt\PublicKey\Rsa;
use Zend\Crypt\Hybrid;
use Zend\Crypt\BlockCipher;

function myZendEncrypt($key, $data, $prime, $options, $generator, $lib)
{
    new FileCipher; // Sensitive. This is used to encrypt files

    new DiffieHellman($prime, $generator, $key); // Sensitive

    $rsa = Rsa::factory([ // Sensitive
        'public_key'    =&gt; 'public_key.pub',
        'private_key'   =&gt; 'private_key.pem',
        'pass_phrase'   =&gt; 'mypassphrase',
        'binary_output' =&gt; false,
    ]);
    $rsa-&gt;encrypt($data); // No issue raised here. The configuration of the Rsa object is the line to review.

    $hybrid = new Hybrid(); // Sensitive

    BlockCipher::factory($lib, $options); // Sensitive
}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-top-ten/2017/A3_2017-Sensitive_Data_Exposure">Top 10 2017 Category A3 - Sensitive Data Exposure</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-top-ten/2017/A6_2017-Security_Misconfiguration">Top 10 2017 Category A6 - Security Misconfiguration</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/321">CWE-321 - Use of Hard-coded Cryptographic Key</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/322">CWE-322 - Key Exchange without Entity Authentication</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/323">CWE-323 - Reusing a Nonce, Key Pair in Encryption</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/324">CWE-324 - Use of a Key Past its Expiration Date</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/325">CWE-325 - Missing Required Cryptographic Step</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/326">CWE-326 - Inadequate Encryption Strength</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/327">CWE-327 - Use of a Broken or Risky Cryptographic Algorithm</a></p>
</li>
</ul>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Make sure that encrypting data is safe here.</p>
</div>
</div>
<div class="sect2">
<h3 id="_highlighting">Highlighting</h3>
<div class="paragraph">
<p>The encryption function call</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_is_related_to_s2087">is related to: <a data-rspec-id="S2087" class="rspec-auto-link">S2087</a></h3>

</div>
<div class="sect2">
<h3 id="_is_related_to_s3329">is related to: <a data-rspec-id="S3329" class="rspec-auto-link">S3329</a></h3>

</div>
<div class="sect2">
<h3 id="_is_related_to_s4426">is related to: <a data-rspec-id="S4426" class="rspec-auto-link">S4426</a></h3>

</div>
<div class="sect2">
<h3 id="_is_related_to_s4432">is related to: <a data-rspec-id="S4432" class="rspec-auto-link">S4432</a></h3>

</div>
<div class="sect2">
<h3 id="_is_related_to_s2277">is related to: <a data-rspec-id="S2277" class="rspec-auto-link">S2277</a></h3>

</div>
<div class="sect2">
<h3 id="_is_related_to_s2278">is related to: <a data-rspec-id="S2278" class="rspec-auto-link">S2278</a></h3>

</div>
<div class="sect2">
<h3 id="_on_4_sep_2018_103610_alexandre_gigleux_wrote">on 4 Sep 2018, 10:36:10 Alexandre Gigleux wrote:</h3>
<div class="paragraph">
<p>LGTM</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_2_dec_2019_103736_alexandre_gigleux_wrote">on 2 Dec 2019, 10:37:36 Alexandre Gigleux wrote:</h3>
<div class="paragraph">
<p>Removing CWE-522 from this rule because CWE-522 maps to the "AUTH" SonarSource Security Category and this makes this RSPEC mapping to 2 SonarSource Security Category and we expect a given RSPEC to map to only one specific SonarSource Security Category. This is especially true for Security Hotspots the guided process introduced with https://jira.sonarsource.com/browse/MMF-1868.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_27_may_2020_164619_eric_therond_wrote">on 27 May 2020, 16:46:19 Eric Therond wrote:</h3>
<div class="paragraph">
<p>Deprecated because it overlaps with all the vulnerability rules we have about cryptography</p>
</div>
<div class="paragraph">
<p>See for instance: https://jira.sonarsource.com/browse/MMF-1852</p>
</div>
</div>
</div>
</div>