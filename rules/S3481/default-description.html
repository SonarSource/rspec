<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Since databases don&#8217;t offer "Are you sure?" dialogs, it&#8217;s best to be very certain of what you&#8217;re changing before you do it. <code>UPDATE</code> and <code>DELETE</code> statements that don&#8217;t precisely limit their effects to single rows risk changing more than was intended. That&#8217;s why they should be reviewed carefully.</p>
</div>
<div class="paragraph">
<p>This rule raises an issue when an <code>UPDATE</code> or <code>DELETE</code> statement&#8217;s <code>WHERE</code> clause does not use precisely either a unique index or all parts of the table&#8217;s primary key. That includes both cases where they are omitted in whole or in part, and when they are used but could still describe multiple rows. E.G. <code>WHERE AGE = 34</code>, and <code>WHERE TABLE_ID &gt; 0 AND TABLE_ID &lt; 40</code>.</p>
</div>
<div class="paragraph">
<p><strong>Note</strong> That this rule raises issues only when a database catalog is provided during the SonarQube analysis.</p>
</div>
<div class="sect2">
<h3 id="_noncompliant_code_example">Noncompliant code example</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cobol" data-lang="cobol">CREATE table my_table (
     compound_a integer not null,
     compound_b integer not null,
     column_c varchar(50),
     primary key (compound_a, compound_b)
);

DELETE FROM my_table
WHERE compound_b=4;  -- Noncompliant</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_exceptions">Exceptions</h3>
<div class="paragraph">
<p>Statements using a cursor and <code>WHERE CURRENT OF</code> are ignored.</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Review carefully this "UPDATE|DELETE" statement which might impact multiple rows.</p>
</div>
</div>
<div class="sect2">
<h3 id="_highlighting">Highlighting</h3>
<div class="paragraph">
<p>entire WHERE clause</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_on_8_jan_2016_172150_pierre_yves_nicolas_wrote">on 8 Jan 2016, 17:21:50 Pierre-Yves Nicolas wrote:</h3>
<div class="paragraph">
<p>I don&#8217;t think that the rule title is very clear. What about "UPDATE and DELETE statements should not impact more than one row"?</p>
</div>
<div class="paragraph">
<p>This rule should not only check primary keys: a unique index may also guarantee that a statement will not update more than 1 row.</p>
</div>
<div class="paragraph">
<p>It seems that we have to exclude statements using "WHERE CURRENT OF" (with a cursor).</p>
</div>
<div class="paragraph">
<p>This rule may overlap <a data-rspec-id="S1590" class="rspec-auto-link">RSPEC-1590</a> and <a data-rspec-id="S3483" class="rspec-auto-link">RSPEC-3483</a>: we can reduce the scope of <a data-rspec-id="S3483" class="rspec-auto-link">RSPEC-3483</a> to SELECT statements.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_11_jan_2016_183147_ann_campbell_wrote">on 11 Jan 2016, 18:31:47 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>I&#8217;ve made the changes you suggested [~pierre-yves.nicolas], and am assigning this back to @Freddy for his initial review.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_19_jan_2016_101426_pierre_yves_nicolas_wrote">on 19 Jan 2016, 10:14:26 Pierre-Yves Nicolas wrote:</h3>
<div class="paragraph">
<p>What should be the behavior of this rule if a table has no primary key and no unique index?</p>
</div>
<div class="paragraph">
<p>Of course, in such a case, every UPDATE or DELETE can then impact multiple rows.</p>
</div>
<div class="paragraph">
<p>On the other hand, we could consider that the problem is on the database structure side, not in the COBOL code using the table.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_19_jan_2016_104458_pierre_yves_nicolas_wrote">on 19 Jan 2016, 10:44:58 Pierre-Yves Nicolas wrote:</h3>
<div class="paragraph">
<p>I think that we should change the message for that rule:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>This rule is not only about primary keys, but also about unique indexes.</p>
</li>
<li>
<p>Primary keys or unique indexes are not always "compound", they may have a single column.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Suggested message: "Change this UPDATE|DELETE statement so that it does not update|delete more than one row"</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_19_jan_2016_105131_ann_campbell_wrote">on 19 Jan 2016, 10:51:31 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>Done [~pierre-yves.nicolas]</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_19_jan_2016_105448_ann_campbell_wrote">on 19 Jan 2016, 10:54:48 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~pierre-yves.nicolas] without a PK and/or unique index, we have no way of knowing how many rows a statement will affect. Perhaps we need to add a rule saying that each table should have a primary key?</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_19_jan_2016_110718_pierre_yves_nicolas_wrote">on 19 Jan 2016, 11:07:18 Pierre-Yves Nicolas wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2] We may add a rule requiring a primary key, but I think it should be implemented only in plugins working purely on the database side, e.g. PLSQL plugin.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_19_jan_2016_120441_ann_campbell_wrote">on 19 Jan 2016, 12:04:41 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>Of course [~pierre-yves.nicolas]</p>
</div>
</div>
</div>
</div>