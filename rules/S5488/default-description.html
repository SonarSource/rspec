<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Passing invalid arguments to UNIX/POSIX functions may result in undefined behavior.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Many UNIX/POSIX functions put certain constraints on the values of their parameters.
The behavior for some of those UNIX/POSIX functions is not defined but instead, their behavior is implementation-defined, if one passes incorrectly constrained parameters.
This may lead to undefined behavior depending on a function&#8217;s concrete implementation.
The constraints include the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Allocation sizes of <code>calloc</code>, <code>malloc</code>, <code>realloc</code>, <code>reallocf</code>, <code>alloca</code> and <code>valloc</code> must be strictly positive</p>
</li>
<li>
<p><code>open</code> and <code>openat</code> should be called with a flag that contains one of the access modes: <code>O_RDONLY</code>, <code>O_WRONLY</code>, or <code>O_RDWR</code></p>
</li>
<li>
<p><code>open</code> and <code>openat</code> with flag <code>O_CREAT</code> should be called with a third argument</p>
</li>
<li>
<p>The <code>O_EXCL</code> flag should be used with <code>O_CREAT</code></p>
</li>
<li>
<p>The first argument of <code>pthread_once</code> should not have automatic storage duration and should be initialized by the constant <code>PTHREAD_ONCE_INIT</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Failing to pass correctly constrained parameters can result in undefined behavior.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">// Depending on the implementation, either NULL is returned, or the behavior is
// as if the passed size parameter were a non-zero value, except that accesses
// of the returned pointer result in undefined behavior.
void *mem = alloca(0); // May result in undefined behavior.

int fd = open("example.txt", O_ APPEND); // Access mode is missing, may result in undefined behavior.

// Third argument should be used to specify the file's access permissions.
int fd_1 = open("another_example.txt", O_CREAT); // May result in undefined behavior.

// Since `O_EXCL` prevents file creation if it already exists, the flag for
// file creation `O_CREAT` should be used in combination with `O_EXCL`.
int fd_3 = open("further_example.txt", O_EXCL); // `O_CREAT` flag is missing, may result in undefined behavior.

int counter = 0;

void inc_counter() { ++counter; }

void bar() {
  // May trigger undefined behavior, because `once_control`'s storage duration
  // is automatic. `counter` might be incremented with each call to `bar`.
  pthread_once_t once_control = PTHREAD_ONCE_INIT;
  pthread_once(&amp;once_control, &amp;inc_counter); // May result in undefined behavior.
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>Using UNIX/POSIX functions with invalid arguments results in implementation-defined behavior and may lead to <strong>undefined behavior</strong>.</p>
</div>
<div class="paragraph">
<p>When a function emits implementation-defined behavior, its behavior is unspecified and each implementation documents how the choice is made.
Implementation-defined behavior can quickly lead to undefined behavior, if the respective function is not used exactly as per the documentation.</p>
</div>
<div class="paragraph">
<p>When a program comprises undefined behavior, the compiler no longer needs to adhere to the language standard, and the program has no meaning assigned to it.</p>
</div>
<div class="paragraph">
<p>Depending on the concrete situation, the application might just crash, but in the worst case, the application may appear to execute correctly, while losing data or producing incorrect results.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ensure that allocation sizes are strictly positive, calls to <code>open</code> and <code>openat</code> are correctly parameterized, and the first argument of <code>pthread_once</code> has non-automatic storage duration and is initialized with <code>PTHREAD_ONCE_INIT</code>.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

char *allocate_buffer(size_t size) {
  char *buf = (char *)malloc(size); // Noncompliant: `size` might be zero.
  if (buf == NULL) {
    // Handle allocation error.
    perror("malloc failed");
    exit(1);
  }
  return buf;
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

char *allocate_buffer(size_t size) {
  if (size == 0) { // Compliant: `size` is checked for zero.
    // Handle error.
    printf("Cannot allocate 0 bytes!\n");
    exit(1);
  }
  char *buf = (char *)malloc(size);
  if (buf == NULL) {
    // Handle allocation error.
    perror("malloc failed");
    exit(1);
  }
  return buf;
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_noncompliant_code_example_2">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">#include &lt;fcntl.h&gt;
#include &lt;sys/stat.h&gt;

int foo() {
  int fd = open("example.txt", O_CREAT); // Noncompliant: file permissions are not set.
  if (fd == -1) {
    return -1;
  }
  return 0;
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution_2">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">#include &lt;fcntl.h&gt;
#include &lt;sys/stat.h&gt;

int foo() {
  // Specify read permissions for user, group and others.
  int fd = open("example.txt", O_CREAT, S_IRUSR | S_IRGRP | S_IROTH); // Compliant: file permissions correctly set.
  if (fd == -1) {
    return -1;
  }
  return 0;
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_noncompliant_code_example_3">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">#include &lt;pthread.h&gt;
#include &lt;stdio.h&gt;

int counter = 0;

void inc_counter() { ++counter; }

void bar() {
  pthread_once_t once_control = PTHREAD_ONCE_INIT;
  pthread_once(&amp;once_control, &amp;inc_counter); // Noncompliant: `once_control` has automatic storage duration.
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution_3">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">#include &lt;pthread.h&gt;
#include &lt;stdio.h&gt;

int counter = 0;
pthread_once_t once_control = PTHREAD_ONCE_INIT;

void inc_counter() { ++counter; }

void bar() {
  pthread_once(&amp;once_control, &amp;inc_counter); // Compliant: `once_control` has global storage duration here.
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_standards">Standards</h3>
<div class="ulist">
<ul>
<li>
<p>CERT - <a href="https://wiki.sei.cmu.edu/confluence/display/c/MEM04-C.+Beware+of+zero-length+allocations">MEM04-C. Beware of zero-length allocations</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_related_rules">Related rules</h3>
<div class="ulist">
<ul>
<li>
<p><a data-rspec-id="S3807" class="rspec-auto-link">S3807</a> ensures that appropriate arguments are passed to C standard library functions</p>
</li>
<li>
<p><a data-rspec-id="S5485" class="rspec-auto-link">S5485</a> ensures that appropriate arguments are passed to C standard library for handling I/O streams</p>
</li>
</ul>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_relates_to_s5828">relates to: <a data-rspec-id="S5828" class="rspec-auto-link">S5828</a></h3>

</div>
<div class="sect2">
<h3 id="_on_24_oct_2019_212551_loïc_joly_wrote">on 24 Oct 2019, 21:25:51 Loïc Joly wrote:</h3>
<div class="paragraph">
<p>\[~amelie.renard] Should you mention openat at the same time you mention open?</p>
</div>
</div>
</div>
</div>