== Why is this an issue?

The checked and unchecked https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/statements/checked-and-unchecked[statements] and https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/language-specification/expressions#12819-the-checked-and-unchecked-operators[operators] specify the https://en.wikipedia.org/wiki/Integer_overflow[overflow]-checking context for integral-type arithmetic operations and conversions.

This means:

* When `unchecked` is specified, the operation result is truncated by discarding any high-order bits that don't fit in the destination type.
+
[source,csharp]
----
uint a = uint.MaxValue;
unchecked(a = a + 1); // a+1 overflows, results in 0
----

* When `checked` is specified, an https://learn.microsoft.com/en-us/dotnet/api/system.overflowexception[OverflowException] is thrown for a run-time overflow, and https://learn.microsoft.com/en-us/dotnet/csharp/misc/cs0220?f1url=%3FappId%3Droslyn%26k%3Dk(CS0220)[CS0220] compile-time error occurs for a constant overflow.
+
[source,csharp]
----
uint a = uint.MaxValue;
checked(a + 1); // run-time: OverflowException

const uint b = uint.MaxValue;
checked(b + 1) // compile-time: Compiler Error CS0220
----


https://learn.microsoft.com/en-us/dotnet/api/system.linq.enumerable.sum[Enumerable.Sum()] always executes addition in a `checked` context, so an OverflowException will be thrown if the value exceeds `MaxValue`, even if an `unchecked` context was specified. Therefore, using this method inside an `unchecked` context will only make the code more confusing, since the behavior will still be `checked`.

This rule raises an issue when an `unchecked` context is specified for a `Sum` on integer types.

=== Exceptions

When the `Sum` call is inside a https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/exceptions/[try-catch block], no issues are reported, since the exception is properly handled.

[source,csharp]
----
void Add(List<int> list)
{
  unchecked 
  {
    try 
    {
      int total = list.Sum();
    } 
    catch (System.OverflowException e) 
    {
      // Exception handling    
    }
  }
}
----


== How to fix it

Remove the `unchecked` operator/statement, and optionally add some exception handling for the `OverflowException`.

=== Code examples

==== Noncompliant code example

[source,csharp,diff-id=1,diff-type=noncompliant]
----
void Add(List<int> list)
{
  int total1 = unchecked(list.Sum());  // Noncompliant

  unchecked 
  {
    int total2 = list.Sum();  // Noncompliant
  }
}
----


==== Compliant solution

[source,csharp,diff-id=1,diff-type=compliant]
----
void Add(List<int> list)
{
  int total1 = list.Sum();

  try 
  {
    int total2 = list.Sum();
  } 
  catch (System.OverflowException e) 
  {
    // Exception handling
  }
}
----


== Resources

=== Documentation

* https://learn.microsoft.com/en-us/dotnet/api/system.linq.enumerable.sum[Enumerable.Sum Method]
* https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/statements/checked-and-unchecked[checked and unchecked statements]
* https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/language-specification/expressions#12819-the-checked-and-unchecked-operators[checked and unchecked operators]
* https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/exceptions/[Exceptions and Exception Handling]
* https://learn.microsoft.com/en-us/dotnet/api/system.overflowexception[OverflowException Class]
* https://learn.microsoft.com/en-us/dotnet/csharp/misc/cs0220?f1url=%3FappId%3Droslyn%26k%3Dk(CS0220)[Compiler Error CS0220]
* https://en.wikipedia.org/wiki/Integer_overflow[Integer overflow]

include::../rspecator.adoc[]
