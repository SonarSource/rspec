Refactor this SOQL query and for loop into a single SOQL for loops