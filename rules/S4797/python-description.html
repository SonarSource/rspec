<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Handling files is security-sensitive. It has led in the past to the following vulnerabilities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.cve.org/CVERecord?id=CVE-2018-0358">CVE-2018-0358</a></p>
</li>
<li>
<p><a href="https://www.cve.org/CVERecord?id=CVE-2017-7560">CVE-2017-7560</a></p>
</li>
<li>
<p><a href="https://www.cve.org/CVERecord?id=CVE-2005-4015">CVE-2005-4015</a></p>
</li>
<li>
<p><a href="https://www.cve.org/CVERecord?id=CVE-2018-3835">CVE-2018-3835</a></p>
</li>
<li>
<p><a href="https://www.cve.org/CVERecord?id=CVE-2018-8008">CVE-2018-8008</a></p>
</li>
<li>
<p><a href="https://www.cve.org/CVERecord?id=CVE-2010-2320">CVE-2010-2320</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Any access to the file system can create a vulnerability. Exposing a file&#8217;s content, path or even its existence or absence is dangerous. It is also extremely risky to create or write files without making sure that their permission and content is safe and controlled. Using a file path or reading a file content must be always done with caution as they could have been tampered with.</p>
</div>
<div class="paragraph">
<p>The file system is a resource which can be easily exhausted. Opening too many files will use up all file descriptors, preventing other software from opening files. Filling the storage space will also prevent any additional write from happening.</p>
</div>
<div class="paragraph">
<p>This rule raises an issue when a function accessing the filesystem via a path-like object is called. It does not raise issues on already opened files access (ex: <code>file.readline()</code>) because an issue is already raised by functions opening files (ex: <code>file = open(path)</code>) The goal is to guide manual security code reviews by pointing to the initial filesystem access.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ask_yourself_whether">Ask Yourself Whether</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>the file or directory path you are using is coming from a user input or could have been tampered with.</p>
</li>
<li>
<p>the code exposes to an unauthorized person the existence of a file or directory. Any hint given to a user might be dangerous. The information could be given by displaying an error if the file/directory does not exist or just by returning an "Unauthorized" error when the file/directory exists but the person can&#8217;t perform an action.</p>
</li>
<li>
<p>the code exposes to an unauthorized person the paths of files and/or directories, for example by listing the content of a directory and displaying the output.</p>
</li>
<li>
<p>a file or directory may be created with the wrong permissions.</p>
</li>
<li>
<p>an unvalidated user input is written into a file.</p>
</li>
<li>
<p>a file is read and its content is used without being validated.</p>
</li>
<li>
<p>a file is read and its content is exposed to an unauthorized person.</p>
</li>
<li>
<p>a file is open, created or written into each time a user performs an action.</p>
</li>
<li>
<p>files are open and not closed before executing a child process. This is only dangerous if file descriptors are inherited in your programming language (example: C, C&#43;&#43;).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You are at risk if you answered yes to any of those questions.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_recommended_secure_coding_practices">Recommended Secure Coding Practices</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Avoid using paths provided by users or other untrusted sources if possible. If this is required, check that the path does not reference an unauthorized directory or file. See <a href="https://www.owasp.org/index.php/Testing_Directory_traversal/file_include_(OTG-AUTHZ-001)">OWASP recommendations</a> as to how to test for directory traversal. Note that the paths length should be validated too.</p>
</div>
<div class="paragraph">
<p>No File and directory names should be exposed. They can contain sensitive information. This means that a user should not be able to list the content of unauthorized directories.</p>
</div>
<div class="paragraph">
<p>Make sure that no attackers can test for the existence or absence of sensitive files. Knowing that a specific file exists can reveal a vulnerability or at least expose file and directory names.</p>
</div>
<div class="paragraph">
<p>Files and directories should be created with restricted permissions and ownership. Only authorized users and applications should be able to access the files, and they should have as little permissions as needed. Modifying a file&#8217;s permissions is not good enough. The permissions should be restricted from the very beginning.</p>
</div>
<div class="paragraph">
<p>Writing user input into files should be done with caution. It could fill the storage space if the amount of data written is not controlled. It could also write dangerous data which will later be used by an application or returned to another user. This is why the user input should be validated before being written.</p>
</div>
<div class="paragraph">
<p>Reading a file can lead to other vulnerabilities. Any file could have been modified by an attacker. Thus the same validation as for any user input should be performed on file content.</p>
</div>
<div class="paragraph">
<p>Once a file is read, its content should only be exposed to authorized users.</p>
</div>
<div class="paragraph">
<p>Add limits to the number of files your application access simultaneously or create because of a user action. It is possible to perform a Denial of Service attack by opening too many files, and thus exhausting available file descriptors, or by filling the file system with new files. Release file descriptors by closing files as soon as possible.</p>
</div>
<div class="paragraph">
<p>We also recommended to have tools monitoring your system and alerting you whenever resources are nearly exhausted.</p>
</div>
<div class="paragraph">
<p>Do not allow untrusted code to access the filesystem. For some programming languages, child-processes may have access to file descriptors opened by the parent process before the creation of the child process. This creates a vulnerability when a child process doesn&#8217;t have the permission to access a file but is still able to modify it via the inherited file descriptor. Check your language documentation for "file descriptor leak" or the use of the flags <code>O_CLOEXEC</code>, <code>FD_CLOEXEC</code>, or <code>bInheritHandles</code>. File descriptors can be inherited in the following languages: C, C&#43;&#43;, C#, Objective-C, Swift, Go (but disabled by default), some JVM versions, Javascript and TypeScript in Nodejs, Some PHP versions,  Python, Ruby, Rust, VB6 and VB.NET.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sensitive_code_example">Sensitive Code Example</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>open</code> builtin</p>
</div>
<div class="listingblock">
<div class="content">
<pre>open(path, 'r')  # Sensitive</pre>
</div>
</div>
<div class="paragraph">
<p><code>fileinput</code> module</p>
</div>
<div class="listingblock">
<div class="content">
<pre>import fileinput

for line in fileinput.input():  # Sensitive
    pass

with fileinput.FileInput(files=('setup.py', 'test.txt')) as file:  # Sensitive
    pass</pre>
</div>
</div>
<div class="paragraph">
<p><code>linecache</code> module</p>
</div>
<div class="listingblock">
<div class="content">
<pre>import linecache

linecache.getline('setup.py', 5)  # Sensitive</pre>
</div>
</div>
<div class="paragraph">
<p><code>os</code> module.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>import os

def access_filesystem(path, file_descriptor, mode, uid):
    os.open(path, os.O_RDONLY)  # Sensitive
    os.chmod(path, mode)  # Sensitive
    os.chown(path, uid)  # Sensitive
    os.lchmod(path, mode)  # Sensitive
    os.lchown(path, uid)  # Sensitive
    os.chroot(path)  # Sensitive
    os.fdopen(file_descriptor)  # Sensitive
    os.link(path, path)  # Sensitive
    os.symlink(path, path)  # Sensitive
    os.mkdir(path, mode)  # Sensitive
    os.mkdir(path)  # Sensitive
    os.makedirs(path)  # Sensitive
    os.mkfifo(path)  # Sensitive
    os.mknod(path)  # Sensitive
    os.remove(path)  # Sensitive
    os.removedirs(path)  # Sensitive
    os.rename(path)  # Sensitive
    os.renames(path)  # Sensitive
    os.replace(path)  # Sensitive
    os.rmdir(path)  # Sensitive
    os.truncate(path, 42)  # Sensitive
    os.unlink(path)  # Sensitive</pre>
</div>
</div>
<div class="paragraph">
<p><code>pathlib</code> module</p>
</div>
<div class="listingblock">
<div class="content">
<pre>from pathlib import Path, PosixPath, WindowsPath

path = 'test.txt'
Path(path)  # Sensitive
PosixPath(path)  # Sensitive
WindowsPath(path)  # Sensitive</pre>
</div>
</div>
<div class="paragraph">
<p><code>shutil</code> module</p>
</div>
<div class="listingblock">
<div class="content">
<pre>import shutil

path1 = '/tmp/test1.txt'
path2 = '/tmp/test2.txt'

shutil.copyfile(path1, path2)  # Sensitive

shutil.copymode(path1, path2)  # Sensitive

shutil.copystat(path1, path2)  # Sensitive

shutil.copy(path1, path2)  # Sensitive
shutil.copy2(path1, path2)  # Sensitive

shutil.copytree('/tmp/dir1', '/tmp/dir2')  # Sensitive
shutil.rmtree('/tmp/mydir')  # Sensitive
shutil.move('/tmp/dir3', '/tmp/dir4')  # Sensitive
shutil.chown(path1)  # Sensitive

shutil.make_archive('/tmp/archive', 'gztar', '/tmp/dir1')  # Sensitive
shutil.unpack_archive('/tmp/archive.tar.gz')  # Sensitive</pre>
</div>
</div>
<div class="paragraph">
<p><code>tempfile</code> module. Accessing temporary files is also risky.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>import tempfile

tempfile.TemporaryFile()  # Sensitive

tempfile.NamedTemporaryFile()  # Sensitive

tempfile.SpooledTemporaryFile()  # Sensitive

tempfile.mkstemp()  # Sensitive

tempfile.mktemp()  # Sensitive and usually dangerous. Use tempfile.mkstemp instead.</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-top-ten/2017/A3_2017-Sensitive_Data_Exposure">Top 10 2017 Category A3 - Sensitive Data Exposure</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/732">CWE-732 - Incorrect Permission Assignment for Critical Resource</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/73">CWE-73 - External Control of File Name or Path</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/20">CWE-20 - Improper Input Validation		</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/22">CWE-22 - Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/400">CWE-400 - Uncontrolled Resource Consumption ('Resource Exhaustion')</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/538">CWE-538 - File and Directory Information Exposure</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/403">CWE-403 - Exposure of File Descriptor to Unintended Control Sphere ('File Descriptor Leak')</a></p>
</li>
</ul>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Make sure this file handling is safe here.</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_is_related_to_s2083">is related to: <a data-rspec-id="S2083" class="rspec-auto-link">S2083</a></h3>

</div>
</div>
</div>