<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is an issue when methods in Jenkins pipeline scripts use closure-heavy operations like <code>collect</code>, <code>findAll</code>, <code>each</code>, or <code>eachLine</code> without the <code>@NonCPS</code> annotation.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Jenkins pipelines use Continuation Passing Style (CPS) transformation to make code serializable and resumable. However, this transformation can cause issues with closure-heavy operations, leading to unexpected behavior such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Closures executing only once instead of for each element</p>
</li>
<li>
<p>Incorrect return values from closure-based methods</p>
</li>
<li>
<p>Runtime exceptions during pipeline execution</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The CPS transformation struggles with complex closure operations because it needs to serialize the execution state at each step. When closures are used extensively for data processing, the transformation can produce incorrect bytecode that doesn&#8217;t behave as expected.</p>
</div>
<div class="paragraph">
<p>For example, <code>[1, 2, 3].each { println it }</code> might only print <code>1</code> instead of all three numbers, or <code>list.findAll { condition }</code> might return unexpected results.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>Without proper handling of closure-heavy operations, Jenkins pipelines may:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Produce incorrect results from data processing operations</p>
</li>
<li>
<p>Skip iterations in loops, leading to incomplete processing</p>
</li>
<li>
<p>Fail with runtime exceptions during execution</p>
</li>
<li>
<p>Behave inconsistently between different pipeline runs</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These issues can cause deployment failures, incorrect data processing, and unreliable CI/CD workflows.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Add the <code>@NonCPS</code> annotation to methods that use closure-heavy operations. This disables CPS transformation for the method, allowing closures to work correctly. However, ensure the method only performs computations and doesn&#8217;t call asynchronous pipeline steps.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">def processData() {
  return [1, 2, 3].collect { it * 2 } // Noncompliant
}

def filterTargets(config) {
  return config.deployTargets.findAll { !it.hasProperty("deployed") } // Noncompliant
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@com.cloudbees.groovy.cps.NonCPS
def processData() {
  return [1, 2, 3].collect { it * 2 }
}

@com.cloudbees.groovy.cps.NonCPS
def filterTargets(config) {
  return config.deployTargets.findAll { !it.hasProperty("deployed") }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>Jenkins Pipeline CPS Documentation - <a href="https://www.jenkins.io/doc/book/pipeline/cps-method-mismatches/">Official Jenkins documentation on CPS method mismatches and the @NonCPS annotation</a></p>
</li>
<li>
<p>Groovy CPS Plugin Documentation - <a href="https://github.com/jenkinsci/workflow-cps-plugin">Documentation for the Jenkins Workflow CPS plugin that handles pipeline execution</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>