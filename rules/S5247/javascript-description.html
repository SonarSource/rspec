<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To reduce the risk of cross-site scripting attacks, templating systems, such as <code>Twig</code>,  <code>Django</code>,  <code>Smarty</code>,  <code>Groovy's template engine</code>, allow configuration of automatic variable escaping before rendering templates. When escape occurs, characters that make sense to the browser (eg: &lt;a&gt;) will be transformed/replaced with escaped/sanitized values (eg: &amp; lt;a&amp; gt; ).</p>
</div>
<div class="paragraph">
<p>Auto-escaping is not a magic feature to annihilate all cross-site scripting attacks, it depends on <a href="https://twig.symfony.com/doc/3.x/filters/escape.html">the strategy applied</a> and the context, for example a "html auto-escaping" strategy  (which only transforms html characters into <a href="https://developer.mozilla.org/en-US/docs/Glossary/Entity">html entities</a>) will not be relevant when variables are used in a <a href="https://en.wikipedia.org/wiki/HTML_attribute">html attribute</a> because '<code>:</code>' character is not escaped and thus an attack as below is possible:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;a href="{{ myLink }}"&gt;link&lt;/a&gt; // myLink = javascript:alert(document.cookie)
&lt;a href="javascript:alert(document.cookie)"&gt;link&lt;/a&gt; // JS injection (XSS attack)</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ask_yourself_whether">Ask Yourself Whether</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Templates are used to render web content and</p>
<div class="ulist">
<ul>
<li>
<p>dynamic variables in templates come from untrusted locations or are user-controlled inputs</p>
</li>
<li>
<p>there is no local mechanism in place to sanitize or validate the inputs.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is a risk if you answered yes to any of those questions.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_recommended_secure_coding_practices">Recommended Secure Coding Practices</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Enable auto-escaping by default and continue to review the use of inputs in order to be sure that the chosen auto-escaping strategy is the right one.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sensitive_code_example">Sensitive Code Example</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://www.npmjs.com/package/mustache">mustache.js</a> template engine:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>let Mustache = require("mustache");

Mustache.escape = function(text) {return text;}; // Sensitive

let rendered = Mustache.render(template, { name: inputName });</pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://www.npmjs.com/package/handlebars">handlebars.js</a> template engine:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>const Handlebars = require('handlebars');

let source = "&lt;p&gt;attack {{name}}&lt;/p&gt;";

let template = Handlebars.compile(source, { noEscape: true }); // Sensitive</pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://www.npmjs.com/package/markdown-it">markdown-it</a> markup language parser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>const markdownIt = require('markdown-it');
let md = markdownIt({
  html: true // Sensitive
});

let result = md.render('# &lt;b&gt;attack&lt;/b&gt;');</pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://www.npmjs.com/package/marked">marked</a> markup language parser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>const marked = require('marked');

marked.setOptions({
  renderer: new marked.Renderer(),
  sanitize: false // Sensitive
});

console.log(marked("# test &lt;b&gt;attack/b&gt;"));</pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://www.npmjs.com/package/kramed">kramed</a> markup language parser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>let kramed = require('kramed');

var options = {
  renderer: new kramed.Renderer({
    sanitize: false // Sensitive
  })
};</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compliant_solution">Compliant Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://www.npmjs.com/package/mustache">mustache.js</a> template engine:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">let Mustache = require("mustache");

let rendered = Mustache.render(template, { name: inputName }); // Compliant autoescaping is on by default</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://www.npmjs.com/package/handlebars">handlebars.js</a> template engine:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const Handlebars = require('handlebars');

let source = "&lt;p&gt;attack {{name}}&lt;/p&gt;";
let data = { "name": "&lt;b&gt;Alan&lt;/b&gt;" };

let template = Handlebars.compile(source); // Compliant by default noEscape is set to false</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://www.npmjs.com/package/markdown-it">markdown-it</a> markup language parser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">let md = require('markdown-it')(); // Compliant by default html is set to false

let result = md.render('# &lt;b&gt;attack&lt;/b&gt;');</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://www.npmjs.com/package/marked">marked</a> markup language parser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const marked = require('marked');

marked.setOptions({
  renderer: new marked.Renderer()
}); // Compliant by default sanitize is set to true

console.log(marked("# test &lt;b&gt;attack/b&gt;"));</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://www.npmjs.com/package/kramed">kramed</a> markup language parser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">let kramed = require('kramed');

let options = {
  renderer: new kramed.Renderer({
    sanitize: true // Compliant
  })
};

console.log(kramed('Attack [xss?](javascript:alert("xss")).', options));</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>OWASP - <a href="https://owasp.org/Top10/A03_2021-Injection/">Top 10 2021 Category A3 - Injection</a></p>
</li>
<li>
<p><a href="https://github.com/OWASP/CheatSheetSeries/blob/master/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.md">OWASP Cheat Sheet</a> - XSS Prevention Cheat Sheet</p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-top-ten/2017/A7_2017-Cross-Site_Scripting_(XSS)">Top 10 2017 Category A7 - Cross-Site Scripting (XSS)</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/79">CWE-79 - Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')</a></p>
</li>
</ul>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Make sure disabling auto-escaping feature is safe here.</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_on_14_may_2019_220746_lars_svensson_wrote">on 14 May 2019, 22:07:46 Lars Svensson wrote:</h3>
<div class="paragraph">
<p>Reference:</p>
</div>
<div class="paragraph">
<p><a href="https://reactjs.org/docs/dom-elements.html#dangerouslysetinnerhtml" class="bare">https://reactjs.org/docs/dom-elements.html#dangerouslysetinnerhtml</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_on_10_sep_2019_082846_alexandre_gigleux_wrote">on 10 Sep 2019, 08:28:46 Alexandre Gigleux wrote:</h3>
<div class="paragraph">
<p>Angular case should also be covered by this rule:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>https://docs.angularjs.org/api/ng/service/$sce#trustAsHtml</p>
</li>
<li>
<p>https://angular.io/api/platform-browser/DomSanitizer#bypassSecurityTrustHtml</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_deprecates_s5439">deprecates: <a data-rspec-id="S5439" class="rspec-auto-link">S5439</a></h3>

</div>
</div>
</div>