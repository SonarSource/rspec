<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Generally speaking, main threads should be available to allow user-facing parts of an application to remain responsive. Long-running blocking operations can significantly reduce threads' availability and are best executed on a designated thread pool.</p>
</div>
<div class="paragraph">
<p>As a consequence, suspending functions should not block main threads and instead move any long-running blocking tasks off the main thread. This can be done conveniently by using <code>withContext</code> with an appropriate dispatcher. Alternatively, coroutine builders such as <code>launch</code> and <code>async</code> accept an optional <code>CoroutineContext</code>. An appropriate dispatcher could be <code>Dispatchers.IO</code> for long-running blocking IO operations, which can create and shutdown threads on demand.</p>
</div>
<div class="paragraph">
<p>For some blocking tasks and APIs there may already be suspending alternatives available. When available, these alternatives should be used instead of their blocking counterparts.</p>
</div>
<div class="paragraph">
<p>This rule raises an issue when the call of a long-running blocking function is detected within a suspending function without the use of an appropriate dispatcher. If non-blocking alternatives to the called function are known, they may be suggested (e.g. use <code>delay(&#8230;&#8203;)</code> instead of <code>Thread.sleep(&#8230;&#8203;)</code>).</p>
</div>
<div class="sect2">
<h3 id="_noncompliant_code_example">Noncompliant code example</h3>
<div class="paragraph">
<p>Executing long-running blocking IO operations on the main thread pool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin">class workerClass {
    suspend fun worker(): String {
        val client = HttpClient.newHttpClient()
        val request = HttpRequest.newBuilder(URI("https://example.com")).build()
        return coroutineScope {
            client.send(request, HttpResponse.BodyHandlers.ofString()).body() // Noncompliant
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using inappropriate blocking APIs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin">suspend fun example() {
    ...
    Thread.sleep(1000) // Noncompliant
    ...
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_compliant_solution">Compliant solution</h3>
<div class="paragraph">
<p>Executing long-running blocking IO operations in an appropriate thread pool using <code>Dispatcher.IO</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin">class workerClass(
    private val ioDispatcher: CoroutineDispatcher = Dispatchers.IO
) {
    suspend fun worker(): String {
        val client = HttpClient.newHttpClient()
        val request = HttpRequest.newBuilder(URI("https://example.com")).build()
        return withContext(ioDispatcher) {
            client.send(request, HttpResponse.BodyHandlers.ofString()).body() // Compliant
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using appropriate non-blocking APIs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin">suspend fun example() {
    ...
    delay(1000) // Compliant
    ...
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://kotlinlang.org/docs/coroutine-context-and-dispatchers.html">Coroutine context and dispatchers</a></p>
</li>
<li>
<p><a href="https://developer.android.com/kotlin/coroutines/coroutines-best-practices#main-safe">Suspend functions should be safe to call from the main thread</a> (Android coroutines best practices)</p>
</li>
<li>
<p><a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-dispatchers/-i-o.html">IO CoroutineDispatcher</a></p>
</li>
<li>
<p><a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-dispatchers/-default.html">Default CoroutineDispatcher</a></p>
</li>
</ul>
</div>
</div>
</div>