== Why is this an issue?

Include injection vulnerabilties occur in an application if data from an untrusted source +
like user input is inserted into an include statement without sanitizing first. 
User-provided data such as URL parameters, POST data payloads or cookies should always be considered untrusted and tainted.

If an application contains include statements that process user controlled input, +
an attacker can control which files will be included on the server side in the PHP script leading to unwanted behavior.

=== What is the potential impact?
A user with malicious intent can abuse an include injection vulnerability to read local files on the server or even execute arbitrary PHP code in the context of the server.

The impact depends on the access control measures taken on the target system
OS. In the worst-case scenario, the process runs with root privileges, and
therefore any OS commands or programs may be affected.

Below are some real-world scenarios that illustrate some impacts of an attacker
exploiting the vulnerability.

==== Denial of service and data leaks

In this scenario, the attack aims to disrupt the organization's activities and
profit from data leaks.

An attacker could, for example:

* download the internal server's data, most likely to sell it
* modify data, send malware
* stop services or exhaust resources (with fork bombs for example)

This threat is particularly insidious if the attacked organization does not
maintain a disaster recovery plan (DRP).

==== Root privilege escalation and pivot

In this scenario, the attacker can do everything described in the previous
section. The difference is that the attacker also manages to elevate their
privileges to an administrative level and attacks other servers.

Here, the impact depends on how much the target company focuses on its Defense
In Depth. For example, the entire infrastructure can be compromised by a
combination of OS injections and *misconfiguration* of:

* Docker or Kubernetes clusters
* cloud services
* network firewalls and routing
* OS access control

== How to fix it

=== Code examples

==== Noncompliant code example
The following code is vulnerable to include injection because it
is inserting untrusted inputs directly into the `include()` statement, +
allowing attackers to specify arbitrary local or even remote files to be included.
[source,php]
----
$filename = $_GET["filename"];
include($filename); // Noncompliant
----


==== Compliant solution

[source,php]
----
$filename = $_GET["filename"];
if (in_array($filename, $whitelist)) {
  include($filename); 
}
----

=== How does this work?

== Use whitelisting

The universal method to prevent include injection is to allow only a whitelist of inputs to be passed to the include function.
This whitelist should contain only files that are safe to include. Manual sanitization is error-prone, so it is best to be as restrictive as possible.

Here, the variable `$whitelist` contains a list of the only allowed files to include. If the user controlled variable `$filename` contains anything that is **not** in the whitelist
the include statement will not be executed, preventing the injection of any unwanted inputs.

== Resources

* https://owasp.org/Top10/A03_2021-Injection/[OWASP Top 10 2021 Category A3] - Injection
* https://owasp.org/Top10/A08_2021-Software_and_Data_Integrity_Failures/[OWASP Top 10 2021 Category A8] - Software and Data Integrity Failures
* https://owasp.org/www-project-top-ten/2017/A1_2017-Injection[OWASP Top 10 2017 Category A1] - Injection
* https://cwe.mitre.org/data/definitions/20[MITRE, CWE-20] - Improper Input Validation
* https://cwe.mitre.org/data/definitions/97[MITRE, CWE-97] - Improper Neutralization of Server-Side Includes (SSI) Within a Web Page
* https://cwe.mitre.org/data/definitions/98[MITRE, CWE-98] - Improper Control of Filename for Include/Require Statement in PHP Program ('PHP Remote File Inclusion')
* https://cwe.mitre.org/data/definitions/829[MITRE, CWE-829] - Inclusion of Functionality from Untrusted Control Sphere
* https://www.sans.org/top25-software-errors/#cat2[SANS Top 25] - Risky Resource Management


ifdef::env-github,rspecator-view[]

'''
== Implementation Specification
(visible only on this page)

=== Message

Refactor this code to not use tainted, user-controlled data in include statements.


=== Highlighting

"[varname]" is tainted (assignments and parameters)

this argument is tainted (method invocations)

the returned value is tainted (returns & method invocations results)


endif::env-github,rspecator-view[]
