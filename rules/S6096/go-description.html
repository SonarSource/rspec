<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Zip slip is a special case of path injection. It occurs when an application uses the name of an archive entry to construct a file path and access this file without validating its path first.</p>
</div>
<div class="paragraph">
<p>This rule will consider all archives untrusted, assuming they have been created outside the application file system.</p>
</div>
<div class="paragraph">
<p>A user with malicious intent would inject specially crafted values, such as <code>../</code>, in the archive entry name to change the initial intended path. The resulting path would resolve somewhere in the filesystem where the user should not normally have access.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>A web application is vulnerable to Zip Slip and an attacker is able to exploit
it by submitting an archive he controls.</p>
</div>
<div class="paragraph">
<p>The files that can be affected are limited by the permission of the process
that runs the application. Worst case scenario: the process runs with root
privileges on Linux, and therefore any file can be affected.</p>
</div>
<div class="paragraph">
<p>Below are some real-world scenarios that illustrate some impacts of an attacker
exploiting the vulnerability.</p>
</div>
<div class="sect3">
<h4 id="_override_arbitrary_files">Override arbitrary files</h4>
<div class="paragraph">
<p>The application opens the archive to copy its entries to the file system. The
entries' names contain path traversal payloads for existing files in the
system, which are overwritten once the entries are copied. The vulnerability is
exploited to corrupt files critical for the application or operating system to
work properly.</p>
</div>
<div class="paragraph">
<p>It could result in data being lost or the application being unavailable.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it_in_archivezip">How to fix it in archive/zip</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="paragraph">
<p>The following code is vulnerable to Zip Slip as it is constructing a path using an archive entry name. This path is then used to copy a file without being validated first. Therefore, it can be leveraged by an attacker to overwrite arbitrary files.</p>
</div>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-go" data-lang="go">import (
	"archive/zip"
	"io"
	"os"
	"path/filepath"
)

func Extract(zipFile *zip.Reader, targetDirectory string) {
	for _, file := range zipFile.File {
		srcFile, _ := file.Open()
		outFilename := filepath.Join(targetDirectory, file.Name)

		outFile, _ := os.Create(outFilename)
		io.Copy(outFile, srcFile)
	}
}

func Example() {
	zipFile, _ := zip.OpenReader("testdata/example.zip")
	Extract(&amp;zipFile.Reader, "/tmp/uploads")
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-go" data-lang="go">import (
	"archive/zip"
	"io"
	"os"
	"path/filepath"
	"strings"
)

func Extract(zipFile *zip.Reader, targetDirectory string) {
	for _, file := range zipFile.File {
		srcFile, _ := file.Open()
		outFilename := filepath.Join(targetDirectory, file.Name)

		if !strings.HasPrefix(filepath.Clean(outFilename), targetDirectory) {
			continue // zip slip detected
		}

		outFile, _ := os.Create(outFilename)
		io.Copy(outFile, srcFile)
	}
}

func Example() {
	zipFile, _ := zip.OpenReader("testdata/example.zip")
	Extract(&amp;zipFile.Reader, "/tmp/uploads/") // Note the trailing slash
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_how_does_this_work">How does this work?</h3>
<div class="paragraph">
<p>The universal way to prevent Zip Slip is to validate the paths constructed from untrusted archive entry names.</p>
</div>
<div class="paragraph">
<p>The validation should be done as follow:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Resolve the canonical path of the file by using methods like <code>filepath.Clean</code> or <code>filepath.Abs</code>. This will resolve relative path or path components like <code>../</code> and removes any ambiguity regarding the file&#8217;s location.</p>
</li>
<li>
<p>Check that the canonical path is within the directory where the file should be located.</p>
</li>
<li>
<p>Ensure the target directory path ends with a forward slash to prevent partial path traversal, for example, <strong>/base/dirmalicious</strong> starts with <strong>/base/dir</strong> but does not start with <strong>/base/dir/</strong>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_pitfalls">Pitfalls</h3>
<div class="sect3">
<h4 id="_partial_path_traversal">Partial Path Traversal</h4>
<div class="paragraph">
<p>When validating untrusted paths by checking if they start with a trusted folder name,
<strong>ensure the validation strings all contain a path separator as the last
character</strong>.<br>
A partial path traversal vulnerability can be unintentionally introduced into
the application without a path separator as the last character of the
validation strings.</p>
</div>
<div class="paragraph">
<p>The non-compliant code example is also vulnerable to partial path injection.
Note how the target directory does not have a trailing path separator.</p>
</div>
<div class="paragraph">
<p>Even if the directory prefix would be checked, the check could be bypassed by using a path that is a prefix of the target directory.
For example, <code>/tmp/uploads_injectedfile.php</code> could be slipped into the system and combined with other vulnerabilities to form an attack chain.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it_in_archivetar">How to fix it in archive/tar</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_code_examples_2">Code examples</h3>
<div class="paragraph">
<p>The following code is vulnerable to Zip Slip as it is constructing a path using an archive entry name. This path is then used to copy a file without being validated first. Therefore, it can be leveraged by an attacker to overwrite arbitrary files.</p>
</div>
<div class="sect3">
<h4 id="_noncompliant_code_example_2">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-go" data-lang="go">import (
	"archive/tar"
	"io"
	"os"
	"path/filepath"
)

func Extract(tarReader *tar.Reader, targetDirectory string) {
	for {
		header, err := tarReader.Next()
		if err != nil {
			break
		}

		outFilename := filepath.Join(targetDirectory, header.Name)
		outFile, _ := os.Create(outFilename)
		io.Copy(outFile, tarReader)
	}
}

func Example() {
	tarFile, _ := os.Open("testdata/example.tar")
	tarReader := tar.NewReader(tarFile)
	Extract(tarReader, "/tmp/uploads")
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution_2">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-go" data-lang="go">import (
	"archive/tar"
	"io"
	"os"
	"path/filepath"
	"strings"
)

func Extract(tarReader *tar.Reader, targetDirectory string) {
	for {
		header, err := tarReader.Next()
		if err != nil {
			break
		}

		outFilename := filepath.Join(targetDirectory, header.Name)
		if !strings.HasPrefix(filepath.Clean(outFilename), filepath.Clean(targetDirectory)) {
			continue // zip slip detected
		}

		outFile, _ := os.Create(outFilename)
		io.Copy(outFile, tarReader)
	}
}

func Example() {
	tarFile, _ := os.Open("testdata/example.tar")
	tarReader := tar.NewReader(tarFile)
	Extract(tarReader, "/tmp/uploads/") // Note the trailing slash
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_how_does_this_work_2">How does this work?</h3>
<div class="paragraph">
<p>The universal way to prevent Zip Slip is to validate the paths constructed from untrusted archive entry names.</p>
</div>
<div class="paragraph">
<p>The validation should be done as follow:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Resolve the canonical path of the file by using methods like <code>filepath.Clean</code> or <code>filepath.Abs</code>. This will resolve relative path or path components like <code>../</code> and removes any ambiguity regarding the file&#8217;s location.</p>
</li>
<li>
<p>Check that the canonical path is within the directory where the file should be located.</p>
</li>
<li>
<p>Ensure the target directory path ends with a forward slash to prevent partial path traversal, for example, <strong>/base/dirmalicious</strong> starts with <strong>/base/dir</strong> but does not start with <strong>/base/dir/</strong>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_pitfalls_2">Pitfalls</h3>
<div class="sect3">
<h4 id="_partial_path_traversal_2">Partial Path Traversal</h4>
<div class="paragraph">
<p>When validating untrusted paths by checking if they start with a trusted folder name,
<strong>ensure the validation strings all contain a path separator as the last
character</strong>.<br>
A partial path traversal vulnerability can be unintentionally introduced into
the application without a path separator as the last character of the
validation strings.</p>
</div>
<div class="paragraph">
<p>The non-compliant code example is also vulnerable to partial path injection.
Note how the target directory does not have a trailing path separator.</p>
</div>
<div class="paragraph">
<p>Even if the directory prefix would be checked, the check could be bypassed by using a path that is a prefix of the target directory.
For example, <code>/tmp/uploads_injectedfile.php</code> could be slipped into the system and combined with other vulnerabilities to form an attack chain.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_articles_blog_posts">Articles &amp; blog posts</h3>
<div class="ulist">
<ul>
<li>
<p>Sonar Blog - <a href="https://www.sonarsource.com/blog/the-hidden-flaws-of-archives-in-java/">The Hidden Flaws of Archives in Java</a></p>
</li>
<li>
<p>Sonar Blog - <a href="https://www.sonarsource.com/blog/openrefine-zip-slip/">Unzipping Dangers: OpenRefine Zip Slip Vulnerability</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_standards">Standards</h3>
<div class="ulist">
<ul>
<li>
<p>OWASP - <a href="https://owasp.org/Top10/A01_2021-Broken_Access_Control/">Top 10 2021 Category A1 - Broken Access Control</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/Top10/A03_2021-Injection/">Top 10 2021 Category A3 - Injection</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-top-ten/2017/A1_2017-Injection">Top 10 2017 Category A1 - Injection</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-top-ten/2017/A5_2017-Broken_Access_Control">Top 10 2017 Category A5 - Broken Access Control</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/20">CWE-20 - Improper Input Validation</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/22">CWE-22 - Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')</a></p>
</li>
<li>
<p>STIG Viewer - <a href="https://stigviewer.com/stigs/application_security_and_development/2024-12-06/finding/V-222609">Application Security and Development: V-222609</a> - The application must not be subject to input handling vulnerabilities.</p>
</li>
</ul>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Change this code to not construct the path from file name entry of an archive.</p>
</div>
</div>
</div>
</div>