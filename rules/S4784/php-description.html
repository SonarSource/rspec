<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Using regular expressions is security-sensitive. It has led in the past to the following vulnerabilities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.cve.org/CVERecord?id=CVE-2017-16021">CVE-2017-16021</a></p>
</li>
<li>
<p><a href="https://www.cve.org/CVERecord?id=CVE-2018-13863">CVE-2018-13863</a></p>
</li>
<li>
<p><a href="https://www.cve.org/CVERecord?id=CVE-2018-8926">CVE-2018-8926</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Evaluating regular expressions against input strings is potentially an extremely CPU-intensive task. Specially crafted regular expressions such as <code>/(a+)+s/</code> will take several seconds to evaluate the input string <code>aaaaaaaaaaaaaaaaaaaaaaaaaaaaaabs</code>. The problem is that with every additional <code>a</code> character added to the input, the time required to evaluate the regex doubles. However, the equivalent regular expression, <code>a+s</code> (without grouping) is efficiently evaluated in milliseconds and scales linearly with the input size.</p>
</div>
<div class="paragraph">
<p>Evaluating such regular expressions opens the door to <a href="https://owasp.org/www-community/attacks/Regular_expression_Denial_of_Service_-_ReDoS">Regular expression Denial of Service (ReDoS)</a> attacks. In the context of a web application, attackers can force the web server to spend all of its resources evaluating regular expressions thereby making the service inaccessible to genuine users.</p>
</div>
<div class="paragraph">
<p>This rule flags any execution of a hardcoded regular expression which has at least 3 characters and contains at at least two instances of any of the following characters <code>*+{</code>.</p>
</div>
<div class="paragraph">
<p>Example: <code>(a+)*</code></p>
</div>
<div class="paragraph">
<p>The following functions are detected as executing regular expressions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://php.net/manual/en/book.pcre.php">PCRE</a>: Perl style regular expressions: <a href="http://php.net/manual/en/function.preg-filter.php">preg_filter</a>, <a href="http://php.net/manual/en/function.preg-grep.php">preg_grep</a>, <a href="http://php.net/manual/en/function.preg-match-all.php">preg_match_all</a>, <a href="http://php.net/manual/en/function.preg-match.php">preg_match</a>, <a href="http://php.net/manual/en/function.preg-replace-callback.php">preg_replace_callback</a>, <a href="http://php.net/manual/en/function.preg-replace.php">preg_replace</a>, <a href="http://php.net/manual/en/function.preg-split.php">preg_split</a></p>
</li>
<li>
<p><a href="http://php.net/manual/en/book.regex.php">POSIX extended</a>, which are deprecated: <a href="http://php.net/manual/en/function.ereg-replace.php">ereg_replace</a>, <a href="http://php.net/manual/en/function.ereg.php">ereg</a>, <a href="http://php.net/manual/en/function.eregi-replace.php">eregi_replace</a>, <a href="http://php.net/manual/en/function.eregi.php">eregi</a>, <a href="http://php.net/manual/en/function.split.php">split</a>, <a href="http://php.net/manual/en/function.spliti.php">spliti</a>.</p>
</li>
<li>
<p><a href="http://php.net/manual/en/function.fnmatch.php">fnmatch</a></p>
</li>
<li>
<p>Any of the multibyte string regular expressions: <a href="http://php.net/manual/en/function.mb-eregi-replace.php">mb_eregi_replace</a>, <a href="http://php.net/manual/en/function.mb-ereg-match.php">mb_ereg_match</a>, <a href="http://php.net/manual/en/function.mb-ereg-replace-callback.php">mb_ereg_replace_callback</a>, <a href="http://php.net/manual/en/function.mb-ereg-replace.php">mb_ereg_replace</a>, <a href="http://php.net/manual/en/function.mb-ereg-search-init.php">mb_ereg_search_init</a>, <a href="http://php.net/manual/en/function.mb-ereg-search-pos.php">mb_ereg_search_pos</a>, <a href="http://php.net/manual/en/function.mb-ereg-search-regs.php">mb_ereg_search_regs</a>, <a href="http://php.net/manual/en/function.mb-ereg-search.php">mb_ereg_search</a>, <a href="http://php.net/manual/en/function.mb-ereg.php">mb_ereg</a>, <a href="http://php.net/manual/en/function.mb-eregi-replace.php">mb_eregi_replace</a>, <a href="http://php.net/manual/en/function.mb-eregi.php">mb_eregi</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that <code>ereg*</code> functions have been removed in PHP 7 and <strong>PHP 5 end of life date is the 1st of January 2019. Using PHP 5 is dangerous as there will be no security fix</strong>.</p>
</div>
<div class="paragraph">
<p>This rule&#8217;s goal is to guide security code reviews.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ask_yourself_whether">Ask Yourself Whether</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>the executed regular expression is sensitive and a user can provide a string which will be analyzed by this regular expression.</p>
</li>
<li>
<p>your regular expression engine performance decrease with specially crafted inputs and regular expressions.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is a risk if you answered yes to any of those questions.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_recommended_secure_coding_practices">Recommended Secure Coding Practices</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Do not set the constant <code>pcre.backtrack_limit</code> to a high value as it will increase the resource consumption of PCRE functions.</p>
</div>
<div class="paragraph">
<p>Check the error codes of PCRE functions via <code>preg_last_error</code>.</p>
</div>
<div class="paragraph">
<p>Check whether your regular expression engine (the algorithm executing your regular expression) has any known vulnerabilities. Search for vulnerability reports mentioning the one engine you&#8217;re are using. Do not run vulnerable regular expressions on user input.</p>
</div>
<div class="paragraph">
<p>Use if possible a library which is not vulnerable to Redos Attacks such as <a href="https://github.com/google/re2">Google Re2</a>.</p>
</div>
<div class="paragraph">
<p>Remember also that a ReDos attack is possible if a user-provided regular expression is executed. This rule won&#8217;t detect this kind of injection.</p>
</div>
<div class="paragraph">
<p>Avoid executing a user input string as a regular expression or use at least <code>preg_quote</code> to escape regular expression characters.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_exceptions">Exceptions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>An issue will be created for the functions <code>mb_ereg_search_pos</code>, <code>mb_ereg_search_regs</code> and <code>mb_ereg_search</code> if and only if at least the first argument, i.e. the $pattern, is provided.</p>
</div>
<div class="paragraph">
<p>The current implementation does not follow variables. It will only detect regular expressions hard-coded directly in the function call.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$pattern = "/(a+)+/";
$result = eregi($pattern, $input);  // No issue will be raised even if it is Sensitive</pre>
</div>
</div>
<div class="paragraph">
<p>Some corner-case regular expressions will not raise an issue even though they might be vulnerable. For example: <code>(a|aa)``, ``(a|a?)</code>.</p>
</div>
<div class="paragraph">
<p>It is a good idea to test your regular expression if it has the same pattern on both side of a "<code>|</code>".</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-top-ten/2017/A1_2017-Injection">Top 10 2017 Category A1 - Injection</a></p>
</li>
<li>
<p>CWE - <a href="https://owasp.org/www-community/attacks/Regular_expression_Denial_of_Service_-_ReDoS">CWE-624 - Executable Regular Expression Error</a></p>
</li>
<li>
<p>OWASP Regular expression Denial of Service - ReDoS</p>
</li>
</ul>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Make sure that using a regular expression is safe here.</p>
</div>
</div>
<div class="sect2">
<h3 id="_highlighting">Highlighting</h3>
<div class="paragraph">
<p>The regular expression parameter</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_is_related_to_s2631">is related to: <a data-rspec-id="S2631" class="rspec-auto-link">S2631</a></h3>

</div>
<div class="sect2">
<h3 id="_on_25_sep_2018_143943_ann_campbell_wrote">on 25 Sep 2018, 14:39:43 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~nicolas.harraudeau] this response seems like good fodder for the docs, specifically: https://github.com/SonarSource/sonar-enterprise/blob/feature/docs/cut-over/server/sonar-docs/src/pages/user-guide/security-reports.md</p>
</div>
<div class="paragraph">
<p>What do you think?</p>
</div>
</div>
</div>
</div>