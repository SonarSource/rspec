== How to fix it in Apache Commons

=== Code examples

The following noncompliant code is vulnerable to XPath injections because
untrusted data is concatenated to an XPath query without prior validation.

==== Noncompliant code example

[source,java,diff-id=11,diff-type=noncompliant]
----
public class Book {
  public String getName() { /* ... */ }
}

public class Author {
  public Book[] getBooks() { /* ... */ }
}

public Book findBook(HttpServletRequest req, Author author) throws JXPathException {
  String name = request.getParameter("name"); 

  JXPathContext context = JXPathContext.newContext(author);

  return (Book)context.getValue("books[@name='" + name + "']");
}
----

==== Compliant solution

[source,java,diff-id=11,diff-type=compliant]
----
public class Book {
  public String getName() { /* ... */ }
}

public class Author {
  public Book[] getBooks() { /* ... */ }
}

public Book findBook(HttpServletRequest req, Author author) throws JXPathException {
  String name = request.getParameter("name"); 

  JXPathContext context = JXPathContext.newContext(author);
  context.getVariables().declareVariable("name", name);

  return (Book)context.getValue("books[@name=$name]");
}
----

=== How does this work?

JXPath is slightly different to other XPath implementations because it works on
object trees rather than just XML documents. This additional functionality can
lead to a greater range of side-effects, potentially including remote code
execution (RCE).

As a rule of thumb, the best approach to protect against injections is to
systematically ensure that untrusted data cannot break out of the initially
intended logic.

include::../../common/fix/parameterized-queries.adoc[]

In the example, a variable is declared to hold the value of the untrusted data.
That variable then used to safely reference the value of the untrusted data,
similar to parameterized SQL queries.

include::../../common/fix/validation.adoc[]

Extra attention should be given to the characters `(` and `)`. These characters
are commonly used when attempting to exploit JXPath weaknesses and should be
rejected as unsafe.
