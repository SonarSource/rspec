<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>XPath injections occur in an application when the application retrieves
untrusted data and inserts it into an XML Path (XPath) query without sanitizing
it first.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>In the context of a web application vulnerable to XPath injection:<br>
After discovering the injection point, attackers insert data into the
vulnerable field to execute malicious commands in the affected XML documents.</p>
</div>
<div class="paragraph">
<p>The impact of this vulnerability depends on the importance of XML
structures in the enterprise.<br>
In cases where organizations rely on XML structures for business-critical
operations or where XML is used only for innocuous data transport, the severity
of an attack ranges from critical to harmless.</p>
</div>
<div class="paragraph">
<p>Below are some real-world scenarios that illustrate some impacts of an attacker
exploiting the vulnerability.</p>
</div>
<div class="sect3">
<h4 id="_data_leaks">Data Leaks</h4>
<div class="paragraph">
<p>A malicious XPath query allows direct data leakage from one or more databases.
Although XML is not as widely used as it once was, this possibility still
exists with configuration files, for example.</p>
</div>
</div>
<div class="sect3">
<h4 id="_data_deletion_and_denial_of_service">Data deletion and denial of service</h4>
<div class="paragraph">
<p>The malicious query allows the attacker to delete data in the affected XML
documents.<br>
This threat is particularly insidious if the attacked organization does not
maintain a disaster recovery plan (DRP) and if XML structures are considered
important, as missing critical data can disrupt the regular operations of an
organization.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it_in_java_xml_api">How to fix it in Java XML API</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="paragraph">
<p>The following noncompliant code is vulnerable to XPath injections because untrusted data is
concatenated to an XPath query without prior validation.</p>
</div>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import javax.xml.xpath.XPath;
import javax.xml.xpath.XPathConstants;

public boolean authenticate(HttpServletRequest request, XPath xpath, Document doc) throws XPathExpressionException {
  String user = request.getParameter("user");
  String pass = request.getParameter("pass");

  String expression = "/users/user[@name='" + user + "' and @pass='" + pass + "']";

  return (boolean)xpath.evaluate(expression, doc, XPathConstants.BOOLEAN);
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import javax.xml.xpath.XPath;
import javax.xml.xpath.XPathConstants;
import javax.xml.xpath.XPathVariableResolver;

public boolean authenticate(HttpServletRequest request, XPath xpath, Document doc) throws XPathExpressionException {
  String user = request.getParameter("user");
  String pass = request.getParameter("pass");

  String expression = "/users/user[@name=$user and @pass=$pass]";

  xpath.setXPathVariableResolver(v -&gt; {
    switch (v.getLocalPart()) {
      case "user":
        return user;
      case "pass":
        return pass;
      default:
        throw new IllegalArgumentException();
    }
  });

  return (boolean)xpath.evaluate(expression, doc, XPathConstants.BOOLEAN);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_how_does_this_work">How does this work?</h3>
<div class="paragraph">
<p>As a rule of thumb, the best approach to protect against injections is to
systematically ensure that untrusted data cannot break out of the initially
intended logic.</p>
</div>
<div class="sect3">
<h4 id="_parameterized_queries">Parameterized Queries</h4>
<div class="paragraph">
<p>For XPath injections, the cleanest way to do so is to use parameterized queries.</p>
</div>
<div class="paragraph">
<p>XPath allows for the usage of variables inside expressions in the form of <code>$variable</code>. XPath variables can be used to construct an XPath query without needing to concatenate user arguments to the query at runtime. Here is an example of an XPath query with variables:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>/users/user[@user=$user and @pass=$pass]</pre>
</div>
</div>
<div class="paragraph">
<p>When the XPath query is executed, the user input is passed alongside it. During execution, when the values of the variables need to be known, a resolver will return the correct user input for each variable. The contents of the variables are not considered application logic by the XPath executor, and thus injection is not possible.</p>
</div>
<div class="paragraph">
<p>In the example, a parameterized XPath query is created, and an <code>XPathVariableResolver</code> is used to securely insert untrusted data into the query, similar to parameterized SQL queries.</p>
</div>
</div>
<div class="sect3">
<h4 id="_validation">Validation</h4>
<div class="paragraph">
<p>In case XPath parameterized queries are not available, the most secure way to protect against injections is to validate the input before using it in an XPath query.</p>
</div>
<div class="paragraph">
<p><strong>Important</strong>: The application must do this validation server-side. Validating this client-side is insecure.</p>
</div>
<div class="paragraph">
<p>Input can be validated in multiple ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>By checking against a list of authorized and secure strings that the application is allowed to use in a query.</p>
</li>
<li>
<p>By ensuring user input is restricted to a specific range of characters (e.g., the regex <code>/^[a-zA-Z0-9]*$/</code> only allows alphanumeric characters.)</p>
</li>
<li>
<p>By ensuring user input does not include any XPath metacharacters, such as <code>"</code>, <code>'</code>, <code>/</code>, <code>@</code>, <code>=</code>, <code>*</code>, <code>[</code>, <code>]</code>, <code>(</code> and <code>)</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If user input is not considered valid, it should be rejected as it is unsafe.</p>
</div>
<div class="paragraph">
<p>For Java, OWASP&#8217;s Enterprise Security API offers <a href="https://www.javadoc.io/doc/org.owasp.esapi/esapi/latest/org/owasp/esapi/Encoder.html#encodeForXPath-java.lang.String-"><code>encodeForXPath</code></a> which sanitizes metacharacters automatically.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it_in_apache_commons">How to fix it in Apache Commons</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_code_examples_2">Code examples</h3>
<div class="paragraph">
<p>The following noncompliant code is vulnerable to XPath injections because
untrusted data is concatenated to an XPath query without prior validation.</p>
</div>
<div class="sect3">
<h4 id="_noncompliant_code_example_2">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public Book findBook(HttpServletRequest req, Author author) throws JXPathException {
  String name = request.getParameter("name");

  JXPathContext context = JXPathContext.newContext(author);

  return (Book)context.getValue("books[@name='" + name + "']");
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution_2">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public Book findBook(HttpServletRequest req, Author author) throws JXPathException {
  String name = request.getParameter("name");

  JXPathContext context = JXPathContext.newContext(author);
  context.getVariables().declareVariable("name", name);

  return (Book)context.getValue("books[@name=$name]");
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_how_does_this_work_2">How does this work?</h3>
<div class="paragraph">
<p>JXPath is slightly different to other XPath implementations because it works on
object trees rather than just XML documents. This additional functionality can
lead to a greater range of side-effects, potentially including remote code
execution (RCE).</p>
</div>
<div class="paragraph">
<p>As a rule of thumb, the best approach to protect against injections is to
systematically ensure that untrusted data cannot break out of the initially
intended logic.</p>
</div>
<div class="sect3">
<h4 id="_parameterized_queries_2">Parameterized Queries</h4>
<div class="paragraph">
<p>For XPath injections, the cleanest way to do so is to use parameterized queries.</p>
</div>
<div class="paragraph">
<p>XPath allows for the usage of variables inside expressions in the form of <code>$variable</code>. XPath variables can be used to construct an XPath query without needing to concatenate user arguments to the query at runtime. Here is an example of an XPath query with variables:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>/users/user[@user=$user and @pass=$pass]</pre>
</div>
</div>
<div class="paragraph">
<p>When the XPath query is executed, the user input is passed alongside it. During execution, when the values of the variables need to be known, a resolver will return the correct user input for each variable. The contents of the variables are not considered application logic by the XPath executor, and thus injection is not possible.</p>
</div>
<div class="paragraph">
<p>In the example, a variable is declared to hold the value of the untrusted data.
That variable then used to safely reference the value of the untrusted data,
similar to parameterized SQL queries.</p>
</div>
</div>
<div class="sect3">
<h4 id="_validation_2">Validation</h4>
<div class="paragraph">
<p>In case XPath parameterized queries are not available, the most secure way to protect against injections is to validate the input before using it in an XPath query.</p>
</div>
<div class="paragraph">
<p><strong>Important</strong>: The application must do this validation server-side. Validating this client-side is insecure.</p>
</div>
<div class="paragraph">
<p>Input can be validated in multiple ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>By checking against a list of authorized and secure strings that the application is allowed to use in a query.</p>
</li>
<li>
<p>By ensuring user input is restricted to a specific range of characters (e.g., the regex <code>/^[a-zA-Z0-9]*$/</code> only allows alphanumeric characters.)</p>
</li>
<li>
<p>By ensuring user input does not include any XPath metacharacters, such as <code>"</code>, <code>'</code>, <code>/</code>, <code>@</code>, <code>=</code>, <code>*</code>, <code>[</code>, <code>]</code>, <code>(</code> and <code>)</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If user input is not considered valid, it should be rejected as it is unsafe.</p>
</div>
<div class="paragraph">
<p>Extra attention should be given to the characters <code>(</code> and <code>)</code>. These characters
are commonly used when attempting to exploit JXPath weaknesses and should be
rejected as unsafe.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_articles_blog_posts">Articles &amp; blog posts</h3>
<div class="ulist">
<ul>
<li>
<p>OWASP - <a href="https://cheatsheetseries.owasp.org/cheatsheets/Injection_Prevention_Cheat_Sheet.html#xpath-injection">XPath Injection Prevention Cheat Sheet</a></p>
</li>
<li>
<p>Ambionics - <a href="https://web.archive.org/web/20230602194100/https://www.ambionics.io/blog/hacking-watchguard-firewalls">XPath Injection Section of "Hacking WatchGuard Firewalls'</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_standards">Standards</h3>
<div class="ulist">
<ul>
<li>
<p>OWASP - <a href="https://owasp.org/Top10/A03_2021-Injection/">Top 10 2021 Category A3 - Injection</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-top-ten/2017/A1_2017-Injection">Top 10 2017 Category A1 - Injection</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/20">CWE-20 - Improper Input Validation</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/643">CWE-643 - Improper Neutralization of Data within XPath Expressions</a></p>
</li>
<li>
<p>STIG Viewer - <a href="https://stigviewer.com/stigs/application_security_and_development/2024-12-06/finding/V-222608">Application Security and Development: V-222608</a> - The application must not be vulnerable to XML-oriented attacks.</p>
</li>
<li>
<p>STIG Viewer - <a href="https://stigviewer.com/stigs/application_security_and_development/2024-12-06/finding/V-222609">Application Security and Development: V-222609</a> - The application must not be subject to input handling vulnerabilities.</p>
</li>
</ul>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Change this code to not construct this XPath expression from user-controlled data.</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_relates_to_s4817">relates to: <a data-rspec-id="S4817" class="rspec-auto-link">S4817</a></h3>

</div>
<div class="sect2">
<h3 id="_on_8_oct_2014_072739_nicolas_peru_wrote">on 8 Oct 2014, 07:27:39 Nicolas Peru wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2]Ok with this rule, but I think that during implementation on Java, the checked API should be precised in the description.</p>
</div>
</div>
</div>
</div>