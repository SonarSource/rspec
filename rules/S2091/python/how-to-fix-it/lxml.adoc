=== How to fix it in lxml

The following noncompliant code is vulnerable to XPath injections because untrusted data is
concatenated to an XPath query without prior validation.

==== Noncompliant code example

[source,python,diff-id=1,diff-type=noncompliant]
----
from lxml.etree import ElementTree

def authenticate(tree: ElementTree, username: str, password: str) -> bool:
    expression = "./users/user[@name='" + username + "' and @pass='" + password + "']"

    return tree.xpath(expression) is not None
----

==== Compliant solution

[source,python,diff-id=1,diff-type=compliant]
----
from lxml.etree import ElementTree

def authenticate(tree: ElementTree, username: str, password: str) -> bool:
    expression = "./users/user[@name=$username and @pass=$password]"

    return tree.xpath(expression, username=username, password=password) is not None
----

=== How does this work?

As a rule of thumb, the best approach to protect against injections is to
systematically ensure that untrusted data cannot break out of the initially
intended logic.

include::../../common/fix/parameterized-queries.adoc[]

In the example, the username and password are passed as https://lxml.de/xpathxslt.html#:~:text=The%20xpath()%20method%20has%20support%20for%20XPath%20variables%3A[XPath variables] rather than concatenated to the XPath query. By using a parameterized query, injection is successfully prevented.
