<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>XPath injections occur in an application when the application retrieves
untrusted data and inserts it into an XML Path (XPath) query without sanitizing
it first.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>In the context of a web application vulnerable to XPath injection:<br>
After discovering the injection point, attackers insert data into the
vulnerable field to execute malicious commands in the affected XML documents.</p>
</div>
<div class="paragraph">
<p>The impact of this vulnerability depends on the importance of XML
structures in the enterprise.<br>
In cases where organizations rely on XML structures for business-critical
operations or where XML is used only for innocuous data transport, the severity
of an attack ranges from critical to harmless.</p>
</div>
<div class="paragraph">
<p>Below are some real-world scenarios that illustrate some impacts of an attacker
exploiting the vulnerability.</p>
</div>
<div class="sect3">
<h4 id="_data_leaks">Data Leaks</h4>
<div class="paragraph">
<p>A malicious XPath query allows direct data leakage from one or more databases.
Although XML is not as widely used as it once was, this possibility still
exists with configuration files, for example.</p>
</div>
</div>
<div class="sect3">
<h4 id="_data_deletion_and_denial_of_service">Data deletion and denial of service</h4>
<div class="paragraph">
<p>The malicious query allows the attacker to delete data in the affected XML
documents.<br>
This threat is particularly insidious if the attacked organization does not
maintain a disaster recovery plan (DRP) and if XML structures are considered
important, as missing critical data can disrupt the regular operations of an
organization.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it_in_net">How to fix it in .NET</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="paragraph">
<p>The following code is vulnerable to XPath injections because untrusted data is
concatenated in an XPath query without prior validation.</p>
</div>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-vbnet" data-lang="vbnet">Public Class ExampleController
    Inherits Controller

    &lt;HttpGet&gt;
    Public Function Authenticate(User As String, Pass As String) As IActionResult
        Dim Doc As New XmlDocument()

        Dim Expression As String = "/users/user[@name='" &amp; User &amp; "' and @pass='" &amp; Pass &amp; "']"

        Return Json(Doc.SelectSingleNode(Expression) IsNot Nothing)
    End Function
End Class</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-vbnet" data-lang="vbnet">Public Class ExampleController
    Inherits Controller

    &lt;HttpGet&gt;
    Public Function Authenticate(User As String, Pass As String) As IActionResult
        Dim Doc As New XmlDocument()
        ' restrict the username and password to letters only
        If Not Regex.IsMatch(User, "^[a-zA-Z]+$") OrElse Not Regex.IsMatch(Pass, "^[a-zA-Z]+$") Then
            Return BadRequest()
        End If

        Dim Expression As String = "/users/user[@name='" &amp; User &amp; "' and @pass='" &amp; Pass &amp; "']"

        Return Json(Doc.SelectSingleNode(Expression) IsNot Nothing)
    End Function
End Class</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_how_does_this_work">How does this work?</h3>
<div class="paragraph">
<p>As a rule of thumb, the best approach to protect against injections is to
systematically ensure that untrusted data cannot break out of the initially
intended logic.</p>
</div>
<div class="sect3">
<h4 id="_validation">Validation</h4>
<div class="paragraph">
<p>In case XPath parameterized queries are not available, the most secure way to protect against injections is to validate the input before using it in an XPath query.</p>
</div>
<div class="paragraph">
<p><strong>Important</strong>: The application must do this validation server-side. Validating this client-side is insecure.</p>
</div>
<div class="paragraph">
<p>Input can be validated in multiple ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>By checking against a list of authorized and secure strings that the application is allowed to use in a query.</p>
</li>
<li>
<p>By ensuring user input is restricted to a specific range of characters (e.g., the regex <code>/^[a-zA-Z0-9]*$/</code> only allows alphanumeric characters.)</p>
</li>
<li>
<p>By ensuring user input does not include any XPath metacharacters, such as <code>"</code>, <code>'</code>, <code>/</code>, <code>@</code>, <code>=</code>, <code>*</code>, <code>[</code>, <code>]</code>, <code>(</code> and <code>)</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If user input is not considered valid, it should be rejected as it is unsafe.</p>
</div>
<div class="paragraph">
<p>In the example, a validation mechanism is applied to untrusted input to ensure
it is strictly composed of alphabetic characters.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_articles_blog_posts">Articles &amp; blog posts</h3>
<div class="ulist">
<ul>
<li>
<p>OWASP - <a href="https://cheatsheetseries.owasp.org/cheatsheets/Injection_Prevention_Cheat_Sheet.html#xpath-injection">XPath Injection Prevention Cheat Sheet</a></p>
</li>
<li>
<p>Ambionics - <a href="https://web.archive.org/web/20230602194100/https://www.ambionics.io/blog/hacking-watchguard-firewalls">XPath Injection Section of "Hacking WatchGuard Firewalls'</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_standards">Standards</h3>
<div class="ulist">
<ul>
<li>
<p>OWASP - <a href="https://owasp.org/Top10/A03_2021-Injection/">Top 10 2021 Category A3 - Injection</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-top-ten/2017/A1_2017-Injection">Top 10 2017 Category A1 - Injection</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/20">CWE-20 - Improper Input Validation</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/643">CWE-643 - Improper Neutralization of Data within XPath Expressions</a></p>
</li>
<li>
<p>STIG Viewer - <a href="https://stigviewer.com/stigs/application_security_and_development/2024-12-06/finding/V-222608">Application Security and Development: V-222608</a> - The application must not be vulnerable to XML-oriented attacks.</p>
</li>
<li>
<p>STIG Viewer - <a href="https://stigviewer.com/stigs/application_security_and_development/2024-12-06/finding/V-222609">Application Security and Development: V-222609</a> - The application must not be subject to input handling vulnerabilities.</p>
</li>
</ul>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Change this code to not construct this XPath expression from user-controlled data.</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_relates_to_s4817">relates to: <a data-rspec-id="S4817" class="rspec-auto-link">S4817</a></h3>

</div>
<div class="sect2">
<h3 id="_on_8_oct_2014_072739_nicolas_peru_wrote">on 8 Oct 2014, 07:27:39 Nicolas Peru wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2]Ok with this rule, but I think that during implementation on Java, the checked API should be precised in the description.</p>
</div>
</div>
</div>
</div>