
== Why is this an issue?

include::../rationale.adoc[]

include::../impact.adoc[]

== How to fix it

=== Code examples

The following examples demonstrate XPath injection vulnerabilities in a Node.js
application using the `xpath` module for user authentication against an XML
database.

==== Noncompliant code example

[source,javascript,diff-id=1,diff-type=noncompliant]
----
const xpath = require('xpath');
const dom = require('@xmldom/xmldom').DOMParser;
const express = require('express');
const fs = require('fs');

const app = express();

app.post('/login', (req, res) => {
  const username = req.body.username;
  const password = req.body.password;
  
  // Load XML user database
  const xml = fs.readFileSync('users.xml', 'utf8');
  const doc = new dom().parseFromString(xml);

  const evaluator = xpath.parse(`/users/user[@username='${username}' and @password='${password}']`);

  const nodes = evaluator.select({
    node: doc,
  }); // Noncompliant

  if (nodes.length > 0) {
    res.json({ success: true, message: 'Login successful' });
  } else {
    res.status(401).json({ success: false, message: 'Invalid credentials' });
  }
});
----

==== Compliant solution

[source,javascript,diff-id=1,diff-type=compliant]
----
const xpath = require('xpath');
const dom = require('@xmldom/xmldom').DOMParser;
const express = require('express');
const fs = require('fs');

const app = express();

app.post('/login', (req, res) => {
  const username = req.body.username;
  const password = req.body.password;
  
  // Load XML user database
  const xml = fs.readFileSync('users.xml', 'utf8');
  const doc = new dom().parseFromString(xml);

  const evaluator = xpath.parse('/users/user[@username=$username and @password=$password]');

  const nodes = evaluator.select({
    node: doc,
    variables: {
      username: username,
      password: password
    }
  });

  if (nodes.length > 0) {
    res.json({ success: true, message: 'Login successful' });
  } else {
    res.status(401).json({ success: false, message: 'Invalid credentials' });
  }
});
----

=== How does this work?

include::../common/fix/parameterized-queries.adoc[]

include::../common/fix/validation.adoc[]

== Resources

include::../common/resources/articles.adoc[]

include::../common/resources/standards.adoc[]

ifdef::env-github,rspecator-view[]

'''
== Implementation Specification
(visible only on this page)

include::../message.adoc[]

'''
== Comments And Links
(visible only on this page)

include::../comments-and-links.adoc[]

endif::env-github,rspecator-view[]
