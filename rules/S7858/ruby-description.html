<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is an issue when using <code>map</code> or <code>collect</code> to extract attributes from ActiveRecord collections, when using ActiveRecord methods like <code>pluck</code> on Array objects, or when unnecessarily converting ActiveRecord collections to Arrays before extracting attributes.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ActiveRecord collections and Array objects require different methods for efficient attribute extraction.</p>
</div>
<div class="paragraph">
<p>When you use <code>map</code> or <code>collect</code> on ActiveRecord collections to extract simple attributes, you force Rails to load all database columns for every record into memory first, then extract only the attributes you need. This is inefficient because:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>All database columns are retrieved, not just the ones you need</p>
</li>
<li>
<p>Full ActiveRecord objects are instantiated in memory</p>
</li>
<li>
<p>Memory usage increases significantly with large datasets</p>
</li>
<li>
<p>Database transfer time is longer due to unnecessary data</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ActiveRecord&#8217;s <code>pluck</code> method operates at the database level. It generates SQL that selects only the specified columns, reducing both memory usage and database transfer time.</p>
</div>
<div class="paragraph">
<p>Conversely, ActiveRecord methods like <code>pluck</code> don&#8217;t exist on Array objects and will raise a <code>NoMethodError</code>. Arrays require standard Ruby methods like <code>map</code> or <code>collect</code>.</p>
</div>
<div class="paragraph">
<p>Unnecessarily converting ActiveRecord collections to Arrays (using <code>to_a</code>) before extracting attributes defeats the purpose of database optimization, as you lose the ability to use efficient database-level operations.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>Performance degradation due to increased memory usage and slower database queries. In applications with large datasets, using <code>collect</code> instead of <code>pluck</code> can cause significant slowdowns and memory consumption. Using ActiveRecord methods on Arrays will cause runtime errors that crash the application.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it_in_rails">How to fix it in Rails</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use <code>pluck</code> to extract attributes efficiently from ActiveRecord collections. This operates at the database level and only retrieves the specified columns.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby"># Using collect/map on ActiveRecord collections loads unnecessary data
user_ids = User.all.collect(&amp;:id) # Noncompliant
user_emails = User.all.map(&amp;:email) # Noncompliant</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby"># Use pluck to extract attributes efficiently from ActiveRecord collections
user_ids = User.pluck(:id)
user_emails = User.pluck(:email)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use <code>map</code> or <code>collect</code> on Array objects since ActiveRecord methods are not available on Arrays.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_code_examples_2">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example_2">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby"># Trying to use ActiveRecord methods on Array objects
arr = User.all.to_a
emails = arr.pluck(:email) # Noncompliant - NoMethodError</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution_2">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby"># Use map/collect on Array objects
arr = User.all.to_a
emails = arr.map(&amp;:email)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Avoid unnecessarily converting ActiveRecord collections to Arrays when you only need to extract specific attributes. Use <code>pluck</code> directly on the ActiveRecord collection instead.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_code_examples_3">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example_3">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby"># Unnecessarily converting to Array when only extracting attributes
arr = User.all.to_a # Noncompliant
emails = arr.map(&amp;:email)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution_3">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby"># Use pluck directly on ActiveRecord collection
emails = User.pluck(:email)</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>Rails Guides - Active Record Query Interface - <a href="https://guides.rubyonrails.org/active_record_querying.html#pluck">Official Rails documentation on the pluck method and query optimization</a></p>
</li>
<li>
<p>Ruby Array Documentation - <a href="https://ruby-doc.org/core/Array.html#method-i-map">Official Ruby documentation for Array methods like map and collect</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_standards">Standards</h3>
<div class="ulist">
<ul>
<li>
<p>CWE-400: Uncontrolled Resource Consumption - <a href="https://cwe.mitre.org/data/definitions/400.html">Inefficient database queries can lead to excessive resource consumption</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>