== How to fix it in Java Cryptography Extension

=== Code examples

==== Noncompliant code example

[source,kotlin,diff-id=101,diff-type=noncompliant]
----
fun encrypt(key: ByteArray, ptxt: ByteArray) {
    val iv = "7cVgr5cbdCZV".toByteArray()

    val cipher = Cipher.getInstance("AES/GCM/NoPadding")
    val keySpec = SecretKeySpec(key, "AES")
    val gcmSpec = GCMParameterSpec(128, iv)

    cipher.init(Cipher.ENCRYPT_MODE, keySpec, gcmSpec) // Noncompliant
}
----

==== Compliant solution

[source,kotlin,diff-id=101,diff-type=compliant]
----
fun encrypt(key: ByteArray, ptxt: ByteArray) {
    val random = SecureRandom()
    val iv = ByteArray(12)
    random.nextBytes(iv)

    val cipher = Cipher.getInstance("AES/GCM/NoPadding")
    val keySpec = SecretKeySpec(key, "AES")
    val gcmSpec = GCMParameterSpec(128, iv)

    cipher.init(Cipher.ENCRYPT_MODE, keySpec, gcmSpec)
}
----

=== How does this work?

When using AES-GCM or AES-CCM, NIST recommends a 96-bit length nonce using a deterministic approach or at least 96 bits using a 'Random Bit Generator (RBG)'.

include::../../common/fix/randomized-nonce.adoc[]

include::../../common/fix/deterministic-nonce.adoc[]
