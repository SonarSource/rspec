<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>DOM-based XPath injection occurs when untrusted user input is directly
incorporated into XPath queries executed on the client side. This vulnerability
allows attackers to manipulate XPath expressions to access unauthorized data, or
extract sensitive information.</p>
</div>
<div class="paragraph">
<p>In the long run, this practice progressively increases the likelihood of
introducing other DOM-based vulnerabilities, such as XSS or open redirects.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const userInput = document.getElementById('searchInput').value;

const xpath = "//user[@name='" + userInput + "']";
const result = document.evaluate(xpath, document, null, // Noncompliant
    XPathResult.FIRST_ORDERED_NODE_TYPE, null);
const userNode = result.singleNodeValue;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const userInput = document.getElementById('searchInput').value;

if (!/^[a-zA-Z0-9_]+$/.test(userInput)) {
    throw new Error('Invalid input');
}

const xpath = "//user[@name=" + userInput + "]";
const result = document.evaluate(xpath, document, null,
    XPathResult.FIRST_ORDERED_NODE_TYPE, null);
const userNode = result.singleNodeValue;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_how_does_this_work">How does this work?</h3>
<div class="paragraph">
<p>As a rule of thumb, the best approach to protect against injections is to
systematically ensure that untrusted data cannot break out of the initially
intended logic.</p>
</div>
<div class="paragraph">
<p>For DOM-based XPath injection in particular, consider whether XPath is
necessary for your use case, as simpler DOM traversal methods may be sufficient
and safer. For example, DOM manipulation methods like <code>querySelector()</code> or
<code>getElementById()</code>.</p>
</div>
<div class="sect3">
<h4 id="_validation">Validation</h4>
<div class="paragraph">
<p>In case XPath parameterized queries are not available, the most secure way to
protect against injections is to validate the input before using it in an XPath
query.</p>
</div>
<div class="paragraph">
<p>Input can be validated in multiple ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>By checking against a list of authorized and secure strings that the application is allowed to use in a query.</p>
</li>
<li>
<p>By ensuring user input is restricted to a specific range of characters (e.g., the regex <code>/^[a-zA-Z0-9]*$/</code> only allows alphanumeric characters.)</p>
</li>
<li>
<p>By ensuring user input does not include any XPath metacharacters, such as <code>"</code>, <code>'</code>, <code>/</code>, <code>@</code>, <code>=</code>, <code>*</code>, <code>[</code>, <code>]</code>, <code>(</code> and <code>)</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If user input is not considered valid, it should be rejected as it is unsafe.</p>
</div>
<div class="paragraph">
<p>In the example, a validation mechanism is applied to untrusted input to ensure
it is strictly composed of alphabetic characters.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_standards">Standards</h3>
<div class="ulist">
<ul>
<li>
<p>OWASP - <a href="https://owasp.org/Top10/A03_2021-Injection/">Top 10 2021 Category A3 - Injection</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-top-ten/2017/A1_2017-Injection">Top 10 2017 Category A1 - Injection</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/20">CWE-20 - Improper Input Validation</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/643">CWE-643 - Improper Neutralization of Data within XPath Expressions</a></p>
</li>
<li>
<p>STIG Viewer - <a href="https://stigviewer.com/stigs/application_security_and_development/2024-12-06/finding/V-222608">Application Security and Development: V-222608</a> - The application must not be vulnerable to XML-oriented attacks.</p>
</li>
<li>
<p>STIG Viewer - <a href="https://stigviewer.com/stigs/application_security_and_development/2024-12-06/finding/V-222609">Application Security and Development: V-222609</a> - The application must not be subject to input handling vulnerabilities.</p>
</li>
</ul>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Change this code to not construct this client-side XPath expression from user-controlled data.</p>
</div>
<hr>
</div>
</div>
</div>