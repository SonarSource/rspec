<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This rule raises an issue when a database transaction is started with <code>db.Begin()</code> but lacks proper rollback handling in error scenarios.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Database transactions follow ACID principles (Atomicity, Consistency, Isolation, Durability) to ensure data integrity. When a transaction is started but not properly handled, several problems can occur:</p>
</div>
<div class="paragraph">
<p><strong>Data Integrity Violations</strong>: If an error occurs during transaction execution and the transaction is not rolled back, partial changes may remain in the database. This violates the atomicity principle, where either all operations in a transaction should succeed or none should.</p>
</div>
<div class="paragraph">
<p><strong>Resource Leaks</strong>: Unhandled transactions can hold database locks and connections longer than necessary. This can lead to connection pool exhaustion and performance degradation, especially under high load.</p>
</div>
<div class="paragraph">
<p><strong>Inconsistent Application State</strong>: When transactions are not properly cleaned up, the application may continue with an assumption that operations succeeded when they actually failed partially. This can lead to data corruption and unpredictable behavior.</p>
</div>
<div class="paragraph">
<p>The standard pattern in Go is to use <code>defer tx.Rollback()</code> immediately after successfully creating a transaction. This ensures that if any error occurs before <code>tx.Commit()</code> is called, the transaction will be automatically rolled back. The <code>Rollback()</code> method is safe to call even after a successful commit, making this pattern both safe and reliable.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>Improper transaction handling can lead to data corruption, resource exhaustion, and application instability. In financial or critical systems, this could result in data loss, inconsistent records, or system downtime.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Add a deferred rollback call immediately after starting the transaction. This ensures the transaction is rolled back if any error occurs before commit.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-go" data-lang="go">func transferMoney(db *sql.DB, from, to int, amount float64) error {
    tx, err := db.Begin()
    if err != nil {
        return err
    }

    _, err = tx.Exec("UPDATE accounts SET balance = balance - ? WHERE id = ?", amount, from)
    if err != nil {
        return err // Noncompliant: transaction not rolled back
    }

    _, err = tx.Exec("UPDATE accounts SET balance = balance + ? WHERE id = ?", amount, to)
    if err != nil {
        return err // Noncompliant: transaction not rolled back
    }

    return tx.Commit()
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-go" data-lang="go">func transferMoney(db *sql.DB, from, to int, amount float64) error {
    tx, err := db.Begin()
    if err != nil {
        return err
    }
    defer tx.Rollback() // Ensures rollback if commit doesn't happen

    _, err = tx.Exec("UPDATE accounts SET balance = balance - ? WHERE id = ?", amount, from)
    if err != nil {
        return err
    }

    _, err = tx.Exec("UPDATE accounts SET balance = balance + ? WHERE id = ?", amount, to)
    if err != nil {
        return err
    }

    return tx.Commit()
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>Go database/sql package - <a href="https://pkg.go.dev/database/sql">Official Go documentation for database/sql package including transaction handling</a></p>
</li>
<li>
<p>Go database/sql tutorial - <a href="https://go.dev/doc/tutorial/database-access">Official Go tutorial covering database access patterns and best practices</a></p>
</li>
<li>
<p>Effective Go - Database transactions - <a href="https://go.dev/doc/effective_go#defer">Go best practices including proper use of defer for resource cleanup</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_standards">Standards</h3>
<div class="ulist">
<ul>
<li>
<p>ACID Properties - <a href="https://en.wikipedia.org/wiki/ACID">Database transaction properties ensuring data integrity and consistency</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>