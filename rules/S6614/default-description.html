<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Generating a new <code>Regex</code> instance for every method call can result in costly compilations of complex patterns or large strings, leading to slower execution times and higher memory usage.</p>
</div>
<div class="paragraph">
<p>Utilizing a single <code>Regex</code> instance can optimize performance and decrease memory usage by avoiding the overhead of compiling the regular expression pattern repeatedly.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>We measured a significant improvement both in execution time and memory allocation. For more details see the <code>Benchmarks</code> section from the <code>More info</code> tab.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to improve performance, consider moving the <code>Regex</code> constructor call outside of the method scope and ensuring that it is only instantiated once.</p>
</div>
<div class="paragraph">
<p>Here are some suggestions for optimizing performance when extracting the <code>Regex</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Consider defining a read-only field or property in your class.</p>
</li>
<li>
<p>When creating the Regex, consider including the <code>RegexOptions.Compiled</code> flag.</p>
</li>
<li>
<p>If you are using NET 7.0+, consider using the <code>[GeneratedRegex]</code> attribute to generate an optimized implementation of the specified regular expression.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>One compliant alternative when unable to extract the Regex is to use the static method <code>Regex.IsMatch</code>. Be aware, by default, the last 15 most recently used static regular expression patterns are cached.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-csharp" data-lang="csharp">bool Matches(string inputString)
{
    var myRegex = new Regex("^[a-zA-Z]$");
    return myRegex.IsMatch(inputString);
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-csharp" data-lang="csharp">readonly Regex myRegex = new Regex("^[a-zA-Z]$");

bool IsAMatch(string inputString) =&gt;
    ipv6Regex.IsMatch(inputString);</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://learn.microsoft.com/en-us/dotnet/standard/base-types/best-practices">Best practices for regular expressions in .NET</a></p>
<div class="ulist">
<ul>
<li>
<p><a href="https://learn.microsoft.com/en-us/dotnet/standard/base-types/best-practices#static-regular-expressions">Best practices for <strong>static</strong> regular expressions</a></p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/system.text.regularexpressions.regexoptions#system-text-regularexpressions-regexoptions-compiled">RegexOptions.Compiled flag</a></p>
</li>
<li>
<p><a href="https://learn.microsoft.com/en-us/dotnet/standard/base-types/regular-expression-source-generators#source-generation">Regex source generator</a></p>
<div class="ulist">
<ul>
<li>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/system.text.regularexpressions.generatedregexattribute">GeneratedRegexAttribute</a></p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/system.text.regularexpressions.regex.ismatch"><code>Regex.IsMatch</code> static method</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_benchmarks">Benchmarks</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Method</th>
<th class="tableblock halign-left valign-top">Runtime</th>
<th class="tableblock halign-left valign-top">Mean</th>
<th class="tableblock halign-left valign-top">Ratio</th>
<th class="tableblock halign-left valign-top">Allocated</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CreateMultiple</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">.NET 7.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">29.645 ms</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">69200016 B</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">UseCached</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">.NET 7.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.052 ms</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.07</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2 B</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CreateMultiple</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">.NET Framework 4.6.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">42.102 ms</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">125729652 B</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">UseCached</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">.NET Framework 4.6.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.283 ms</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.08</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The results were generated by running the following snippet with <a href="https://github.com/dotnet/BenchmarkDotNet">BenchmarkDotNet</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-csharp" data-lang="csharp">[Params(10_000)]
public int Iterations;

// IPV4 Regex pattern
private const string RegexPattern = "^((25[0-5]|(2[0-4]|1\\d|[1-9]|)\\d)\\.?\b){4}$";
private readonly Regex cachedRegex = new Regex(RegexPattern);

[Benchmark(Baseline = true)]
public void CreateMultiple()
{
    for (int i = 0; i &lt; Iterations; i++)
    {
        var regex = new Regex(RegexPattern);
        _ = regex.IsMatch("127.0.0.1");
    }
}

[Benchmark]
public void UseCached()
{
    for (int i = 0; i &lt; Iterations; i++)
    {
        _ = cachedRegex.IsMatch("127.0.0.1");
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Hardware configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>BenchmarkDotNet=v0.13.5, OS=Windows 10 (10.0.19045.2846/22H2/2022Update)
12th Gen Intel Core i7-12800H, 1 CPU, 20 logical and 14 physical cores
.NET SDK=7.0.203
  [Host]               : .NET 7.0.5 (7.0.523.17405), X64 RyuJIT AVX2
  .NET 7.0             : .NET 7.0.5 (7.0.523.17405), X64 RyuJIT AVX2
  .NET Framework 4.6.2 : .NET Framework 4.8 (4.8.4614.0), X64 RyuJIT VectorSize=256</code></pre>
</div>
</div>
</div>
</div>
</div>