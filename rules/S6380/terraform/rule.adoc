Authorizing anonymous access can reduce an organization's ability to protect itself against attacks on its Azure resources.

Security incidents may include disrupting critical functions, data theft, and additional Azure subscription costs due to resource overload.

Using authentication coupled with fine-grained authorizations helps bring Defense-In-Depth and bring traceability to investigators of security incidents.

Depending on the affected Azure resource, multiple authentication choices are possible: Active Directory Authentication, OpenID implementations (Google, Microsoft, etc.) or native Azure mechanisms.
Unfortunately, specific Azure resources only expose basic authentication, but it should also be an acceptable first layer of defense.

== Ask Yourself Whether

* This Azure resource is essential for the information system infrastructure.
* This Azure resource is essential for mission-critical functions.
* This Azure resource stores or processes sensitive data.
* Compliance policies require access to this resource to be authenticated.

There is a risk if you answered yes to any of those questions.

== Recommended Secure Coding Practices

Enable authentication in this Azure resource, and disable anonymous access.

== Sensitive Code Example

For https://azure.microsoft.com/en-us/services/app-service/[App Services and equivalent]:

----
resource "azurerm_function_app" "example" { # Sensitive
  name = "example"

  auth_settings {
    enabled = false
    unauthenticated_client_action = "AllowAnonymous"
  }
}
----

For https://azure.microsoft.com/en-us/services/api-management/[API Management]:

----
resource "azurerm_api_management_api" "example" { # Sensitive, the openid_authentication block is missing
  name = "example-api"
}

resource "azurerm_api_management" "example" {
  sign_in {
    enabled = false # Sensitive
  }
----

For https://azure.microsoft.com/en-us/services/data-factory/[Data Factory] Linked Services:

----
resource "azurerm_data_factory_linked_service_sftp" "example" {
  authentication_type = "Anonymous"
}
----

For https://azure.microsoft.com/en-us/product-categories/storage/[Storage Accounts]:

----
resource "azurerm_storage_account" "example" {
  allow_blob_public_access = true
----

For https://azure.microsoft.com/en-us/services/cache/[Redis Caches]:

----
resource "azurerm_redis_cache" "example" {
  name = "example-cache"

  redis_configuration {
    enable_authentication = false # Sensitive
  }
}
----

== Compliant Solution

For https://azure.microsoft.com/en-us/services/app-service/[App Services and equivalent]:

----
resource "azurerm_function_app" "example" {
  name = "example"

  auth_settings {
    enabled = true
    unauthenticated_client_action = "RedirectToLoginPage"
  }
}
----

For https://azure.microsoft.com/en-us/services/api-management/[API Management]:

----
resource "azurerm_api_management_api" "example" { # Sensitive, the openid_authentication block is missing
  name = "example-api"

  openid_authentication {
    openid_provider_name = azurerm_api_management_openid_connect_provider.example.name
  }
}

resource "azurerm_api_management" "example" {
  sign_in {
    enabled = true
  }
----

For https://azure.microsoft.com/en-us/services/data-factory/[Data Factory] Linked Services:

----
resource "azurerm_data_factory_linked_service_sftp" "example" {
  authentication_type = "Basic"
  username            = local.creds.username
  password            = local.creds.password
}
----

For https://azure.microsoft.com/en-us/product-categories/storage/[Storage Accounts]:

----
resource "azurerm_storage_account" "example" {
  allow_blob_public_access = true
----

For https://azure.microsoft.com/en-us/services/cache/[Redis Caches]:

----
resource "azurerm_redis_cache" "example" {
  name = "example-cache"
  
  redis_configuration {
    enable_authentication = true
  }
}
----

== See

* https://owasp.org/Top10/A01_2021-Broken_Access_Control/[OWASP Top 10 2021 Category A1] - Boken Access Control
* https://cwe.mitre.org/data/definitions/668.html[MITRE, CWE-668] - Exposure of Resource to Wrong Sphere

ifdef::env-github,rspecator-view[]

'''
== Implementation Specification
(visible only on this page)

=== Message

Make sure that disabling authentication is safe here.

=== Highlighting

* For ``auth_settings`` cases: Highlight the resource or ``auth_settings->enabled = false``
* For ``api_management_api``: Highlight the resource
* For ``redis_cache``: Highlight ``enable_authentication = false``

endif::env-github,rspecator-view[]
