<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This rule raises an issue when resources are recreated on every Lambda function invocation instead of being reused.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Resources that can be reused across multiple invocations of the Lambda function should be initialized at module level, outside the handler function. When the same Lambda container is reused for multiple function invocations, existing instances including SDK clients and database connections can be reused without recreating them. It is a good practice to initialize AWS clients, like boto3, and database connections outside the handler function to avoid recreating them on every Lambda invocation. Failing to do so can lead to performance degradation, increased latency, and even higher AWS costs.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>Performance degradation is the primary concern, as recreating resources adds significant latency to each Lambda invocation. This can result in slower response times and higher costs due to increased execution duration.</p>
</div>
<div class="paragraph">
<p>Availability risks may also emerge under high load scenarios, as the additional overhead from resource recreation can cause functions to timeout more frequently or hit concurrency limits sooner than necessary.</p>
</div>
<div class="paragraph">
<p>Increased API throttling is another potential issue, as recreating resources may lead to more frequent authentication requests and connection establishments, potentially triggering rate limits.</p>
</div>
</div>
<div class="sect2">
<h3 id="_exceptions">Exceptions</h3>
<div class="paragraph">
<p>If the resource contains sensitive information that should not be shared across invocations, it may be necessary to initialize it within the handler function. However, this should be done cautiously and only when absolutely necessary.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Move the resource initialization outside the Lambda handler function to the module level. This ensures resources are created once when the Lambda environment is initialized and reused across invocations.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">import boto3

def lambda_handler(event, context):
    s3_client = boto3.client('s3')  # Noncompliant: Client created inside handler

    response = s3_client.get_object(Bucket='my-bucket', Key='my-key')
    return response['Body'].read()</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">import boto3

s3_client = boto3.client('s3')  # Compliant

def lambda_handler(event, context):
    response = s3_client.get_object(Bucket='my-bucket', Key='my-key')
    return response['Body'].read()</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>AWS Documentation - <a href="https://docs.aws.amazon.com/lambda/latest/dg/python-handler.html#python-handler-best-practices">Python handler best practices</a></p>
</li>
</ul>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="paragraph">
<p>If the following functions are found in a lambda handler (or a function called by a lambda handler), the rule raises an issue. The rule should also consider functions which were called by the lambda handler.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>AWS SDK (boto3)</p>
<div class="ulist">
<ul>
<li>
<p><code>boto3.client</code></p>
</li>
<li>
<p><code>boto3.resource</code></p>
</li>
<li>
<p><code>boto3.session.Session</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Database Connections</p>
<div class="ulist">
<ul>
<li>
<p><code>pymysql.connect</code></p>
</li>
<li>
<p><code>mysql.connector.connect</code></p>
</li>
<li>
<p><code>psycopg2.connect</code></p>
</li>
<li>
<p><code>pymongo.MongoClient</code></p>
</li>
<li>
<p><code>sqlite3.connect</code></p>
</li>
<li>
<p><code>redis.Redis</code></p>
</li>
<li>
<p><code>redis.StrictRedis</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>ORM Connections</p>
<div class="ulist">
<ul>
<li>
<p><code>sqlalchemy.orm.sessionmaker</code></p>
</li>
<li>
<p><code>peewee.PostgresqlDatabase</code></p>
</li>
<li>
<p><code>peewee.MySQLDatabase</code></p>
</li>
<li>
<p><code>peewee.SqliteDatabase</code></p>
</li>
<li>
<p><code>mongoengine.connect</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Initialize this AWS client or database connection outside the Lambda handler function.</p>
</div>
</div>
<div class="sect2">
<h3 id="_highlighting">Highlighting</h3>
<div class="paragraph">
<p>Client/Database connection creation</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
</div>
</div>