<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Recursively merging objects or dynamically assigning object properties from strings may be prone to Prototype Pollution vulnerabilities in JavaScript. Prototype Pollution vulnerabilities allow to inject new properties into the built-in <code>Object.prototype</code> object. Since most objects inherit from this prototype, it can result in unexpected behavior, e.g., crashes or more severe vulnerabilities.</p>
</div>
<div class="paragraph">
<p>Recursively merging objects or dynamically assigning object properties from strings has led in the past to the following vulnerabilities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.cve.org/CVERecord?id=CVE-2019-10744">CVE-2019-10744</a></p>
</li>
<li>
<p><a href="https://www.cve.org/CVERecord?id=CVE-2019-11358">CVE-2019-11358</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ask_yourself_whether">Ask Yourself Whether</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Object properties are set dynamically from potential user-input.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is a risk if you answered yes to any of these questions.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_recommended_secure_coding_practices">Recommended Secure Coding Practices</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Do not set object properties from user-input. If it cannot be avoided or if you cannot be sure if user-input will be used add an ignore-list to prevent modifications of the following properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>__proto__</p>
</li>
<li>
<p>constructor</p>
</li>
<li>
<p>prototype</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sensitive_code_example">Sensitive Code Example</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For merge functions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>function for_in_merge(dst, src) {
    for (let key in src) {
        if (dst[key]) {
            for_in_merge(dst[key], src[key]);
        } else {
            dst[key] = src[key]; // Sensitive
        }
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p>For set-path functions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>function for_set(target, path, value) {
    let keys = path.split('.');
    for (let i = 0; i &lt; keys.length; ++i) {
        let key = keys[i];
        if (i &lt; keys.length - 1) {
            if (!target[key]) {
                target[key] = {};
            }
            target = target[key];
        } else {
            target[key] = value; // Sensitive
        }
    }
}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compliant_solution">Compliant Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For merge functions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">function for_in_merge(dst, src) {
    for (let key in src) {
        // Recommended Secure Coding Practices: prevent sensible keys
        if (key === "constructor" || key === "prototype" || key === "__proto__") {
            continue;
        }

        if (dst[key]) {
            for_in_merge(dst[key], src[key]);
        } else {
            dst[key] = src[key]; // Compliant
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For set-path functions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">function for_set(target, path, value) {
    let keys = path.split('.');
    for (let i = 0; i &lt; keys.length; ++i) {
        let key = keys[i];
        // Recommended Secure Coding Practices: prevent sensible keys
        if (key === "constructor" || key === "prototype" || key === "__proto__") {
            break;
        }
        if (i &lt; keys.length - 1) {
            if (!target[key]) {
                target[key] = {};
            }
            target = target[key];
        } else {
            target[key] = value; // Compliant
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/HoLyVieR/prototype-pollution-nsec18/blob/master/paper/JavaScript_prototype_pollution_attack_in_NodeJS.pdf">Prototype pollution attack in NodeJS application - Olivier Arteau</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/1321">CWE-1321 - Improperly Controlled Modification of Object Prototype Attributes ('Prototype Pollution')</a></p>
</li>
</ul>
</div>
</div>
</div>