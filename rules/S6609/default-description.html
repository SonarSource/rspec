<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Both the <code>Enumerable.Max</code> extension method and the <code>SortedSet&lt;T&gt;.Max</code> property can be used to find the maximum value in a <code>SortedSet&lt;T&gt;</code>. However, <code>SortedSet&lt;T&gt;.Max</code> is much faster than <code>Enumerable.Max</code>. For small collections, the performance difference may be minor, but for large collections, it can be noticeable. The same applies for the <code>Min</code> property as well.</p>
</div>
<div class="paragraph">
<p><code>Max</code> and <code>Min</code> in <code>SortedSet&lt;T&gt;</code> exploit the fact that the set is implemented via a <code>Red-Black tree</code>. The algorithm to find the <code>Max</code>/<code>Min</code> is "go left/right whenever possible". The operation has the time complexity of <code>O(h)</code> which becomes <code>O(ln(n))</code> due to the fact that the tree is balanced. This is much better than the <code>O(n)</code> time complexity of extension methods.</p>
</div>
<div class="paragraph">
<p><code>Max</code> and <code>Min</code> in <code>ImmutableSortedSet&lt;T&gt;</code> exploits a tree augmentation technique, storing the <code>Min</code>, <code>Max</code> and <code>Count</code> values on each node of the data structure. The time complexity in this case is <code>O(1)</code> that is significantly better than <code>O(n)</code> of extension methods.</p>
</div>
<div class="paragraph">
<p><strong>Applies to:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/system.collections.generic.sortedset-1.max">SortedSet&lt;T&gt;.Max</a></p>
</li>
<li>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/system.collections.generic.sortedset-1.min">SortedSet&lt;T&gt;.Min</a></p>
</li>
<li>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/system.collections.immutable.immutablesortedset-1.max">ImmutableSortedSet&lt;T&gt;.Max</a></p>
</li>
<li>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/system.collections.immutable.immutablesortedset-1.min">ImmutableSortedSet&lt;T&gt;.Min</a></p>
</li>
<li>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/system.collections.immutable.immutablesortedset-1.builder.max">ImmutableSortedSet&lt;T&gt;.Builder.Max</a></p>
</li>
<li>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/system.collections.immutable.immutablesortedset-1.builder.min">ImmutableSortedSet&lt;T&gt;.Builder.Min</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>We measured a significant improvement both in execution time and memory allocation. For more details see the <code>Benchmarks</code> section from the <code>More info</code> tab.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>Min</code> and <code>Max</code> properties are defined on the following classes, and the extension method call can be replaced by calling the propery instead:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>SortedSet&lt;T&gt;</code></p>
</li>
<li>
<p><code>ImmutableSortedSet&lt;T&gt;</code></p>
</li>
<li>
<p><code>ImmutableSortedSet&lt;T&gt;.Builder</code></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-csharp" data-lang="csharp">int GetMax(SortedSet&lt;int&gt; data) =&gt;
    data.Max();</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-csharp" data-lang="csharp">int GetMin(SortedSet&lt;int&gt; data) =&gt;
    data.Min();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-csharp" data-lang="csharp">int GetMax(SortedSet&lt;int&gt; data) =&gt;
    data.Max;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-csharp" data-lang="csharp">int GetMin(SortedSet&lt;int&gt; data) =&gt;
    data.Min;</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/system.collections.generic.sortedset-1">SortedSet&lt;T&gt;</a></p>
</li>
<li>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/system.collections.immutable.immutablesortedset-1">ImmutableSortedSet&lt;T&gt;</a></p>
</li>
<li>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/system.collections.immutable.immutablesortedset-1.builder">ImmutableSortedSet&lt;T&gt;.Builder</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_benchmarks">Benchmarks</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Method</th>
<th class="tableblock halign-left valign-top">Runtime</th>
<th class="tableblock halign-left valign-top">Mean</th>
<th class="tableblock halign-left valign-top">Standard Deviation</th>
<th class="tableblock halign-left valign-top">Allocated</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MaxMethod</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">.NET 7.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">68,961.483 us</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">499.6623 us</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">248063 B</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MaxProperty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">.NET 7.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4.638 us</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.0634 us</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MaxMethod</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">.NET Framework 4.6.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">85,827.359 us</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1,531.1611 us</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">281259 B</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MaxProperty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">.NET Framework 4.6.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">67.682 us</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.3757 us</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">312919 B</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="_glossary">Glossary</h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://en.wikipedia.org/wiki/Arithmetic_mean">Mean</a></p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/Standard_deviation">Standard Deviation</a></p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/Memory_management">Allocated</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The results were generated by running the following snippet with <a href="https://github.com/dotnet/BenchmarkDotNet">BenchmarkDotNet</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-csharp" data-lang="csharp">private SortedSet&lt;string&gt; data;

[Params(1_000)]
public int Iterations;

[GlobalSetup]
public void Setup() =&gt;
    data = new SortedSet&lt;string&gt;(Enumerable.Range(0, Iterations).Select(x =&gt; Guid.NewGuid().ToString()));

[Benchmark(Baseline = true)]
public void MaxMethod()
{
    for (var i = 0; i &lt; Iterations; i++)
    {
        _ = data.Max();     // Max() extension method
    }
}

[Benchmark]
public void MaxProperty()
{
    for (var i = 0; i &lt; Iterations; i++)
    {
        _ = data.Max;       // Max property
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Hardware configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>BenchmarkDotNet=v0.13.5, OS=Windows 10 (10.0.19045.2846/22H2/2022Update)
11th Gen Intel Core i7-11850H 2.50GHz, 1 CPU, 16 logical and 8 physical cores
  [Host]               : .NET Framework 4.8 (4.8.4614.0), X64 RyuJIT VectorSize=256
  .NET 7.0             : .NET 7.0.5 (7.0.523.17405), X64 RyuJIT AVX2
  .NET Framework 4.6.2 : .NET Framework 4.8 (4.8.4614.0), X64 RyuJIT VectorSize=256</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>