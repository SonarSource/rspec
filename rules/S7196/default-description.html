<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This rule raises an issue when complex expressions are directly passed to <code>withColumn</code>, <code>filter</code> or <code>when</code> functions.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>withColumn</code>, <code>filter</code> and <code>when</code> methods are commonly used to add, modify, or filter columns in a DataFrame. When long or complex expressions are directly passed to those functions, it can lead to code that is difficult to read, understand, and maintain. Refactoring such expressions into functions or variables will help with readability. Also, it will become easier to write unit tests for these functions, ensuring that the logic is correct and behaves as expected. This leads to more robust and reliable code.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To fix this issue, complex logic within <code>withColumn</code>, <code>filter</code> and <code>when</code> calls should be refactored into separate functions or variables to improve code clarity and maintainability,</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">from pyspark.sql.functions import *
df = df.withColumn('Revenue', col('fare_amount').substr(0, 10).cast("float") + col('extra').substr(0, 5).cast("float") + col('tax').substr(0, 3).cast("float")) # Noncompliant
df = df.withColumn('High revenue', when(col('fare_amount').substr(0, 10).cast("float") &gt; 100. and col('extra').substr(0, 5).cast("float") &gt; 100. and col('tax').substr(0, 3).cast("float") &lt; 50.)) # Noncompliant
df = df.filter(col('fare_amount').substr(0, 10).cast("float") &gt; 100. and col('extra').substr(0, 5).cast("float") &gt; 100. and col('tax').substr(0, 3).cast("float") &lt; 50.) # Noncompliant</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">from pyspark.sql.functions import *

def get_revenue_inputs():
        fare_amount = col('fare_amount').substr(0, 15).cast("float")
        extra = col('extra').substr(0, 5).cast("float")
        tax = col('tax').substr(0, 3).cast("float")
        return fare_amount, extra, tax

def compute_revenue():
        fare_amount, extra, tax = get_revenue_inputs()
        return fare_amount + extra + tax

def is_high_revenue():
    fare_amount, extra, tax = get_revenue_inputs()
    return when( (fare_amount &gt; 100.) &amp; (extra &gt; 100.) &amp; (tax &lt; 50), True).otherwise(False)

df = df.withColumn("Revenue", compute_revenue()) # Compliant
df = df.withColumn('High revenue', is_high_revenue()) # Compliant
df = df.filter( is_high_revenue() ) # Compliant</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>PySpark withColumn documentation - <a href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.withColumn.html">pyspark.sql.DataFrame.withColumn</a></p>
</li>
<li>
<p>PySpark filter documentation - <a href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.filter.html">pyspark.sql.DataFrame.filter</a></p>
</li>
<li>
<p>PySpark when documentation - <a href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.functions.when.html">pyspark.sql.functions.when</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>