<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This rule raises an issue when the object of a <code>with</code> statement is not a valid a context manager.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="https://docs.python.org/3/reference/compound_stmts.html#the-with-statement"><code>with</code> statement</a> is used to wrap the execution of a block with methods defined by a context manager. The <a href="https://docs.python.org/3/reference/datamodel.html#context-managers">context manager</a> handles the entry into, and the exit from, the desired runtime context for the execution of the block of code. To do so, a context manager should have an <code>__enter__</code> and an <code>__exit__</code> method.</p>
</div>
<div class="paragraph">
<p>Executing the  following block of code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class MyContextManager:
    def __enter__(self):
        print("Entering")

    def __exit__(self, exc_type, exc_val, exc_tb):
        print("Exiting")


with MyContextManager():
    print("Executing body")</code></pre>
</div>
</div>
<div class="paragraph">
<p>will output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">Entering
Executing body
Exiting</code></pre>
</div>
</div>
<div class="paragraph">
<p>If either the <code>__enter__</code> or the <code>__exit__</code> method is missing, an <code>AttributeError</code> will be raised instead.</p>
</div>
<div class="sect2">
<h3 id="_note">Note</h3>
<div class="paragraph">
<p>When working with <a href="https://docs.python.org/3/reference/datamodel.html#async-context-managers">asynchronous context managers</a>, the <code>with</code> statement should be replaced by <code>async with</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To fix this issue, make sure that the object of the <code>with</code> statement is a valid context manager (implementing both <code>__enter__</code> and <code>__exit__</code> methods).</p>
</div>
<div class="paragraph">
<p>If the object of the <code>with</code> statement is an asynchronous context manager, make sure to use an <code>async with</code> statement.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class MyContextManager:
    ...

with MyContextManager():  # Noncompliant: not a valid contex manager
    ...

def simple_contextmanager():
    ...

with simple_contextmanager() as e:  # Noncompliant: not a valid contex manager
    ...

@asynccontextmanager
async def async_context_manager():
    yield 42

def call_async_context_manager():
    with async_context_manager() as context:  # Noncompliant: missing "async"
        ...</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class MyContextManager:
    def __enter__(self):
        print("Entering")

    def __exit__(self, exc_type, exc_val, exc_tb):
        print("Exiting")


with MyContextManager():
    ...

from contextlib import contextmanager, asynccontextmanager

@contextmanager
def simple_contextmanager():
    print("enter")
    yield
    print("exit")

with simple_contextmanager() as e:
    ...

@asynccontextmanager
async def async_context_manager():
    yield 42

async def call_async_context_manager():
    async with async_context_manager() as context:
        ...</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>Python Documentation - <a href="https://docs.python.org/3/reference/compound_stmts.html#the-with-statement"><code>with</code> statement</a></p>
</li>
<li>
<p>Python Documentation - <a href="https://docs.python.org/3/reference/datamodel.html#context-managers">context managers</a></p>
</li>
</ul>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="ulist">
<ul>
<li>
<p>Replace this expression with a context manager.</p>
</li>
<li>
<p>Add "async" before "with"; Expression is an async context manager.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_highlighting">Highlighting</h3>
<div class="paragraph">
<p>Primary: the expression used as a context manager</p>
</div>
<div class="paragraph">
<p>Secondary: the "with" keyword</p>
</div>
</div>
</div>
</div>