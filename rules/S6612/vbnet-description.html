<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When using the <code>ConcurrentDictionary</code>, there are many overloads of the <code>GetOrAdd</code> and <code>AddOrUpdate</code> methods that take both a <code>TKey</code> argument and a lambda that expects a <code>TKey</code> parameter. This means that the right side of the lambda can be written using either the lambda&#8217;s parameter or the method&#8217;s argument. However, using the method&#8217;s argument leads to the lambda capturing it, and the compiler will need to generate a class and instantiate it before the call. This means memory allocations, as well as more time spend during Garbage Collection.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>We measured a significant improvement both in execution time and memory allocation. For more details see the <code>Benchmarks</code> section from the <code>More info</code> tab.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When you are using the <code>ConcurrentDictionary</code> methods <code>GetOrAdd</code> or <code>AddOrUpdate</code>, reference the key by using the lambda&#8217;s parameter instead of the method&#8217;s one.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-vbnet" data-lang="vbnet">Function UpdateValue(dict As ConcurrentDictionary(Of Integer, Integer), key As Integer) As Integer
    Return dict.GetOrAdd(key, Function(k)
                                   Return key + 42
                               End Function)
End Function</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-vbnet" data-lang="vbnet">Function UpdateValue(dict As ConcurrentDictionary(Of Integer, Integer), key As Integer) As Integer
    Return dict.GetOrAdd(key, Function(k)
                                   Return k + 42
                               End Function)
End Function</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/system.collections.concurrent.concurrentdictionary-2.getoradd">ConcurrentDictionary&lt;TKey,TValue&gt;.GetOrAdd</a></p>
</li>
<li>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/system.collections.concurrent.concurrentdictionary-2.addorupdate">ConcurrentDictionary&lt;TKey,TValue&gt;.AddOrUpdate</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_benchmarks">Benchmarks</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Method</th>
<th class="tableblock halign-left valign-top">Runtime</th>
<th class="tableblock halign-left valign-top">Mean</th>
<th class="tableblock halign-left valign-top">Standard Deviation</th>
<th class="tableblock halign-left valign-top">Allocated</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Capture</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">.NET 7.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">68.52 ms</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4.450 ms</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">88000063 B</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lambda</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">.NET 7.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">39.29 ms</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.712 ms</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">50 B</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Capture</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">.NET Framework 4.6.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">74.58 ms</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5.199 ms</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">88259787 B</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lambda</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">.NET Framework 4.6.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">42.03 ms</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.752 ms</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="_glossary">Glossary</h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://en.wikipedia.org/wiki/Arithmetic_mean">Mean</a></p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/Standard_deviation">Standard Deviation</a></p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/Memory_management">Allocated</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The results were generated by running the following snippet with <a href="https://github.com/dotnet/BenchmarkDotNet">BenchmarkDotNet</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-csharp" data-lang="csharp">private ConcurrentDictionary&lt;int, string&gt; dict;
private List&lt;int&gt; data;

[Params(1_000_000)]
public int N { get; set; }

[GlobalSetup]
public void Setup()
{
    dict = new ConcurrentDictionary&lt;int, string&gt;();
    data = Enumerable.Range(0, N).OrderBy(_ =&gt; Guid.NewGuid()).ToList();
}

[Benchmark(baseline=true)]
public void Capture()
{
    foreach (var guid in data)
    {
        dict.GetOrAdd(guid, _ =&gt; $"{guid}"); // "guid" is captured
    }
}

[Benchmark]
public void Lambda()
{
    foreach (var guid in data)
    {
        dict.GetOrAdd(guid, x =&gt; $"{x}"); // no capture
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Hardware configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>BenchmarkDotNet=v0.13.5, OS=Windows 10 (10.0.19045.2846/22H2/2022Update)
11th Gen Intel Core i7-11850H 2.50GHz, 1 CPU, 16 logical and 8 physical cores
.NET SDK=7.0.203
  [Host]               : .NET 7.0.5 (7.0.523.17405), X64 RyuJIT AVX2
  .NET 7.0             : .NET 7.0.5 (7.0.523.17405), X64 RyuJIT AVX2
  .NET Framework 4.6.2 : .NET Framework 4.8.1 (4.8.9139.0), X64 RyuJIT VectorSize=256</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>