<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This rule raises an issue when <code>Database.setSavepoint()</code> is used but the corresponding exception handlers do not call <code>Database.rollback()</code> with the savepoint.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Database savepoints in Apex are designed to provide transaction control by allowing you to roll back to a specific point when errors occur. When you create a savepoint using <code>Database.setSavepoint()</code>, you&#8217;re essentially marking a point in your transaction that you can return to if something goes wrong.</p>
</div>
<div class="paragraph">
<p>However, savepoints only provide value if you actually use them. If your exception handlers don&#8217;t call <code>Database.rollback()</code> with the savepoint, several problems can occur:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Partial transaction commits</strong>: Some operations before the exception may succeed while others fail, leaving your data in an inconsistent state</p>
</li>
<li>
<p><strong>Resource waste</strong>: The savepoint consumes system resources but provides no benefit</p>
</li>
<li>
<p><strong>Misleading code</strong>: Other developers may assume proper rollback handling exists when it doesn&#8217;t</p>
</li>
<li>
<p><strong>Data integrity issues</strong>: Related records may be created or modified without proper cleanup when errors occur</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The whole purpose of using savepoints is to maintain transaction integrity by rolling back to a known good state when exceptions happen. Without the rollback call, you lose this protection and may end up with corrupted or inconsistent data.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>This can lead to data integrity issues where some database operations succeed while others fail, leaving the system in an inconsistent state. Users may experience unexpected behavior, and debugging becomes more difficult when partial transactions create orphaned or incomplete records.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Add <code>Database.rollback()</code> calls in your exception handlers to roll back to the savepoint when errors occur. This ensures transaction integrity by undoing all operations performed after the savepoint was created.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-apex" data-lang="apex">Savepoint savep = Database.setSavepoint();
try {
    // database operations that might fail
    insert newRecords;
    update existingRecords;
} catch(Exception e) {
    // Exception logged but no rollback - partial commit possible // Noncompliant
    System.debug('Error: ' + e.getMessage());
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-apex" data-lang="apex">Savepoint savep = Database.setSavepoint();
try {
    // database operations that might fail
    insert newRecords;
    update existingRecords;
} catch(Exception e) {
    Database.rollback(savep); // Roll back to savepoint
    System.debug('Error: ' + e.getMessage());
    throw e; // Re-throw if needed
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>Apex Database Methods - <a href="https://developer.salesforce.com/docs/atlas.en-us.apexref.meta/apexref/apex_methods_system_database.htm">Official Salesforce documentation for Database class methods including setSavepoint() and rollback()</a></p>
</li>
<li>
<p>Transaction Control in Apex - <a href="https://developer.salesforce.com/docs/atlas.en-us.apexcode.meta/apexcode/apex_transaction_control.htm">Salesforce guide on managing transactions and using savepoints effectively</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_standards">Standards</h3>
<div class="ulist">
<ul>
<li>
<p>CWE-459: Incomplete Cleanup - <a href="https://cwe.mitre.org/data/definitions/459.html">Weakness related to incomplete cleanup of resources or state</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>