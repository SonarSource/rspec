<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Making blocking calls to <code>async</code> methods transforms code that was intended to be asynchronous into a blocking operation. Doing so can cause deadlocks and unexpected blocking of context threads.</p>
</div>
<div class="paragraph">
<p>According to the MSDN documentation:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The root cause of this deadlock is due to the way <code>await</code> handles contexts. By default, when an incomplete <code>Task</code> is awaited, the current “context” is captured and used to resume the method when the <code>Task</code> completes. This “context” is the current <code>SynchronizationContext</code> unless it’s null, in which case it’s the current <code>TaskScheduler</code>. GUI and ASP.NET applications have a <code>SynchronizationContext</code> that permits only one chunk of code to run at a time. When the <code>await</code> completes, it attempts to execute the remainder of the <code>async</code> method within the captured context. But that context already has a thread in it, which is (synchronously) waiting for the <code>async</code> method to complete. They’re each waiting for the other, causing a deadlock.</p>
</div>
</blockquote>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">To Do This …</th>
<th class="tableblock halign-center valign-top">Instead of This …</th>
<th class="tableblock halign-center valign-top">Use This</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Retrieve the result of a background task</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>Task.Wait</code>, <code>Task.Result</code> or <code>Task.GetAwaiter.GetResult</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>await</code></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Wait for any task to complete</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>Task.WaitAny</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>await Task.WhenAny</code></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Retrieve the results of multiple tasks</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>Task.WaitAll</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>await Task.WhenAll</code></p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Wait a period of time</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>Thread.Sleep</code></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>await Task.Delay</code></p></td>
</tr>
</tbody>
</table>
<div class="sect2">
<h3 id="_noncompliant_code_example">Noncompliant code example</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">public static class DeadlockDemo
{
    private static async Task DelayAsync()
    {
        await Task.Delay(1000);
    }

    // This method causes a deadlock when called in a GUI or ASP.NET context.
    public static void Test()
    {
        // Start the delay.
        var delayTask = DelayAsync();
        // Wait for the delay to complete.
        delayTask.Wait(); // Noncompliant
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_compliant_solution">Compliant solution</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">public static class DeadlockDemo
{
    private static async Task DelayAsync()
    {
        await Task.Delay(1000);
    }

    public static async Task TestAsync()
    {
        // Start the delay.
        var delayTask = DelayAsync();
        // Wait for the delay to complete.
        await delayTask;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_exceptions">Exceptions</h3>
<div class="ulist">
<ul>
<li>
<p>Main methods of Console Applications are not subject to this deadlock issue and so are ignored by this rule.</p>
</li>
<li>
<p><code>Thread.Sleep</code> is also ignored when it is used in a non-<code>async</code> method.</p>
</li>
<li>
<p>Calls chained after <code>Task.Run</code> or <code>Task.Factory.StartNew</code> are ignored because they don&#8217;t suffer from this deadlock issue</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://msdn.microsoft.com/en-us/magazine/jj991977.aspx">Async/Await - Best Practices in Asynchronous Programming</a></p>
</li>
</ul>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Replace this use of '{0}' with '{1}'.</p>
</div>
<div class="paragraph">
<p>Task.Wait, Task.Result or Task.GetAwaiter.GetResult &#8658; await</p>
</div>
<div class="paragraph">
<p>Task.WaitAny &#8658; await Task.WhenAny</p>
</div>
<div class="paragraph">
<p>Task.WaitAll &#8658; await Task.WhenAll</p>
</div>
<div class="paragraph">
<p>Thread.Sleep &#8658; await Task.Delay</p>
</div>
</div>
<div class="sect2">
<h3 id="_highlighting">Highlighting</h3>
<div class="paragraph">
<p>Method invocation</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_on_9_feb_2018_152742_amaury_levé_wrote">on 9 Feb 2018, 15:27:42 Amaury Levé wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2] Could you review? If that&#8217;s fine for you please set the "Completeness" to "Full".</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_9_feb_2018_161633_ann_campbell_wrote">on 9 Feb 2018, 16:16:33 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>Looks good!</p>
</div>
</div>
</div>
</div>