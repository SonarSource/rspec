<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Executing XPATH expressions is security-sensitive. It has led in the past to the following vulnerabilities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.cve.org/CVERecord?id=CVE-2016-6272">CVE-2016-6272</a></p>
</li>
<li>
<p><a href="https://www.cve.org/CVERecord?id=CVE-2016-9149">CVE-2016-9149</a></p>
</li>
<li>
<p><a href="https://www.cve.org/CVERecord?id=CVE-2012-4837">CVE-2012-4837</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>User-provided data such as URL parameters should always be considered as untrusted and tainted. Constructing XPath expressions directly from tainted data enables attackers to inject specially crafted values that changes the initial meaning of the expression itself. Successful XPath injections attacks can read sensitive information from the XML document.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ask_yourself_whether">Ask Yourself Whether</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>the XPATH expression might contain some unsafe input coming from a user.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You are at risk if you answered yes to this question.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_recommended_secure_coding_practices">Recommended Secure Coding Practices</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Sanitize any user input before using it in an XPATH expression.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sensitive_code_example">Sensitive Code Example</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>// === javax.xml.xpath.XPath ===
import javax.xml.namespace.QName;
import javax.xml.xpath.XPath;

import org.xml.sax.InputSource;

class M {
    void foo(XPath xpath, String expression, InputSource source, QName returnType, Object item) throws Exception {
        xpath.compile(expression); // Sensitive
        xpath.evaluate(expression, source); // Sensitive
        xpath.evaluate(expression, source, returnType); // Sensitive
        xpath.evaluate(expression, item); // Sensitive
        xpath.evaluate(expression, item, returnType); // Sensitive
    }
}</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>// === Apache XML Security ===
import org.apache.xml.utils.PrefixResolver;
import org.apache.xml.security.utils.XPathAPI;
import org.w3c.dom.Node;

class M {
    void foo(XPathAPI api, Node contextNode, String str, Node namespaceNode, PrefixResolver prefixResolver,
            Node xpathnode) throws Exception {
        api.evaluate(contextNode, xpathnode, str, namespaceNode); // Sensitive
        api.selectNodeList(contextNode, xpathnode, str, namespaceNode); // Sensitive
    }
}</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>// === Apache Xalan ===
import org.apache.xml.utils.PrefixResolver;
import org.apache.xpath.XPathAPI;
import org.w3c.dom.Node;

class M {
    void foo(XPathAPI api, Node contextNode, String str, Node namespaceNode, PrefixResolver prefixResolver)
            throws Exception {
        XPathAPI.eval(contextNode, str); // Sensitive
        XPathAPI.eval(contextNode, str, namespaceNode); // Sensitive
        XPathAPI.eval(contextNode, str, prefixResolver); // Sensitive
        XPathAPI.selectNodeIterator(contextNode, str); // Sensitive
        XPathAPI.selectNodeIterator(contextNode, str, namespaceNode); // Sensitive
        XPathAPI.selectNodeList(contextNode, str); // Sensitive
        XPathAPI.selectNodeList(contextNode, str, namespaceNode); // Sensitive
        XPathAPI.selectSingleNode(contextNode, str); // Sensitive
        XPathAPI.selectSingleNode(contextNode, str, namespaceNode); // Sensitive
    }
}</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>// === org.apache.commons.jxpath ===
import org.apache.commons.jxpath.JXPathContext;

abstract class A extends JXPathContext{
    A(JXPathContext compilationContext, Object contextBean) {
        super(compilationContext, contextBean);
    }


    void foo(JXPathContext context, String str, Object obj, Class&lt;?&gt; requiredType) {
        JXPathContext.compile(str); // Sensitive
        this.compilePath(str); // Sensitive
        context.createPath(str); // Sensitive
        context.createPathAndSetValue(str, obj); // Sensitive
        context.getPointer(str); // Sensitive
        context.getValue(str); // Sensitive
        context.getValue(str, requiredType); // Sensitive
        context.iterate(str); // Sensitive
        context.iteratePointers(str); // Sensitive
        context.removeAll(str); // Sensitive
        context.removePath(str); // Sensitive
        context.selectNodes(str); // Sensitive
        context.selectSingleNode(str); // Sensitive
        context.setValue(str, obj); // Sensitive
    }
}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-top-ten/2017/A1_2017-Injection">Top 10 2017 Category A1 - Injection</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/643">CWE-643 - Improper Neutralization of Data within XPath Expressions</a></p>
</li>
<li>
<p><a href="https://wiki.sei.cmu.edu/confluence/x/cDZGBQ">CERT, IDS53-J.</a> - Prevent XPath Injection</p>
</li>
</ul>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Make sure that executing this XPATH expression is safe.</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_on_17_sep_2018_185500_nicolas_harraudeau_wrote">on 17 Sep 2018, 18:55:00 Nicolas Harraudeau wrote:</h3>
<div class="paragraph">
<p>Note: JXPath is a little different as it targets Beans and other objects but it should be as vulnerable.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_9_may_2019_155945_nicolas_harraudeau_wrote">on 9 May 2019, 15:59:45 Nicolas Harraudeau wrote:</h3>
<div class="paragraph">
<p>This rule is deprecated for Java because it is handled by the taint analysis engine (<a data-rspec-id="S2091" class="rspec-auto-link">RSPEC-2091</a>).</p>
</div>
</div>
<div class="sect2">
<h3 id="_is_related_to_s2091">is related to: <a data-rspec-id="S2091" class="rspec-auto-link">S2091</a></h3>

</div>
<div class="sect2">
<h3 id="_on_30_aug_2018_181920_nicolas_harraudeau_wrote">on 30 Aug 2018, 18:19:20 Nicolas Harraudeau wrote:</h3>
<div class="paragraph">
<p>This rule flags every XPATH execution for review.</p>
</div>
<div class="paragraph">
<p>The corresponding vulnerability, i.e. <a data-rspec-id="S2091" class="rspec-auto-link">RSPEC-2091</a>, should match only real vulnerabilities detected by taint analysis.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_4_sep_2018_105214_alexandre_gigleux_wrote">on 4 Sep 2018, 10:52:14 Alexandre Gigleux wrote:</h3>
<div class="paragraph">
<p>LGTM</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_27_may_2020_164410_eric_therond_wrote">on 27 May 2020, 16:44:10 Eric Therond wrote:</h3>
<div class="paragraph">
<p>Deprecated because it overlaps with SonarSecurity</p>
</div>
</div>
</div>
</div>