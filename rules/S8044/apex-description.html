<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This rule raises an issue when using <code>FormulaEval.FormulaBuilder</code> without proper configuration for null checking, SObject type specification, or return type declaration.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Salesforce&#8217;s Dynamic Formula Evaluation (DFE) feature allows you to evaluate formula expressions at runtime. However, improper configuration of <code>FormulaEval.FormulaBuilder</code> can lead to several problems.</p>
</div>
<div class="paragraph">
<p>When you don&#8217;t check if the formula string is null or empty before building, your code can throw runtime exceptions. This is especially common when retrieving formulas from Custom Metadata Types, where the formula field might be blank.</p>
</div>
<div class="paragraph">
<p>Without specifying the SObject type using <code>withType()</code>, the formula lacks proper context for field references. This means formulas that reference object fields like <code>Type</code> or <code>AnnualRevenue</code> may fail to evaluate correctly or throw errors.</p>
</div>
<div class="paragraph">
<p>Not declaring the return type with <code>withReturnType()</code> removes type safety guarantees. The formula evaluation becomes unpredictable, and you might get unexpected data types that cause issues when casting or using the results.</p>
</div>
<div class="paragraph">
<p>These configuration issues become more critical in production environments where formula strings come from external sources like Custom Metadata Types, and where type mismatches can cause silent failures or unexpected behavior.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>Missing proper configuration can cause runtime exceptions, unpredictable formula evaluation results, and type casting errors. In production environments, this can lead to failed business logic execution, incorrect calculations, and poor user experience.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Always implement all three best practices when using FormulaEval.FormulaBuilder: check for null/empty formula strings, specify the SObject type with withType(), and declare the return type with withReturnType().</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-apex" data-lang="apex">DiscountCalculationRule__mdt discountRule = [SELECT DiscountFormula__c FROM DiscountCalculationRule__mdt WHERE DeveloperName = 'StandardDiscount' LIMIT 1];
FormulaEval.FormulaBuilder builder = Formula.builder()
    .withFormula(discountRule.DiscountFormula__c); // Noncompliant</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-apex" data-lang="apex">DiscountCalculationRule__mdt discountRule = [SELECT DiscountFormula__c FROM DiscountCalculationRule__mdt WHERE DeveloperName = 'StandardDiscount' LIMIT 1];
if (String.isNotBlank(discountRule.DiscountFormula__c)) {
    FormulaEval.FormulaBuilder builder = Formula.builder()
        .withType(Opportunity.SObjectType)
        .withReturnType(FormulaEval.FormulaReturnType.INTEGER)
        .withFormula(discountRule.DiscountFormula__c);
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>Dynamic Formula Evaluation in Salesforce - <a href="https://www.merfantz.com/blog/how-to-dynamically-evaluate-formulas-in-salesforce-apex">Comprehensive guide on implementing Dynamic Formula Evaluation with best practices</a></p>
</li>
<li>
<p>Salesforce FormulaEval Class Documentation - <a href="https://developer.salesforce.com/docs/atlas.en-us.apexref.meta/apexref/apex_class_FormulaEval.htm">Official Salesforce documentation for the FormulaEval class and its methods</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>