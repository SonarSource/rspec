include::../description.adoc[]

== Noncompliant Code Example

`escapeshellcmd` doesn't prevent additional arguments from being injected:

----
/* 
   here the attacker can cat any files, not only the ones prefixed with "public_",
   by passing additional arguments such as "file.txt /tmp/private_data.csv"
*/
exec(escapeshellcmd("/usr/bin/cat /tmp/public_".$_GET["arg"])); // Noncompliant
----

`escapeshellcmd` cancels any prior sanitization with `escapeshellarg`:

----
exec(escapeshellcmd("/usr/bin/cat /tmp/public_".escapeshellarg($_GET["arg"])); // Noncompliant
----

Fifth argument of the `mail` function accepts arguments that are added to the command line:

----
mail($to, $subject, $message, $params, $_GET["arg"]); // Noncompliant

// by default php sanitizes the fifth argument with escapeshellcmd thus escapeshellarg has no effect:
mail($to, $subject, $message, $params, escapeshellarg($_GET["arg"])); // Noncompliant
----

== Compliant Solution

`escapeshellarg` should be used to sanitize a specific argument:

----
exec("/usr/bin/cat /tmp/public_".escapeshellarg($_GET["arg"]));
----

Fifth argument of the `mail` function can be secured with the use of an allow-list:

----
$arg = $_GET["arg"];
if($arg === "something1" || $arg === "something2") {
  mail($to, $subject, $message, $params, $arg);
}
----

include::./see.adoc[]