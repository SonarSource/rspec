<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This rule raises an issue when a <code>Sql</code> instance is created using <code>Sql.newInstance()</code> but is not explicitly closed with <code>sql.close()</code> and doesn&#8217;t use the automatic resource management pattern with <code>Sql.withInstance()</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Database connections are limited and expensive resources that must be properly managed to prevent resource leaks.</p>
</div>
<div class="paragraph">
<p>When you create a <code>Sql</code> instance using <code>Sql.newInstance()</code>, it establishes a connection to the database. This connection consumes memory and occupies a slot in the database&#8217;s connection pool. If the connection is not properly closed, it remains open indefinitely, even after your code finishes executing.</p>
</div>
<div class="paragraph">
<p>Over time, these unclosed connections accumulate and can exhaust the database&#8217;s connection pool. Once the pool is full, new connection requests will fail, causing your application to throw exceptions and potentially become unavailable.</p>
</div>
<div class="paragraph">
<p>Groovy provides two approaches to handle this properly:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Manual resource management</strong>: Explicitly call <code>sql.close()</code> when you&#8217;re done with the connection</p>
</li>
<li>
<p><strong>Automatic resource management</strong>: Use <code>Sql.withInstance()</code> which automatically closes the connection when the closure completes, even if an exception occurs</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The automatic approach is generally preferred because it&#8217;s more reliable and handles edge cases like exceptions automatically.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>Unclosed database connections can lead to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Connection pool exhaustion</strong>: When all available connections are consumed, new database operations will fail</p>
</li>
<li>
<p><strong>Application instability</strong>: Database-related functionality becomes unreliable or completely unavailable</p>
</li>
<li>
<p><strong>Memory leaks</strong>: Each unclosed connection consumes system resources</p>
</li>
<li>
<p><strong>Service outages</strong>: In severe cases, the entire application may become unresponsive</p>
</li>
<li>
<p><strong>Cascading failures</strong>: Other parts of the system that depend on database access may also fail</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Explicitly close the database connection by calling <code>sql.close()</code> when you&#8217;re finished using it. This ensures the connection is returned to the pool and resources are freed.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">import groovy.sql.Sql
def url = 'jdbc:hsqldb:mem:yourDB'
def user = 'sa'
def password = ''
def driver = 'org.hsqldb.jdbcDriver'
def sql = Sql.newInstance(url, user, password, driver) // Noncompliant
// use 'sql' instance ...
// Missing sql.close()</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">import groovy.sql.Sql
def url = 'jdbc:hsqldb:mem:yourDB'
def user = 'sa'
def password = ''
def driver = 'org.hsqldb.jdbcDriver'
def sql = Sql.newInstance(url, user, password, driver)
// use 'sql' instance ...
sql.close() // Properly close the connection</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>Groovy Database Documentation - <a href="https://groovy-lang.org/databases.html">Official Groovy documentation covering database operations and resource management</a></p>
</li>
<li>
<p>Groovy Sql Class Documentation - <a href="https://docs.groovy-lang.org/latest/html/gapi/groovy/sql/Sql.html">API documentation for the Groovy Sql class including resource management methods</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_standards">Standards</h3>
<div class="ulist">
<ul>
<li>
<p>CWE-404: Improper Resource Shutdown or Release - <a href="https://cwe.mitre.org/data/definitions/404.html">Describes the security implications of not properly releasing resources</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_related_rules">Related rules</h3>
<div class="ulist">
<ul>
<li>
<p><a data-rspec-id="S2095" class="rspec-auto-link">RSPEC-2095</a> - <a href="https://rules.sonarsource.com/java/RSPEC-2095/">Java rule for resources that should be closed (try-with-resources pattern)</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>