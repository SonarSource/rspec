<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This rule raises an issue when code directly casts polymorphic fields (like <code>WhoId</code> or <code>WhatId</code>) to specific object types without first checking the actual type using the <code>instanceof</code> operator.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Polymorphic fields in Apex can reference different object types. For example, the <code>WhoId</code> field on Task can point to either a Contact or a Lead object. When you directly cast a polymorphic field to a specific type without checking, you risk a <code>ClassCastException</code> at runtime if the actual object type doesn&#8217;t match your assumption.</p>
</div>
<div class="paragraph">
<p>This happens because Apex is strongly typed - you cannot cast an object to an incompatible type. If your code assumes <code>task.Who</code> is always a Contact but it&#8217;s actually a Lead, the cast will fail and throw an exception.</p>
</div>
<div class="paragraph">
<p>The <code>instanceof</code> operator solves this by letting you verify the actual type before attempting the cast. This ensures your code only processes objects of the expected type and handles other types appropriately.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>Without proper type checking, your application can crash with <code>ClassCastException</code> errors when processing records. This creates unreliable code that may work in testing but fail in production when encountering different data combinations. Users may experience unexpected errors, and automated processes may stop working.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use the <code>instanceof</code> operator to check the actual type of polymorphic fields before casting them to specific object types.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-apex" data-lang="apex">for(Task task : taskList) {
    Contact con = (Contact) task.Who; // Noncompliant
    System.debug('Contact Name: ' + con.Name);
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-apex" data-lang="apex">for(Task task : taskList) {
    if(task.Who instanceof Contact) {
        Contact con = (Contact) task.Who;
        System.debug('Contact Name: ' + con.Name);
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>Apex Developer Guide - instanceof Operator - <a href="https://developer.salesforce.com/docs/atlas.en-us.apexcode.meta/apexcode/langCon_apex_expressions_operators_instanceof.htm">Official Salesforce documentation on using the instanceof operator in Apex</a></p>
</li>
<li>
<p>Working with Polymorphic Relationships - <a href="https://www.apexhours.com/working-with-polymorphic-relationships-in-soql-queries">Guide on handling polymorphic relationships in Apex and SOQL queries</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_standards">Standards</h3>
<div class="ulist">
<ul>
<li>
<p>CWE-704: Incorrect Type Conversion or Cast - <a href="https://cwe.mitre.org/data/definitions/704.html">Covers issues related to incorrect type conversions that can lead to runtime errors</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_related_rules">Related rules</h3>
<div class="ulist">
<ul>
<li>
<p><a data-rspec-id="S6201" class="rspec-auto-link">RSPEC-6201</a> - <a href="https://rules.sonarsource.com/java/RSPEC-6201/">Java rule for type checking before casting</a></p>
</li>
<li>
<p><a data-rspec-id="S6660" class="rspec-auto-link">RSPEC-6660</a> - <a href="https://rules.sonarsource.com/python/RSPEC-6660/">Python rule for isinstance checks before type operations</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>