This rule raises an issue when code directly casts polymorphic fields (like `WhoId` or `WhatId`) to specific object types without first checking the actual type using the `instanceof` operator.

== Why is this an issue?

Polymorphic fields in Apex can reference different object types. For example, the `WhoId` field on Task can point to either a Contact or a Lead object. When you directly cast a polymorphic field to a specific type without checking, you risk a `ClassCastException` at runtime if the actual object type doesn't match your assumption.

This happens because Apex is strongly typed - you cannot cast an object to an incompatible type. If your code assumes `task.Who` is always a Contact but it's actually a Lead, the cast will fail and throw an exception.

The `instanceof` operator solves this by letting you verify the actual type before attempting the cast. This ensures your code only processes objects of the expected type and handles other types appropriately.

=== What is the potential impact?

Without proper type checking, your application can crash with `ClassCastException` errors when processing records. This creates unreliable code that may work in testing but fail in production when encountering different data combinations. Users may experience unexpected errors, and automated processes may stop working.

== How to fix it

Use the `instanceof` operator to check the actual type of polymorphic fields before casting them to specific object types.

=== Code examples

==== Noncompliant code example

[source,apex,diff-id=1,diff-type=noncompliant]
----
for(Task task : taskList) {
    Contact con = (Contact) task.Who; // Noncompliant
    System.debug('Contact Name: ' + con.Name);
}
----

==== Compliant solution

[source,apex,diff-id=1,diff-type=compliant]
----
for(Task task : taskList) {
    if(task.Who instanceof Contact) {
        Contact con = (Contact) task.Who;
        System.debug('Contact Name: ' + con.Name);
    }
}
----

== Resources

=== Documentation

 * Apex Developer Guide - instanceof Operator - https://developer.salesforce.com/docs/atlas.en-us.apexcode.meta/apexcode/langCon_apex_expressions_operators_instanceof.htm[Official Salesforce documentation on using the instanceof operator in Apex]

 * Working with Polymorphic Relationships - https://www.apexhours.com/working-with-polymorphic-relationships-in-soql-queries[Guide on handling polymorphic relationships in Apex and SOQL queries]

=== Standards

 * CWE-704: Incorrect Type Conversion or Cast - https://cwe.mitre.org/data/definitions/704.html[Covers issues related to incorrect type conversions that can lead to runtime errors]

=== Related rules

 * RSPEC-6201 - https://rules.sonarsource.com/java/RSPEC-6201/[Java rule for type checking before casting]

 * RSPEC-6660 - https://rules.sonarsource.com/python/RSPEC-6660/[Python rule for isinstance checks before type operations]
