<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>NoSQL injections occur when an application retrieves untrusted data and inserts
it into a database query without sanitizing it first.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>In the context of a web application that is vulnerable to NoSQL injection:<br>
After discovering the injection point, attackers insert data into the vulnerable
field to execute malicious commands in the affected databases.</p>
</div>
<div class="paragraph">
<p>Below are some real-world scenarios that illustrate some impacts of an attacker
exploiting the vulnerability.</p>
</div>
<div class="sect3">
<h4 id="_identity_spoofing_and_data_leakage">Identity spoofing and data leakage</h4>
<div class="paragraph">
<p>In the context of simple query logic breakouts, a malicious database query
enables privilege escalation or direct data leakage from one or more databases.<br>
This threat is the most widespread impact.</p>
</div>
</div>
<div class="sect3">
<h4 id="_data_deletion_and_denial_of_service">Data deletion and denial of service</h4>
<div class="paragraph">
<p>The malicious query makes it possible for the attacker to delete data in the
affected databases.<br>
This threat is particularly insidious if the attacked organization does not
maintain a disaster recovery plan (DRP) as missing data can disrupt the regular
operations of an organization.</p>
</div>
</div>
<div class="sect3">
<h4 id="_chaining_nosql_injections_with_other_vulnerabilities">Chaining NoSQL injections with other vulnerabilities</h4>
<div class="paragraph">
<p>Attackers who exploit NoSQL injections rely on other vulnerabilities to maximize
their profits.<br>
Most of the time, organizations overlook some defense in depth measures because
they assume attackers cannot reach certain points in the infrastructure. This
misbehavior can lead to multiple attacks with great impact:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When secrets are stored unencrypted in databases: Secrets can be exfiltrated and lead to compromise of other components.</p>
</li>
<li>
<p>If server-side OS and/or database permissions are misconfigured, injection can lead to remote code execution (RCE).</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it_in_spring_data_mongodb">How to fix it in Spring Data MongoDB</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="paragraph">
<p>The following code is an example of a simple API endpoint designed to read public messages. It is vulnerable to NoSQL injection because user-controlled data is inserted directly into a query string. The application assumes that incoming data always has a specific range of characters and ignores that some characters may change the query logic to a malicious one.</p>
</div>
<div class="paragraph">
<p>In this particular case, the query can be exploited with the following values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>username=user1', private:true}},{a:'</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By adapting and inserting these values, an attacker can bypass the <code>private = false</code> condition and get access to private messages.</p>
</div>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin">import com.mongodb.client.MongoClient
import org.springframework.data.mongodb.core.MongoTemplate
import org.springframework.data.mongodb.core.query.BasicQuery

@RestController
class ApiController(private val mongoClient: MongoClient) {
    @GetMapping("/read")
    @ResponseBody
    fun readPublicOnly(@RequestParam(value = "username") username: String): List&lt;String&gt; {
        val template = MongoTemplate(mongoClient, "demo")
        val query = BasicQuery("{ username:'$username', private: false }") // Noncompliant
        return template.find(query, String::class.java, "messages")
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin">import com.mongodb.client.MongoClient
import org.springframework.data.mongodb.core.MongoTemplate
import org.springframework.data.mongodb.core.query.Criteria
import org.springframework.data.mongodb.core.query.Query

@RestController
class ApiController(private val mongoClient: MongoClient) {
    @GetMapping("/read")
    @ResponseBody
    fun readPublicOnly(@RequestParam(value = "username") username: String): List&lt;String&gt; {
        val template = MongoTemplate(mongoClient, "demo")
        val query = Query.query(Criteria.where("username").`is`(username).and("private").`is`(false))
        return template.find(query, String::class.java, "messages")
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_how_does_this_work">How does this work?</h3>
<div class="paragraph">
<p>The compliant solution uses the <code>Query</code> and <code>Critera</code> objects to build the query syntax safely.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it_in_spring_data_redis">How to fix it in Spring Data Redis</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_code_examples_2">Code examples</h3>
<div class="paragraph">
<p>The following code is vulnerable to NoSQL injections because untrusted data is
concatenated to a Redis script. Such a script is used to perform advanced
queries on a Redis instance so that an injection in it might result in the
compromise of the Redis instance.</p>
</div>
<div class="sect3">
<h4 id="_noncompliant_code_example_2">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin">import org.springframework.data.redis.core.RedisTemplate
import org.springframework.data.redis.core.script.RedisScript

@RestController
class RedisController(private val redisTemplate: RedisTemplate&lt;String, Any&gt;) {
    @GetMapping("/redis-template/{input}")
    fun redisTemplate(@PathVariable input: String): String {
        val script = "return $input;"
        val result = redisTemplate.execute(RedisScript.of(script, Any::class.java), listOf()) // Noncompliant
        return result.toString()
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution_2">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin">import org.springframework.data.redis.core.RedisTemplate
import org.springframework.data.redis.core.script.RedisScript

@RestController
class RedisController(private val redisTemplate: RedisTemplate&lt;String, Any&gt;) {
    @GetMapping("/redis-template/{input}")
    fun redisTemplate(@PathVariable input: String): String {
        val script = "return ARGV[1];"
        val result = redisTemplate.execute(RedisScript.of(script, Any::class.java), listOf(), input)
        return result.toString()
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_how_does_this_work_2">How does this work?</h3>
<div class="paragraph">
<p>Here, the compliant solution passes the untrusted data as a parameter to the
Redis script. This ensures the data will be treated as a single value and will
not tamper with the script semantics.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_articles_blog_posts">Articles &amp; blog posts</h3>
<div class="ulist">
<ul>
<li>
<p>SonarSource - <a href="https://blog.sonarsource.com/nosql-injections-in-rocket-chat/">NoSQL Injections in Rocket.Chat 3.12.1</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_standards">Standards</h3>
<div class="ulist">
<ul>
<li>
<p>OWASP - <a href="https://owasp.org/Top10/A03_2021-Injection/">Top 10 2021 Category A3 - Injection</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-top-ten/2017/A1_2017-Injection">Top 10 2017 Category A1 - Injection</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/20">CWE-20 - Improper Input Validation</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/943">CWE-943 - Improper Neutralization of Special Elements in Data Query Logic</a></p>
</li>
<li>
<p>STIG Viewer - <a href="https://stigviewer.com/stigs/application_security_and_development/2024-12-06/finding/V-222609">Application Security and Development: V-222609</a> - The application must not be subject to input handling vulnerabilities.</p>
</li>
</ul>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Change this code to not construct database queries directly from user-controlled data.</p>
</div>
</div>
<div class="sect2">
<h3 id="_highlighting">Highlighting</h3>
<div class="paragraph">
<p>"[varname]" is tainted (assignments and parameters)</p>
</div>
<div class="paragraph">
<p>this argument is tainted (method invocations)</p>
</div>
<div class="paragraph">
<p>the returned value is tainted (returns &amp; method invocations results)</p>
</div>
<hr>
</div>
</div>
</div>