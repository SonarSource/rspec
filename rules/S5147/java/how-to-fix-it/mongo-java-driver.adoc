=== How to fix it in Legacy Mongo Java Driver

The following code is vulnerable to NoSQL injections because untrusted data is
interpreted by the `$where` expression.

[cols="a"]
|===
h| Non-compliant code example
|
[source,java]
----
protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws UnknownHostException
{
    String input = req.getParameter("input");
    
    MongoClient mongoClient = new MongoClient();
    DB database             = mongoClient.getDB("exampleDatabase");
    DBCollection collection = database.getCollection("exampleCollection");
    BasicDBObject query     = new BasicDBObject();

    query.put("$where", "this.field == \"" + input + "\""); // Noncompliant
}
----
h| Compliant solution
|
[source,java]
----
protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws UnknownHostException
{
    String input = req.getParameter("input");
    
    MongoClient mongoClient = new MongoClient();
    DB database             = mongoClient.getDB("ExampleDatabase");
    DBCollection collection = database.getCollection("exampleCollection");
    BasicDBObject query     = new BasicDBObject();

    query.put("field", input);
}
----
|===

=== How does this work?

include::../../common/fix/validation.adoc[]

In the previous example, the untrusted data doesn't need validation for its use
case. Moving it out of a `$where` expression into a proper field query is
enough.

