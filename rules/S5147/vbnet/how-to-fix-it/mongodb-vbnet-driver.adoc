== How to fix it in MongoDB

=== Code examples

The following code is vulnerable to NoSQL injections because untrusted data is
used to find data in a database.
Such cases can be encountered when client-side code crafts the query, such as 
``++[{ '$match': { 'Username': 'John Doe' } }]++``.

Note that `Find` and `FindAsync` are not the only constructs whose input should be
verified. Multiple
https://mongodb.github.io/mongo-csharp-driver/2.4/reference/driver/definitions/[definitions]
can be built from a string and allow attackers to leak or tamper with data.

==== Noncompliant code example

[source,vbnet,diff-id=1,diff-type=noncompliant]
----
Imports MongoDB.Driver
Imports MongoDB.Bson

<ApiController>
<Route("Example")>
Public Class ExampleController
    Inherits ControllerBase

    Private connectionString As String
    
    <Route("Example")>
    Public Async Function Example() As Task(Of String)
        Dim client = New MongoClient(connectionString)
        Dim database = client.GetDatabase("example")
        Dim collection = database.GetCollection(Of Message)("messages")

        Dim filterDefinition = Request.Query("filterDefinition")

        Await collection.FindAsync(filter)
    End Function
End Class
----

==== Compliant solution

[source,vbnet,diff-id=1,diff-type=compliant]
----
Imports MongoDB.Driver
Imports MongoDB.Bson

<ApiController>
<Route("Example")>
Public Class ExampleController
    Inherits ControllerBase

    Private connectionString As String
    
    <Route("Example")>
    Public Async Function Example() As Task(Of String)
        Dim client = New MongoClient(connectionString)
        Dim database = client.GetDatabase("example")
        Dim collection = database.GetCollection(Of Message)("messages")

        Dim filterDefinition = Builders(Of BsonDocument).Filter.Eq("Username", "Example")

        Await collection.FindAsync(filter)
    End Function
End Class
----

=== How does this work?

include::../../common/fix/builder-pattern.adoc[]

If using a builder pattern is not possible, follow the instructions below:

include::../../common/fix/pre-approved-list.adoc[]

include::../../common/fix/dangerous-operators.adoc[]
