<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>NoSQL injections occur when an application retrieves untrusted data and inserts
it into a database query without sanitizing it first.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>In the context of a web application that is vulnerable to NoSQL injection:<br>
After discovering the injection point, attackers insert data into the vulnerable
field to execute malicious commands in the affected databases.</p>
</div>
<div class="paragraph">
<p>Below are some real-world scenarios that illustrate some impacts of an attacker
exploiting the vulnerability.</p>
</div>
<div class="sect3">
<h4 id="_identity_spoofing_and_data_leakage">Identity spoofing and data leakage</h4>
<div class="paragraph">
<p>In the context of simple query logic breakouts, a malicious database query
enables privilege escalation or direct data leakage from one or more databases.<br>
This threat is the most widespread impact.</p>
</div>
</div>
<div class="sect3">
<h4 id="_data_deletion_and_denial_of_service">Data deletion and denial of service</h4>
<div class="paragraph">
<p>The malicious query makes it possible for the attacker to delete data in the
affected databases.<br>
This threat is particularly insidious if the attacked organization does not
maintain a disaster recovery plan (DRP) as missing data can disrupt the regular
operations of an organization.</p>
</div>
</div>
<div class="sect3">
<h4 id="_chaining_nosql_injections_with_other_vulnerabilities">Chaining NoSQL injections with other vulnerabilities</h4>
<div class="paragraph">
<p>Attackers who exploit NoSQL injections rely on other vulnerabilities to maximize
their profits.<br>
Most of the time, organizations overlook some defense in depth measures because
they assume attackers cannot reach certain points in the infrastructure. This
misbehavior can lead to multiple attacks with great impact:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When secrets are stored unencrypted in databases: Secrets can be exfiltrated and lead to compromise of other components.</p>
</li>
<li>
<p>If server-side OS and/or database permissions are misconfigured, injection can lead to remote code execution (RCE).</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it_in_mongodb">How to fix it in MongoDB</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="paragraph">
<p>The following code is vulnerable to a NoSQL injection because the database query is built using untrusted JavaScript objects that are extracted from user inputs.</p>
</div>
<div class="paragraph">
<p>Here the application assumes the user-submitted parameters are always strings, while they might contain more complex structures. An array or dictionary input might tamper with the expected query behavior.</p>
</div>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const { MongoClient } = require('mongodb');

function (req, res) {
    let query = { user: req.query.user, city: req.query.city };

    MongoClient.connect(url, (err, db) =&gt; {
        db.collection("users")
        .find(query) // Noncompliant
        .toArray((err, docs) =&gt; { });
    });
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const { MongoClient } = require('mongodb');

function (req, res) {
    let query = { user: req.query.user.toString(), city: req.query.city.toString() };

    MongoClient.connect(url, (err, db) =&gt; {
        db.collection("users")
        .find(query)
        .toArray((err, docs) =&gt; { });
    });
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_how_does_this_work">How does this work?</h3>
<div class="sect3">
<h4 id="_use_only_plain_string_values">Use only plain string values</h4>
<div class="paragraph">
<p>With MongoDB, NoSQL injection can arise when attackers are able to inject objects in the query instead of plain string values. For example, using the object <code>{ $ne: "" }</code> in a field of a <code>find</code> query, will return every entry where the field is not empty.</p>
</div>
<div class="paragraph">
<p>Some JavaScript application servers enable "extended" syntax that serializes URL query parameters into JavaScript objects or arrays. This allows attackers to control all the fields of an object.
In express.js, this "extended" syntax <a href="https://expressjs.com/en/4x/api.html#express.urlencoded">is enabled by default</a>.</p>
</div>
<div class="paragraph">
<p>Before using any untrusted value in a MongoDB query, make sure it is a plain string and not a JavaScript object or an array.</p>
</div>
<div class="paragraph">
<p>In some cases, this will not be enough to protect against all attacks and strict validation needs to be applied (see the "Pitfalls" section)</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_pitfalls">Pitfalls</h3>
<div class="sect3">
<h4 id="_code_execution">Code execution</h4>
<div class="paragraph">
<p>When untrusted data is used within query operators such as <code>$where</code>, <code>$accumulator</code>, or <code>$function</code> it usually results in JavaScript code execution vulnerabilities.</p>
</div>
<div class="paragraph">
<p>Therefore, untrusted values should not be used inside these query operators unless they are properly validated.</p>
</div>
<div class="paragraph">
<p>For more information about MongoDB code execution vulnerabilities, see rule <a data-rspec-id="S5334" class="rspec-auto-link">S5334</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it_in_mongoose">How to fix it in Mongoose</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_code_examples_2">Code examples</h3>
<div class="paragraph">
<p>The following code is vulnerable to a NoSQL injection because the database query is built using untrusted JavaScript objects that are extracted from user inputs.</p>
</div>
<div class="paragraph">
<p>Here the application assumes the user-submitted parameters are always strings, while they might contain more complex structures. An array or dictionary input might tamper with the expected query behavior.</p>
</div>
<div class="sect3">
<h4 id="_noncompliant_code_example_2">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const mongoose = require('mongoose');

function(req, res) {
    let query = { user: req.query.user, city: req.query.city };
    const userModel = mongoose.model('User', userSchema);
    userModel.find(query, (err, users) =&gt; {}); // Noncompliant
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution_2">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">const mongoose = require('mongoose');

function (req, res) {
    let query = { user: req.query.user.toString(), city: req.query.city.toString() };
    const userModel = mongoose.model('User', userSchema);
    userModel.find(query, (err, users) =&gt; {});
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_how_does_this_work_2">How does this work?</h3>
<div class="sect3">
<h4 id="_use_only_plain_string_values_2">Use only plain string values</h4>
<div class="paragraph">
<p>With MongoDB, NoSQL injection can arise when attackers are able to inject objects in the query instead of plain string values. For example, using the object <code>{ $ne: "" }</code> in a field of a <code>find</code> query, will return every entry where the field is not empty.</p>
</div>
<div class="paragraph">
<p>Some JavaScript application servers enable "extended" syntax that serializes URL query parameters into JavaScript objects or arrays. This allows attackers to control all the fields of an object.
In express.js, this "extended" syntax <a href="https://expressjs.com/en/4x/api.html#express.urlencoded">is enabled by default</a>.</p>
</div>
<div class="paragraph">
<p>Before using any untrusted value in a MongoDB query, make sure it is a plain string and not a JavaScript object or an array.</p>
</div>
<div class="paragraph">
<p>In some cases, this will not be enough to protect against all attacks and strict validation needs to be applied (see the "Pitfalls" section)</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_pitfalls_2">Pitfalls</h3>
<div class="sect3">
<h4 id="_code_execution_2">Code execution</h4>
<div class="paragraph">
<p>When untrusted data is used within query operators such as <code>$where</code>, <code>$accumulator</code>, or <code>$function</code> it usually results in JavaScript code execution vulnerabilities.</p>
</div>
<div class="paragraph">
<p>Therefore, untrusted values should not be used inside these query operators unless they are properly validated.</p>
</div>
<div class="paragraph">
<p>For more information about MongoDB code execution vulnerabilities, see rule <a data-rspec-id="S5334" class="rspec-auto-link">S5334</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_articles_blog_posts">Articles &amp; blog posts</h3>
<div class="ulist">
<ul>
<li>
<p>SonarSource - <a href="https://blog.sonarsource.com/nosql-injections-in-rocket-chat/">NoSQL Injections in Rocket.Chat 3.12.1</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_standards">Standards</h3>
<div class="ulist">
<ul>
<li>
<p>OWASP - <a href="https://owasp.org/Top10/A03_2021-Injection/">Top 10 2021 Category A3 - Injection</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-top-ten/2017/A1_2017-Injection">Top 10 2017 Category A1 - Injection</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/20">CWE-20 - Improper Input Validation</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/943">CWE-943 - Improper Neutralization of Special Elements in Data Query Logic</a></p>
</li>
<li>
<p>STIG Viewer - <a href="https://stigviewer.com/stigs/application_security_and_development/2024-12-06/finding/V-222609">Application Security and Development: V-222609</a> - The application must not be subject to input handling vulnerabilities.</p>
</li>
</ul>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Change this code to not construct database queries directly from user-controlled data.</p>
</div>
</div>
<div class="sect2">
<h3 id="_highlighting">Highlighting</h3>
<div class="paragraph">
<p>"[varname]" is tainted (assignments and parameters)</p>
</div>
<div class="paragraph">
<p>this argument is tainted (method invocations)</p>
</div>
<div class="paragraph">
<p>the returned value is tainted (returns &amp; method invocations results)</p>
</div>
<hr>
</div>
</div>
</div>