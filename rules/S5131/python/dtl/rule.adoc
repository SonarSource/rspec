include::../../summary.adoc[]

== Why is this an issue?

include::../../rationale.adoc[]

include::../../impact.adoc[]

include::../../threats.adoc[]

== How to fix it?

The following code is vulnerable to Cross-Site Scripting because auto-escaping of special HTML characters has been disabled. The recommended way to fix this code is to move the HTML content to the template and to only inject the dynamic value. Therefore, it is not necessary to disable auto-escaping. 

[cols="a,a"]
|===
|
[source,python]
----
from django.shortcuts import render

def hello(request):
        name = request.GET.get("name")
        hello = f"<h1>Hello { name }</h1>"
        return render(request, 'hello.html', {'hello': hello})
----
|
[source,python]
----
from django.shortcuts import render

def hello(request):
        name = request.GET.get("name")
        return render(request, 'hello.html', {'name': name})
----

|
[source,html]
----
<!doctype html>
{% autoescape false %} 
{{ hello }} <!-- Noncompliant -->
{% endautoescape %}
----
|
[source,html]
----
<!doctype html>
<h1>Hello {{ name }}</h1>
----

|===

=== How does this work?

Template engines are used by web applications to build HTML content. Template files contain static HTML as well as template language instructions. These instructions allow, for example, to insert dynamic values in the document as the template is rendered. Template engines can auto-escape HTML special characters of dynamic values in order to prevent XSS vulnerabilities.

In Django applications, the engine's auto-escaping feature is enabled by default. XSS vulnerabilities arise when an untrusted value is injected in the template and auto-escaping is disabled using ``++{% autoescape false %}++`` or ``++|safe++`` filter. This is often the case when a piece of dynamic HTML is generated from the code and used in a template variable.

include::../../common/fix/data_encoding.adoc[]

Django templates auto-escaping only takes care of HTML entity endcoding. It will not protect from XSS if a variable is injected in an unquoted attribute or direcly in a script block.

Auto-escaping may be disabled at application level causing XSS vulnerabilities even if ``++{% autoescape false %}++`` or ``++|safe++`` are not being used.

[cols="a,a"]
|===
|
[source,python]
----
# settings.py
TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'OPTIONS': {
            'autoescape': False,
            ],
        },
    },
]
----
|
[source,python]
----
# settings.py
TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'OPTIONS': {
            'autoescape': True,
            ],
        },
    },
]
----

|===

=== Pitfalls

Although auto-escaping drastically decreases the chance of introducing Cross-Site Scripting vulnerabilities, there are still specific cases where vulnerabilities can occur.

==== Variables in script blocks

As mentionned above, injecting user-contoled value inside a ``++script++`` is dangerous and the best practice, in such a case, is to add the value to an attribute.
Another option is to use ``++json_script++`` filter to insert a data structure that can then be accessed from the JavaScript code.

[cols="a,a"]
|===
|
[source,html]
----
<!doctype html>
<script> var name = '{{ name }}';</script>
----
|
[source,html]
----
<!doctype html>
{{ name\|json_script:"name-data" }}
<script> var name = JSON.parse(document.getElementById('name-data').textContent);</script>
----
|===

include::../../common/pitfalls/validation.adoc[]

=== Going the extra mile

== Resources

=== Documentation

* https://docs.djangoproject.com/en/4.0/ref/templates/builtins[Django, Built-in template tags and filters]

include::../../common/resources/articles.adoc[]

include::../../common/resources/presentations.adoc[]

include::../../common/resources/standards.adoc[]

ifdef::env-github,rspecator-view[]

'''
== Implementation Specification
(visible only on this page)

include::../../message.adoc[]

include::../../highlighting.adoc[]

'''
== Comments And Links
(visible only on this page)

include::../../comments-and-links.adoc[]
endif::env-github,rspecator-view[]
