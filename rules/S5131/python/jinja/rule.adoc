include::../../summary.adoc[]

== Why is this an issue?

include::../../rationale.adoc[]

include::../../impact.adoc[]

include::../../threats.adoc[]

== How to fix it?

The following code is vulnerable to XSS because Jinja auto escaping of special HTML characters has been disabled.

[source,python]
----
from flask import render_template

@app.route('/hello/<name>')
def hello(name=None):
    hello = f"<h1>Hello { name }</h1>"
    return render_template('hello.html', hello=hello)
----

[source,html]
----
<!doctype html>
{% autoescape false %} 
{{ hello }} <!-- Noncompliant -->
{% endautoescape %}
----

One option is to move the dynamic HTML content to the template engine and stop disabling auto escaping.

[[source,python]
----
from flask import render_template

@app.route('/hello/<name>')
def hello(name=None):
    return render_template('hello.html', name=name)
----
[source,html]
----
<!doctype html>
<h1>Hello {{ name }}</h1>
----

Another option is to use ``++jinja2.escape++`` or ``++html.escape++`` to sanitize untrusted values before using them in the dynamically-generated HTML string.

[[source,python]
----
from flask import render_template
import html

@app.route('/hello/<name>')
def hello(name=None):
    hello = f"<h1>Hello { html.escape(name) }</h1>"
    return render_template('hello.html', hello=hello)
----

[source,html]
----
<!doctype html>
{% autoescape false %} 
{{ hello }}
{% endautoescape %}
----

=== How does this work?

Template engines are used by web applications to build HTML content. Template files contain static HTML as well as template language instruction. These instructions allow, for example, to insert dynamic values in the document as the template is rendered. Template engines can auto escape HTML special characters of dynamic values in order to prevent XSS vulnerabilities.

In Flask applications, the Jinja auto escaping feature is enabled by default. XSS vulnerabilities arise when an untrusted value is injected in the template and that auto escaping is disabled using `{% autoescape false %}`. This is often the case when a piece of dynamic HTML is generated from the Python code and used as a template parameter. 

=== Pitfalls

Although Jinja autoescaping drastically decreases the chance of introducing Cross-Site Scripting vulnerabilities, there are still specific cases where vulnerabilities can occure.

==== Dynamic values inside a script tag

Autoescaping doesn't prevent XSS when dynamic value are replaced inside ```++<script>++` tags.
In the following example, if ``++name++`` is not untrusted, JavaScript code can be injected.

[source,html]
----
<!doctype html>
<script> var name = {{ name }}</script>
----

In this case dynamic data should be retrived asynchronously form the JavaScript code.
Alternatively the ``++tojson++`` filter can be use to insert a data structure in the JavaScript code at render time.

[source,html]
----
<!doctype html>
<script> var name = {{ name | tojson }}</script>
----

=== Going the extra mile

== Resources

=== Documentation

include::../../common/resources/articles.adoc[]

include::../../common/resources/presentations.adoc[]

include::../../common/resources/standards.adoc[]

ifdef::env-github,rspecator-view[]

'''
== Implementation Specification
(visible only on this page)

include::../../message.adoc[]

include::../../highlighting.adoc[]

'''
== Comments And Links
(visible only on this page)

include::../../comments-and-links.adoc[]
endif::env-github,rspecator-view[]
