include::../../summary.adoc[]

== Why is this an issue?

include::../../rationale.adoc[]

include::../../impact.adoc[]

include::../../threats.adoc[]

== How to fix it?

The following code is vulnerable to Cross-Site Scripting because auto-escaping of special HTML characters has been disabled.
Enable auto-escaping by moving the dynamic HTML content to the template engine.

[cols="a,a"]
|===
|
[source,csharp]
----
using Microsoft.AspNetCore.Mvc;

public class HelloController : Controller
{
    public IActionResult Hello(string name)
    {
        ViewData["Hello"] = "<h1>Hello"+ name +"</h1>";
        return View("Hello");
     }
}
----
|
[source,html]
----
@Html.Raw(ViewData["Hello"])
----
|
[source,csharp]
----
using Microsoft.AspNetCore.Mvc;

public class HelloController : Controller
{
    public IActionResult Hello(string name)
    {
        ViewData["Name"] = name;
        return View("Hello");
     }
}
----
|
[source,html]
----
<h1>@ViewData["Name"]</h1>
----
|===

=== How does this work?

Template engines are used by web applications to build HTML content. Template files contain static HTML as well as template language instructions. These instructions allow, for example, to insert dynamic values in the document as the template is rendered. Template engines can auto-escape HTML special characters of dynamic values in order to prevent XSS vulnerabilities.

In .NET applications relying on Razor, the auto-escaping feature is enabled by default. XSS vulnerabilities arise when an untrusted value is injected in the template and auto-escaping is disabled using ``++@Html.Raw++`` or ``++Microsoft.AspNetCore.Html.HtmlString++`` expressions. This is often the case when a piece of dynamic HTML is generated from the code and used in a template variable.

include::../../common/fix/data_encoding.adoc[]

Razor engine auto-escaping only takes care of HTML entity endcoding. It will not protect from XSS if a variable is injected in an unquoted attribute or direcly in a script block.

=== Pitfalls

include::../../common/pitfalls/validation.adoc[]

=== Going the extra mile

include::../../common/extra-mile/csp.adoc[]

:blazor-csps: https://docs.microsoft.com/en-us/aspnet/core/blazor/security/content-security-policy?view=aspnetcore-6.0
:aspdotnet-core-middleware: https://docs.microsoft.com/en-us/aspnet/core/fundamentals/middleware/?view=aspnetcore-6.0
:csp-nonces-owin: https://vcsjones.dev/content-security-policy-nonces-in-asp-net-and-owin/

Implementing content security policies differs from one architecture to another.

* When client-side code is processed by Blazor
** {blazor-csps}[the library supports it by default].
* When CSP requirements are low
** {aspdotnet-core-middleware}[the ASP.Net Core Middleware provides header control].
* When code requirements enforce optimal CSP, including content security policies nonces
** The Open Web Interface for . NET (OWIN) {csp-nonces-owin}[can be used for a simple implementation].


== Resources

include::../../common/resources/docs.adoc[]

include::../../common/resources/articles.adoc[]

include::../../common/resources/presentations.adoc[]

* https://vcsjones.dev/content-security-policy-nonces-in-asp-net-and-owin/[vcsjones.dev, Content-Security-Policy Nonces in ASP.NET and OWIN]
* http://owin.org/[owin.org, OWIN - Open Web Interface for .NET]

include::../../common/resources/standards.adoc[]

ifdef::env-github,rspecator-view[]

'''
== Implementation Specification
(visible only on this page)

include::../../message.adoc[]

include::../../highlighting.adoc[]

'''
== Comments And Links
(visible only on this page)

include::../../comments-and-links.adoc[]
endif::env-github,rspecator-view[]
