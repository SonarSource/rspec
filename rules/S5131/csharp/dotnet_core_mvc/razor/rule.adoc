include::../../summary.adoc[]

== Why is this an issue?

include::../../rationale.adoc[]

include::../../impact.adoc[]

include::../../threats.adoc[]

== How to fix it?

include::../../fix/intro.adoc[]

//Nice to have:
//include::{S5131}/fix/data_encoding_section_3.adoc[]
include::../../fix/data_encoding_section_3.adoc[]
// Protect well-meaning users from the actions of malicious users by ensuring that user-supplied data cannot break out of its context when injected into a response. 
// To do this, encode the data according to its context. The following table lists how user input should be handled depending on its output context.

Note: Special Razor Form tags are already encoded by default:
* The {asp-route-\{value\}} attribute is automatically encoded by the {BeginWriteTagHelperAttribute()} function.
* HTML Attributes are automatically encoded by the Runtime, with {AddHtmlAttributeValue}.


==== In the View, Model, or ViewModel 
IHtmlContent is considered already as HTML content and won't be encoded, to avoid double-encoding.
To encode data from a View, Model, or ViewModel, multiple considerations are possible:

1. Avoiding {IHtmlContent}, that is considered already-encoded by Razor, which won't encode it at runtime
2. Using {Dependency Injection} to retrieve an HtmlEncoder, JavaScriptEncoder, or UrlEncoder

[source,csharp]
----
// Non-Compliant Sample
public class ViewModel 
{
    public string ThirdPartyString     { get; private set; }
    public IHtmlContent ThirdPartyHtml { get; private set; }

    public ViewModel(string thirdPartyData)
    {
        this.ThirdPartyString = thirdPartyData;
        this.ThirdPartyHtml   = new HtmlString(thirdPartyData);
    }
}
----

[source,csharp]
----
// Compliant Sample
public class ViewModel 
{
    public string ThirdPartyString     { get; private set; }
    public IHtmlContent ThirdPartyHtml { get; private set; }

    public ViewModel(string thirdPartyData, HtmlEncoder htmlEncoder)
    {
        thirdPartyData        = htmlEncoder(thirdPartyData);
        this.ThirdPartyString = thirdPartyData;
        this.ThirdPartyHtml   = new HtmlString(thirdPartyData);
    }
}
----

==== In the Razor View
Important: everything except IHtmlContent is encoded under the hood

The data passed via special .Net objects is encoded the same way as regular data, such as Model data. The aforementionned objects are:

* ViewData
* ViewBag
* TempData
* Context (HttpContext.Items)

[source,html]
----
// Non-Compliant Sample

@Model.TaintedHtml  @*Noncompliant (S5131)*@

@Html.Raw(Model.TaintedString) @*Noncompliant*@

@{ Output.Write(Model.TaintedString);} @*Noncompliant*@

@ViewData["TaintedHtml"]   @*Noncompliant*@
@Html.Raw(ViewData["TaintedString"]) @*Noncompliant*@
@Html.Raw(ViewBag.TaintedString) @*Noncompliant*@

@{
    object taintedObject = ViewBag.TaintedString; // Value is read from ViewBagAll argument => can cause FP
    string taintedString = ViewBag.TaintedString as string;
}
@Html.Raw(taintedObject) @*Noncompliant*@
@taintedObject @*Noncompliant FP, everything except IHtmlContent is encoded under the hood*@
----

[source,html]
----
// Compliant Sample
@Model.CleanString
@Model.TaintedString @*Compliant, automatically encoded*@

@Model.CleanHtml    @*Compliant, engine is field sensitive*@

@Html.Raw(Model.CleanString)   @*Compliant, engine is field sensitive*@

@{ Output.Write(Model.CleanString);}   @*Compliant, engine is field sensitive*@

@ViewData["TaintedString"] @*Compliant, everything except IHtmlContent is encoded under the hood*@
@Html.Raw(ViewBag.CleanString)

@{
    object taintedObject = ViewBag.TaintedString; // Value is read from ViewBagAll argument => can cause FP
    string taintedString = ViewBag.TaintedString as string;
}
@taintedString @*Compliant, overload with string argument is recognized here*@
----


=== Pitfalls

include::../../pitfalls/deny-lists.adoc[]

To create an allow-list in .Net Core, you have TODO TODO TODO TODO

=== Going the extra mile

include::../../extra-mile/csp.adoc[]

To add CSP in .Net Blabla, you have TODO TODO TODO

include::../../resources.adoc[]

ifdef::env-github,rspecator-view[]

'''
== Implementation Specification
(visible only on this page)

include::../../message.adoc[]

include::../../highlighting.adoc[]

'''
== Comments And Links
(visible only on this page)

include::../../comments-and-links.adoc[]
endif::env-github,rspecator-view[]
