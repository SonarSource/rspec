== Why is this an issue?

GitHub Actions workflows support special workflow commands that allow workflows to interact with the runner.
These commands can be invoked by printing specially crafted messages to the standard output.
For example, `::set-mask` can be used to mask sensitive values in the workflow logs and `::error` to terminate execution with a useful error message.

Two of such commands, `::set-env` and `::add-path`, allow setting arbitrary environment variables and modifying the system PATH for the subsequent workflow steps.
In 2020, these commands were deprecated and disabled by default due to security concerns.
However, `ACTIONS_ALLOW_UNSECURE_COMMANDS` environment variable can still be used to re-enable them.

If this environment variable is set, the runner will process `::set-env` and `::add-path` commands printed to the standard output.
If an adversary can influence the content printed to the standard output (e.g., by injecting something into the build logs), they could use these commands to manipulate the runtime environment.

=== What is the potential impact?

When user-supplied values are used to manipulate environment variables, an attacker can supply carefully chosen values that cause the system to behave unexpectedly.
This can be used to execute arbitrary commands as well as affect the behavior of other tools and scripts executed after the injection point.
In most cases, this leads to arbitrary code execution on the system.

It is important to note, that these commands are triggered by printing to standard output.
Therefore, this issue can be exploited if an attacker can influence the output of any command executed during the workflow.

The consequences of a successful attack can be severe and far-reaching:

include::../../../shared_content/githubactions/impact/information_disclosure.adoc[]

include::../../../shared_content/githubactions/impact/system_compromise.adoc[]

include::../../../shared_content/githubactions/impact/supply_chain_attacks.adoc[]

include::../../../shared_content/githubactions/impact/repository_manipulation.adoc[]

== How to fix it

To fix this issue, remove setting of the `ACTIONS_ALLOW_UNSECURE_COMMANDS` environment variable, and replace the use of `::set-env` and `::add-path` with their safe alternatives:

* To set environment variables, echo to the `$GITHUB_ENV` environment variable. For example, to make a an environment variable named `VARIABLE` to `value` for the subsequent workflows steps, you can do the following:

  # This is equivalent to `export VARIABLE=value` across stpes
  echo "VARIABLE=value" >> $GITHUB_ENV

* To prepend a new entry to the system PATH, echo to the `$GITHUB_PATH` environment variable. For example, to add `/new/path` to the PATH for the subsequent workflow steps, you can do the following:

  # This is equivalent to `export PATH=/new/path:$PATH` across steps
  echo "/new/path" >> $GITHUB_PATH

=== Code examples

==== Noncompliant code example

[source,yaml,diff-id=1,diff-type=noncompliant]
----
name: "Example"

jobs:
  set_env:
    runs-on: ubuntu-latest
    env:
      ACTIONS_ALLOW_UNSECURE_COMMANDS: true  # Noncompliant
    steps:
      - run: |
          echo "::set-env name=MESSAGE::hello"
      - run: |
          echo "Message: $MESSAGE"
----

==== Compliant solution

[source,yaml,diff-id=1,diff-type=compliant]
----
name: "Example"

jobs:
  set_env:
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "MESSAGE::hello" >> $GITHUB_ENV
      - run: |
          echo "Message: $MESSAGE"
----

== Resources
=== Documentation

* GitHub Docs - https://docs.github.com/en/actions/reference/workflows-and-actions/workflow-commands#setting-an-environment-variable[Workflow commands for GitHub Actions: Setting an environment variable]
* GitHub Docs - https://docs.github.com/en/actions/reference/workflows-and-actions/workflow-commands#adding-a-system-path[Workflow commands for GitHub Actions: Adding a system path]

=== Articles & blog posts

* GitHub Blog - https://github.blog/changelog/2020-10-01-github-actions-deprecating-set-env-and-add-path-commands/[GitHub Actions: Deprecating set-env and add-path commands]
* GitHub Advisory Database - https://github.com/actions/toolkit/security/advisories/GHSA-mfwh-5m23-j46w[`add-path` and `set-env` Runner commands are processed via stdout]
* Google Project Zero - https://project-zero.issues.chromium.org/issues/42451175[Github: Widespread injection vulnerabilities in Actions]

//=== Conference presentations
=== Standards

* OWASP - https://owasp.org/Top10/A03_2021-Injection/[Top 10 2021 Category A3 - Injection]
* OWASP - https://owasp.org/www-project-top-ten/2017/A1_2017-Injection[Top 10 2017 Category A1 - Injection]
* CWE - https://cwe.mitre.org/data/definitions/20[CWE-20 - Improper Input Validation]
* CWE - https://cwe.mitre.org/data/definitions/454[CWE-454 - External Initialization of Trusted Variables or Data Stores]
* STIG Viewer - https://stigviewer.com/stigs/application_security_and_development/2024-12-06/finding/V-222609[Application Security and Development: V-222609] - The application must not be subject to input handling vulnerabilities.

//=== External coding guidelines
//=== Benchmarks
=== Related rules

* S6547 Environment variables should not be defined from untrusted input
