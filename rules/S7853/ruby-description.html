<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This rule raises an issue when <code>find_each</code> is chained with <code>limit()</code> or <code>order()</code> methods in ActiveRecord queries.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ActiveRecord&#8217;s <code>find_each</code> method is designed for efficient batch processing of large datasets. It automatically handles batching and ordering internally to prevent memory issues when processing thousands of records.</p>
</div>
<div class="paragraph">
<p>However, <code>find_each</code> has specific behavior that developers often misunderstand:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It always orders records by primary key (usually <code>id</code>) in ascending order</p>
</li>
<li>
<p>It processes ALL matching records in batches, regardless of any limit</p>
</li>
<li>
<p>It completely ignores any <code>order()</code> or <code>limit()</code> clauses in the query chain</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When you combine <code>find_each</code> with <code>limit()</code> or <code>order()</code> clauses, the code becomes misleading. A developer reading the code might expect it to respect the limit or custom ordering, but it won&#8217;t. This can lead to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Processing more records than intended (ignoring limits)</p>
</li>
<li>
<p>Processing records in unexpected order (ignoring custom sorting)</p>
</li>
<li>
<p>Confusion during debugging when the code doesn&#8217;t behave as written</p>
</li>
<li>
<p>Potential performance issues if you expected to process only a subset of records</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The problem is that the code looks like it should work one way, but ActiveRecord silently ignores parts of your query chain.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>This issue primarily affects code clarity and predictability. Developers may experience unexpected behavior when their queries process more records than intended or in a different order than specified. While not a security vulnerability, it can lead to performance issues if large datasets are processed when only a subset was intended.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it_in_ruby_on_rails">How to fix it in Ruby on Rails</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use <code>find_each</code> without <code>limit</code> or <code>order</code> clauses when you want to process all matching records in batches. Configure batch size if needed.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby"># This ignores the limit and order clauses
Thing.active.order("created_at DESC").limit(50000).find_each { |t| puts t.id } // Noncompliant</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby"># Use find_each without limit/order for batch processing
Thing.active.find_each(batch_size: 1000) { |t| puts t.id }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use <code>each</code> instead of <code>find_each</code> when you need to respect <code>limit</code> or <code>order</code> clauses for smaller result sets.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_code_examples_2">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example_2">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby"># The order clause is ignored
User.where(active: true).order("name ASC").find_each { |u| process(u) } // Noncompliant</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution_2">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby"># Use each to respect the order clause
User.where(active: true).order("name ASC").each { |u| process(u) }</code></pre>
</div>
</div>
<div class="paragraph">
<p>For custom batching with specific ordering and limits, implement manual batching by first getting the IDs, then processing in chunks.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_code_examples_3">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example_3">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby"># The limit is ignored - processes all records
Product.published.limit(1000).find_each { |p| update_cache(p) } // Noncompliant</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution_3">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby"># Manual batching with custom order and limit
ids = Product.published.order("created_at DESC").limit(1000).pluck(:id)
ids.in_groups_of(100, false).each do |batch_ids|
  Product.where(id: batch_ids).each { |p| update_cache(p) }
end</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>Rails Guides - Active Record Query Interface - <a href="https://guides.rubyonrails.org/active_record_querying.html#retrieving-multiple-objects-in-batches">Official Rails documentation on batch processing methods including find_each</a></p>
</li>
<li>
<p>ActiveRecord::Batches API Documentation - <a href="https://api.rubyonrails.org/classes/ActiveRecord/Batches.html">Complete API documentation for ActiveRecord batch processing methods</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>