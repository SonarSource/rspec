<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This rule raises an issue when a field is lazily initialized using a simple null check without proper synchronization in a multi-threaded context.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Lazy initialization is a common pattern where you delay creating an object until it&#8217;s actually needed. This can improve performance by avoiding unnecessary object creation.</p>
</div>
<div class="paragraph">
<p>However, the simple approach of checking if a field is null and then initializing it creates a race condition in multi-threaded applications. Here&#8217;s what can go wrong:</p>
</div>
<div class="paragraph">
<p>When multiple threads access the same lazy initialization code simultaneously, they might all see the field as null at the same time. This means multiple threads will create new instances of the object, and the field might be overwritten multiple times.</p>
</div>
<div class="paragraph">
<p>This leads to several problems:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Wasted resources</strong>: Multiple objects are created when only one is needed</p>
</li>
<li>
<p><strong>Inconsistent state</strong>: Different parts of your application might use different instances</p>
</li>
<li>
<p><strong>Memory leaks</strong>: Unused instances consume memory unnecessarily</p>
</li>
<li>
<p><strong>Logic errors</strong>: If the initialization has side effects, they might happen multiple times</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The issue is particularly problematic with singleton patterns, where you expect exactly one instance to exist throughout your application&#8217;s lifetime.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>Race conditions can cause unpredictable behavior, memory waste, and logic errors. In singleton patterns, multiple instances can break application assumptions and lead to inconsistent state across the system.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use the <code>synchronized</code> keyword on the method to ensure only one thread can execute the initialization logic at a time.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">private SomeObject instance

protected SomeObject getInstance() {
    if (instance == null) { // Noncompliant
        instance = new SomeObject()
    }
    return instance
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">private SomeObject instance

protected synchronized SomeObject getInstance() {
    if (instance == null) {
        instance = new SomeObject()
    }
    return instance
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>Groovy @Lazy annotation - <a href="https://docs.groovy-lang.org/latest/html/gapi/groovy/transform/Lazy.html">Official documentation for Groovy&#8217;s @Lazy transformation</a></p>
</li>
<li>
<p>Java Concurrency in Practice - Safe Publication - <a href="https://jcip.net/">Comprehensive guide to thread-safe programming patterns</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_standards">Standards</h3>
<div class="ulist">
<ul>
<li>
<p>CWE-362: Concurrent Execution using Shared Resource with Improper Synchronization - <a href="https://cwe.mitre.org/data/definitions/362.html">Race conditions in concurrent execution</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_related_rules">Related rules</h3>
<div class="ulist">
<ul>
<li>
<p><a data-rspec-id="S3064" class="rspec-auto-link">RSPEC-3064</a> - <a href="https://rules.sonarsource.com/java/RSPEC-3064/">Lazy initialization should be thread-safe (Java)</a></p>
</li>
<li>
<p><a data-rspec-id="S2444" class="rspec-auto-link">RSPEC-2444</a> - <a href="https://rules.sonarsource.com/java/RSPEC-2444/">Lazy initialization of static fields should be thread-safe (Java)</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>