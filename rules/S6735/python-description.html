<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This rule raises an issue when the parameters <code>how</code>, <code>on</code> and <code>validate</code> are not provided when using <code>pandas.merge</code> or <code>pandas.join</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Pandas library provides a user-friendly API to concatenate two data frames together with the methods <code>merge</code> and <code>join</code>.</p>
</div>
<div class="paragraph">
<p>When using these methods, it is possible to specify how the merge will be performed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The parameter <code>how</code> specifies the type of merge (<code>left</code>, <code>inner</code>, <code>outer</code>, etc..).</p>
</li>
<li>
<p>The parameter <code>on</code> specifies the column(s) on which the merge will be performed.</p>
</li>
<li>
<p>The parameter <code>validate</code> specifies a way to verify if the merge result is what was expected.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">import pandas as pd

age_df = pd.DataFrame({"user_id":[1,2,4], "age":[42,45, 35]})
name_df = pd.DataFrame({"user_id":[1,2,3,4], "name":["a","b","c","d"]})

result = age_df.merge(name_df, on="user_id", how="right", validate="1:1")</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above, both data frames will be merged together based on the column <code>user_id</code>, specified by the parameter <code>on</code>.</p>
</div>
<div class="paragraph">
<p>The parameter <code>how</code> set to <code>right</code> states that the resulting data frame will contain all the <code>user_id</code>s present in the data frame <code>name_df</code>
(including <code>3</code>, which is absent from <code>age_df</code> and will therefore be assigned a <code>NaN</code> value for the <code>age</code> column).</p>
</div>
<div class="paragraph">
<p>Lastly, setting the <code>validate</code> parameter to <code>1:1</code> means a check will be performed
to verify that the column used for the merge only contains unique keys in both data frames.
If this check fails a <code>MergeError</code> will be raised.</p>
</div>
<div class="paragraph">
<p>Here is the resulting data frame:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">row</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">user_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">age</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">42</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">a</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">45</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">b</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NaN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">c</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">35</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">d</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>More information about these methods and their parameters can be found in the pandas documentation: <a href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.merge.html#pandas-dataframe-merge">merge</a> and <a href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.join.html#pandas-dataframe-join">join</a>.</p>
</div>
<div class="paragraph">
<p>The <code>how</code>, <code>on</code> and <code>validate</code> parameters are optional and pandas provides sensible default values.</p>
</div>
<div class="paragraph">
<p>This means <code>merge</code> could be used as follow:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">import pandas as pd

age_df = pd.DataFrame({"user_id":[1,2,4], "age":[42,45, 35]})
name_df = pd.DataFrame({"user_id":[1,2,3,4], "name":["a","b","c","d"]})

result = age_df.merge(name_df)</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>how</code> parameter defaults to <code>inner</code>.</p>
</li>
<li>
<p>The <code>on</code> parameter defaults to the columns which have a similar name, in our case <code>user_id</code> .</p>
</li>
<li>
<p>The <code>validate</code> parameter will be set to <code>many_to_many</code>, meaning no validation will be performed.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is the resulting data frame:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">row</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">user_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">age</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">42</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">a</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">45</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">b</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">35</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">d</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>While the example above is perfectly valid, using the <code>merge</code> and <code>join</code> methods without providing the <code>how</code>,
<code>on</code> and <code>validate</code> arguments has two main drawbacks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It makes the code intention unclear: without the <code>how</code> parameter set, it is unclear if the developer noticed that a <code>user_id</code> (<code>3</code>) will be missing from the resulting data frame, or if it is done on purpose.</p>
</li>
<li>
<p>It makes the code harder to maintain: if one of the data frame would change its <code>user_id</code> column name to <code>id</code>, the code would still run but the result would be entirely different.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In order to mitigate these drawbacks, setting the <code>how</code> parameter to <code>inner</code> would better convey that the intention is to only keep <code>user_id</code>s present in both data frame.
Setting the <code>on</code> parameter to <code>user_id</code> could also avoid issues in the future, for example if the input data frames came to change.</p>
</div>
<div class="paragraph">
<p>The information provided by these parameters is extremely valuable, especially when another developer is in charge of refactoring or
debugging this particular piece of code.</p>
</div>
<div class="paragraph">
<p>This is why it is a good practice to provide the parameters <code>how</code>, <code>on</code> (or <code>left_on</code> and <code>right_on</code>) and <code>validate</code> to the pandas' <code>merge</code> and <code>join</code>.</p>
</div>
<div class="sect2">
<h3 id="_exceptions">Exceptions</h3>
<div class="paragraph">
<p>When providing the <code>how</code> parameter with the value <code>cross</code> this rule will not raise an issue if the <code>on</code> (or <code>left_on</code> and <code>right_on</code>) parameter is missing.</p>
</div>
<div class="paragraph">
<p>When using <code>cross</code> the resulting DataFrame will be the Cartesian product of the two other DataFrames, this means there is no need to specify a column to merge on.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To fix this issue provide the parameters <code>how</code>, <code>on</code> (or <code>left_on</code> and <code>right_on</code>) and <code>validate</code> to the <code>pd.merge</code> or <code>pd.join</code> methods.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">import pandas as pd

def merge_dfs(age_df:pd.DataFrame, name_df:pd.DataFrame):
  return age_df.merge(name_df) # Noncompliant: it is unclear on which column the merge should happen, as well as what is the expected result.</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">import pandas as pd

def merge_dfs(age_df:pd.DataFrame, name_df:pd.DataFrame):
  return age_df.merge(
          name_df,
          on="user_id",
          how="inner",
          validate="1:1"
         ) # Compliant</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>Pandas Documentation - <a href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.merge.html#pandas-dataframe-merge">pandas.DataFrame.merge</a></p>
</li>
<li>
<p>Pandas Documentation - <a href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.join.html#pandas-dataframe-join">pandas.DataFrame.join</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>