<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Sending emails is security-sensitive and can expose an application to a large range of vulnerabilities.</p>
</div>
<div class="paragraph">
<p><strong>Information Exposure</strong></p>
</div>
<div class="paragraph">
<p>Emails often contain sensitive information which might be exposed to an attacker if he can add an arbitrary address to the recipient list.</p>
</div>
<div class="paragraph">
<p><strong>Spamming / Phishing</strong></p>
</div>
<div class="paragraph">
<p>Malicious user can abuse email based feature to send spam or phishing content.</p>
</div>
<div class="paragraph">
<p><strong>Dangerous Content Injection</strong></p>
</div>
<div class="paragraph">
<p>Emails can contain HTML and JavaScript code, thus they can be used for XSS attacks.</p>
</div>
<div class="paragraph">
<p><strong>Email Headers Injection</strong></p>
</div>
<div class="paragraph">
<p>Email fields such as <code>subject</code>, <code>to</code>, <code>cc</code>, <code>bcc</code>, <code>from</code> are set in email "headers".  Using unvalidated user input to set those fields might allow attackers to inject new line characters in headers to craft malformed SMTP requests. Although modern libraries are filtering new line character by default, user data used in email "headers" should always be validated.</p>
</div>
<div class="paragraph">
<p>In the past, it has led to the following vulnerabilities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.cve.org/CVERecord?id=CVE-2017-9801">CVE-2017-9801</a></p>
</li>
<li>
<p><a href="https://www.cve.org/CVERecord?id=CVE-2016-4803">CVE-2016-4803</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ask_yourself_whether">Ask Yourself Whether</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Unvalidated user input are used to set email headers.</p>
</li>
<li>
<p>Email content contains data provided by users and it is not sanitized.</p>
</li>
<li>
<p>Email recipient list or body are based on user inputs.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You are at risk if you answered yes to any of those questions.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_recommended_secure_coding_practices">Recommended Secure Coding Practices</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Use an email library which sanitizes headers (Flask-Mail or django.core.mail).</p>
</li>
<li>
<p>Use html escape functions to sanitize every piece of data used to in the email body.</p>
</li>
<li>
<p>Verify application logic to make sure that email base feature can not be abuse to:</p>
<div class="ulist">
<ul>
<li>
<p>Send arbitrary email for spamming or fishing</p>
</li>
<li>
<p>Disclose sensitive email content</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sensitive_code_example">Sensitive Code Example</h2>
<div class="sectionbody">
<div class="paragraph">
<p>smtplib</p>
</div>
<div class="listingblock">
<div class="content">
<pre>import smtplib

def send(from_email, to_email, msg):
  server = smtplib.SMTP('localhost', 1025)
  server.sendmail(from_email, to_email, msg) # Sensitive</pre>
</div>
</div>
<div class="paragraph">
<p>Django</p>
</div>
<div class="listingblock">
<div class="content">
<pre>from django.core.mail import send_mail

def send(subject, msg, from_email, to_email):
  send_mail(subject, msg, from_email, [to_email]) # Sensitive</pre>
</div>
</div>
<div class="paragraph">
<p>Flask-Mail</p>
</div>
<div class="listingblock">
<div class="content">
<pre>from flask import Flask
from flask_mail import Mail, Message

app = Flask(__name__)

def send(subject, msg, from_email, to_email):
    mail = Mail(app)
    msg = Message(subject, [to_email], body, sender=from_email)
    mail.send(msg) # Sensitive{code}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://www.damonkohler.com/2008/12/email-injection.html">Email Injection</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-top-ten/2017/A1_2017-Injection">Top 10 2017 Category A1 - Injection</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/93">CWE-93 - Improper Neutralization of CRLF Sequences ('CRLF Injection')</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/80">CWE-80 - Improper Neutralization of Script-Related HTML Tags in a Web Page (Basic XSS)</a></p>
</li>
</ul>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Make sure that this email is sent in a safe manner.</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_on_28_oct_2019_074243_alexandre_gigleux_wrote">on 28 Oct 2019, 07:42:43 Alexandre Gigleux wrote:</h3>
<div class="paragraph">
<p>LGTM</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_27_may_2020_164158_eric_therond_wrote">on 27 May 2020, 16:41:58 Eric Therond wrote:</h3>
<div class="paragraph">
<p>Deprecated because it overlaps with SonarSecurity</p>
</div>
</div>
</div>
</div>