<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This rule raises an issue when SQL date functions like <code>DATE()</code> or direct date comparisons are used in ActiveRecord where clauses with datetime columns.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Using SQL date functions in ActiveRecord queries can cause timezone conversion issues and unexpected results. When you use functions like <code>DATE()</code> or compare datetime columns directly with Date objects, the database performs timezone conversions that may not align with your application&#8217;s timezone settings.</p>
</div>
<div class="paragraph">
<p>For example, <code>Subscription.where("DATE(created_at) = ?", Date.today)</code> might miss records created late in the day if your application timezone differs from the database timezone. The <code>DATE()</code> function strips the time component using the database&#8217;s timezone, while <code>Date.today</code> uses the application&#8217;s timezone.</p>
</div>
<div class="paragraph">
<p>Additionally, SQL date functions are database-specific, making your code less portable. Functions like <code>DATEPART()</code> work in SQL Server but not in PostgreSQL or MySQL, creating maintenance challenges when switching databases.</p>
</div>
<div class="paragraph">
<p>These issues are particularly problematic in applications serving users across multiple timezones, where incorrect date filtering can lead to missing or duplicate data in reports and user interfaces.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>This issue can lead to incorrect query results, causing data inconsistencies in reports, missing records in time-sensitive operations, and subtle bugs that are difficult to detect and debug. In multi-timezone applications, users may see incorrect data or miss important information due to timezone conversion errors.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it_in_ruby_on_rails">How to fix it in Ruby on Rails</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use Ruby date ranges with <code>beginning_of_day</code> and <code>end_of_day</code> methods instead of SQL date functions. This ensures proper timezone handling and database portability.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby"># Avoid SQL DATE() function - causes timezone issues
Subscription.where("DATE(created_at) = ?", Date.today) // Noncompliant</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby"># Use date ranges for timezone-aware date queries
Subscription.where(created_at: Date.today.beginning_of_day..Date.today.end_of_day)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use ActiveRecord&#8217;s <code>all_day</code> helper method for cleaner date range queries that respect timezone settings.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_code_examples_2">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example_2">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby"># Avoid direct date comparison with datetime columns
Subscription.where("created_at = ?", Date.today) // Noncompliant</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution_2">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby"># Use ActiveRecord's date helpers
Subscription.where(created_at: Date.current.all_day)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For open-ended date comparisons, use explicit time boundaries instead of database-specific date functions.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_code_examples_3">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example_3">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby"># Avoid database-specific date functions
Subscription.where("DATEPART(day, created_at) = ?", Date.today.day) // Noncompliant</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution_3">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby"># Be explicit about time boundaries
Subscription.where(created_at: Date.today.beginning_of_day..)</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>Rails Guides - Active Record Query Interface - <a href="https://guides.rubyonrails.org/active_record_querying.html">Official Rails documentation on querying with Active Record</a></p>
</li>
<li>
<p>Ruby Date and Time Classes - <a href="https://ruby-doc.org/core/Date.html">Ruby documentation for Date class methods including beginning_of_day and end_of_day</a></p>
</li>
<li>
<p>Rails Time Zone Handling - <a href="https://guides.rubyonrails.org/configuring.html#configuring-time-zones">Rails guide on configuring and handling time zones</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>