=== How to fix it in Express.Js

:canonicalization_function: `fs.realPath`
include::../../common/fix/code-rationale.adoc[]

Then the compliant code sample uses the optional `root` property to define a
base path under which to download the file.

:send: https://www.npmjs.com/package/send 
Behind the scenes, the {send}[send] package is used and eliminates several
risks such as partial path bypass.

==== Non-compliant code example

[source,javascript,diff-id=1,diff-type=noncompliant]
----
const fs = require('fs');

function (req, res) {
  const userFilename = __dirname + req.query.filename;

  res.sendFile(userFilename); // Noncompliant
}
----

==== Compliant solution

[source,javascript,diff-id=1,diff-type=compliant]
----
const fs = require('fs');

function (req, res) {
  const userFilename = __dirname + req.query.filename;

  const targetDirectory = process.cwd();
  res.sendFile(userFilename, { root: targetDirectory });
}
----

=== How does this work?

include::../../common/fix/how-does-this-work.adoc[]
