<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Path injections occur when an application uses untrusted data to construct a file path and access this file without validating its path first.</p>
</div>
<div class="paragraph">
<p>A user with malicious intent would inject specially crafted values, such as <code>../</code>, to change the initial intended path. The resulting path would resolve somewhere in the filesystem where the user should not normally have access to.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>A web application is vulnerable to path injection and an attacker is able to
exploit it.</p>
</div>
<div class="paragraph">
<p>The files that can be affected are limited by the permission of the process
that runs the application. Worst case scenario: the process runs with root
privileges on Linux, and therefore any file can be affected.</p>
</div>
<div class="paragraph">
<p>Below are some real-world scenarios that illustrate some impacts of an attacker
exploiting the vulnerability.</p>
</div>
<div class="sect3">
<h4 id="_override_or_delete_arbitrary_files">Override or delete arbitrary files</h4>
<div class="paragraph">
<p>The injected path component tampers with the location of a file the application
is supposed to delete or write into. The vulnerability is exploited to remove
or corrupt files that are critical for the application or for the system to
work properly.</p>
</div>
<div class="paragraph">
<p>It could result in data being lost or the application being unavailable.</p>
</div>
</div>
<div class="sect3">
<h4 id="_read_arbitrary_files">Read arbitrary files</h4>
<div class="paragraph">
<p>The injected path component tampers with the location of a file the application
is supposed to read and output. The vulnerability is exploited to leak the
content of arbitrary files from the file system, including sensitive files like
SSH private keys.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it_in_net">How to fix it in .NET</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="paragraph">
<p>The following code is vulnerable to path injection as it creates a path using
untrusted data without validation.</p>
</div>
<div class="paragraph">
<p>In this particular case, the code can be exploited with the following input to
delete arbitrary files outside of the intended directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>../../../../</pre>
</div>
</div>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-csharp" data-lang="csharp">public class ExampleController : Controller
{
    private static string TargetDirectory = "/path/to/target/directory/";

    public void Example(string filename)
    {
        string path = Path.Combine(TargetDirectory, filename);
        System.IO.File.Delete(path);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-csharp" data-lang="csharp">public class ExampleController : Controller
{
    private static string TargetDirectory = "/path/to/target/directory/";

    public void Example(string filename)
    {
        string path = Path.Combine(TargetDirectory, filename);
        string canonicalDestinationPath = Path.GetFullPath(path);

        if (canonicalDestinationPath.StartsWith(TargetDirectory, StringComparison.Ordinal))
        {
            System.IO.File.Delete(canonicalDestinationPath);
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_how_does_this_work">How does this work?</h3>
<div class="sect3">
<h4 id="_canonical_path_validation">Canonical path validation</h4>
<div class="paragraph">
<p>If it is impossible to use secure-by-design APIs that do this automatically, the universal way to prevent path injection is to validate paths constructed from untrusted data:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Ensure the target directory path ends with a forward slash to prevent partial path traversal, for example, <code>/base/dirmalicious</code> starts with <code>/base/dir</code> but does not start with <code>/base/dir/</code>.</p>
</li>
<li>
<p>Resolve the canonical path of the file by using methods like <code>System.IO.Path.GetFullPath</code>. This will resolve relative path or path components like <code>../</code> and removes any ambiguity regarding the file&#8217;s location.</p>
</li>
<li>
<p>Check that the canonical path is within the directory where the file should be located.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Important Note</strong>: The order of this process pattern is important. The code must
follow this order exactly to be secure by design:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>data = transform(user_input);</code></p>
</li>
<li>
<p><code>data = normalize(data);</code></p>
</li>
<li>
<p><code>data = sanitize(data);</code></p>
</li>
<li>
<p><code>use(data);</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>As pointed out in <a href="https://www.youtube.com/watch?v=V-DdcKADnFk">this SonarSource talk</a>, failure to follow this
exact order leads to security vulnerabilities.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_pitfalls">Pitfalls</h3>
<div class="sect3">
<h4 id="_partial_path_traversal">Partial Path Traversal</h4>
<div class="paragraph">
<p>When validating untrusted paths by checking if they start with a trusted folder name,
<strong>ensure the validation string contains a path separator as the last character</strong>.<br>
A partial path traversal vulnerability can be unintentionally introduced into
the application without a path separator as the last character of the
validation strings.</p>
</div>
<div class="paragraph">
<p>For example, the following code is vulnerable to partial path injection. Note
that the string <code>TargetDirectory</code> does not end with a path separator:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-csharp" data-lang="csharp">private static string TargetDirectory = "/Users/John";

public void Example(string filename)
{
    string canonicalDestinationPath = Path.GetFullPath(filename);

    if (canonicalDestinationPath.StartsWith(TargetDirectory, StringComparison.Ordinal))
    {
        System.IO.File.Delete(canonicalDestinationPath);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This check can be bypassed because <code>"/Users/Johnny/file".startsWith("/Users/John")</code>
returns <code>true</code>. Thus, for validation, <code>"/Users/John"</code> should actually be
<code>"/Users/John/"</code>.</p>
</div>
<div class="paragraph">
<p><strong>Warning</strong>: Some functions remove the terminating path separator in their
return value.<br>
The validation code should be tested to ensure that it cannot be impacted by this
issue.</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/aws/aws-sdk-java/security/advisories/GHSA-c28r-hw5m-5gv3">Here is a real-life example of this vulnerability.</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_do_not_use_path_combine_as_a_validator">Do not use Path.Combine as a validator</h4>
<div class="paragraph">
<p>The <a href="https://learn.microsoft.com/en-us/dotnet/api/system.io.path.combine">official documentation</a> states that if any argument other
than the first is an absolute path, any previous argument is discarded.</p>
</div>
<div class="paragraph">
<p>This means that including untrusted data in any of the parameters and using the
resulting string for file operations may lead to a path traversal vulnerability.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_standards">Standards</h3>
<div class="ulist">
<ul>
<li>
<p>OWASP - <a href="https://owasp.org/Top10/A01_2021-Broken_Access_Control/">Top 10 2021 Category A1 - Broken Access Control</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/Top10/A03_2021-Injection/">Top 10 2021 Category A3 - Injection</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-top-ten/2017/A1_2017-Injection">Top 10 2017 Category A1 - Injection</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-top-ten/2017/A5_2017-Broken_Access_Control">Top 10 2017 Category A5 - Broken Access Control</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/20">CWE-20 - Improper Input Validation</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/22">CWE-22 - Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')</a></p>
</li>
<li>
<p>STIG Viewer - <a href="https://stigviewer.com/stigs/application_security_and_development/2024-12-06/finding/V-222609">Application Security and Development: V-222609</a> - The application must not be subject to input handling vulnerabilities.</p>
</li>
</ul>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Change this code to not construct the path from user-controlled data.</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_relates_to_s4797">relates to: <a data-rspec-id="S4797" class="rspec-auto-link">S4797</a></h3>

</div>
<div class="sect2">
<h3 id="_on_2_oct_2014_081401_nicolas_peru_wrote">on 2 Oct 2014, 08:14:01 Nicolas Peru wrote:</h3>
<div class="paragraph">
<p>I have some doubt about that one as for instance in Java plugin code base I have the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>private File resolvePath(File baseDir, String fileName) {
    File file = new File(fileName);
    if (!file.isAbsolute()) {
      file = new File(baseDir, fileName);
    }
    return file;
  }</pre>
</div>
</div>
<div class="paragraph">
<p>Which is based on a property coming from SQ and filled by the user to be able to access libraries of a java project. So you actually <em>want</em> to support access to some files eventually located in relative directories&#8230;&#8203;</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_2_oct_2014_141234_ann_campbell_wrote">on 2 Oct 2014, 14:12:34 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~nicolas.peru] there are 2 CWE&#8217;s we&#8217;re covering here, one about absolute path traversal and another about relative traversal.</p>
</div>
<div class="paragraph">
<p>In any case, the point of your code is to read files on paths provided by the user. Since your code runs on the user&#8217;s machine, there&#8217;s no problem with that and I wouldn&#8217;t expect this rule to be activated. I&#8217;ll switch this to off by default.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_8_oct_2014_084009_nicolas_peru_wrote">on 8 Oct 2014, 08:40:09 Nicolas Peru wrote:</h3>
<div class="paragraph">
<p>Probably easier with CFG.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_14_may_2018_120403_dinesh_bolkensteyn_wrote">on 14 May 2018, 12:04:03 Dinesh Bolkensteyn wrote:</h3>
<div class="paragraph">
<p>FYI, I fail to understand your 4 years old comment [~nicolas.peru] - is it still relevant? feel free to delete it otherwise</p>
</div>
</div>
</div>
</div>