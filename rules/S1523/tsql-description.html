<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Executing code dynamically is security sensitive. It has led in the past to the following vulnerabilities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.cve.org/CVERecord?id=CVE-2017-9807">CVE-2017-9807</a></p>
</li>
<li>
<p><a href="https://www.cve.org/CVERecord?id=CVE-2017-9802">CVE-2017-9802</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Some APIs enable the execution of dynamic code by providing it as strings at runtime. These APIs might be useful in some very specific meta-programming use-cases. However most of the time their use is frowned upon as they also increase the risk of <a href="https://owasp.org/www-community/attacks/Code_Injection">Injected Code</a>. Such attacks can either run on the server or in the client (exemple: XSS attack) and have a huge impact on an application&#8217;s security.</p>
</div>
<div class="paragraph">
<p>Both <code>EXECUTE( ... )</code> and <code>EXEC( ... )</code> execute as a command the string passed as an argument. They are safe only if the argument is composed of constant character string expressions. But if the command string is dynamically built using external parameters, then it is considered very dangerous because executing a random string allows the execution of arbitrary code.</p>
</div>
<div class="paragraph">
<p>This rule marks for review each occurrence of <code>EXEC</code> and <code>EXECUTE</code>. This rule does not detect code injections. It only highlights the use of APIs which should be used sparingly and very carefully. The goal is to guide security code reviews.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ask_yourself_whether">Ask Yourself Whether</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>the executed code may come from an untrusted source and hasn&#8217;t been sanitized.</p>
</li>
<li>
<p>you really need to run code dynamically.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is a risk if you answered yes to any of those questions.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_recommended_secure_coding_practices">Recommended Secure Coding Practices</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The best solution is to not run code provided by an untrusted source. If you really need to build a command string using external parameters, you should use <code>EXEC sp_executesql</code> instead.</p>
</div>
<div class="paragraph">
<p>Do not try to create a blacklist of dangerous code. It is impossible to cover all attacks that way.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sensitive_code_example">Sensitive Code Example</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>CREATE PROCEDURE USER_BY_EMAIL(@email VARCHAR(255)) AS
BEGIN
  EXEC('USE AuthDB; SELECT id FROM user WHERE email = ''' + @email + ''' ;'); -- Sensitive: could inject code using @email
END</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compliant_solution">Compliant Solution</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">CREATE PROCEDURE USER_BY_EMAIL(@email VARCHAR(255)) AS
BEGIN
  EXEC sp_executesql 'USE AuthDB; SELECT id FROM user WHERE email = @user_email;',
                     '@user_email VARCHAR(255)',
                      @user_email = @email;
END</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>OWASP - <a href="https://owasp.org/Top10/A03_2021-Injection/">Top 10 2021 Category A3 - Injection</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-top-ten/2017/A1_2017-Injection">Top 10 2017 Category A1 - Injection</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/95">CWE-95 - Improper Neutralization of Directives in Dynamically Evaluated Code ('Eval Injection')</a></p>
</li>
</ul>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Use "sp_executesql" to execute this command string using dynamic parameters.</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_on_20_jul_2017_162216_pierre_yves_nicolas_wrote">on 20 Jul 2017, 16:22:16 Pierre-Yves Nicolas wrote:</h3>
<div class="paragraph">
<p><a href="https://msdn.microsoft.com/en-us/library/ms175170(v=sql.105).aspx">Microsoft recommends using sp_executesql</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_20_jul_2017_162640_pierre_yves_nicolas_wrote">on 20 Jul 2017, 16:26:40 Pierre-Yves Nicolas wrote:</h3>
<div class="paragraph">
<p>Maybe we should target both <code>EXECUTE(sql)</code> and <code>sp_executesql</code> where the executed string is the result of a concatenation which uses a parameter of the current procedure.</p>
</div>
</div>
<div class="sect2">
<h3 id="_deprecates_s3523">deprecates: <a data-rspec-id="S3523" class="rspec-auto-link">S3523</a></h3>

</div>
<div class="sect2">
<h3 id="_on_8_jan_2014_154612_dinesh_bolkensteyn_wrote">on 8 Jan 2014, 15:46:12 Dinesh Bolkensteyn wrote:</h3>
<div class="paragraph">
<p>PHP: Is implemented by http://jira.codehaus.org/browse/SONARPLUGINS-2333</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_10_feb_2014_162832_dinesh_bolkensteyn_wrote">on 10 Feb 2014, 16:28:32 Dinesh Bolkensteyn wrote:</h3>
<div class="paragraph">
<p>FYI [~freddy.mallet] I think that the remdiation cost of this should be fairly high, because it will usually force you to redesign your program.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_9_apr_2015_185023_ann_campbell_wrote">on 9 Apr 2015, 18:50:23 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~nicolas.peru] is this rule appropriate for ABAP?</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_12_may_2015_125851_ann_campbell_wrote">on 12 May 2015, 12:58:51 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~nicolas.peru] I need some help narrowing how this rule should apply to ABAP. It looks like we should flag instances of:</p>
</div>
<div class="paragraph">
<p><code>GENERATE SUBROUTINE POOL</code></p>
</div>
<div class="paragraph">
<p><code>INSERT REPORT ... FROM ...</code></p>
</div>
<div class="paragraph">
<p><code>READ REPORT ... INTO ...</code></p>
</div>
<div class="paragraph">
<p><code>GENERATE REPORT</code></p>
</div>
<div class="paragraph">
<p><code>GENERATE DYNPRO</code></p>
</div>
<div class="paragraph">
<p>&#8230;&#8203;?</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_12_may_2015_142532_nicolas_peru_wrote">on 12 May 2015, 14:25:32 Nicolas Peru wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2]  We should flag instances of those where the variable has been generated by concatenating information from some other table.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_4_sep_2018_104943_alexandre_gigleux_wrote">on 4 Sep 2018, 10:49:43 Alexandre Gigleux wrote:</h3>
<div class="paragraph">
<p>\[~nicolas.harraudeau] Review</p>
</div>
<div class="paragraph">
<p>Java, C#, VB.NET, Kotlin, Ruby should be in the list of Targeted Languages. I did no check for all of them, but I believe that all modern languages can call compiler API at runtime.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_4_sep_2018_162444_nicolas_harraudeau_wrote">on 4 Sep 2018, 16:24:44 Nicolas Harraudeau wrote:</h3>
<div class="paragraph">
<p>\[~alexandre.gigleux] I added Ruby as it has the <code>eval</code> function. I am open to discussion of course but I wouldn&#8217;t include compiled language for now as they are rarely used to execute dynamic code. The value of this rule in this context would be probably low compared to its implementation time. The <a href="https://rosettacode.org/wiki/Runtime_evaluation#Java">way to do it in java</a> is so complex that I am not even sure what should be checked, the compilation or the class loading? There would be case where the code is compiled without being loaded, which would then be false positives.</p>
</div>
</div>
</div>
</div>