<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Database connection strings control how an application connects to a database. They include information such as the
location of the database, how to authenticate with the database, and how the connection should be secured.</p>
</div>
<div class="paragraph">
<p>The insertion of user-supplied values into a connection string can allow external control of these database connections.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Connection strings contain a series of parameters that are structured as key/value pairs, similar to
<code>key1=value1;key2=value2</code>.</p>
</div>
<div class="paragraph">
<p>If an attacker can control values that are inserted into the connection string, they may be able to insert
additional parameters.  These additional parameters can override values that were supplied earlier in the
connection string.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>An attacker can use specially-crafted values to change how the database connection is made. These values can add new
parameters to the connection string, or can override parameters that had already been specified.</p>
</div>
<div class="sect3">
<h4 id="_escalation_of_privilege">Escalation of privilege</h4>
<div class="paragraph">
<p>Some database servers allow authentication via an OS user account instead of a username and password. The database
connection is authenticated as the user running the application. When this authentication mode is used, any username or
password in the connection string are ignored.</p>
</div>
<div class="paragraph">
<p>If an attacker can force the use of this authentication mode, the connection will be made as the user that the web
application is running under. This will often be the <code>LocalSystem</code> or <code>NetworkService</code> account on Windows. Such accounts
are often given a high level of privileges on the database server.</p>
</div>
</div>
<div class="sect3">
<h4 id="_credential_theft">Credential theft</h4>
<div class="paragraph">
<p>If an attacker can change the database server in the connection string, they can have the web application connect to a
server that they control. The web application will then authenticate with that server, allowing those credentials to be
stolen.</p>
</div>
</div>
<div class="sect3">
<h4 id="_bypassing_data_validation">Bypassing data validation</h4>
<div class="paragraph">
<p>Many web applications implicitly trust data that&#8217;s stored in the database. The data is validated before it is stored,
so no additional validation is performed when that data is loaded.</p>
</div>
<div class="paragraph">
<p>If an attacker can change the database server in the connection string, they can have the web application connect to a
database server that they control. Invalid data in this database could be passed to other services or systems, or could
be used to trigger other bugs and logic flaws in the web application.</p>
</div>
</div>
<div class="sect3">
<h4 id="_network_traffic_sniffing">Network traffic sniffing</h4>
<div class="paragraph">
<p>The connection string can control how the connection to the database server is secured. For example, it can control
whether connections to Microsoft SQL Server use transport layer security (TLS).</p>
</div>
<div class="paragraph">
<p>If an attacker can disable these network security measures and they have some way to monitor traffic between the web
server and the database server, they will be able to see all information that&#8217;s written to and read from the database.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it_in_net">How to fix it in .NET</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Microsoft&#8217;s database connection libraries typically provide a connection string builder class. These classes provide
methods and properties that safely set parameter values.</p>
</div>
<div class="paragraph">
<p>Connection string builders will only protect you if you use these methods and properties to set parameter values. They
will not help if you are using them to modify a connection string where user-supplied values have already been added.</p>
</div>
<div class="paragraph">
<p>If no connection string builder is available, user-supplied values must either be validated to ensure that they&#8217;re not
malicious, or must be properly quoted so that they cannot interfere with other connection string parameters.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-vbnet" data-lang="vbnet">Public Property ConnectionString As String = "Server=10.0.0.101;Database=CustomerData"

Public Function ConnectToDatabase(Request As HttpRequest) As SqlConnection
    Dim ConnectionStringFormatted As String = String.Format("{0};User ID={1};Password={2}",
        Me.ConnectionString,
        Request.Form("username"),
        Request.Form("password"))

    Dim Connection As New SqlConnection()
    Connection.ConnectionString = ConnectionStringFormatted ' Noncompliant
    Connection.Open()
    Return Connection
End Function</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-vbnet" data-lang="vbnet">Public Property ConnectionString As String = "Server=10.0.0.101;Database=CustomerData"

Public Function ConnectToDatabase(Request As HttpRequest) As SqlConnection
    Dim Builder As New SqlConnectionStringBuilder(ConnectionString)
    Builder.UserID = Request.Form("username")
    Builder.Password = Request.Form("password")

    Dim Connection As New SqlConnection()
    Connection.ConnectionString = Builder.ConnectionString
    Connection.Open()
    Return Connection
End Function</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_how_does_this_work">How does this work?</h3>
<div class="paragraph">
<p>Connection string builders will ensure that values are correctly sanitized when adding them to the connection string.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>Microsoft - <a href="https://learn.microsoft.com/en-us/dotnet/framework/data/adonet/connection-string-syntax">Connection string syntax</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_conference_presentations">Conference presentations</h3>
<div class="ulist">
<ul>
<li>
<p>DefCon 18: Alonso Palazon, Connection String Attacks -
<a href="https://media.defcon.org/DEF%20CON%2018/DEF%20CON%2018%20presentations/DEF%20CON%2018%20-%20Alonso-Palazon-String.pdf">presentation</a>,
<a href="https://media.defcon.org/DEF%20CON%2018/DEF%20CON%2018%20presentations/DEF%20CON%2018%20-%20Alonso-Palazon-String-wp.pdf">white paper</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_standards">Standards</h3>
<div class="ulist">
<ul>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/15">CWE-15 - External Control of System or Configuration Setting</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/Top10/A03_2021-Injection/">Top 10 2021 Category A3 - Injection</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-top-ten/2017/A1_2017-Injection">Top 10 2017 Category A1 - Injection</a></p>
</li>
<li>
<p>STIG Viewer - <a href="https://stigviewer.com/stigs/application_security_and_development/2024-12-06/finding/V-222609">Application Security and Development: V-222609</a> - The application must not be subject to input handling vulnerabilities.</p>
</li>
</ul>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Change this code to ensure that user-supplied values cannot insert additional connection string parameters.</p>
</div>
</div>
<div class="sect2">
<h3 id="_highlighting">Highlighting</h3>
<div class="paragraph">
<p>When the tainted connection string is being passed as a parameter in a constructor:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Highlight the connection string parameter in the constructor.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When the tainted connection string is being passed as a property value:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Highlight the value that is being assigned to the property.</p>
</li>
</ul>
</div>
<hr>
</div>
</div>
</div>