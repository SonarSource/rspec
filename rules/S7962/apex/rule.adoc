This is an issue when a test class contains multiple test methods that create similar or identical test data, leading to code duplication.

== Why is this an issue?

When test classes contain multiple test methods that need similar test data, duplicating the data creation code across methods creates several problems.

First, it leads to unnecessary code duplication. Each test method repeats the same data setup logic, making the test class longer and harder to maintain. If you need to change how test data is created, you must update multiple locations.

Second, it reduces test efficiency. Each test method executes its own data creation code, which means more database operations and longer test execution times. This becomes particularly noticeable in large test suites.

Third, it increases the risk of inconsistencies. When test data creation is scattered across multiple methods, it's easy for the data setup to drift apart over time, leading to tests that behave differently due to subtle data differences.

The `@testSetup` annotation in Apex provides a clean solution. Methods annotated with `@testSetup` execute once before any test methods run, creating shared test data that all test methods in the class can use. This approach centralizes data creation, improves performance, and ensures consistency across tests.

=== What is the potential impact?

Code duplication makes test classes harder to maintain and increases the risk of inconsistencies. Duplicated data creation logic also leads to longer test execution times and more database operations during testing.

== How to fix it

Move common test data creation logic from individual test methods into a single @testSetup method. The setup method will execute once before any test methods run, and all test methods can access the created data.

=== Code examples

==== Noncompliant code example

[source,apex,diff-id=1,diff-type=noncompliant]
----
@isTest
public class AccountServiceTest {
    @isTest
    static void testCreateAccount() {
        Account acc = new Account(Name = 'Test Account'); // Noncompliant
        insert acc;
        // test logic here
    }
    
    @isTest
    static void testUpdateAccount() {
        Account acc = new Account(Name = 'Test Account'); // Noncompliant
        insert acc;
        // test logic here
    }
}
----

==== Compliant solution

[source,apex,diff-id=1,diff-type=compliant]
----
@isTest
public class AccountServiceTest {
    @testSetup
    static void setupTestData() {
        Account acc = new Account(Name = 'Test Account');
        insert acc;
    }
    
    @isTest
    static void testCreateAccount() {
        Account acc = [SELECT Id, Name FROM Account LIMIT 1];
        // test logic here
    }
    
    @isTest
    static void testUpdateAccount() {
        Account acc = [SELECT Id, Name FROM Account LIMIT 1];
        // test logic here
    }
}
----

== Resources

=== Documentation

 * Apex Testing Framework - https://developer.salesforce.com/docs/atlas.en-us.apexcode.meta/apexcode/apex_testing_framework.htm[Official Salesforce documentation on Apex testing framework and best practices]

 * Test Setup Methods - https://developer.salesforce.com/docs/atlas.en-us.apexcode.meta/apexcode/apex_testing_testsetup_using.htm[Salesforce documentation specifically about using @testSetup methods]
