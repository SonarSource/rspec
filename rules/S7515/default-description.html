<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This rule raises when using a regular <code>with</code> statement inside an async function with a context manager that implements the asynchronous context manager protocol.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When working within an async function, it is important to maintain consistency with the asynchronous programming model. If a context manager implements the asynchronous context manager protocol (defining <code>__aenter__</code> and <code>__aexit__</code> methods), it should be used with the <code>async with</code> statement rather than the regular <code>with</code> statement.</p>
</div>
<div class="paragraph">
<p>The asynchronous context manager protocol is specifically designed to handle resources that may require asynchronous setup or teardown operations. Using the regular <code>with</code> statement in an async context bypasses this intended asynchronous behavior.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>Not following the proper async pattern can lead to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Inconsistent async usage</strong>: Mixing synchronous and asynchronous patterns reduces code clarity</p>
</li>
<li>
<p><strong>Missed async opportunities</strong>: Asynchronous setup and cleanup operations may not be utilized</p>
</li>
<li>
<p><strong>Maintenance issues</strong>: Future developers may not understand the intended async behavior</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use the <code>async with</code> statement when working with asynchronous context managers.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Resource:
    def __enter__(self):
        return self

    def __exit__(self, exc_type, exc, tb):
        ...

    async def __aenter__(self):
        return self

    async def __aexit__(self, exc_type, exc, tb):
        ...

async def main():
    resource = Resource()
    with resource:  # Noncompliant: using 'with' in async function when async protocol is available
        ...</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Resource:
    def __enter__(self):
        return self

    def __exit__(self, exc_type, exc, tb):
        ...

    async def __aenter__(self):
        return self

    async def __aexit__(self, exc_type, exc, tb):
        ...

async def main():
    async with Resource() as resource:  # Compliant: using 'async with' in async function
        ...</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_how_does_this_work">How does this work?</h3>
<div class="paragraph">
<p>The <code>async with</code> statement provides the proper way to use asynchronous context managers:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>It calls the <code>__aenter__</code> method and awaits its result</p>
</li>
<li>
<p>Assigns the returned value to the variable after <code>as</code> (if specified)</p>
</li>
<li>
<p>Executes the code block within the context</p>
</li>
<li>
<p>Calls the <code>__aexit__</code> method and awaits its completion, even if an exception occurs</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This ensures consistency with the async programming model and allows the context manager to perform any necessary asynchronous operations during setup and cleanup.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Use "async with" for asynchronous context managers</p>
</div>
<div class="paragraph">
<p>Quickfix should be considered for implementation.</p>
</div>
</div>
<div class="sect2">
<h3 id="_highlighting">Highlighting</h3>
<div class="ulist">
<ul>
<li>
<p>Primary location: The <code>with</code> keyword when used with an asynchronous context manager</p>
</li>
<li>
<p>Secondary location: The <code>async</code> keyword of the enclosing function</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>Python Documentation - <a href="https://docs.python.org/3/reference/datamodel.html#asynchronous-context-managers">Asynchronous Context Managers</a></p>
</li>
<li>
<p>Python Documentation - <a href="https://docs.python.org/3/reference/compound_stmts.html#the-async-with-statement">The async with statement</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>