== How to fix it

=== Code examples

include::../../common/fix/code-rationale.adoc[]

==== Noncompliant code example

[source,csharp,diff-id=1,diff-type=noncompliant]
----
using System.Text.RegularExpressions;

public class Example
{
    public void validate(string input)
    {
        var rx = new Regex("^(a+)+$", RegexOptions.None); // Noncompliant
        MatchCollection matches = rx.Matches(input);
    }
}
----

[source,csharp,diff-id=2,diff-type=noncompliant]
----
using System.Text.RegularExpressions;

public class Example
{
    public void validate(string input)
    {
        var matches = Regex.IsMatch(input, "^(a+)+$", RegexOptions.None); // Noncompliant
    }
}
----

==== Compliant solution

[source,csharp,diff-id=1,diff-type=compliant]
----
using System;
using System.Text.RegularExpressions;

public class Example
{
    public void validate(string input)
    {
        var rx = new Regex("^(a+)+$", RegexOptions.None, TimeSpan.FromMilliseconds(100));
        MatchCollection matches = rx.Matches(input);
    }
}
----

[source,csharp,diff-id=2,diff-type=compliant]
----
using System;
using System.Text.RegularExpressions;

public class Example
{
    public void validate(string input)
    {
        var matches = Regex.IsMatch(input, "^(a+)+$", RegexOptions.NonBacktracking, TimeSpan.FromMilliseconds(100));
    }
}
----

=== How does this work?

It is recommended to set a timeout value in all regular expression
pattern-matching operations to avoid potential cases of catastrophic
backtracking. This can be done by specifying a time span through the
`matchTimeout` argument as shown in the compliant solutions, or by specifying a
default timeout with the `REGEX_DEFAULT_MATCH_TIMEOUT` property:

[source,csharp]
----
AppDomain.CurrentDomain.SetData("REGEX_DEFAULT_MATCH_TIMEOUT", TimeSpan.FromMilliseconds(100));
----

Additionally, starting from .NET 7, `RegexOptions.NonBacktracking` can be
specified to enable matching using an approach that avoids backtracking and
guarantees linear-time processing in the length of the input.
