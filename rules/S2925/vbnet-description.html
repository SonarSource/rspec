<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Using <code>Thread.Sleep</code> in a test might introduce unpredictable and inconsistent results depending on the environment. Furthermore, it will block the <a href="https://en.wikipedia.org/wiki/Thread_(computing)">thread</a>, which means the system resources are not being fully used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-vbnet" data-lang="vbnet">&lt;TestMethod&gt;
Public Sub SomeTest()
    Threading.Thread.Sleep(500) ' Noncompliant
    ' assertions...
End Sub</code></pre>
</div>
</div>
<div class="paragraph">
<p>An alternative is a task-based asynchronous approach, using <a href="https://learn.microsoft.com/en-us/dotnet/csharp/asynchronous-programming/">async and await</a>.</p>
</div>
<div class="paragraph">
<p>More specifically the <a href="https://learn.microsoft.com/en-us/dotnet/api/system.threading.tasks.task.delay">Task.Delay</a> method should be used, because of the following advantages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It is <strong>asynchronous</strong>: The thread will not be blocked, but instead will be reused by other operations</p>
</li>
<li>
<p>It is more <strong>precise</strong> in timing the delay than <code>Thread.Sleep</code></p>
</li>
<li>
<p>It can be <strong>canceled and continued</strong>, which gives more flexibility and control in the timing of your code</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-vbnet" data-lang="vbnet">&lt;TestMethod&gt;
Public Async Function SomeTest() As Task
    Await Task.Delay(500)
    ' assertions...
End Function</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another scenario is when some data might need to be mocked using <a href="https://github.com/moq/moq4">Moq</a>, and a delay needs to be introduced:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-vbnet" data-lang="vbnet">&lt;TestMethod&gt;
Public Sub UserService_Test()
    Dim UserService As New Mock(Of UserService)
    Dim Expected As New User
    UserService.Setup(Function(X) X.GetUserById(42)).Returns(
        Function()
            Threading.Thread.Sleep(500) ' Noncompliant
            Return Task.FromResult(Expected)
        End Function)
    ' assertions...
End Sub</code></pre>
</div>
</div>
<div class="paragraph">
<p>An alternative to <code>Thread.Sleep</code> while mocking with <code>Moq</code> is to use <code>ReturnsAsync</code> and pass the amount of time to delay there:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-vbnet" data-lang="vbnet">&lt;TestMethod&gt;
Public Sub UserService_Test()
    Dim UserService As New Mock(Of UserService)
    Dim Expected As New User
    UserService.Setup(Function(X) X.GetUserById(42)).ReturnsAsync(Expected, TimeSpan.FromMilliseconds(500))
    ' assertions...
End Sub</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/system.threading.thread.sleep">Thread.Sleep method</a></p>
</li>
<li>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/system.threading.tasks.task.delay">Task.Delay method</a></p>
</li>
<li>
<p><a href="https://learn.microsoft.com/en-us/dotnet/csharp/asynchronous-programming/">Asynchronous programming with async and await</a></p>
</li>
<li>
<p><a href="https://github.com/moq/moq4">Moq mocking library</a></p>
</li>
</ul>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Remove this use of "Thread.Sleep()".</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_on_12_may_2015_145251_david_gageot_wrote">on 12 May 2015, 14:52:51 David Gageot wrote:</h3>
<div class="paragraph">
<p>lgtm</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_20_may_2015_150839_nicolas_peru_wrote">on 20 May 2015, 15:08:39 Nicolas Peru wrote:</h3>
<div class="paragraph">
<p>Ok.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_21_aug_2015_092147_michael_gumowski_wrote">on 21 Aug 2015, 09:21:47 Michael Gumowski wrote:</h3>
<div class="paragraph">
<p>WDYT about changes [~duarte.meneses]?</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_21_aug_2015_092958_duarte_meneses_wrote">on 21 Aug 2015, 09:29:58 Duarte Meneses wrote:</h3>
<div class="paragraph">
<p>Looks good.</p>
</div>
<div class="paragraph">
<p>Only suggestion I have is to put the timeout in the solution longer (2/3s?), otherwise it wouldn&#8217;t fix the problem of dependency on the environment.</p>
</div>
<div class="paragraph">
<p>With awaitility we can use larger timeouts but still proceed quickly as soon as the polling conditions is satisfied.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_21_aug_2015_093555_michael_gumowski_wrote">on 21 Aug 2015, 09:35:55 Michael Gumowski wrote:</h3>
<div class="paragraph">
<p>Ok, updated. Thanks for your feedback! Feels free to modify it directly next time!</p>
</div>
</div>
</div>
</div>