
When you acquire a lock you should also release it in the same method.

This rule raises if you acquire a lock with one of the following methods and you do not release it.

* https://learn.microsoft.com/en-us/dotnet/api/system.threading.readerwriterlock.acquirewriterlock[ReaderWriterLock.AcquireWriterLock]
* https://learn.microsoft.com/en-us/dotnet/api/system.threading.readerwriterlock.acquirereaderlock[ReaderWriterLock.AcquireReaderLock]
* https://learn.microsoft.com/en-us/dotnet/api/system.threading.readerwriterlockslim.enterwritelock[ReaderWriterLockSlim.EnterWriteLock]
* https://learn.microsoft.com/en-us/dotnet/api/system.threading.readerwriterlockslim.tryenterwritelock[ReaderWriterLockSlim.TryEnterWriteLock]
* https://learn.microsoft.com/en-us/dotnet/api/system.threading.readerwriterlockslim.enterreadlock[ReaderWriterLockSlim.EnterReadLock]
* https://learn.microsoft.com/en-us/dotnet/api/system.threading.readerwriterlockslim.tryenterreadlock[ReaderWriterLockSlim.TryEnterReadLock]
* https://learn.microsoft.com/en-us/dotnet/api/system.threading.readerwriterlockslim.enterupgradeablereadlock[ReaderWriterLockSlim.EnterUpgradeableReadLock]
* https://learn.microsoft.com/en-us/dotnet/api/system.threading.readerwriterlockslim.tryenterupgradeablereadlock[ReaderWriterLockSlim.TryEnterUpgradeableReadLock]
* https://learn.microsoft.com/en-us/dotnet/api/system.threading.spinlock.enter[SpinLock.Enter]
* https://learn.microsoft.com/en-us/dotnet/api/system.threading.spinlock.tryente[SpinLock.TryEnter]
* https://learn.microsoft.com/en-us/dotnet/api/system.threading.monitor.enter[Monitor.Enter]
* https://learn.microsoft.com/en-us/dotnet/api/system.threading.monitor.enter[Monitor.TryEnter]



== Why is this an issue?
Not releasing a lock in the same method where you acquire it makes the code less clear and less easy to maintain. You are also introducing the risk of not releasing a lock at all
which can lead to deadlocks or exceptions.

=== Code examples

==== Noncompliant code example

[source,csharp,diff-id=1,diff-type=noncompliant]
----
class Example
{
    private static ReaderWriterLock rwLock = new ReaderWriterLock();
    private static int sharedResource = 0;

    static void Writer()
    {
        try
        {
            rwLock.AcquireWriterLock(2000);  // Noncompliant
            sharedResource++;
        }
        finally
        {
            Reader();
        }
    }

    static void Reader()
    {
        try
        {
            MethodThatMightThrow();  // If this method throws an exception the writer lock will never be released
            rwLock.ReleaseWriterLock();
            rwLock.AcquireReaderLock(2000);
            Console.WriteLine(sharedResource);
        }
        finally
        {
            rwLock.ReleaseReaderLock();
        }
    }
}
----

==== Compliant solution

[source,csharp,diff-id=1,diff-type=compliant]
----
class Example
{
    private static ReaderWriterLock rwLock = new ReaderWriterLock();
    private static int sharedResource = 0;

    static void Writer()
    {
        try
        {
            rwLock.AcquireWriterLock(2000);  // Compliant
            sharedResource++;
        }
        finally
        {
            rwLock.ReleaseWriterLock();
            Reader();
        }
    }

    static void Reader()
    {
        try
        {
            MethodThatMightThrow();  // If this method throws an exception the writer lock will never be released
            rwLock.AcquireReaderLock(2000);
            Console.WriteLine(sharedResource);
        }
        finally
        {
            rwLock.ReleaseReaderLock();
        }
    }
}
----

== Resources

=== Documentation

* Microsoft Learn - https://learn.microsoft.com/en-us/dotnet/api/system.threading.readerwriterlock[ReaderWriterLock Class]
* Microsoft Learn - https://learn.microsoft.com/en-us/dotnet/api/system.threading.readerwriterlockslim[ReaderWriterLockSlim Classs]
* Microsoft Learn - https://learn.microsoft.com/en-us/dotnet/api/system.threading.spinlock[Spinlock Struct]
* Microsoft Learn - https://learn.microsoft.com/en-us/dotnet/api/system.threading.monitor[Monitor Classs]

include::../rspecator.adoc[]