== How to fix it in Java SE

=== Code examples

include::../../common/fix/code-rationale.adoc[]

==== Noncompliant code example

[source,java,diff-id=1,diff-type=noncompliant]
----
DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance(); // Noncompliant
----

[source,java,diff-id=2,diff-type=noncompliant]
----
SAXParserFactory factory = SAXParserFactory.newInstance(); // Noncompliant
----

[source,java,diff-id=3,diff-type=noncompliant]
----
XMLInputFactory factory = XMLInputFactory.newInstance(); // Noncompliant
----

[source,java,diff-id=4,diff-type=noncompliant]
----
TransformerFactory factory = javax.xml.transform.TransformerFactory.newInstance(); // Noncompliant
----

[source,java,diff-id=4,diff-type=noncompliant]
----
SchemaFactory factory = SchemaFactory.newInstance(XMLConstants.W3C_XML_SCHEMA_NS_URI); // Noncompliant
----

==== Compliant solution

[source,java,diff-id=1,diff-type=compliant]
----
DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
// To be compliant, completely disable DOCTYPE declaration:
factory.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true); 
// Or completely disable external entities declarations:     
factory.setFeature("http://xml.org/sax/features/external-general-entities", false); 
factory.setFeature("http://xml.org/sax/features/external-parameter-entities", false);
// Or prohibit the use of all protocols by external entities:
factory.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, "");
factory.setAttribute(XMLConstants.ACCESS_EXTERNAL_SCHEMA, "");
// Or disable entity expansion but keep in mind that this doesn't prevent fetching external entities
// and this solution is not correct for OpenJDK < 13 due to a bug: https://bugs.openjdk.java.net/browse/JDK-8206132
factory.setExpandEntityReferences(false);
----

[source,java,diff-id=2,diff-type=compliant]
----
SAXParserFactory factory = SAXParserFactory.newInstance();
// To be compliant, completely disable DOCTYPE declaration:
factory.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true); 
// Or completely disable external entities declarations:     
factory.setFeature("http://xml.org/sax/features/external-general-entities", false); 
factory.setFeature("http://xml.org/sax/features/external-parameter-entities", false);
// Or prohibit the use of all protocols by external entities:
SAXParser parser = factory.newSAXParser(); // Noncompliant
parser.setProperty(XMLConstants.ACCESS_EXTERNAL_DTD, "");
parser.setProperty(XMLConstants.ACCESS_EXTERNAL_SCHEMA, "");
----

[source,java,diff-id=3,diff-type=compliant]
----
XMLInputFactory factory = XMLInputFactory.newInstance();
// To be compliant, completely disable DOCTYPE declaration:
factory.setProperty(XMLInputFactory.SUPPORT_DTD, false); 
// Or completely disable external entities declarations:     
factory.setProperty(XMLInputFactory.IS_SUPPORTING_EXTERNAL_ENTITIES, Boolean.FALSE);
// Or prohibit the use of all protocols by external entities:
factory.setProperty(XMLConstants.ACCESS_EXTERNAL_DTD, "");
factory.setProperty(XMLConstants.ACCESS_EXTERNAL_SCHEMA, "");
----

[source,java,diff-id=4,diff-type=compliant]
----
TransformerFactory factory = javax.xml.transform.TransformerFactory.newInstance();
// To be compliant, prohibit the use of all protocols by external entities:
factory.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, "");
factory.setAttribute(XMLConstants.ACCESS_EXTERNAL_STYLESHEET, "");
----

[source,java,diff-id=5,diff-type=compliant]
----
SchemaFactory factory = SchemaFactory.newInstance(XMLConstants.W3C_XML_SCHEMA_NS_URI);
// To be compliant, completely disable DOCTYPE declaration:
factory.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true); 
// Or prohibit the use of all protocols by external entities:
factory.setProperty(XMLConstants.ACCESS_EXTERNAL_DTD, "");
factory.setProperty(XMLConstants.ACCESS_EXTERNAL_SCHEMA, "");
----

=== How does this work?

include::../../common/fix/xxe.adoc[]
