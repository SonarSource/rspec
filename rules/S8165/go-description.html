<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This rule raises an issue when a <code>uintptr</code> value is stored in a variable before being converted back to <code>unsafe.Pointer</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When you convert an <code>unsafe.Pointer</code> to <code>uintptr</code> and store it in a variable, you break Go&#8217;s garbage collection safety guarantees.</p>
</div>
<div class="paragraph">
<p>The <code>uintptr</code> type is an integer, not a pointer reference. This means the garbage collector cannot track it as pointing to an object. If you store a <code>uintptr</code> in a variable, the garbage collector might:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Move the object to a different memory location</p>
</li>
<li>
<p>Collect the object entirely</p>
</li>
<li>
<p>Reuse the memory for something else</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When you later convert the stored <code>uintptr</code> back to <code>unsafe.Pointer</code>, you may be pointing to invalid memory, moved objects, or completely different data.</p>
</div>
<div class="paragraph">
<p>The Go documentation explicitly states that conversions from <code>Pointer</code> to <code>uintptr</code> and back must happen in the same expression, with only arithmetic operations between them. This ensures the garbage collector knows the object is still being referenced during the conversion.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>Using stored <code>uintptr</code> values can lead to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Memory corruption</strong>: Writing to invalid memory locations</p>
</li>
<li>
<p><strong>Application crashes</strong>: Accessing freed or moved memory</p>
</li>
<li>
<p><strong>Data corruption</strong>: Reading or writing wrong data</p>
</li>
<li>
<p><strong>Unpredictable behavior</strong>: The program may work sometimes but fail randomly</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These issues are particularly dangerous because they may not manifest immediately and can be difficult to debug.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Perform the pointer arithmetic in a single expression without storing the uintptr in a variable.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-go" data-lang="go">// INVALID: uintptr cannot be stored in variable
// before conversion back to Pointer.
u := uintptr(p) // Noncompliant
p = unsafe.Pointer(u + offset)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-go" data-lang="go">// Valid: conversion happens in same expression
p = unsafe.Pointer(uintptr(p) + offset)</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>Go unsafe package documentation - <a href="https://pkg.go.dev/unsafe#Pointer">Official Go documentation explaining valid patterns for unsafe.Pointer usage</a></p>
</li>
<li>
<p>Go Memory Model - <a href="https://go.dev/ref/mem">Specification of Go&#8217;s memory model and garbage collection behavior</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_standards">Standards</h3>
<div class="ulist">
<ul>
<li>
<p>CWE-119: Improper Restriction of Operations within the Bounds of a Memory Buffer - <a href="https://cwe.mitre.org/data/definitions/119.html">Using invalid pointers can lead to buffer overflows and memory corruption</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>