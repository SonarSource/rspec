<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>XML injections occur when an application builds an XML-formatted string from
user input without prior validation or sanitation. In such a case, a tainted
user-controlled value can tamper with the XML string content. Especially,
unexpected arbitrary elements and attributes can be inserted in the
corresponding XML description.</p>
</div>
<div class="paragraph">
<p>A malicious injection payload could, for example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Insert tags into the main XML document.</p>
</li>
<li>
<p>Add attributes to an existing XML tag.</p>
</li>
<li>
<p>Change the data value inside a tag.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A malicious user-supplied value can perform other modifications depending on
where and how the constructed data is later used.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>The consequences of an XML injection attack on an application vary greatly
depending on the application&#8217;s logic. It can affect the application itself or
another element if the XML document is used for cross-component data exchange.
For this reason, the actual impact can range from benign information disclosure
to critical remote code execution.</p>
</div>
<div class="sect3">
<h4 id="_information_disclosure">Information disclosure</h4>
<div class="paragraph">
<p>An attacker can forge an attack payload that will modify the XML document so
that it will become syntactically incorrect. In that case, when the data is
later used, the parsing component will raise a technical error. If displayed
back to the attacker or made available through log files, this technical error
may disclose sensitive business or technical information.</p>
</div>
<div class="paragraph">
<p>This scenario, while in general the less severe one, is the most frequently
encountered. It can combine with any other logic-dependant threat.</p>
</div>
</div>
<div class="sect3">
<h4 id="_internal_requests_tampering">Internal requests tampering</h4>
<div class="paragraph">
<p>Some applications communicate with backend micro-services APIs using XML-based
protocols such as SOAP. When those applications are vulnerable to XML
injections, attackers can tamper with the internal requests' content. This will
allow them to change internal requests' parameters or locations which, in turn,
can lead to various consequences like performing unauthorized actions or
accessing sensitive data.</p>
</div>
<div class="paragraph">
<p>For example, altering a user creation request in such a way can lead to a
privilege escalation if attackers manage to modify the default account privilege
level.</p>
</div>
</div>
<div class="sect3">
<h4 id="_code_execution">Code execution</h4>
<div class="paragraph">
<p>An application might build objects based on an XML serialization string. In that
case, an attacker that would exploit an XML injection could be able to alter the
serialization string to modify the corresponding object&#8217;s properties.</p>
</div>
<div class="paragraph">
<p>Depending on the deserialization process, this might allow instantiating
arbitrary objects or objects with sensitive properties altered. This can lead to
arbitrary code being executed in the same way as a deserialization injection
vulnerability.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it_in_a_servlet">How to fix it in a Servlet</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="paragraph">
<p>The following code is an example of an overly simple authentication function:
The role of a user is set in an XML file and the default user role is <code>user</code>.<br>
This example code is vulnerable to an XML injection vulnerability because it
builds an XML string from user input without prior sanitation or validation.</p>
</div>
<div class="paragraph">
<p>In this particular case, the query can be exploited with the following string:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>attacker&lt;/username&gt;&lt;role&gt;admin&lt;/role&gt;&lt;/user&gt;
&lt;user&gt;&lt;username&gt;foo</pre>
</div>
</div>
<div class="paragraph">
<p>By adapting and inserting this string into the <code>username</code> field, an attacker
would be able to log in as an admin.</p>
</div>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin">import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;

fun doGet(req: HttpServletRequest, resp: HttpServletResponse) {
  val xml = """
     &lt;user&gt;
       &lt;username&gt;
        ${req.getParameter("username")}
       &lt;/username&gt;
       &lt;role&gt;user&lt;/role&gt;
     &lt;/user&gt;
     """

  val factory = DocumentBuilderFactory.newInstance()
  try {
    val builder = factory.newDocumentBuilder()
    builder.parse(InputSource(StringReader(xml))) // Noncompliant
  } catch (e: ParserConfigurationException) {
    resp.sendError(400)
  } catch (e: SAXException) {
    resp.sendError(400)
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin">import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import org.w3c.dom.Document;
import org.w3c.dom.Element;

fun doGet(req: HttpServletRequest, resp: HttpServletResponse) {
  val factory = DocumentBuilderFactory.newInstance()
  try {
    val builder = factory.newDocumentBuilder()
    val doc: Document = builder.newDocument()
    val user: Element = doc.createElement("user")
    doc.appendChild(user)

    val usernameElement: Element = doc.createElement("username")
    user.appendChild(usernameElement)
    usernameElement.textContent = req.getParameter("username")

    val role: Element = doc.createElement("role")
    user.appendChild(role)
    role.textContent = "user"
  } catch (e: ParserConfigurationException) {
    resp.sendError(400)
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_how_does_this_work">How does this work?</h3>
<div class="paragraph">
<p>In most cases, building XML strings with a direct concatenation of user input
is discouraged. While not always possible, a strong pattern-based validation can
help sanitize tainted inputs. Likewise, converting to a harmless type can
sometimes be a solution.</p>
</div>
<div class="paragraph">
<p>However, directly constructing Java objects should be preferred over handling
the properties of objects as strings.</p>
</div>
<div class="sect3">
<h4 id="_programmatic_object_building">Programmatic object building</h4>
<div class="paragraph">
<p>In most cases, an application can directly create documents from user input
without having to build and parse an XML string. Doing so prevents injection
vulnerabilities as XML document construction libraries and functions will
properly escape and check the type of input values.</p>
</div>
<div class="paragraph">
<p>Sometimes, the application might need to include the user input in a document
built from a trusted XML string. In that case, the recommended solution is to
parse the trusted string first and then programmatically modify the resulting
document.</p>
</div>
<div class="paragraph">
<p>The example compliant code takes advantage of the <code>javax.xml</code> and <code>org.w3c.dom</code>
libraries capabilities to programmatically build XML documents.</p>
</div>
</div>
<div class="sect3">
<h4 id="_converting_to_a_harmless_type">Converting to a harmless type</h4>
<div class="paragraph">
<p>When the application allows it, casting user-submitted data to a harmless type
can help prevent XML injection vulnerabilities. In particular, converting user
inputs to numeric types is an efficient sanitation mechanism.</p>
</div>
<div class="paragraph">
<p>This mechanism can be extended to other types, including more complex ones.
However, care should be taken when dealing with them, as manually validating or
sanitizing complex types can represent a challenge.</p>
</div>
<div class="paragraph">
<p>Note that choosing this solution can be error-prone: every user input has to be
validated or sanitized without oversight.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_standards">Standards</h3>
<div class="ulist">
<ul>
<li>
<p>OWASP - <a href="https://owasp.org/Top10/A03_2021-Injection/">Top 10 2021 Category A3 - Injection</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-top-ten/2017/A1_2017-Injection">Top 10 2017 Category A1 - Injection</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/20">CWE-20 - Improper Input Validation</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/91">CWE-91 - XML Injection (aka Blind XPath Injection)</a></p>
</li>
<li>
<p>STIG Viewer - <a href="https://stigviewer.com/stigs/application_security_and_development/2024-12-06/finding/V-222608">Application Security and Development: V-222608</a> - The application must not be vulnerable to XML-oriented attacks.</p>
</li>
<li>
<p>STIG Viewer - <a href="https://stigviewer.com/stigs/application_security_and_development/2024-12-06/finding/V-222609">Application Security and Development: V-222609</a> - The application must not be subject to input handling vulnerabilities.</p>
</li>
</ul>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Change this code to not construct XML documents directly from user-controlled data.</p>
</div>
</div>
</div>
</div>