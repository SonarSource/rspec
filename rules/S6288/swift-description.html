<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>On iOS and macOS, the Keychain is the dedicated secure container for storing key materials or secrets. When using Keychain services, the complexities of encryption are handled by the system, which ensures that the data is stored securely. Keychain also provides fine-grained access control, allowing developers to specify the conditions under which a keychain item can be accessed. For instance, access control can be configured to require user authentication, such as Face ID, Touch ID, or passcode, every time an application attempts to access the Keychain item. This measure protects the keychain item from unauthorized access, even if the device has no passcode or is already unlocked.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ask_yourself_whether">Ask Yourself Whether</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>The application requires prohibiting the use of keys in case of compromise of the application process.</p>
</li>
<li>
<p>The key material is used in the context of a highly sensitive application like a e-banking mobile app.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is a risk if you answered yes to any of those questions.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_recommended_secure_coding_practices">Recommended Secure Coding Practices</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It&#8217;s recommended to enable user authentication by setting <code>kSecAttrAccessControl</code> using the <code>SecAccessControlCreateWithFlags</code> function. It allows you to require user authentication (such as Face ID, Touch ID, or passcode) before accessing the keychain item.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sensitive_code_example">Sensitive Code Example</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The generated key can be used without authentication.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-swift" data-lang="swift">import Security

let parameters: [String: Any] = [
    kSecAttrKeyType as String: kSecAttrKeyTypeRSA,
    kSecAttrKeySizeInBits as String: 4096,
    kSecPrivateKeyAttrs as String: [
        kSecAttrIsPermanent as String: true,
        kSecAttrApplicationTag as String: "a-private-key"
    ]
]

SecKeyCreateRandomKey(parameters as CFDictionary, nil) // Noncompliant</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compliant_solution">Compliant Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Accessing the key will trigger a local authentication.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-swift" data-lang="swift">import Security

let parameters: [String: Any] = [
    kSecAttrKeyType as String: kSecAttrKeyTypeRSA,
    kSecAttrKeySizeInBits as String: 4096,
    kSecPrivateKeyAttrs as String: [
        kSecAttrIsPermanent as String: true,
        kSecAttrApplicationTag as String: "a-private-key",
        kSecAttrAccessControl as String: SecAccessControlCreateWithFlags(
            nil,
            kSecAttrAccessibleWhenUnlockedThisDeviceOnly,
            .userPresence,
            nil
        )!
    ]
]

SecKeyCreateRandomKey(parameters as CFDictionary, nil)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>OWASP - <a href="https://owasp.org/Top10/A04_2021-Insecure_Design/">Top 10 2021 Category A4 - Insecure Design</a></p>
</li>
<li>
<p>OWASP - <a href="https://mas.owasp.org/checklists/MASVS-STORAGE/">Mobile AppSec Verification Standard - Authentication and Session Management Requirements</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-mobile-top-10/2016-risks/m4-insecure-authentication">Mobile Top 10 2016 Category M4 - Insecure Authentication</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-mobile-top-10/2023-risks/m3-insecure-authentication-authorization">Mobile Top 10 2024 Category M3 - Insecure Authentication/Authorization</a></p>
</li>
<li>
<p>OWASP - <a href="https://owasp.org/www-project-mobile-top-10/2023-risks/m10-insufficient-cryptography">Mobile Top 10 2024 Category M10 - Insufficient Cryptography</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/522">CWE-522 - Insufficiently Protected Credentials</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="https://developer.apple.com/documentation/security/restricting-keychain-item-accessibility?language=swift">developer.apple.com</a> - Restricting keychain item accessibility</p>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>This keychain item will not require authentication to be used. Make sure it is safe here.</p>
</div>
</div>
<div class="sect2">
<h3 id="_highlighting">Highlighting</h3>
<div class="paragraph">
<p>Highlight the call to <code>SecItemAdd</code>, <code>SecKeyCreateRandomKey</code>, <code>SecKeyGeneratePair</code></p>
</div>
</div>
</div>
</div>