Refactor this code to not nest functions more than {n} levels deep.