<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When testing if a collection contains a specific item by simple equality, both <code>ICollection.Contains(T item)</code> and <code>IEnumerable.Any(x &#8658; x == item)</code> can be used. However, <code>Any</code> searches the data structure in a linear manner using a foreach loop, whereas <code>Contains</code> is considerably faster in some collection types, because of the underlying implementation. More specifically:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>HashSet&lt;T&gt;</code> is a hashtable, and therefore has an O(1) lookup</p>
</li>
<li>
<p><code>SortedSet&lt;T&gt;</code> is a red-black tree, and therefore has a O(logN) lookup</p>
</li>
<li>
<p><code>List&lt;T&gt;</code> is a linear search, and therefore has an O(N) lookup, but the EqualityComparer is optimized for the <code>T</code> type, which is not the case for <code>Any</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For small collections, the performance difference may be negligible, but for large collections, it can be noticeable.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>We measured a significant improvement both in execution time and memory allocation. For more details see the <code>Benchmarks</code> section from the <code>More info</code> tab.</p>
</div>
</div>
<div class="sect2">
<h3 id="_exceptions">Exceptions</h3>
<div class="paragraph">
<p>Since <code><a href="https://learn.microsoft.com/en-us/dotnet/framework/data/adonet/ef/language-reference/linq-to-entities">LINQ to Entities</a></code> relies a lot on <code>System.Linq</code> for <a href="https://learn.microsoft.com/en-us/dotnet/framework/data/adonet/ef/language-reference/linq-to-entities#query-conversion">query conversion</a>, this rule won&#8217;t raise when used within LINQ to Entities syntaxes.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>Contains</code> is a method defined on the <code>ICollection&lt;T&gt;</code> interface and takes a <code>T item</code> argument.
<code>Any</code> is an extension method defined on the <code>IEnumerable&lt;T&gt;</code> interface and takes a predicate argument.
Therefore, calls with simple equality checks like <code>Any(x &#8658; x == item)</code> can be replaced by <code>Contains(item)</code>.</p>
</div>
<div class="paragraph">
<p>This applies to the following collection types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/system.collections.generic.hashset-1">HashSet&lt;T&gt;</a></p>
</li>
<li>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/system.collections.generic.sortedset-1">SortedSet&lt;T&gt;</a></p>
</li>
<li>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/system.collections.generic.list-1">List&lt;T&gt;</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-vbnet" data-lang="vbnet">Function ValueExists(data As HashSet(Of Integer)) As Boolean
    Return data.Any(Function(x) x = 42)
End Function</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-vbnet" data-lang="vbnet">Function ValueExists(data As List(Of Integer)) As Boolean
    Return data.Any(Function(x) x = 42)
End Function</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-vbnet" data-lang="vbnet">Function ValueExists(data As HashSet(Of Integer)) As Boolean
    Return data.Contains(42)
End Function</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-vbnet" data-lang="vbnet">Function ValueExists(data As List(Of Integer)) As Boolean
    Return data.Contains(42)
End Function</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/system.collections.generic.hashset-1.contains">HashSet&lt;T&gt;.Contains(T)</a></p>
</li>
<li>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/system.collections.generic.sortedset-1.contains">SortedSet&lt;T&gt;.Contains(T)</a></p>
</li>
<li>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/system.collections.generic.list-1.contains">List.Contains(T)</a></p>
</li>
<li>
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/system.linq.enumerable.any">Enumerable.Any</a></p>
</li>
<li>
<p><a href="https://learn.microsoft.com/en-us/dotnet/framework/data/adonet/ef/language-reference/linq-to-entities">LINQ to Entities</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_articles_blog_posts">Articles &amp; blog posts</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://learn.microsoft.com/en-us/dotnet/standard/collections/">Collections and Data Structures</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_benchmarks">Benchmarks</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Method</th>
<th class="tableblock halign-left valign-top">Runtime</th>
<th class="tableblock halign-left valign-top">Mean</th>
<th class="tableblock halign-left valign-top">Standard Deviation</th>
<th class="tableblock halign-left valign-top">Allocated</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HashSet_Any</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">.NET 7.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">35,388.333 us</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">620.1863 us</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">40132 B</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HashSet_Contains</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">.NET 7.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.799 us</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1489 us</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">List_Any</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">.NET 7.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">32,851.509 us</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">667.1658 us</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">40130 B</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">List_Contains</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">.NET 7.0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">375.132 us</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8.0764 us</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HashSet_Any</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">.NET Framework 4.6.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">28,979.763 us</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">678.0093 us</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">40448 B</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HashSet_Contains</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">.NET Framework 4.6.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5.987 us</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.1090 us</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">List_Any</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">.NET Framework 4.6.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">25,830.221 us</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">487.2470 us</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">40448 B</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">List_Contains</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">.NET Framework 4.6.2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5,935.812 us</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">57.7569 us</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="_glossary">Glossary</h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://en.wikipedia.org/wiki/Arithmetic_mean">Mean</a></p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/Standard_deviation">Standard Deviation</a></p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/Memory_management">Allocated</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The results were generated by running the following snippet with <a href="https://github.com/dotnet/BenchmarkDotNet">BenchmarkDotNet</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-csharp" data-lang="csharp">[Params(10_000)]
public int SampleSize;

[Params(1_000)]
public int Iterations;

private static HashSet&lt;int&gt; hashSet;
private static List&lt;int&gt; list;

[GlobalSetup]
public void Setup()
{
    hashSet = new HashSet&lt;int&gt;(Enumerable.Range(0, SampleSize));
    list = Enumerable.Range(0, SampleSize).ToList();
}

[Benchmark]
public void HashSet_Any() =&gt;
    CheckAny(hashSet, SampleSize / 2);

[Benchmark]
public void HashSet_Contains() =&gt;
    CheckContains(hashSet, SampleSize / 2);

[Benchmark]
public void List_Any() =&gt;
    CheckAny(list, SampleSize / 2);

[Benchmark]
public void List_Contains() =&gt;
    CheckContains(list, SampleSize / 2);

void CheckAny(IEnumerable&lt;int&gt; values, int target)
{
    for (int i = 0; i &lt; Iterations; i++)
    {
        _ = values.Any(x =&gt; x == target);  // Enumerable.Any
    }
}

void CheckContains(ICollection&lt;int&gt; values, int target)
{
    for (int i = 0; i &lt; Iterations; i++)
    {
        _ = values.Contains(target); // ICollection&lt;T&gt;.Contains
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Hardware configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>BenchmarkDotNet=v0.13.5, OS=Windows 10 (10.0.19045.2846/22H2/2022Update)
11th Gen Intel Core i7-11850H 2.50GHz, 1 CPU, 16 logical and 8 physical cores
.NET SDK=7.0.203
  [Host]               : .NET 7.0.5 (7.0.523.17405), X64 RyuJIT AVX2
  .NET 7.0             : .NET 7.0.5 (7.0.523.17405), X64 RyuJIT AVX2
  .NET Framework 4.6.2 : .NET Framework 4.8.1 (4.8.9139.0), X64 RyuJIT VectorSize=256</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>