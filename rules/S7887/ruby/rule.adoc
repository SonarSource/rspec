This is an issue when a `before_destroy` callback adds validation errors but fails to properly halt the destruction process, or when using `return false` in Rails 5+ where it no longer prevents destruction.

== Why is this an issue?

In Rails applications, `before_destroy` callbacks are commonly used to validate whether a record can be safely deleted. However, simply adding errors to the model does not automatically prevent destruction.

In Rails versions prior to 5.0, returning `false` from a callback would halt the callback chain and prevent the destruction. However, this behavior changed in Rails 5.0 for consistency with other callback types.

Starting with Rails 5.0, callbacks must explicitly use `throw :abort` to halt execution. The `return false` approach silently fails, allowing records to be destroyed despite validation errors.

When callbacks add errors but fail to halt execution, the destruction proceeds normally. This creates a misleading situation where the model appears to have validation errors, but the record is still deleted from the database. This can lead to data integrity issues, orphaned records, and broken business logic.

=== What is the potential impact?

Records may be destroyed despite validation failures, leading to data integrity issues and broken business logic. Users may receive error messages but still see their data deleted, creating confusion and potential data loss.

== How to fix it in Rails 5+

Use `throw :abort` to properly halt the destruction process when validation errors are added.

=== Code examples

==== Noncompliant code example

[source,ruby,diff-id=1,diff-type=noncompliant]
----
class Administratorship < ActiveRecord::Base
  before_destroy :validate_destruction

  private

  def validate_destruction
    unless can_be_destroyed?
      errors.add(:base, "Cannot destroy this record")
      # Missing halt mechanism - destruction will proceed despite errors // Noncompliant
    end
  end
end
----

==== Compliant solution

[source,ruby,diff-id=1,diff-type=compliant]
----
class Administratorship < ActiveRecord::Base
  before_destroy :validate_destruction

  private

  def validate_destruction
    unless can_be_destroyed?
      errors.add(:base, "Cannot destroy this record")
      throw :abort # Properly halts destruction in Rails 5+
    end
  end
end
----

Replace `return false` with `throw :abort` in Rails 5+ applications, as returning false no longer prevents destruction.

=== Code examples

==== Noncompliant code example

[source,ruby,diff-id=2,diff-type=noncompliant]
----
class Submission < ActiveRecord::Base
  before_destroy :check_for_payments

  private

  def check_for_payments
    if has_payments?
      errors[:base] << "Cannot delete submission with payments"
      return false # Incorrect: doesn't prevent destruction in Rails 5+ // Noncompliant
    end
  end
end
----

==== Compliant solution

[source,ruby,diff-id=2,diff-type=compliant]
----
class Submission < ActiveRecord::Base
  before_destroy :check_for_payments

  private

  def check_for_payments
    if has_payments?
      errors[:base] << "Cannot delete submission with payments"
      throw :abort # Correct: Use throw :abort in Rails 5+
    end
  end
end
----

== How to fix it in Rails < 5.0

In Rails versions prior to 5.0, use `return false` to halt the destruction process when validation errors are added.

=== Code examples

==== Noncompliant code example

[source,ruby,diff-id=3,diff-type=noncompliant]
----
class Document < ActiveRecord::Base
  before_destroy :validate_destruction

  private

  def validate_destruction
    if has_dependencies?
      errors.add(:base, "Cannot destroy document with dependencies")
      # Missing return false - destruction will proceed // Noncompliant
    end
  end
end
----

==== Compliant solution

[source,ruby,diff-id=3,diff-type=compliant]
----
class Document < ActiveRecord::Base
  before_destroy :validate_destruction

  private

  def validate_destruction
    if has_dependencies?
      errors.add(:base, "Cannot destroy document with dependencies")
      return false # Properly halts destruction in Rails < 5.0
    end
  end
end
----

== Resources

=== Documentation

 * Rails Active Record Callbacks Guide - https://guides.rubyonrails.org/active_record_callbacks.html#halting-execution[Official Rails documentation on callback execution and halting mechanisms]

 * Rails 5.0 Release Notes - Callback Changes - https://guides.rubyonrails.org/5_0_release_notes.html#active-record-deprecations[Documentation of the Rails 5.0 callback behavior changes]
