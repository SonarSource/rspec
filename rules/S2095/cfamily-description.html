<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A function call to <code>fopen</code> or <code>open</code> must be matched with a call to <code>fclose</code> or <code>close</code>, respectively.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The standard C library provides <code>fopen</code> and the system call <code>open</code> to open and possibly create files.
Each call to one of these functions must be matched with a respective call to <code>fclose</code> or <code>close</code>.</p>
</div>
<div class="paragraph">
<p>Failing to close files that have been opened may lead to using up all of the OS&#8217;s file handles.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>If a program does not properly close or release file handles after using them, it will leak resources.
In that case, the program will continue to hold onto file handles even when they are no longer needed, eventually exhausting the available file handles.</p>
</div>
<div class="paragraph">
<p>If a program has run out of file handles and tries to open yet another file, the file opening operation will fail.
This can result in errors or unexpected behavior in the program.</p>
</div>
<div class="paragraph">
<p>The program may not be able to read or write to files anymore, which can cause data loss, corruption, or incomplete operations.
In some cases, when a program runs out of file handles, it may crash or hang indefinitely.
This can happen if the program does not handle the error condition properly or if it enters an infinite loop trying to open files, for instance.
In the worst case, a resource leak can lock up everything that runs on the machine.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Make sure that each call to <code>fopen</code> and <code>open</code> has a matching call to <code>fclose</code> and <code>close</code>, respectively.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

int process_file(int print) {
  FILE *f = fopen("example.txt", "r");
  if (!f) {
    perror("fopen() failed");
    return 1;
  }

  if (print) {
    char buffer[256];
    while (fgets(buffer, 256, f)) {
      printf("%s", buffer);
    }
  }

  return 0; // Noncompliant: file `f` has not been closed
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

int process_file(int print) {
  FILE *f = fopen("example.txt", "r");
  if (!f) {
    perror("fopen() failed");
    return 1;
  }

  if (print) {
    char buffer[256];
    while (fgets(buffer, 256, f)) {
      printf("%s", buffer);
    }
  }

  fclose(f);
  return 0; // Compliant: file `f` has been closed
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_going_the_extra_mile">Going the extra mile</h3>
<div class="paragraph">
<p>Using C&#43;&#43;'s <em>RAII</em> idiom can mitigate unmatched calls to <code>fopen</code> and <code>open</code>.</p>
</div>
<div class="paragraph">
<p>Following this idiom, one would create a class that manages the underlying file by opening it when the object is constructed and closing it when the object is destroyed, effectively using a constructor-destructor pair as a "do-undo"-mechanism.</p>
</div>
<div class="paragraph">
<p>An exemplary class that manages a pointer to a file is shown in what follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cpp" data-lang="cpp">#include &lt;cstdio&gt;
#include &lt;fstream&gt;
#include &lt;string&gt;
#include &lt;utility&gt;

// Although `std::fstream` should be preferred, if available, a file stream
// managed by this `File` class cannot suffer from "double-close" issues.
class File {
  FILE *f;

public:
  // Opens file stream on construction.
  File(std::string const &amp;path, std::string const &amp;modes)
      : f(fopen(path.c_str(), modes.c_str())) {
    if (!f) {
      throw std::ios_base::failure("fopen() failed");
    }
  }
  // Will close the file stream upon destruction.
  ~File() {
    // Here we are fine with `std::terminate` being called here in case `close`
    // throws and exception.
    close();
  }
  // Allow only one owner of a file, disallow copy operations.
  File(const File &amp;other) = delete;
  File &amp;operator=(const File &amp;other) = delete;
  // Moving a file to a different scope shall be allowed.
  File(File &amp;&amp;other) : f(std::exchange(other.f, nullptr)) {}
  File &amp;operator=(File &amp;&amp;other) {
    if (this != &amp;other) {
      // In case of non-self-assignment, close the currently managed file and
      // "steal" the other's file.
      close();
      f = std::exchange(other.f, nullptr);
    }
    return *this;
  }
  // Allow file to be closed explicitly.
  void close() {
    if (f != nullptr &amp;&amp; fclose(std::exchange(f, nullptr)) == EOF) {
      throw std::ios_base::failure("fclose() failed");
    }
  }
  // Allow access to underlying file via `f`.
  FILE *handle() { return f; }
  // Release `f`, i.e., stop managing it.
  FILE *release() { return std::exchange(f, nullptr); }
};

void file_user() {
  File fh{"example.txt", "r"};
  FILE *f = fh.handle();
  // Use `f` for the desired file operation(s).
  //
  // The file stream managed by `fh` will be automatically closed when `fh` goes
  // out of scope at the end of this function.
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the design shown above, calls to <code>fopen</code> will be automatically matched with a corresponding call to <code>fclose</code> by default.
The associated file will be automatically closed when the <code>File</code> typed file handle object goes out of scope and its destructor is called.
However, it is still possible to leak a resource, if <code>File</code>'s function member <code>File::release</code> is used inappropriately.
If this is a concern, this function member should be removed.</p>
</div>
<div class="paragraph">
<p>If falling back to low-level file operations is not necessary, one should prefer <code>std::fstream</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_standards">Standards</h3>
<div class="ulist">
<ul>
<li>
<p>CERT - <a href="https://wiki.sei.cmu.edu/confluence/x/QtUxBQ">FIO42-C. Close files when they are no longer needed</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/459">CWE-459 Incomplete Cleanup</a></p>
</li>
<li>
<p>CWE - <a href="https://cwe.mitre.org/data/definitions/772">CWE-772 Missing Release of Resource after Effective Lifetime</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_related_rules">Related rules</h3>
<div class="ulist">
<ul>
<li>
<p><a data-rspec-id="S3588" class="rspec-auto-link">S3588</a> ensures that <code>FILE*</code> typed variables are not accessed after the associated file has been closed</p>
</li>
</ul>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Review the data-flow; this file might not have been closed when reaching exit point at line <code>line</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_highlighting">Highlighting</h3>
<div class="ulist">
<ul>
<li>
<p>Primary: the open call, ex: fopen</p>
</li>
<li>
<p>Additional: statement exiting the function</p>
<div class="ulist">
<ul>
<li>
<p>Message: Exit point</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_on_30_mar_2016_164631_ann_campbell_wrote">on 30 Mar 2016, 16:46:31 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~massimo.paladin] I&#8217;ve expanded the description slightly with a 'why'.</p>
</div>
<div class="paragraph">
<p>Speaking of which, why downgrade this from Blocker to Critical?</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_31_mar_2016_131153_ann_campbell_wrote">on 31 Mar 2016, 13:11:53 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~massimo.paladin] I&#8217;ve moved the Cert C reference back to the main task. All references go on every language-variation of a rule.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_31_mar_2016_131508_massimo_paladin_wrote">on 31 Mar 2016, 13:15:08 Massimo PALADIN wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2] what about <code>Exceptions</code> section which is present on the main task but is not applicable to the language variation?</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_31_mar_2016_132956_ann_campbell_wrote">on 31 Mar 2016, 13:29:56 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~massimo.paladin] I&#8217;ve moved that into a language-specific subtask</p>
</div>
</div>
<div class="sect2">
<h3 id="_relates_to_s5485">relates to: <a data-rspec-id="S5485" class="rspec-auto-link">S5485</a></h3>

</div>
<div class="sect2">
<h3 id="_is_related_to_s3546">is related to: <a data-rspec-id="S3546" class="rspec-auto-link">S3546</a></h3>

</div>
<div class="sect2">
<h3 id="_is_related_to_s2930">is related to: <a data-rspec-id="S2930" class="rspec-auto-link">S2930</a></h3>

</div>
<div class="sect2">
<h3 id="_on_2_feb_2015_142837_sébastien_gioria_wrote">on 2 Feb 2015, 14:28:37 Sébastien Gioria wrote:</h3>
<div class="paragraph">
<p>Could be tag</p>
</div>
<div class="ulist">
<ul>
<li>
<p>OWASP Top10 2013 A5 (Denial Of Service fall mostly in this category because finishing most the time in stacktrace of the JavaVM. )</p>
</li>
<li>
<p>CERT Secure Coding FIO04-J</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_on_4_feb_2015_131112_ann_campbell_wrote">on 4 Feb 2015, 13:11:12 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>Thanks for the CERT reference [~sebastien.gioria], but I don&#8217;t understand the OWASP tie.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_11_feb_2015_230232_freddy_mallet_wrote">on 11 Feb 2015, 23:02:32 Freddy Mallet wrote:</h3>
<div class="paragraph">
<p>This one can lead to a denial of service.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_24_apr_2015_075503_michael_gumowski_wrote">on 24 Apr 2015, 07:55:03 Michael Gumowski wrote:</h3>
<div class="paragraph">
<p>As for the moment we are not making cross-file or cross-method analysis (it is planned), we are not able to tell if it is the responsibility of the method to close a Closeable/AutoCloseable retrieved using method invocation. There is no existing annotation neither which would provide the information. I changed the non-compliant example and compliant solution to something that we can actually detect.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_11_jun_2015_185732_ann_campbell_wrote">on 11 Jun 2015, 18:57:32 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~michael.gumowski], would it be appropriate to map this rule to the CodePro rule <a href="https://developers.google.com/java-dev-tools/codepro/doc/features/audit/audit_rules_com.instantiations.assist.eclipse.auditGroup.possibleErrors#com.instantiations.assist.eclipse.audit.closeInFinally">Close In Finally</a>?</p>
</div>
<div class="paragraph">
<p>I&#8217;m asking first for an answer based on the current implementation.</p>
</div>
<div class="paragraph">
<p>And if that answer&#8217;s "no" my second question is whether we should go ahead &amp; do the mapping &amp; extend the implementation.</p>
</div>
<div class="paragraph">
<p>As a followup, there is also this CodePro rule: <a href="https://developers.google.com/java-dev-tools/codepro/doc/features/audit/audit_rules_com.instantiations.assist.eclipse.auditGroup.jdbc#com.instantiations.assist.eclipse.audit.closeOrder">Close Order</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_on_17_jun_2015_141804_ann_campbell_wrote">on 17 Jun 2015, 14:18:04 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>CodePro: Close In Finally</p>
</div>
</div>
</div>
</div>