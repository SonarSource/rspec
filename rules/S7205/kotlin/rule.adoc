Software projects often rely on external code libraries, known as dependencies. Package managers such as Gradle, allow developpers to reference dependencies for their projects.
These dependencies simplify development, but also introduce risk as they download and include external code based on a project's configuration. 
Integrity checking is the step of verifying that the downloaded or included dependency code is exactly what the developer expects. Without this verification, the application cannot guarantee that the dependency is legitimate.

== Why is this an issue?

Failing to verify the integrity of dependencies before using them is a significant security problem. It exposes your application, and potentially your users, to several risks. The core issue is that you're running code from an untrusted source without checking it, effectively giving an attacker a direct pathway into your application.

This is often a key component of what's called a "supply chain attack." The attacker isn't directly attacking your application. Instead, they're attacking a component you use. This is an important consideration because the attack's source is less obvious. You might diligently secure your own code, but overlook the risk introduced by external dependencies.

== How to fix it in Gradle

=== Code examples

==== Noncompliant code example

[source,kotlin,diff-id=1,diff-type=noncompliant]
----
dependencies {
    implementation("com.example:a-dependency:1.0")
}

configurations { 
    all {
        resolutionStrategy {
            disableDependencyVerification() // Noncompliant: dependency verification is disabled
        }
    }
}
----

Absence of a `verification-metadata.xml` file in the `gradle` directory of your project will also result in the Gradle build not verifying the integrity of the dependencies.


==== Compliant solution

[source,kotlin,diff-id=1,diff-type=compliant]
----
dependencies {
    implementation("com.example:adependency:1.0")
}
----

Create a `verification-metadata.xml` in the `gradle` directory of your project.
Use `./gradlew --write-verification-metadata pgp,sha256 --export-keys` to bootstrap the file content

[source,xml]
----
<verification-metadata 
    xmlns="https://schema.gradle.org/dependency-verification" 
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
    xsi:schemaLocation="https://schema.gradle.org/dependency-verification https://schema.gradle.org/dependency-verification/dependency-verification-1.3.xsd">
   <configuration>
      <verify-metadata>true</verify-metadata>
      <verify-signatures>true</verify-signatures>
      <keyring-format>armored</keyring-format>
      <trusted-keys>
         <trusted-key id="FD8190C7D72E7DCD42582B1042677B9FC1DC2161" group="com.example" name="adependency"/>
      </trusted-keys>
   </configuration>
</verification-metadata>
----

== How does this work?

Gradle performs dependency verification by comparing the downloaded dependencies against known checksums or signatures. This ensures that the dependencies have not been tampered with and are exactly what the developer expects.

=== Checksum Verification

Checksum verification involves generating a unique hash value (checksum) for the dependency file and comparing it against a known, trusted checksum. If the checksums match, the dependency is considered valid. This method ensures that the file has not been altered since the checksum was generated.

=== Signature Verification

Signature verification involves using cryptographic signatures to verify the authenticity of the dependency. The dependency is signed with a private key, and the signature can be verified using the corresponding public key. This method not only ensures the integrity of the file but also verifies the identity of the entity that signed it.

== Resources
=== Documentation
* Gradle - https://docs.gradle.org/current/userguide/dependency_verification.html[Verifying dependencies]

=== Standards

* OWASP - https://owasp.org/Top10/A08_2021-Software_and_Data_Integrity_Failures/[Top 10 2021 Category A8 - Software and Data Integrity Failures]
* OWASP - https://owasp.org/www-project-mobile-top-10/2023-risks/m2-inadequate-supply-chain-security[Mobile Top 10 2024 Category M2 - Inadequate Supply Chain Security]
* CWE - https://cwe.mitre.org/data/definitions/494[CWE-494 - Download of Code Without Integrity Check]
* STIG Viewer - https://stigviewer.com/stig/application_security_and_development/2023-06-08/finding/V-222618[Application Security and Development: V-222618] - Unsigned Category 1A mobile code must not be used in the application in accordance with DoD policy.

ifdef::env-github,rspecator-view[]

'''
== Implementation Specification
(visible only on this page)

include::../message.adoc[]

include::../highlighting.adoc[]


endif::env-github,rspecator-view[]
