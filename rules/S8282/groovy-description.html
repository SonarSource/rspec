<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is an issue when MetaClass properties are modified in test methods without proper cleanup, causing changes to persist across test executions.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Groovy&#8217;s ExpandoMetaClass allows dynamic modification of classes at runtime, including built-in JDK classes. These modifications are global and persist beyond the scope of individual test methods unless explicitly cleaned up.</p>
</div>
<div class="paragraph">
<p>When MetaClass changes are not properly removed, they can cause test pollution where one test&#8217;s modifications affect subsequent tests. This leads to unpredictable test failures, makes tests dependent on execution order, and violates the principle of test isolation.</p>
</div>
<div class="paragraph">
<p>Test isolation is fundamental to reliable testing. Each test should run independently and produce the same results regardless of which other tests have run before it. MetaClass modifications that persist across tests break this isolation and can cause:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Intermittent test failures that are difficult to reproduce</p>
</li>
<li>
<p>Tests that pass or fail depending on execution order</p>
</li>
<li>
<p>False positives or negatives in test results</p>
</li>
<li>
<p>Debugging nightmares when trying to understand why tests behave differently in different contexts</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>Without proper cleanup, MetaClass modifications can cause:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Test flakiness</strong>: Tests may pass or fail unpredictably depending on execution order</p>
</li>
<li>
<p><strong>False test results</strong>: Tests may produce incorrect results due to unexpected MetaClass state</p>
</li>
<li>
<p><strong>Debugging difficulties</strong>: Intermittent failures become hard to reproduce and diagnose</p>
</li>
<li>
<p><strong>Reduced confidence in test suite</strong>: Unreliable tests undermine trust in the testing process</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it">How to fix it</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use a try-finally block to ensure MetaClass changes are cleaned up even if the test fails. This approach keeps the cleanup logic close to the modification.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Test
void testMetaClassChange() {
    String.metaClass.reverse = { -&gt; 'reversed' } // Noncompliant
    assert 'test'.reverse() == 'reversed'
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">@Test
void testMetaClassChange() {
    String.metaClass.reverse = { -&gt; 'reversed' }
    try {
        assert 'test'.reverse() == 'reversed'
    } finally {
        GroovySystem.metaClassRegistry.removeMetaClass(String)
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>Groovy Testing Guide - Expando Meta-Class - <a href="https://groovy-lang.org/testing.html#testing_guide_emc">Official Groovy documentation on using ExpandoMetaClass in tests and the importance of cleanup</a></p>
</li>
<li>
<p>GroovySystem.metaClassRegistry API - <a href="https://docs.groovy-lang.org/latest/html/gapi/groovy/lang/GroovySystem.html">API documentation for the GroovySystem class and MetaClass registry management</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_standards">Standards</h3>
<div class="ulist">
<ul>
<li>
<p>Test Isolation Principle - <a href="https://martinfowler.com/bliki/TestIsolation.html">Fundamental testing principle that each test should run independently without affecting others</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>