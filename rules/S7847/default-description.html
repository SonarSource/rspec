<div class="sect1">
<h2 id="_description">Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This rule raises an issue when database queries are executed inside loops, causing multiple round trips to the database instead of using batch operations.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_is_this_an_issue">Why is this an issue?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Executing database queries inside loops creates the N+1 query problem, one of the most common performance issues in web applications.</p>
</div>
<div class="paragraph">
<p>When you iterate over a collection and execute a database query for each item, you create multiple round trips between your application and the database. For example, if you have 100 items in your collection, you&#8217;ll execute 101 queries: 1 to fetch the collection and 100 individual queries inside the loop.</p>
</div>
<div class="paragraph">
<p>Each database round trip has overhead:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Network latency between application and database</p>
</li>
<li>
<p>Query parsing and execution planning</p>
</li>
<li>
<p>Connection management overhead</p>
</li>
<li>
<p>Lock acquisition and release</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This overhead multiplies with each iteration, causing exponential performance degradation as your data grows. A page that loads quickly with 10 records might timeout with 1000 records.</p>
</div>
<div class="paragraph">
<p>ActiveRecord provides built-in solutions for batch operations. When you pass an array to a <code>where</code> clause, it automatically generates an <code>IN</code> condition that fetches all matching records in a single query. For complex conditions involving multiple columns, you can use tuple-based WHERE conditions with proper parameterization.</p>
</div>
<div class="sect2">
<h3 id="_what_is_the_potential_impact">What is the potential impact?</h3>
<div class="paragraph">
<p>Applications will experience severe performance degradation as data volume increases. Database connections may be exhausted under load, leading to timeouts and service unavailability. The exponential nature of this problem means that performance issues often appear suddenly when data reaches a critical threshold.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_fix_it_in_activerecord">How to fix it in ActiveRecord</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Replace the loop with a single query using array parameters. ActiveRecord automatically converts arrays in WHERE clauses to IN conditions.</p>
</div>
<div class="sect2">
<h3 id="_code_examples">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">lawyers = []
phones.each do |phone|
  lawyers += Lawyer.joins(:phones).where(phones: { area_code: phone[:area_code], number: phone[:number] }) # Noncompliant
end</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">area_codes = phones.map { |phone| phone[:area_code] }
numbers = phones.map { |phone| phone[:number] }
lawyers = Lawyer.joins(:phones).where(phones: { area_code: area_codes, number: numbers })</code></pre>
</div>
</div>
<div class="paragraph">
<p>For complex conditions involving multiple columns, use tuple-based WHERE conditions with proper parameterization to avoid SQL injection.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_code_examples_2">Code examples</h3>
<div class="sect3">
<h4 id="_noncompliant_code_example_2">Noncompliant code example</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">results = []
phone_numbers.each { |phone| results.concat(Phone.where(area_code: phone[0], number: phone[1])) } # Noncompliant</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compliant_solution_2">Compliant solution</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">phone_pairs = phone_numbers.map { |phone| [phone[0], phone[1]] }
placeholders = Array.new(phone_pairs.size, '(?, ?)').join(', ')
results = Phone.where("(area_code, number) IN (#{placeholders})", *phone_pairs.flatten)</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resources">Resources</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_documentation">Documentation</h3>
<div class="ulist">
<ul>
<li>
<p>ActiveRecord Query Interface - <a href="https://guides.rubyonrails.org/active_record_querying.html">Official Rails guide covering ActiveRecord querying methods and best practices</a></p>
</li>
<li>
<p>Rails Performance Best Practices - <a href="https://guides.rubyonrails.org/performance_testing.html">Rails guide on performance optimization techniques including database query optimization</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_standards">Standards</h3>
<div class="ulist">
<ul>
<li>
<p>CWE-400: Uncontrolled Resource Consumption - <a href="https://cwe.mitre.org/data/definitions/400.html">Weakness related to inefficient resource usage that can lead to denial of service</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_related_rules">Related rules</h3>
<div class="ulist">
<ul>
<li>
<p><a data-rspec-id="S6912" class="rspec-auto-link">RSPEC-6912</a> - <a href="https://rules.sonarsource.com/java/RSPEC-6912/">Java rule for avoiding JPA queries in loops</a></p>
</li>
<li>
<p><a data-rspec-id="S5380" class="rspec-auto-link">RSPEC-5380</a> - <a href="https://rules.sonarsource.com/apex/RSPEC-5380/">Apex rule for avoiding SOQL queries in loops</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>